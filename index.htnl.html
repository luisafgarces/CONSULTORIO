<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suite Cl√≠nica | Luisa Fernanda Garc√©s Garc√≠a</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<script>
// Config Firebase - se inicializa cuando los scripts cargan
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyB-N6-kZ3_E9CxzKPom79TPJ1pBA3-M11c",
  authDomain: "consultorio-449a6.firebaseapp.com",
  projectId: "consultorio-449a6",
  storageBucket: "consultorio-449a6.firebasestorage.app",
  messagingSenderId: "853876080178",
  appId: "1:853876080178:web:a89b0d5b71ec077c66c62b"
};
let _firebaseDB = null;

function showSyncBadge(msg, color){
  let el = document.getElementById("sync-badge");
  if(!el){
    el = document.createElement("div");
    el.id = "sync-badge";
    el.style.cssText = "position:fixed;bottom:70px;right:24px;padding:7px 16px;border-radius:20px;font-size:0.74rem;font-family:Lato,sans-serif;z-index:9998;transition:opacity 0.6s;pointer-events:none;";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.background = color || "rgba(100,48,0,0.85)";
  el.style.color = "#fff";
  el.style.opacity = "1";
  clearTimeout(el._t);
  el._t = setTimeout(function(){ el.style.opacity = "0"; }, 2800);
}

const DB = {
  _cache: {},
  _loaded: false,

  get: function(k){
    if(this._cache[k] !== undefined) return this._cache[k];
    try { var v = localStorage.getItem(k); return v ? JSON.parse(v) : null; } catch(e){ return null; }
  },

  set: function(k, v){
    this._cache[k] = v;
    try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){}
    if(_firebaseDB){
      _firebaseDB.collection("suitedata").doc(k).set({ value: v })
        .then(function(){ showSyncBadge("‚òÅÔ∏è Guardado en la nube ‚úì", "#7ab87a"); })
        .catch(function(err){ console.warn("Error Firebase:", err); showSyncBadge("‚ö†Ô∏è Error al guardar en nube", "#e57373"); });
    }
  },

  loadAll: function(){
    if(!_firebaseDB) return Promise.resolve(false);
    showSyncBadge("üîÑ Sincronizando con la nube...", "#cd8e9d");
    var self = this;
    return _firebaseDB.collection("suitedata").get()
      .then(function(snap){
        snap.forEach(function(d){
          var v = d.data().value;
          self._cache[d.id] = v;
          try { localStorage.setItem(d.id, JSON.stringify(v)); } catch(e){}
        });
        self._loaded = true;
        showSyncBadge("‚úÖ Sincronizado con la nube", "#7ab87a");
        return true;
      })
      .catch(function(e){
        console.warn("Error cargando Firebase:", e);
        showSyncBadge("‚ö†Ô∏è Sin conexi√≥n ‚Äî usando datos locales", "#e57373");
        return false;
      });
  },

  // Espera a que Firebase cargue y luego ejecuta el callback
  whenReady: function(callback){
    if(this._loaded){ callback(); return; }
    var self = this;
    this.loadAll().then(function(){ callback(); });
  }
};
</script>
<style>
:root {
  --border: #cd8e9d;
  --bg: #fadae1;
  --text: #643000;
  --white: #fff8f9;
  --soft: #f5eaec;
  --strong: #a0536a;
  --success: #6aaa6a;
  --sidebar-w: 240px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Lato', sans-serif; background: var(--white); color: var(--text); display: flex; min-height: 100vh; }

/* SIDEBAR */
#sidebar {
  width: var(--sidebar-w); min-height: 100vh; background: var(--bg);
  border-right: 2px solid var(--border); display: flex; flex-direction: column;
  position: fixed; left: 0; top: 0; z-index: 100;
}
#sidebar .logo-area { padding: 20px 16px 14px; border-bottom: 1px solid var(--border); text-align: center; }
#sidebar .logo-area img { height: 70px; object-fit: contain; }
#sidebar .logo-area h2 { font-family: 'Playfair Display', serif; font-size: 0.82rem; color: var(--text); margin-top: 8px; line-height: 1.4; }
#sidebar .logo-area p { font-size: 0.65rem; color: var(--border); letter-spacing: 1.2px; text-transform: uppercase; margin-top: 2px; }

#sidebar nav { flex: 1; padding: 16px 0; }
.nav-section { font-size: 0.62rem; color: var(--border); letter-spacing: 1.5px; text-transform: uppercase; padding: 10px 18px 4px; }
.nav-btn {
  display: flex; align-items: center; gap: 10px;
  width: 100%; padding: 10px 18px; border: none;
  background: transparent; color: var(--text); font-family: 'Lato', sans-serif;
  font-size: 0.85rem; cursor: pointer; transition: all 0.2s; text-align: left;
}
.nav-btn .icon { font-size: 1.1rem; width: 22px; }
.nav-btn:hover { background: rgba(205,142,157,0.18); }
.nav-btn.active { background: var(--border); color: #fff; font-weight: 700; }

#sidebar .version { padding: 12px 18px; font-size: 0.65rem; color: var(--border); border-top: 1px solid var(--border); }
#sync-btn { margin: 0 12px 12px; padding: 8px 14px; border-radius: 20px; border: 1.5px solid var(--border); background: transparent; color: var(--text); font-family: Lato,sans-serif; font-size: 0.75rem; cursor: pointer; width: calc(100% - 24px); transition: all 0.2s; }
#sync-btn:hover { background: var(--border); color: #fff; }

/* MAIN */
#main { margin-left: var(--sidebar-w); flex: 1; padding: 28px 32px; min-height: 100vh; }

.page { display: none; }
.page.active { display: block; }

/* PATIENT SELECTOR BAR */
.patient-bar {
  background: #fff; border: 1.5px solid var(--bg); border-radius: 14px;
  padding: 14px 20px; margin-bottom: 24px; display: flex;
  align-items: center; gap: 14px; flex-wrap: wrap;
}
.patient-bar label { font-size: 0.75rem; color: var(--strong); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.patient-bar select, .patient-bar input { border: 1.5px solid #e8d0d6; border-radius: 10px; padding: 7px 12px; font-family: 'Lato', sans-serif; font-size: 0.87rem; color: var(--text); background: var(--white); }
.patient-bar select:focus, .patient-bar input:focus { outline: none; border-color: var(--border); }

/* PAGE HEADER */
.page-header { margin-bottom: 24px; }
.page-header h1 { font-family: 'Playfair Display', serif; font-size: 1.6rem; color: var(--text); }
.page-header p { font-size: 0.83rem; color: var(--border); margin-top: 4px; }

/* CARDS */
.card { background: #fff; border: 1.5px solid var(--bg); border-radius: 16px; padding: 24px; margin-bottom: 18px; }
.sec-title { font-family: 'Playfair Display', serif; font-size: 1.05rem; color: var(--border); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--bg); }
.subsec { font-size: 0.78rem; font-weight: 700; color: var(--strong); text-transform: uppercase; letter-spacing: 0.5px; margin: 16px 0 8px; }

/* FORM */
.row { display: grid; gap: 14px; margin-bottom: 14px; }
.col2 { grid-template-columns: 1fr 1fr; }
.col3 { grid-template-columns: 1fr 1fr 1fr; }
.fg { display: flex; flex-direction: column; gap: 5px; }
label.lbl { font-size: 0.73rem; color: var(--strong); font-weight: 700; letter-spacing: 0.4px; text-transform: uppercase; }
input[type=text], input[type=date], input[type=number], input[type=email], input[type=tel], select, textarea {
  border: 1.5px solid #e8d0d6; border-radius: 10px; padding: 9px 13px;
  font-family: 'Lato', sans-serif; font-size: 0.88rem; color: var(--text);
  background: var(--white); transition: border-color 0.2s; width: 100%;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--border); }
textarea { resize: vertical; min-height: 80px; }
.checks { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 4px; }
.chk { display: flex; align-items: center; gap: 6px; font-size: 0.87rem; cursor: pointer; }
.chk input[type=checkbox] { accent-color: var(--border); width: 15px; height: 15px; }
.range-row { display: flex; align-items: center; gap: 12px; }
input[type=range] { accent-color: var(--border); flex: 1; }
.rval { background: var(--border); color: #fff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.88rem; flex-shrink: 0; }

/* BUTTONS */
.btn { padding: 9px 20px; border-radius: 20px; border: 1.5px solid var(--border); font-family: 'Lato', sans-serif; font-size: 0.83rem; cursor: pointer; transition: all 0.2s; background: transparent; color: var(--text); }
.btn:hover { background: var(--border); color: #fff; }
.btn.primary { background: var(--border); color: #fff; }
.btn.primary:hover { background: var(--strong); border-color: var(--strong); }
.btn.success { background: var(--success); border-color: var(--success); color: #fff; }
.btn.danger { background: #e57373; border-color: #e57373; color: #fff; }
.btn-row { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; }

/* TABS */
.tab-nav { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 20px; }
.tab-btn { padding: 6px 14px; border-radius: 18px; border: 1.5px solid var(--border); background: transparent; color: var(--text); font-family: 'Lato', sans-serif; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
.tab-btn.active, .tab-btn:hover { background: var(--border); color: #fff; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* PATIENT CARDS (dashboard) */
.patient-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; margin-bottom: 20px; }
.patient-card { background: #fff; border: 1.5px solid var(--bg); border-radius: 16px; padding: 18px; cursor: pointer; transition: all 0.2s; }
.patient-card:hover { border-color: var(--border); box-shadow: 0 4px 16px rgba(205,142,157,0.18); }
.patient-card.selected { border-color: var(--border); background: var(--soft); }
.patient-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--text); margin-bottom: 4px; }
.patient-card .meta { font-size: 0.75rem; color: var(--border); }
.patient-card .badge { display: inline-block; background: var(--bg); color: var(--strong); border-radius: 10px; font-size: 0.68rem; padding: 2px 8px; margin-top: 6px; }

/* SESSION LIST */
.session-item { background: var(--soft); border-left: 4px solid var(--border); border-radius: 0 12px 12px 0; padding: 12px 16px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
.session-item:hover { background: var(--bg); }
.session-item h4 { font-size: 0.9rem; color: var(--text); font-weight: 700; }
.session-item p { font-size: 0.78rem; color: var(--strong); margin-top: 3px; }

/* SUMMARY BOX */
.summary-box { background: var(--soft); border: 1.5px solid var(--border); border-radius: 14px; padding: 20px; margin-top: 16px; white-space: pre-wrap; font-size: 0.88rem; line-height: 1.8; }

/* TESTS */
.test-question { margin-bottom: 18px; }
.test-question p { font-size: 0.9rem; margin-bottom: 8px; line-height: 1.5; }
.likert { display: flex; gap: 8px; flex-wrap: wrap; }
.likert label { display: flex; align-items: center; gap: 4px; font-size: 0.78rem; cursor: pointer; background: var(--soft); border: 1.5px solid var(--bg); border-radius: 10px; padding: 5px 10px; transition: all 0.2s; }
.likert label:hover { border-color: var(--border); }
.likert input[type=radio] { accent-color: var(--border); }
.result-bar { background: var(--bg); border-radius: 10px; height: 12px; margin: 6px 0; overflow: hidden; }
.result-bar-fill { background: var(--border); height: 100%; border-radius: 10px; transition: width 0.6s; }
.result-schema { background: #fff; border: 1px solid var(--bg); border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; }
.result-schema h4 { font-size: 0.82rem; color: var(--strong); font-weight: 700; margin-bottom: 6px; }

/* TOAST */
#toast { position: fixed; bottom: 28px; right: 28px; background: var(--strong); color: #fff; padding: 12px 22px; border-radius: 20px; font-size: 0.85rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 9999; }
#toast.show { opacity: 1; }

/* ‚îÄ‚îÄ CUMPLEA√ëOS ‚îÄ‚îÄ */
.bday-overlay{display:none;position:fixed;inset:0;background:rgba(100,48,0,0.32);z-index:10000;align-items:center;justify-content:center;backdrop-filter:blur(5px);}
.bday-overlay.open{display:flex;animation:bdFadeIn 0.3s ease;}
@keyframes bdFadeIn{from{opacity:0}to{opacity:1}}
.bday-modal{background:#fff;border-radius:28px;border:2px solid var(--border);max-width:520px;width:94%;overflow:hidden;box-shadow:0 24px 70px rgba(100,48,0,0.22);animation:bdPop 0.45s cubic-bezier(.175,.885,.32,1.275);}
@keyframes bdPop{from{transform:scale(0.7) translateY(30px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.bday-canvas-wrap canvas{width:100%;display:block;}
.bday-footer{padding:16px 20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
.bday-pac-name{font-family:'Playfair Display',serif;font-size:.95rem;color:var(--text);}
.bday-pac-name span{display:block;font-size:.73rem;font-family:'Lato',sans-serif;color:var(--strong);margin-top:2px;}
.bday-btns{display:flex;gap:8px;flex-wrap:wrap;}
.btn-bday-dl{background:var(--border);color:#fff;border:none;border-radius:20px;padding:8px 16px;font-family:'Lato',sans-serif;font-size:.8rem;cursor:pointer;}
.btn-bday-wa{background:#25D366;color:#fff;border:none;border-radius:20px;padding:8px 16px;font-family:'Lato',sans-serif;font-size:.8rem;cursor:pointer;}
.btn-bday-close{background:transparent;color:var(--text);border:1.5px solid var(--border);border-radius:20px;padding:8px 16px;font-family:'Lato',sans-serif;font-size:.8rem;cursor:pointer;}
/* badge flotante cumplea√±os */
.bday-badge{position:fixed;top:20px;right:20px;background:#fff;border:2px solid var(--border);border-radius:18px;padding:14px 18px 12px;z-index:9500;box-shadow:0 8px 32px rgba(100,48,0,0.16);max-width:290px;cursor:pointer;animation:bdSlide 0.5s cubic-bezier(.175,.885,.32,1.275);}
@keyframes bdSlide{from{transform:translateX(130%);opacity:0}to{transform:translateX(0);opacity:1}}
.bday-badge h4{font-family:'Playfair Display',serif;color:var(--text);font-size:.92rem;margin-bottom:3px;}
.bday-badge p{font-size:.74rem;color:var(--strong);line-height:1.5;}
.bday-badge-x{position:absolute;top:7px;right:10px;background:none;border:none;font-size:1rem;cursor:pointer;color:var(--border);}

/* ‚îÄ‚îÄ QR en recibo ‚îÄ‚îÄ */
.recibo-qr-wrap{text-align:center;margin:10px 0 4px;}
.recibo-qr-wrap canvas{border-radius:8px;border:1px solid var(--bg);}
.recibo-qr-wrap p{font-size:.67rem;color:var(--border);margin-top:4px;}

/* ‚îÄ‚îÄ MODAL PACIENTE (ver/editar) ‚îÄ‚îÄ */
.pac-modal-overlay{display:none;position:fixed;inset:0;background:rgba(100,48,0,0.22);z-index:600;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.pac-modal-overlay.open{display:flex;}
.pac-modal{background:#fff;border-radius:22px;border:1.5px solid var(--border);max-width:680px;width:94%;max-height:90vh;overflow-y:auto;padding:28px;}
.pac-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.pac-modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--border);}
.pac-modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--strong);}

/* ‚îÄ‚îÄ HISTORIAL PACIENTE ‚îÄ‚îÄ */
.pac-historia-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;}
.pac-hist-btn{padding:5px 14px;border-radius:14px;border:1.5px solid var(--border);background:transparent;color:var(--text);font-family:'Lato',sans-serif;font-size:.75rem;cursor:pointer;transition:all .2s;}
.pac-hist-btn.active,.pac-hist-btn:hover{background:var(--border);color:#fff;}
.pac-hist-section{display:none;}.pac-hist-section.active{display:block;}
.hist-item{background:var(--soft);border-left:3px solid var(--border);border-radius:0 10px 10px 0;padding:10px 14px;margin-bottom:8px;}
.hist-item h5{font-size:.88rem;color:var(--text);font-weight:700;}
.hist-item p{font-size:.77rem;color:var(--strong);margin-top:2px;}
.hist-item.cancelada{border-left-color:#e57373;background:#fdecea;}

/* ‚îÄ‚îÄ DISTORCIONES COGNITIVAS ‚îÄ‚îÄ */
.dc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-top:10px;}
.dc-item{background:var(--soft);border:1.5px solid var(--bg);border-radius:12px;padding:12px;cursor:pointer;transition:all .2s;position:relative;}
.dc-item:hover{border-color:var(--border);}
.dc-item.selected{border-color:var(--border);background:var(--bg);}
.dc-item.selected::after{content:'‚úì';position:absolute;top:6px;right:8px;color:var(--strong);font-weight:700;font-size:.9rem;}
.dc-name{font-weight:700;font-size:.82rem;color:var(--text);margin-bottom:3px;}
.dc-desc{font-size:.73rem;color:var(--strong);line-height:1.4;}
.dc-nivel{display:flex;gap:5px;margin-top:6px;}
.dc-nivel button,.dc-nivel-btn{padding:2px 8px;border-radius:10px;border:1.5px solid var(--bg);background:white;font-size:.72rem;cursor:pointer;transition:all .2s;}
.dc-nivel button.sel,.dc-nivel-btn.sel{background:var(--border);color:#fff;border-color:var(--border);}

/* ‚îÄ‚îÄ CIE-11 SUGERENCIAS ‚îÄ‚îÄ */
.cie-suggestions{position:absolute;z-index:200;background:#fff;border:1.5px solid var(--border);border-radius:10px;max-height:220px;overflow-y:auto;box-shadow:0 4px 18px rgba(100,48,0,.12);width:100%;}
.cie-item{padding:9px 14px;cursor:pointer;font-size:.85rem;border-bottom:1px solid var(--bg);transition:background .15s;}
.cie-item:hover{background:var(--soft);}
.cie-item .cie-code{font-weight:700;color:var(--border);margin-right:8px;font-size:.78rem;}
.cie-wrap{position:relative;}

/* ‚îÄ‚îÄ CANCELACIONES ‚îÄ‚îÄ */
.cancel-badge{display:inline-block;background:#fdecea;color:#c62828;border-radius:10px;font-size:.68rem;padding:2px 8px;margin-left:6px;font-weight:700;}

/* ‚îÄ‚îÄ SESI√ìN DETALLE ‚îÄ‚îÄ */
.ses-detail-overlay{display:none;position:fixed;inset:0;background:rgba(100,48,0,.22);z-index:650;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.ses-detail-overlay.open{display:flex;}
.ses-detail-modal{background:#fff;border-radius:22px;border:1.5px solid var(--border);max-width:600px;width:94%;max-height:88vh;overflow-y:auto;padding:28px;}

/* ‚îÄ‚îÄ IMAGEN RECORDATORIO CITA ‚îÄ‚îÄ */
.cita-img-overlay{display:none;position:fixed;inset:0;background:rgba(100,48,0,0.32);z-index:10001;align-items:center;justify-content:center;backdrop-filter:blur(5px);}
.cita-img-overlay.open{display:flex;animation:bdFadeIn 0.3s ease;}
.cita-img-modal{background:#fff;border-radius:24px;border:2px solid var(--border);max-width:480px;width:94%;overflow:hidden;box-shadow:0 20px 60px rgba(100,48,0,0.2);animation:bdPop 0.4s cubic-bezier(.175,.885,.32,1.275);}
.cita-img-canvas-wrap canvas{width:100%;display:block;}
.cita-img-footer{padding:14px 18px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.btn-cita-dl{background:var(--border);color:#fff;border:none;border-radius:20px;padding:8px 15px;font-family:'Lato',sans-serif;font-size:.8rem;cursor:pointer;}
.btn-cita-wa{background:#25D366;color:#fff;border:none;border-radius:20px;padding:8px 15px;font-family:'Lato',sans-serif;font-size:.8rem;cursor:pointer;}
.btn-cita-close{background:transparent;color:var(--text);border:1.5px solid var(--border);border-radius:20px;padding:8px 15px;font-family:'Lato',sans-serif;font-size:.8rem;cursor:pointer;}

/* MODAL */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(100,48,0,0.18); z-index: 500; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: #fff; border-radius: 20px; padding: 28px; max-width: 480px; width: 90%; border: 1.5px solid var(--border); }
.modal h3 { font-family: 'Playfair Display', serif; color: var(--border); margin-bottom: 16px; }

/* PROGRESS */
.progress-wrap { background: var(--bg); border-radius: 10px; height: 6px; margin-bottom: 4px; overflow: hidden; }
.progress-bar { background: var(--border); height: 100%; border-radius: 10px; transition: width 0.4s; }
.progress-label { font-size: 0.72rem; color: var(--border); text-align: right; margin-bottom: 18px; }

/* FASE TABLE */
.fase-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.fase-table th { background: var(--bg); color: var(--text); font-size: 0.76rem; text-transform: uppercase; letter-spacing: 0.5px; padding: 9px 11px; text-align: left; border: 1px solid var(--border); }
.fase-table td { padding: 9px 11px; border: 1px solid #f0d8de; font-size: 0.84rem; vertical-align: top; }
.fase-table tr:nth-child(even) td { background: #fdf0f3; }
.fase-table input, .fase-table textarea { border: 1px solid #e8d0d6; border-radius: 6px; padding: 5px 8px; font-size: 0.82rem; background: white; width: 100%; }
.fase-table textarea { min-height: 50px; }

/* STAT CARDS */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 14px; margin-bottom: 20px; }
.stat-card { background: #fff; border: 1.5px solid var(--bg); border-radius: 14px; padding: 16px; text-align: center; }
.stat-card .num { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--border); }
.stat-card .lbl2 { font-size: 0.72rem; color: var(--strong); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

/* ‚îÄ‚îÄ DOCUMENTOS ‚îÄ‚îÄ */
.doc-tipos { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:14px; margin-bottom:28px; }
.doc-tipo-btn { background:#fff; border:2px solid var(--bg); border-radius:16px; padding:18px 16px; cursor:pointer; text-align:left; transition:all 0.2s; }
.doc-tipo-btn:hover { border-color:var(--border); box-shadow:0 4px 16px rgba(205,142,157,0.2); }
.doc-tipo-btn.selected { border-color:var(--border); background:var(--soft); }
.doc-tipo-btn .dt-icon { font-size:1.6rem; margin-bottom:8px; }
.doc-tipo-btn .dt-nombre { font-weight:700; font-size:.88rem; color:var(--text); margin-bottom:3px; }
.doc-tipo-btn .dt-desc { font-size:.72rem; color:var(--strong); line-height:1.5; }
.doc-form { background:#fff; border:1.5px solid var(--bg); border-radius:16px; padding:24px; margin-bottom:18px; }
.doc-form-title { font-family:'Playfair Display',serif; font-size:1rem; color:var(--border); margin-bottom:18px; border-bottom:1px solid var(--bg); padding-bottom:10px; }
.doc-field-group { margin-bottom:16px; }
.doc-field-group .lbl { display:block; font-size:.72rem; font-weight:700; color:var(--strong); text-transform:uppercase; letter-spacing:.4px; margin-bottom:5px; }
.doc-field-group textarea { width:100%; border:1.5px solid #e8d0d6; border-radius:10px; padding:10px 13px; font-family:'Lato',sans-serif; font-size:.88rem; color:var(--text); resize:vertical; min-height:80px; }
.doc-field-group input, .doc-field-group select { width:100%; border:1.5px solid #e8d0d6; border-radius:10px; padding:9px 13px; font-family:'Lato',sans-serif; font-size:.88rem; color:var(--text); }
.doc-field-group textarea:focus, .doc-field-group input:focus, .doc-field-group select:focus { outline:none; border-color:var(--border); }
.doc-preview { background:var(--soft); border:1.5px solid var(--border); border-radius:14px; padding:22px; font-size:.88rem; line-height:1.8; color:var(--text); margin-top:16px; white-space:pre-wrap; font-family:'Georgia',serif; }
.doc-preview h3 { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--border); text-align:center; margin-bottom:6px; }
.doc-preview .firma-preview { margin-top:32px; border-top:1px solid var(--border); padding-top:16px; font-size:.82rem; }

.fin-screen { display:none; }
.fin-screen.active { display:block; }
.fin-tab-nav { display:flex; gap:0; border-bottom:1.5px solid var(--border); margin-bottom:24px; background:#fff; border-radius:14px 14px 0 0; overflow:hidden; }
.fin-tab { padding:12px 20px; font-size:0.78rem; font-weight:500; letter-spacing:0.08em; text-transform:uppercase; color:var(--border); cursor:pointer; border:none; background:none; border-bottom:3px solid transparent; margin-bottom:-1.5px; transition:all 0.2s; }
.fin-tab.active { color:var(--text); border-bottom-color:var(--text); background:var(--soft); }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:14px; margin-bottom:20px; }
.stat-card-fin { background:#fff; border:1.5px solid var(--bg); border-radius:14px; padding:16px; }
.stat-card-fin.verde { border-left:4px solid #6aaa6a; }
.stat-card-fin.rojo { border-left:4px solid #e57373; }
.stat-card-fin.rosa { border-left:4px solid var(--border); }
.stat-label { font-size:0.72rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--strong); margin-bottom:6px; }
.stat-value { font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--text); }
.stat-sub { font-size:0.72rem; color:var(--border); margin-top:3px; }
.form-card { background:#fff; border:1.5px solid var(--bg); border-radius:16px; padding:22px; margin-bottom:18px; }
.form-title { font-family:'Playfair Display',serif; font-size:1rem; color:var(--border); margin-bottom:16px; }
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.field { display:flex; flex-direction:column; gap:5px; }
.field label { font-size:0.72rem; font-weight:700; color:var(--strong); text-transform:uppercase; letter-spacing:0.4px; }
.field input, .field select { border:1.5px solid #e8d0d6; border-radius:10px; padding:9px 13px; font-family:'Lato',sans-serif; font-size:0.88rem; color:var(--text); background:var(--white); }
.field input:focus, .field select:focus { outline:none; border-color:var(--border); }
.pago-item { display:flex; align-items:center; gap:12px; background:#fff; border:1.5px solid var(--bg); border-radius:12px; padding:14px 16px; margin-bottom:10px; }
.pago-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.pago-dot.ingreso { background:#6aaa6a; }
.pago-dot.gasto { background:#e57373; }
.pago-info { flex:1; }
.pago-nombre { font-size:0.9rem; font-weight:600; color:var(--text); }
.pago-meta { font-size:0.75rem; color:var(--strong); margin-top:2px; }
.pago-monto { font-family:'Playfair Display',serif; font-size:1rem; font-weight:600; white-space:nowrap; }
.pago-monto.ingreso { color:#6aaa6a; }
.pago-monto.gasto { color:#e57373; }
.pago-actions { display:flex; gap:6px; }
.icon-btn { background:none; border:1.5px solid var(--bg); border-radius:8px; width:30px; height:30px; cursor:pointer; font-size:0.85rem; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.icon-btn:hover { background:var(--bg); }
.icon-btn.btn-danger:hover { background:#fdecea; border-color:#e57373; }
.metodo-badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:0.68rem; font-weight:600; background:var(--bg); color:var(--strong); margin-left:4px; }
.deudor-item { display:flex; align-items:center; justify-content:space-between; background:#fff; border:1.5px solid var(--bg); border-radius:12px; padding:14px 18px; margin-bottom:10px; }
.deudor-nombre { font-weight:700; font-size:0.9rem; }
.deudor-monto { font-family:'Playfair Display',serif; font-size:1.1rem; color:#e57373; }
.mes-nav { display:flex; align-items:center; gap:12px; margin-bottom:20px; }
.mes-nav h2 { font-family:'Playfair Display',serif; font-size:1.3rem; font-weight:400; flex:1; text-transform:capitalize; }
.arrow { width:34px; height:34px; border-radius:50%; border:1.5px solid var(--border); background:white; cursor:pointer; font-size:1.1rem; transition:background 0.2s; }
.arrow:hover { background:var(--bg); }
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(100,48,0,0.2); z-index:500; align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:#fff; border-radius:20px; padding:28px; max-width:420px; width:90%; border:1.5px solid var(--border); }
.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
.modal-title { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--border); }
.modal-close { background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--strong); }
.recibo { background:var(--soft); border-radius:12px; padding:18px; margin-bottom:18px; }
.recibo-logo { text-align:center; margin-bottom:12px; }
.recibo-logo p { font-family:'Playfair Display',serif; font-size:1rem; color:var(--text); }
.recibo-logo small { font-size:0.72rem; color:var(--border); }
.recibo-divider { border:none; border-top:1px solid var(--border); margin:10px 0; }
.recibo-fila { display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:6px; }
.recibo-total { display:flex; justify-content:space-between; font-size:1rem; font-weight:700; color:var(--text); margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
.btn-wa { background:#25D366; color:white; border:none; border-radius:20px; padding:9px 18px; font-family:'Lato',sans-serif; font-size:0.83rem; cursor:pointer; display:flex; align-items:center; gap:7px; }
.btn-wa svg { width:16px; height:16px; fill:white; }
.btn-secondary-fin { background:white; color:var(--text); border:1.5px solid var(--border); border-radius:20px; padding:9px 18px; font-family:'Lato',sans-serif; font-size:0.83rem; cursor:pointer; }

/* ‚îÄ‚îÄ AGENDA ‚îÄ‚îÄ */
.ag-tab-nav { display:flex; gap:0; border-bottom:1.5px solid var(--border); margin-bottom:24px; background:#fff; border-radius:14px 14px 0 0; overflow:hidden; }
.ag-tab { padding:12px 20px; font-size:0.78rem; font-weight:500; letter-spacing:0.08em; text-transform:uppercase; color:var(--border); cursor:pointer; border:none; background:none; border-bottom:3px solid transparent; margin-bottom:-1.5px; transition:all 0.2s; }
.ag-tab.active { color:var(--text); border-bottom-color:var(--text); background:var(--soft); }
.cita-card { background:white; border:1.5px solid var(--border); border-radius:14px; padding:18px 22px; margin-bottom:12px; position:relative; overflow:hidden; transition:box-shadow 0.2s; }
.cita-card:hover { box-shadow:0 4px 18px rgba(205,142,157,0.2); }
.cita-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background:var(--border); border-radius:14px 0 0 14px; }
.cita-hora { font-size:0.75rem; font-weight:500; letter-spacing:0.1em; text-transform:uppercase; color:var(--border); margin-bottom:4px; }
.cita-nombre { font-family:'Playfair Display',serif; font-size:1.15rem; font-weight:600; margin-bottom:2px; }
.cita-desc { font-size:0.82rem; color:var(--strong); margin-bottom:10px; }
.ag-tag { display:inline-block; padding:3px 10px; border-radius:20px; font-size:0.7rem; font-weight:600; letter-spacing:0.05em; margin-bottom:8px; }
.ag-tag.virtual { background:#e8f0fe; color:#3b5bdb; }
.ag-tag.presencial { background:#e8f5e9; color:#2e7d32; }
.ag-tag.admin { background:#fff3e0; color:#e65100; }
.wa-box { background:var(--soft); border:1.5px solid var(--border); border-radius:12px; padding:14px 16px; font-size:0.87rem; line-height:1.65; position:relative; margin-top:10px; display:none; }
.wa-box.show { display:block; }
.wa-texto { display:block; white-space:pre-line; padding-right:70px; }
.copy-badge { position:absolute; top:10px; right:12px; background:var(--border); color:white; border:none; border-radius:20px; padding:4px 14px; font-size:0.72rem; cursor:pointer; font-family:'Lato',sans-serif; transition:all 0.2s; }
.copy-badge.copied { background:#7ab87a; }
.dia-label { font-size:0.75rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--border); padding-left:4px; margin-bottom:8px; margin-top:18px; }
.ag-empty { text-align:center; padding:48px 20px; color:var(--border); }
.ag-empty .emoji { font-size:2.2rem; margin-bottom:10px; }

  #sidebar { width: 200px; }
  #main { margin-left: 200px; padding: 16px; }
  .col2, .col3 { grid-template-columns: 1fr; }
}
@media(max-width: 560px) {
  #sidebar { position: static; width: 100%; min-height: auto; border-right: none; border-bottom: 2px solid var(--border); }
  #sidebar nav { display: flex; flex-wrap: wrap; padding: 8px; }
  .nav-section { display: none; }
  .nav-btn { width: auto; padding: 7px 12px; font-size: 0.75rem; }
  #main { margin-left: 0; }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="logo-area">
    <img id="logo-img" src="" alt="Logo">
    <h2>Luisa Fernanda Garc√©s Garc√≠a</h2>
    <p>Psic√≥loga ¬∑ TP 174366</p>
  </div>
  <nav>
    <div class="nav-section">Principal</div>
    <button class="nav-btn active" onclick="goPage('dashboard')"><span class="icon">üè†</span> Inicio</button>
    <button class="nav-btn" onclick="goPage('pacientes')"><span class="icon">üë§</span> Pacientes</button>

    <div class="nav-section">Cl√≠nico</div>
    <button class="nav-btn" onclick="goPage('anamnesis')"><span class="icon">üìã</span> Anamnesis</button>
    <button class="nav-btn" onclick="goPage('plan')"><span class="icon">üó∫Ô∏è</span> Plan de Tratamiento</button>
    <button class="nav-btn" onclick="goPage('sesiones')"><span class="icon">üìù</span> Notas de Sesi√≥n</button>

    <div class="nav-section">Evaluaci√≥n</div>
    <button class="nav-btn" onclick="goPage('tests')"><span class="icon">üß™</span> Tests</button>
    <button class="nav-btn" onclick="goPage('seguimiento')"><span class="icon">üìä</span> Seguimiento</button>

    <div class="nav-section">Gesti√≥n</div>
    <button class="nav-btn" onclick="goPage('agenda')"><span class="icon">üìÖ</span> Agenda</button>
    <button class="nav-btn" onclick="goPage('finanzas')"><span class="icon">üí∞</span> Finanzas</button>
    <button class="nav-btn" onclick="goPage('documentos')"><span class="icon">üìÑ</span> Documentos</button>
    <button class="nav-btn" onclick="goPage('herramientas')"><span class="icon">üîß</span> Herramientas TCC</button>
    <button class="nav-btn" onclick="goPage('cumpleanos')"><span class="icon">üéÇ</span> Cumplea√±os</button>
  </nav>
  <div class="version">
    <div style="margin-bottom:8px;font-size:0.65rem;color:var(--border)">Suite Cl√≠nica v1.0 ¬∑ 2025</div>
    <button id="sync-btn" onclick="sincronizarAhora()">üîÑ Sincronizar</button>
    <button class="btn" onclick="exportarJSON()" style="width:100%;margin-bottom:6px;font-size:0.72rem;padding:7px 10px">‚¨áÔ∏è Exportar respaldo</button>
    <button class="btn" onclick="document.getElementById('import-input').click()" style="width:100%;font-size:0.72rem;padding:7px 10px">‚¨ÜÔ∏è Importar respaldo</button>
    <input type="file" id="import-input" accept=".json" style="display:none" onchange="importarJSON(event)">
  </div>
</aside>

<!-- MAIN -->
<main id="main">

<!-- ========== DASHBOARD ========== -->
<div class="page active" id="page-dashboard">
  <div class="page-header">
    <h1>Bienvenida, Luisa Fernanda üå∏</h1>
    <p>Resumen general de tu pr√°ctica cl√≠nica</p>
  </div>
  <div class="stat-grid" id="dash-stats"></div>
  <div id="dash-bday-widget"></div>
  <div class="card">
    <div class="sec-title">Pacientes Recientes</div>
    <div id="dash-recent-patients"></div>
  </div>
  <div class="card">
    <div class="sec-title">√öltimas Sesiones</div>
    <div id="dash-recent-sessions"></div>
  </div>
</div>

<!-- ========== PACIENTES ========== -->
<div class="page" id="page-pacientes">
  <div class="page-header">
    <h1>Gesti√≥n de Pacientes</h1>
    <p>Crea y administra los expedientes de tus pacientes</p>
  </div>
  <div class="card">
    <div class="sec-title">Nuevo Paciente</div>
    <div class="row col3">
      <div class="fg"><label class="lbl">Nombre completo *</label><input type="text" id="np-nombre"></div>
      <div class="fg"><label class="lbl">Fecha de nacimiento</label><input type="date" id="np-fnac"></div>
      <div class="fg"><label class="lbl">G√©nero</label><select id="np-genero"><option value="">‚Äî</option><option>Femenino</option><option>Masculino</option><option>No binario</option><option>Prefiero no decir</option></select></div>
    </div>
    <div class="row col3">
      <div class="fg"><label class="lbl">Tel√©fono</label><input type="tel" id="np-tel"></div>
      <div class="fg"><label class="lbl">Email</label><input type="email" id="np-email"></div>
      <div class="fg"><label class="lbl">Ocupaci√≥n</label><input type="text" id="np-ocup"></div>
    </div>
    <div class="row col3">
      <div class="fg"><label class="lbl">C√©dula / ID</label><input type="text" id="np-cc"></div>
      <div class="fg"><label class="lbl">Contacto emergencia</label><input type="text" id="np-emerg-nombre" placeholder="Nombre"></div>
      <div class="fg"><label class="lbl">Parentesco</label>
        <select id="np-emerg-parentesco">
          <option value="">‚Äî</option>
          <option>Madre</option><option>Padre</option><option>Pareja</option>
          <option>Esposo/a</option><option>Hijo/a</option><option>Hermano/a</option>
          <option>Abuel@</option><option>T√≠o/a</option><option>Amigo/a cercano</option>
          <option>Compa√±ero/a de trabajo</option><option>Otro familiar</option>
        </select>
      </div>
    </div>
    <div class="row col2">
      <div class="fg"><label class="lbl">Tel√©fono emergencia</label><input type="tel" id="np-emerg-tel"></div>
      <div class="fg"><label class="lbl">Diagn√≥stico inicial (CIE-11)</label>
        <div class="cie-wrap">
          <input type="text" id="np-dx" placeholder="Escribe para buscar..." autocomplete="off" oninput="buscarCIE(this,'np-dx-sugg')">
          <div class="cie-suggestions" id="np-dx-sugg" style="display:none"></div>
        </div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn primary" onclick="crearPaciente()">+ Crear Paciente</button>
    </div>
  </div>
  <div class="card">
    <div class="sec-title">Pacientes Registrados</div>
    <div id="filtro-pacientes" style="margin-bottom:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <input type="text" id="buscar-pac" placeholder="üîç Buscar paciente..." style="border:1.5px solid #e8d0d6;border-radius:10px;padding:7px 12px;font-size:.87rem;width:220px" oninput="renderPacientes()">
    </div>
    <div class="patient-grid" id="lista-pacientes"></div>
  </div>
</div>

<!-- ========== ANAMNESIS ========== -->
<div class="page" id="page-anamnesis">
  <div class="page-header">
    <h1>Anamnesis</h1>
    <p>Historia cl√≠nica completa del paciente</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="an-sel-pac" onchange="loadAnamnesis()"></select>
    <button class="btn primary" onclick="guardarAnamnesis()">üíæ Guardar</button>
    <button class="btn" onclick="exportarAnamnesis()">‚¨áÔ∏è Exportar RTF</button>
  </div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('an','datos')">I. Datos Personales</button>
    <button class="tab-btn" onclick="switchTab('an','motivo')">II. Motivo Consulta</button>
    <button class="tab-btn" onclick="switchTab('an','historia')">III. Historia Cl√≠nica</button>
    <button class="tab-btn" onclick="switchTab('an','cogcond')">IV. Evaluaci√≥n</button>
    <button class="tab-btn" onclick="switchTab('an','sustancias')">V. Sustancias</button>
    <button class="tab-btn" onclick="switchTab('an','alimentaria')">VI. Alimentaria</button>
    <button class="tab-btn" onclick="switchTab('an','sueno')">VII. Sue√±o</button>
    <button class="tab-btn" onclick="switchTab('an','trauma')">VIII. Trauma</button>
    <button class="tab-btn" onclick="switchTab('an','social')">IX. Red Social</button>
    <button class="tab-btn" onclick="switchTab('an','metas')">X. Metas</button>
  </div>

  <!-- I. DATOS -->
  <div class="tab-content active" id="an-datos">
    <div class="card">
      <div class="sec-title">I. Datos Personales</div>
      <div style="background:var(--soft);border:1.5px solid var(--bg);border-radius:12px;padding:16px 20px;margin-bottom:18px;display:flex;align-items:center;gap:12px">
        <span style="font-size:1.6rem">üë§</span>
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--text)" id="an-pac-nombre-disp">‚Äî</div>
          <div style="font-size:0.75rem;color:var(--strong);margin-top:3px" id="an-pac-meta-disp">‚Äî</div>
          <div style="font-size:0.72rem;color:var(--border);margin-top:2px">Datos tomados del perfil del paciente ¬∑ <a href="#" onclick="goPageDirect('pacientes');return false;" style="color:var(--border)">Editar en Pacientes ‚Üí</a></div>
        </div>
      </div>
      <div class="row col2">
        <div class="fg"><label class="lbl">Fecha de consulta</label><input type="date" id="an-fecha"></div>
        <div class="fg"><label class="lbl">Estado civil</label><select id="an-estado"><option value="">‚Äî</option><option>Soltero/a</option><option>Casado/a</option><option>Uni√≥n libre</option><option>Divorciado/a</option><option>Viudo/a</option></select></div>
      </div>
      <div class="row col3">
        <div class="fg"><label class="lbl">Nivel educativo</label><select id="an-edu"><option value="">‚Äî</option><option>Primaria</option><option>Secundaria</option><option>T√©cnico</option><option>Universitario</option><option>Posgrado</option></select></div>
        <div class="fg"><label class="lbl">Estrato</label><select id="an-estrato"><option value="">‚Äî</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
        <div class="fg"><label class="lbl">Ciudad</label><input type="text" id="an-ciudad"></div>
      </div>
      <div class="row col2"><div class="fg"><label class="lbl">Contacto de emergencia</label><input type="text" id="an-emergN" placeholder="Nombre"></div><div class="fg"><label class="lbl">Parentesco</label>
        <select id="an-emergParent">
          <option value="">‚Äî</option>
          <option>Madre</option><option>Padre</option><option>Pareja</option><option>Esposo/a</option>
          <option>Hijo/a</option><option>Hermano/a</option><option>Abuel@</option><option>T√≠o/a</option>
          <option>Amigo/a cercano</option><option>Compa√±ero/a de trabajo</option><option>Otro familiar</option>
        </select>
      </div></div>
      <div class="row col2"><div class="fg"><label class="lbl">Tel√©fono emergencia</label><input type="tel" id="an-emergT"></div><div class="fg"></div></div>
      <div class="fg"><label class="lbl">Modalidad de atenci√≥n</label>
        <div class="checks">
          <label class="chk"><input type="radio" name="an-modalidad" value="Presencial"> Presencial</label>
          <label class="chk"><input type="radio" name="an-modalidad" value="Virtual"> Virtual</label>
          <label class="chk"><input type="radio" name="an-modalidad" value="Mixta"> Mixta</label>
        </div>
      </div>
    </div>
  </div>

  <!-- II. MOTIVO -->
  <div class="tab-content" id="an-motivo">
    <div class="card">
      <div class="sec-title">II. Motivo de Consulta</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Motivo principal (en palabras del paciente)</label><textarea id="an-motivo"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">¬øPor qu√© consultar ahora?</label><textarea id="an-decision"></textarea></div>
      <div class="row col2"><div class="fg"><label class="lbl">Duraci√≥n del problema</label><input type="text" id="an-duracion" placeholder="Ej: 6 meses"></div><div class="fg"><label class="lbl">Intentos previos de soluci√≥n</label><input type="text" id="an-intentos"></div></div>
      <div class="fg"><label class="lbl">Intensidad percibida (1‚Äì10)</label>
        <div class="range-row">
          <input type="range" id="an-intensidad" min="1" max="10" value="5" oninput="document.getElementById('an-ival').textContent=this.value">
          <div class="rval" id="an-ival">5</div>
        </div>
      </div>
    </div>
  </div>

  <!-- III. HISTORIA -->
  <div class="tab-content" id="an-historia">
    <div class="card">
      <div class="sec-title">III. Historia Cl√≠nica</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Diagn√≥sticos previos</label><textarea id="an-dx"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Tratamientos anteriores</label><textarea id="an-ttoPrev"></textarea></div>
      <div class="row col2"><div class="fg"><label class="lbl">Hospitalizaciones</label><select id="an-hosp"><option>No</option><option>S√≠</option></select></div><div class="fg"><label class="lbl">Detalles hospitalizaciones</label><input type="text" id="an-hospD"></div></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Medicaci√≥n actual</label><textarea id="an-med" placeholder="Nombre, dosis, prescriptor"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Historia del desarrollo</label><textarea id="an-desarrollo"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Antecedentes familiares de salud mental</label><textarea id="an-famMental"></textarea></div>
      <div class="fg"><label class="lbl">Relaci√≥n familiar actual</label><textarea id="an-relFam"></textarea></div>
    </div>
  </div>

  <!-- IV. EVALUACI√ìN -->
  <div class="tab-content" id="an-cogcond">
    <div class="card">
      <div class="sec-title">IV. Evaluaci√≥n Cognitivo-Conductual-Emocional</div>
      <div class="subsec">A. √Årea Cognitiva</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Pensamientos autom√°ticos</label><textarea id="an-pens"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Creencias nucleares</label><textarea id="an-creencias"></textarea></div>
      <div class="subsec">B. √Årea Conductual</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Conductas problema</label><textarea id="an-conductas"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Actividades placenteras</label><textarea id="an-placer"></textarea></div>
      <div class="subsec">C. √Årea Emocional</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Emoci√≥n predominante</label><input type="text" id="an-emociones"></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">S√≠ntomas f√≠sicos</label><textarea id="an-sinFis"></textarea></div>
      <div class="fg"><label class="lbl">Factores de mantenimiento</label><textarea id="an-mant"></textarea></div>
      <div class="subsec" style="margin-top:22px">D. Distorsiones Cognitivas e Ideas Irracionales</div>
      <p style="font-size:.8rem;color:var(--strong);margin-bottom:10px">Haz clic en las distorsiones identificadas. Luego indica la intensidad.</p>
      <div class="dc-grid" id="dc-grid"></div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn" style="font-size:.74rem;padding:4px 11px;background:#f5eaec;color:var(--strong);border-color:var(--bg)" onclick="dcGrupoNoAplica('dc')">‚Äî No aplica (Distorsiones)</button>
        <button class="btn" style="font-size:.74rem;padding:4px 11px;background:#f5eaec;color:var(--strong);border-color:var(--bg)" onclick="dcGrupoNoAplica('cn')">‚Äî No aplica (Creencias nucleares)</button>
        <button class="btn" style="font-size:.74rem;padding:4px 11px;background:#f5eaec;color:var(--strong);border-color:var(--bg)" onclick="dcGrupoNoAplica('ci')">‚Äî No aplica (Creencias intermedias)</button>
        <button class="btn" style="font-size:.74rem;padding:4px 11px" onclick="dcLimpiarTodo()">‚úï Limpiar</button>
      </div>
      <div class="fg" style="margin-top:12px"><label class="lbl">Observaciones sobre distorsiones</label><textarea id="an-dc-obs" placeholder="Notas adicionales sobre las distorsiones identificadas..."></textarea></div>
    </div>
  </div>

  <!-- V. SUSTANCIAS -->
  <div class="tab-content" id="an-sustancias">
    <div class="card">
      <div class="sec-title">V. Consumo de Sustancias</div>
      <div class="row col2"><div class="fg"><label class="lbl">Alcohol</label><select id="an-salc"><option>No</option><option>Ocasional</option><option>Frecuente</option><option>Dependencia</option></select></div><div class="fg"><label class="lbl">Detalle alcohol</label><input type="text" id="an-salcD"></div></div>
      <div class="row col2"><div class="fg"><label class="lbl">Tabaco</label><select id="an-stab"><option>No</option><option>Ocasional</option><option>Frecuente</option><option>Dependencia</option></select></div><div class="fg"><label class="lbl">Detalle tabaco</label><input type="text" id="an-stabD"></div></div>
      <div class="row col2"><div class="fg"><label class="lbl">Cannabis</label><select id="an-scan"><option>No</option><option>Ocasional</option><option>Frecuente</option><option>Dependencia</option></select></div><div class="fg"><label class="lbl">Detalle cannabis</label><input type="text" id="an-scanD"></div></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Otras sustancias</label><textarea id="an-sotras"></textarea></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Observaciones generales</label><textarea id="an-sobs"></textarea></div>
    </div>
  </div>

  <!-- VI. ALIMENTARIA -->
  <div class="tab-content" id="an-alimentaria">
    <div class="card">
      <div class="sec-title">VI. Conducta Alimentaria</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Conductas de riesgo alimentario</label><textarea id="an-alCond"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Imagen corporal percibida</label><textarea id="an-alImag"></textarea></div>
      <div class="row col2"><div class="fg"><label class="lbl">Peso / Talla</label><input type="text" id="an-alPeso"></div><div class="fg"><label class="lbl">Relaci√≥n emocional con la comida</label><input type="text" id="an-alEmoc"></div></div>
    </div>
  </div>

  <!-- VII. SUE√ëO -->
  <div class="tab-content" id="an-sueno">
    <div class="card">
      <div class="sec-title">VII. H√°bitos de Sue√±o</div>
      <div class="row col2"><div class="fg"><label class="lbl">Calidad del sue√±o</label><select id="an-suCal"><option>‚Äî</option><option>Buena</option><option>Regular</option><option>Mala</option><option>Muy mala</option></select></div><div class="fg"><label class="lbl">Horas promedio</label><input type="number" id="an-suHoras" min="0" max="24"></div></div>
      <div class="row col2"><div class="fg"><label class="lbl">Hora de acostarse</label><input type="text" id="an-suAcost" placeholder="Ej: 11pm"></div><div class="fg"><label class="lbl">Hora de levantarse</label><input type="text" id="an-suLev" placeholder="Ej: 7am"></div></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Alteraciones del sue√±o</label><textarea id="an-suAlter" placeholder="Insomnio, pesadillas, apnea..."></textarea></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Observaciones</label><textarea id="an-suObs"></textarea></div>
    </div>
  </div>

  <!-- VIII. TRAUMA -->
  <div class="tab-content" id="an-trauma">
    <div class="card">
      <div class="sec-title">VIII. Historia de Trauma</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Eventos referidos</label><textarea id="an-trEv"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Descripci√≥n del impacto</label><textarea id="an-trImp"></textarea></div>
      <div class="fg"><label class="lbl">Atenci√≥n previa por trauma</label><textarea id="an-trAten"></textarea></div>
    </div>
  </div>

  <!-- IX. SOCIAL -->
  <div class="tab-content" id="an-social">
    <div class="card">
      <div class="sec-title">IX. Red de Apoyo Social</div>
      <div class="row col2"><div class="fg"><label class="lbl">Calidad de la red</label><select id="an-raCal"><option>‚Äî</option><option>S√≥lida</option><option>Moderada</option><option>Fr√°gil</option><option>Ausente</option></select></div><div class="fg"><label class="lbl">¬øAislamiento?</label><select id="an-raAis"><option>No</option><option>Leve</option><option>Moderado</option><option>Severo</option></select></div></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Personas de confianza</label><textarea id="an-raPers"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Calidad de relaciones interpersonales</label><textarea id="an-raRel"></textarea></div>
      <div class="fg"><label class="lbl">Apoyo disponible en crisis</label><textarea id="an-raCrisis"></textarea></div>
    </div>
  </div>

  <!-- X. METAS -->
  <div class="tab-content" id="an-metas">
    <div class="card">
      <div class="sec-title">X. Metas y Observaciones Cl√≠nicas</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Meta corto plazo (1 mes)</label><textarea id="an-mCorto"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Meta mediano plazo (3 meses)</label><textarea id="an-mMedio"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Meta largo plazo (6+ meses)</label><textarea id="an-mLargo"></textarea></div>
      <div class="subsec">Observaciones del Terapeuta</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Estilo de afrontamiento</label><textarea id="an-oAfront"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Actitud hacia la terapia</label><textarea id="an-oActit"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Fortalezas detectadas</label><textarea id="an-oFortal"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Factores de riesgo</label><textarea id="an-oRiesgo"></textarea></div>
      <div class="fg"><label class="lbl">Notas adicionales</label><textarea id="an-oNotas"></textarea></div>
    </div>
    <div class="btn-row">
      <button class="btn primary" onclick="guardarAnamnesis()">üíæ Guardar Anamnesis</button>
      <button class="btn" onclick="exportarAnamnesis()">‚¨áÔ∏è Exportar RTF</button>
    </div>
  </div>
</div>

<!-- ========== PLAN DE TRATAMIENTO ========== -->
<div class="page" id="page-plan">
  <div class="page-header">
    <h1>Plan de Tratamiento</h1>
    <p>Dise√±a el plan terap√©utico personalizado</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="pl-sel-pac" onchange="loadPlan()"></select>
  </div>

  <div class="card">
    <div class="sec-title">Informaci√≥n General</div>
    <div class="row col3">
      <div class="fg"><label class="lbl">Fecha de inicio</label><input type="date" id="pl-fecha"></div>
      <div class="fg"><label class="lbl">Modalidad</label><select id="pl-modalidad"><option>Presencial</option><option>Virtual</option><option>Mixta</option></select></div>
      <div class="fg"><label class="lbl">Frecuencia</label><select id="pl-frecuencia"><option>Semanal</option><option>Quincenal</option><option>Mensual</option></select></div>
    </div>
    <div class="fg">
      <label class="lbl">Diagn√≥stico de trabajo (CIE-11 / DSM-5)</label>
      <div class="cie-wrap">
        <textarea id="pl-dx" style="min-height:60px"></textarea>
        <div style="margin-top:5px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <input type="text" id="pl-cie-buscar" placeholder="üîç Buscar c√≥digo CIE-11..." style="border:1.5px solid #e8d0d6;border-radius:8px;padding:6px 11px;font-size:.82rem;width:260px" oninput="buscarCIE(this,'pl-cie-sugg')" autocomplete="off">
          <div class="cie-suggestions" id="pl-cie-sugg" style="display:none;width:280px"></div>
          <span style="font-size:.73rem;color:var(--strong)">‚Üê selecciona c√≥digo y se agrega al diagn√≥stico</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="sec-title">Objetivo General del Proceso</div>
    <div class="fg"><textarea id="pl-objetivo" style="min-height:90px" placeholder="Describe el objetivo terap√©utico central en lenguaje claro para el paciente..."></textarea></div>
  </div>

  <div class="card">
    <div class="sec-title">Fases del Proceso</div>
    <table class="fase-table" id="pl-fases-tabla">
      <thead><tr><th>#</th><th>Fase</th><th>Objetivos</th><th>T√©cnicas</th><th>Semanas</th></tr></thead>
      <tbody id="pl-fases-body">
        <tr><td>1</td><td><input type="text" placeholder="Evaluaci√≥n"></td><td><textarea placeholder="Establecer alianza, evaluar..."></textarea></td><td><textarea placeholder="Entrevista, psicoeducaci√≥n..."></textarea></td><td><input type="text" placeholder="1-3"></td></tr>
        <tr><td>2</td><td><input type="text" placeholder="Intervenci√≥n"></td><td><textarea placeholder="Modificar patrones..."></textarea></td><td><textarea placeholder="Reestructuraci√≥n cognitiva..."></textarea></td><td><input type="text" placeholder="4-10"></td></tr>
        <tr><td>3</td><td><input type="text" placeholder="Mantenimiento"></td><td><textarea placeholder="Consolidar avances..."></textarea></td><td><textarea placeholder="Prevenci√≥n de reca√≠das..."></textarea></td><td><input type="text" placeholder="11-14"></td></tr>
      </tbody>
    </table>
    <button class="btn" style="margin-top:10px" onclick="addFaseRow()">+ Agregar Fase</button>
  </div>

  <div class="card">
    <div class="sec-title">Tareas Intersesi√≥n</div>
    <div class="fg" style="margin-bottom:14px"><label class="lbl">Tareas para casa (semanas 1‚Äì4)</label><textarea id="pl-t1"></textarea></div>
    <div class="fg"><label class="lbl">Tareas para casa (semanas 5+)</label><textarea id="pl-t2"></textarea></div>
  </div>

  <div class="card">
    <div class="sec-title">Recursos y Herramientas</div>
    <div class="row col2">
      <div class="fg"><label class="lbl">Materiales / lecturas</label><textarea id="pl-mat"></textarea></div>
      <div class="fg"><label class="lbl">Apps recomendadas</label><textarea id="pl-apps"></textarea></div>
    </div>
    <div class="fg"><label class="lbl">Contacto de emergencia para el paciente</label><input type="text" id="pl-emerg"></div>
  </div>

  <div class="btn-row">
    <button class="btn primary" onclick="guardarPlan()">&#128190; Guardar Plan</button>
    <button class="btn" onclick="limpiarPlan()" style="background:#f5eaec;color:#a0536a;border:1.5px solid #cd8e9d">&#128465; Nuevo plan</button>
    <button class="btn" onclick="exportarPlanWord()">&#128196; Descargar Word</button>
    <button class="btn primary" onclick="entregablePlan()" style="background:linear-gradient(135deg,#a0536a,#cd8e9d);color:#fff;">&#127800; Entregable para Paciente</button>
  </div>
</div>

<!-- ========== NOTAS DE SESI√ìN ========== -->
<div class="page" id="page-sesiones">
  <div class="page-header">
    <h1>Notas de Sesi√≥n</h1>
    <p>Registra cada sesi√≥n y genera el resumen para el paciente</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="ses-sel-pac" onchange="loadSesiones()"></select>
    <button class="btn primary" onclick="nuevaSesion()">+ Nueva Sesi√≥n</button>
  </div>

  <div style="display:grid; grid-template-columns:260px 1fr; gap:20px">
    <div>
      <div class="card" style="padding:16px">
        <div class="sec-title" style="font-size:0.9rem">Sesiones</div>
        <div id="lista-sesiones"></div>
      </div>
    </div>
    <div id="sesion-form" style="display:none">
      <div class="card">
        <div class="sec-title" id="ses-form-title">Nueva Sesi√≥n</div>
        <!-- DATOS B√ÅSICOS -->
        <div class="row col3">
          <div class="fg"><label class="lbl">Fecha</label><input type="date" id="ses-fecha"></div>
          <div class="fg"><label class="lbl">Sesi√≥n N¬∞</label><input type="number" id="ses-num" min="1" readonly style="background:#f5eaec"></div>
          <div class="fg"><label class="lbl">Duraci√≥n (min)</label><input type="number" id="ses-dur" value="50"></div>
        </div>
        <div class="row col2">
          <div class="fg"><label class="lbl">Tipo de sesi√≥n</label>
            <select id="ses-tipo-sesion" onchange="toggleCancelacion()">
              <option value="sesion">Sesi√≥n de seguimiento</option>
              <option value="evaluacion">Evaluaci√≥n</option>
              <option value="cierre">Cierre terap√©utico</option>
              <option value="cancelacion">Cancelaci√≥n</option>
            </select>
          </div>
          <div class="fg" id="ses-motivo-cancel-wrap" style="display:none">
            <label class="lbl">Motivo de cancelaci√≥n</label>
            <select id="ses-motivo-cancel">
              <option>Enfermedad del paciente</option>
              <option>Imprevisto personal</option>
              <option>Sin aviso</option>
              <option>Reagend√≥</option>
              <option>Solicitud del terapeuta</option>
              <option>Otro</option>
            </select>
          </div>
        </div>

        <!-- I. DATOS CLAVE DE LA SESI√ìN -->
        <div class="subsec" style="margin-top:18px">I. Datos Clave de la Sesi√≥n</div>
        
        <div class="fg" style="margin-bottom:14px"><label class="lbl">Estado emocional al inicio (1‚Äì10)</label>
          <div class="range-row">
            <input type="range" id="ses-estado" min="1" max="10" value="5" oninput="document.getElementById('ses-eval').textContent=this.value">
            <div class="rval" id="ses-eval">5</div>
          </div>
        </div>

        <div class="fg" style="margin-bottom:12px"><label class="lbl">Humor predominante</label>
          <div class="checks" id="ses-humores">
            <label class="chk"><input type="checkbox" name="humor" value="Estable"> Estable</label>
            <label class="chk"><input type="checkbox" name="humor" value="Ansioso/a"> Ansioso/a</label>
            <label class="chk"><input type="checkbox" name="humor" value="Depresivo/a"> Depresivo/a</label>
            <label class="chk"><input type="checkbox" name="humor" value="Irritable"> Irritable</label>
            <label class="chk"><input type="checkbox" name="humor" value="Otro"> Otro</label>
          </div>
        </div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Eventos relevantes desde la √∫ltima sesi√≥n</label><textarea id="ses-eventos" placeholder="¬øQu√© pas√≥ esta semana? Eventos importantes..."></textarea></div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Revisi√≥n de tarea (sesi√≥n anterior)</label>
          <div class="checks" style="margin-bottom:8px">
            <label class="chk"><input type="radio" name="ses-tarea-rev" value="Completa"> ‚úÖ Completa</label>
            <label class="chk"><input type="radio" name="ses-tarea-rev" value="Parcial"> üî∂ Parcial</label>
            <label class="chk"><input type="radio" name="ses-tarea-rev" value="No realizada"> ‚ùå No realizada</label>
            <label class="chk"><input type="radio" name="ses-tarea-rev" value="No aplica"> ‚Äî No aplica</label>
          </div>
          <textarea id="ses-dif-tarea" placeholder="Dificultades encontradas con la tarea..."></textarea>
        </div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Temas trabajados en sesi√≥n</label><textarea id="ses-temas" style="min-height:100px" placeholder="Temas principales abordados..."></textarea></div>

        <!-- II. PROCESO TERAP√âUTICO -->
        <div class="subsec" style="margin-top:4px">II. Proceso Terap√©utico (Foco TCC)</div>

        <div class="fg" style="margin-bottom:12px">
          <label class="lbl">T√©cnicas aplicadas en sesi√≥n</label>
          <div style="margin-top:6px">
            <div style="font-size:.7rem;font-weight:700;color:var(--border);text-transform:uppercase;letter-spacing:1px;margin:8px 0 4px;padding-bottom:3px;border-bottom:1px solid var(--bg)">üß† T√©cnicas Cognitivas</div>
            <div class="checks" id="ses-tecnicas" style="flex-wrap:wrap;gap:6px">
              <label class="chk"><input type="checkbox" name="tecnica" value="Registro de pensamientos autom√°ticos"> Registro PA</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Reestructuraci√≥n cognitiva"> Reestructuraci√≥n cognitiva</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Debate socr√°tico"> Debate socr√°tico</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Flecha descendente"> Flecha descendente</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="B√∫squeda de evidencia"> B√∫squeda de evidencia</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Reatribuci√≥n"> Reatribuci√≥n</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Descatastrofizaci√≥n"> Descatastrofizaci√≥n</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Continuum cognitivo"> Continuum cognitivo</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Ventajas y desventajas"> Ventajas y desventajas</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Reformulaci√≥n alternativa"> Reformulaci√≥n alternativa</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Identificaci√≥n distorsiones"> Identificaci√≥n distorsiones</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Cuestionamiento guiado"> Cuestionamiento guiado</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="T√©cnica del abogado defensor"> Abogado defensor</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Doble est√°ndar"> Doble est√°ndar</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Ensayo cognitivo"> Ensayo cognitivo</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Descentramiento"> Descentramiento</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Silla vac√≠a (cognitiva)"> Silla vac√≠a</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Trabajo creencias nucleares"> Creencias nucleares</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Modificaci√≥n supuestos intermedios"> Supuestos intermedios</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Tarjetas recordatorias"> Tarjetas recordatorias</label>
              <div style="font-size:.7rem;font-weight:700;color:var(--border);text-transform:uppercase;letter-spacing:1px;margin:10px 0 4px;padding-bottom:3px;border-bottom:1px solid var(--bg);width:100%">üìã T√©cnicas Conductuales</div>
              <label class="chk"><input type="checkbox" name="tecnica" value="Activaci√≥n conductual"> Activaci√≥n conductual</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Programaci√≥n de actividades"> Programaci√≥n actividades</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Exposici√≥n en vivo"> Exposici√≥n en vivo</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Exposici√≥n imaginada"> Exposici√≥n imaginada</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Exposici√≥n interoceptiva"> Exposici√≥n interoceptiva</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Prevenci√≥n de respuesta"> Prevenci√≥n de respuesta</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Experimentos conductuales"> Experimentos conductuales</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Modelado"> Modelado</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Ensayo conductual"> Ensayo conductual</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Role playing"> Role playing</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Entrenamiento habilidades sociales"> HH. sociales</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Entrenamiento asertividad"> Asertividad</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Contrato conductual"> Contrato conductual</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Reforzamiento positivo"> Reforzamiento positivo</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Extinci√≥n"> Extinci√≥n</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Autoregistro conductual"> Autoregistro conductual</label>
              <div style="font-size:.7rem;font-weight:700;color:var(--border);text-transform:uppercase;letter-spacing:1px;margin:10px 0 4px;padding-bottom:3px;border-bottom:1px solid var(--bg);width:100%">ü´Å T√©cnicas Fisiol√≥gicas</div>
              <label class="chk"><input type="checkbox" name="tecnica" value="Respiraci√≥n diafragm√°tica"> Respiraci√≥n diafragm√°tica</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Relajaci√≥n muscular progresiva"> Relajaci√≥n progresiva</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Entrenamiento aut√≥geno"> Entrenamiento aut√≥geno</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Visualizaci√≥n guiada"> Visualizaci√≥n guiada</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Biofeedback"> Biofeedback</label>
              <div style="font-size:.7rem;font-weight:700;color:var(--border);text-transform:uppercase;letter-spacing:1px;margin:10px 0 4px;padding-bottom:3px;border-bottom:1px solid var(--bg);width:100%">üíö T√©cnicas Emocionales</div>
              <label class="chk"><input type="checkbox" name="tecnica" value="Exposici√≥n emocional"> Exposici√≥n emocional</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Etiquetado emocional"> Etiquetado emocional</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Regulaci√≥n emocional"> Regulaci√≥n emocional</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Tolerancia al malestar"> Tolerancia al malestar</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Inoculaci√≥n de estr√©s"> Inoculaci√≥n de estr√©s</label>
              <div style="font-size:.7rem;font-weight:700;color:var(--border);text-transform:uppercase;letter-spacing:1px;margin:10px 0 4px;padding-bottom:3px;border-bottom:1px solid var(--bg);width:100%">üè† Herramientas y Tareas para Casa</div>
              <label class="chk"><input type="checkbox" name="tecnica" value="Autorregistro diario"> Autorregistro diario</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Registro ABC"> Registro ABC</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Registro pensamientos disfuncionales"> Registro RPD</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Registro de emociones"> Registro emociones</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Diario de actividades"> Diario actividades</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Programaci√≥n semanal"> Programaci√≥n semanal</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Tareas de exposici√≥n"> Tareas exposici√≥n</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Pr√°ctica de habilidades"> Pr√°ctica habilidades</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Tarjetas de afrontamiento"> Tarjetas afrontamiento</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Lecturas psicoeducativas"> Lecturas psicoed.</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Autoevaluaciones estructuradas"> Autoevaluaciones</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Psicoeducaci√≥n"> Psicoeducaci√≥n</label>
              <label class="chk"><input type="checkbox" name="tecnica" value="Mindfulness"> Mindfulness</label>
            </div>
          </div>
        </div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Intervenciones y descripciones adicionales</label><textarea id="ses-inter" placeholder="Detalla las intervenciones realizadas..."></textarea></div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Pensamiento autom√°tico clave identificado</label><textarea id="ses-pensamiento" placeholder='Ej: "Nadie me quiere", "Siempre me pasa lo peor"...' rows="2"></textarea></div>

        <!-- DISTORSIONES EN SESI√ìN -->
        <div class="fg" style="margin-bottom:14px">
          <label class="lbl">Distorsiones cognitivas / Ideas irracionales identificadas en sesi√≥n</label>
          <div id="ses-dc-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px;margin-top:8px"></div>
          <div style="margin-top:8px">
            <button class="btn" style="font-size:.75rem;padding:4px 12px;background:#f5eaec;color:var(--strong);border-color:var(--bg)" onclick="sesDcNoAplica()">‚Äî No aplica</button>
          </div>
        </div>

        <!-- III. PLAN DE ACCI√ìN -->
        <div class="subsec" style="margin-top:4px">III. Plan de Acci√≥n</div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Tarea para pr√≥xima sesi√≥n</label>
          <div class="checks" style="margin-bottom:8px" id="ses-tareas-check">
            <label class="chk"><input type="checkbox" name="starea" value="Registro de pensamientos"> üìù Registro de pensamientos (Situaci√≥n‚ÜíEmoci√≥n‚ÜíPensamiento)</label>
            <label class="chk"><input type="checkbox" name="starea" value="Pr√°ctica habilidad DBT"> üßò Pr√°ctica de habilidad DBT</label>
            <label class="chk"><input type="checkbox" name="starea" value="Activaci√≥n conductual"> üö∂ Activaci√≥n conductual</label>
          </div>
          <textarea id="ses-tarea" placeholder="Describe la tarea espec√≠fica acordada con el paciente..."></textarea>
        </div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Acuerdos y objetivos para la pr√≥xima sesi√≥n</label><textarea id="ses-acuerdos" placeholder="Corto plazo / largo plazo..."></textarea></div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Avances y observaciones cl√≠nicas</label><textarea id="ses-avances"></textarea></div>

        <!-- IV. NOTAS CL√çNICAS -->
        <div class="subsec" style="margin-top:4px">IV. Notas Cl√≠nicas</div>

        <div class="fg" style="margin-bottom:12px"><label class="lbl">Riesgos detectados</label>
          <div class="checks">
            <label class="chk"><input type="checkbox" name="riesgo" value="Ideaci√≥n suicida"> ‚ö†Ô∏è Ideaci√≥n suicida</label>
            <label class="chk"><input type="checkbox" name="riesgo" value="Autolesiones"> ‚ö†Ô∏è Autolesiones</label>
            <label class="chk"><input type="checkbox" name="riesgo" value="Ninguno"> ‚úÖ Ninguno</label>
          </div>
        </div>

        <div class="fg" style="margin-bottom:12px"><label class="lbl">Recursos del paciente</label>
          <div class="checks">
            <label class="chk"><input type="checkbox" name="recurso" value="Insight"> üí° Insight</label>
            <label class="chk"><input type="checkbox" name="recurso" value="Motivaci√≥n"> üî• Motivaci√≥n</label>
            <label class="chk"><input type="checkbox" name="recurso" value="Apoyo social"> ü§ù Apoyo social</label>
          </div>
        </div>

        <div class="fg" style="margin-bottom:14px"><label class="lbl">Ajustes terap√©uticos</label><textarea id="ses-ajustes" placeholder='Ej: "Reducir velocidad por crisis actual"...' rows="2"></textarea></div>

        <!-- V. ESCALAS (opcional) -->
        <div class="subsec" style="margin-top:4px">V. Tests aplicados (opcional)</div>
        <div class="fg" style="margin-bottom:14px">
          <div class="checks" id="ses-tests-chk">
            <label class="chk"><input type="checkbox" value="PHQ-9"> PHQ-9</label>
            <label class="chk"><input type="checkbox" value="GAD-7"> GAD-7</label>
            <label class="chk"><input type="checkbox" value="YSQ-L3"> YSQ-L3</label>
            <label class="chk"><input type="checkbox" value="SMI"> SMI</label>
            <label class="chk"><input type="checkbox" value="Escala impulsividad"> Escala de impulsividad (TLP)</label>
            <label class="chk"><input type="checkbox" value="Otro" id="ses-test-otro-chk" onchange="toggleTestOtro()"> Otro</label>
            <input type="text" id="ses-test-otro" placeholder="Nombre del test" style="display:none;width:180px;padding:5px 10px;border:1.5px solid #e8d0d6;border-radius:8px;font-size:.83rem">
          </div>
        </div>

        <div class="fg"><label class="lbl">Notas confidenciales (solo tuyas, no van al resumen)</label><textarea id="ses-notas-priv"></textarea></div>
      </div>
      <div class="card">
        <div class="sec-title">üì§ Resumen para el Paciente</div>
        <p style="font-size:0.82rem; color:var(--strong); margin-bottom:14px">Vista previa del documento que recibir√° el paciente. No incluye tus notas confidenciales.</p>
        <button class="btn primary" onclick="generarResumen()" style="margin-bottom:16px">‚ú® Generar Resumen</button>
        <div class="summary-box" id="ses-resumen-box" style="display:none"></div>
        <div class="btn-row" id="ses-export-btns" style="display:none">
          <button class="btn" onclick="exportarResumenPDF()">‚¨áÔ∏è Resumen para Paciente</button>
          <button class="btn primary" onclick="exportarHistoriaClinica()">üìã Historia Cl√≠nica de Evoluci√≥n</button>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn primary" onclick="guardarSesion()">üíæ Guardar Sesi√≥n</button>
      </div>
    </div>
    <div id="sesion-placeholder" style="display:flex; align-items:center; justify-content:center; color:var(--border); font-size:0.9rem; padding:40px">
      Selecciona un paciente y crea o abre una sesi√≥n
    </div>
  </div>
</div>

<!-- ========== TESTS ========== -->
<div class="page" id="page-tests">
  <div class="page-header">
    <h1>Tests de Evaluaci√≥n</h1>
    <p>Aplica y registra los instrumentos de evaluaci√≥n</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="tst-sel-pac"></select>
    <label>Test:</label>
    <select id="tst-sel" onchange="loadTest()">
      <option value="">‚Äî Seleccionar ‚Äî</option>
      <option value="phq9">PHQ-9 (Depresi√≥n)</option>
      <option value="gad7">GAD-7 (Ansiedad)</option>
      <option value="ysq">YSQ-L3 (Esquemas - Young)</option>
      <option value="smi">SMI (Modos - Young)</option>
    </select>
    <button class="btn primary" onclick="guardarTest()">üíæ Guardar Resultado</button>
  </div>
  <div id="test-container"></div>
  <div id="test-resultados" style="display:none">
    <div class="card">
      <div class="sec-title" id="res-titulo">Resultados</div>
      <div id="res-content"></div>
      <div class="btn-row">
        <button class="btn" onclick="exportarTestPDF()">‚¨áÔ∏è Exportar PDF</button>
      </div>
    </div>
    <div class="card">
      <div class="sec-title">Historial de Tests</div>
      <div id="test-historial"></div>
    </div>
  </div>
</div>

<!-- ========== SEGUIMIENTO ========== -->
<div class="page" id="page-seguimiento">
  <div class="page-header">
    <h1>Seguimiento</h1>
    <p>Evoluci√≥n y progreso del paciente a lo largo del tiempo</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="seg-sel-pac" onchange="loadSeguimiento()"></select>
  </div>
  <div class="stat-grid" id="seg-stats"></div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
      <div class="sec-title" style="margin-bottom:0;border-bottom:none;padding-bottom:0">Evoluci√≥n del Estado Emocional por Sesi√≥n</div>
      <button class="btn primary" onclick="exportarEvolucionPDF()">üå∏ Generar Entregable para Paciente</button>
    </div>
    <canvas id="seg-chart" height="100"></canvas>
  </div>
  <div class="card">
    <div class="sec-title">Historial de Sesiones</div>
    <div id="seg-sesiones-lista"></div>
  </div>
  <div class="card">
    <div class="sec-title">Resultados de Tests</div>
    <div id="seg-tests-lista"></div>
  </div>
</div>

<!-- ========== AGENDA ========== -->
<div class="page" id="page-agenda">
  <div class="page-header" style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div>
      <h1>Mi Agenda</h1>
      <p>Citas y eventos del consultorio</p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" style="font-size:.78rem;padding:7px 16px" onclick="document.getElementById('ics-input').click()">üì• Importar desde Google Calendar (.ics)</button>
      <input type="file" id="ics-input" accept=".ics" style="display:none" onchange="importarICS(event)">
      <button class="btn danger" style="font-size:.78rem;padding:7px 16px" onclick="agLimpiarTodo()">üóë Limpiar todos</button>
    </div>
  </div>
  <div class="ag-tab-nav">
    <button class="ag-tab active" onclick="agSwitchTab('hoy',this)">Hoy</button>
    <button class="ag-tab" onclick="agSwitchTab('manana',this)">Ma√±ana</button>
    <button class="ag-tab" onclick="agSwitchTab('semana',this)">Esta semana</button>
    <button class="ag-tab" id="ag-tab-cumple" onclick="agSwitchTab('cumpleanos',this)" style="display:flex;align-items:center;gap:6px">üéÇ Cumplea√±os <span id="ag-badge-cumple" style="display:none;background:#cd8e9d;color:#fff;border-radius:10px;font-size:.67rem;padding:1px 7px;font-weight:700;line-height:1.6"></span></button>
  </div>
  <div class="card" id="ag-nav-card" style="padding:14px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div id="ag-fecha-titulo" style="font-family:'Playfair Display',serif;font-size:1.1rem"></div>
    <div style="display:flex;gap:8px">
      <button class="arrow" onclick="agCambiarDia(-1)" id="ag-prev">‚Äπ</button>
      <button class="arrow" onclick="agCambiarDia(1)" id="ag-next">‚Ä∫</button>
    </div>
  </div>
  <div id="ag-container"></div>
  <div class="card" id="ag-form-card" style="margin-top:24px">
    <div class="sec-title">‚ûï Agregar evento</div>
    <div class="row col3">
      <div class="fg"><label class="lbl">T√≠tulo</label><input type="text" id="ag-nuevo-titulo" placeholder="Ej: Sesi√≥n con Mar√≠a"></div>
      <div class="fg"><label class="lbl">Fecha y hora inicio</label><input type="datetime-local" id="ag-nuevo-inicio"></div>
      <div class="fg"><label class="lbl">Hora fin</label><input type="datetime-local" id="ag-nuevo-fin"></div>
    </div>
    <div class="row col2">
      <div class="fg"><label class="lbl">Tipo</label>
        <select id="ag-nuevo-tipo">
          <option value="virtual">Virtual</option>
          <option value="presencial">Presencial</option>
          <option value="admin">Administrativo</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Descripci√≥n</label><input type="text" id="ag-nuevo-desc" placeholder="Nota opcional"></div>
    </div>
    <div class="btn-row"><button class="btn primary" onclick="agAgregarEvento()">+ Guardar evento</button></div>
  </div>

  <!-- PANEL CUMPLEA√ëOS (pesta√±a dentro de agenda) -->
  <div id="ag-panel-cumple" style="display:none">

    <!-- Hoy -->
    <div class="card" id="ag-cumple-hoy-card" style="display:none;border:2px solid #cd8e9d;background:linear-gradient(135deg,#fff8f9,#fadae1);margin-bottom:16px">
      <div class="sec-title" style="color:#cd8e9d;margin-bottom:12px">üéâ ¬°Cumplea√±os hoy!</div>
      <div id="ag-cumple-hoy-list"></div>
    </div>

    <!-- Pr√≥ximos 30 d√≠as -->
    <div class="card" style="margin-bottom:16px">
      <div class="sec-title" style="margin-bottom:12px">üìÖ Pr√≥ximos 30 d√≠as</div>
      <div id="ag-cumple-proximos"></div>
    </div>

    <!-- Todos por mes -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:14px">
        <div class="sec-title" style="margin:0">üìã Todos los cumplea√±os</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap" id="ag-cumple-meses-btns"></div>
      </div>
      <div id="ag-cumple-lista-mes"></div>
    </div>

  </div>
</div>

<!-- ========== FINANZAS ========== -->
<div class="page" id="page-finanzas">
  <div class="page-header">
    <h1>Finanzas</h1>
    <p>Control de ingresos, gastos y pagos pendientes</p>
  </div>
  <div class="fin-tab-nav">
    <button class="fin-tab active" onclick="finSwitchTab('resumen',this)">Resumen</button>
    <button class="fin-tab" onclick="finSwitchTab('registrar',this)">Registrar</button>
    <button class="fin-tab" onclick="finSwitchTab('historial',this)">Historial</button>
    <button class="fin-tab" onclick="finSwitchTab('deudores',this)">Pendientes</button>
  </div>

  <!-- RESUMEN -->
  <div class="fin-screen active" id="fin-resumen">
    <div class="mes-nav">
      <button class="arrow" onclick="cambiarMes(-1)">‚Äπ</button>
      <h2 id="mesTitle"></h2>
      <button class="arrow" onclick="cambiarMes(1)">‚Ä∫</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card-fin verde"><div class="stat-label">Ingresos</div><div class="stat-value" id="stat-ingresos">$0</div><div class="stat-sub" id="stat-ingresos-n">0 sesiones</div></div>
      <div class="stat-card-fin rojo"><div class="stat-label">Gastos</div><div class="stat-value" id="stat-gastos">$0</div><div class="stat-sub" id="stat-gastos-n">0 registros</div></div>
      <div class="stat-card-fin rosa"><div class="stat-label">Ganancia neta</div><div class="stat-value" id="stat-neta">$0</div><div class="stat-sub">este mes</div></div>
      <div class="stat-card-fin"><div class="stat-label">Pendientes</div><div class="stat-value" id="stat-pendientes">$0</div><div class="stat-sub" id="stat-pendientes-n">0 pacientes</div></div>
    </div>
    <div id="resumen-lista"></div>
  </div>

  <!-- REGISTRAR -->
  <div class="fin-screen" id="fin-registrar">
    <div class="form-card">
      <div class="form-title">üå∏ Registrar pago de paciente</div>
      <div class="form-grid">
        <div class="field" style="grid-column:1/-1"><label>Seleccionar paciente del expediente</label>
          <select id="r_pac_selector" onchange="rellenarPacienteDesdeSelector()">
            <option value="">‚Äî Seleccionar paciente registrada ‚Äî</option>
          </select>
        </div>
        <div class="field"><label>Nombre del paciente</label><input type="text" id="r_paciente" placeholder="Ej: Mar√≠a Gonz√°lez"></div>
        <div class="field"><label>Fecha</label><input type="date" id="r_fecha"></div>
        <div class="field"><label>Tipo de sesi√≥n</label>
          <select id="r_tipo">
            <option value="80000">Sesi√≥n individual ¬∑ $80.000</option>
            <option value="140000">Pareja / Familia ¬∑ $140.000</option>
            <option value="140000b">Evaluaci√≥n individual ¬∑ $140.000</option>
            <option value="160000">Evaluaci√≥n pareja ¬∑ $160.000</option>
            <option value="custom">Otro monto</option>
          </select>
        </div>
        <div class="field"><label>M√©todo de pago</label>
          <select id="r_metodo">
            <option value="efectivo">Efectivo</option>
            <option value="nu">Nu</option>
            <option value="davibank">Davibank</option>
            <option value="nequi">Nequi</option>
            <option value="breve">Breve</option>
          </select>
        </div>
        <div class="field" id="campo-monto-custom" style="display:none"><label>Monto personalizado</label><input type="number" id="r_monto_custom" placeholder="Ej: 100000"></div>
        <div class="field"><label>Estado</label>
          <select id="r_estado">
            <option value="pagado">Pagado ‚úì</option>
            <option value="pendiente">Pendiente de pago</option>
          </select>
        </div>
      </div>
      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" onclick="registrarPago()">Guardar pago</button>
        <button class="btn" onclick="registrarYRecibo()">Guardar + generar recibo</button>
      </div>
    </div>
    <div class="form-card">
      <div class="form-title">üõí Registrar gasto</div>
      <div class="form-grid">
        <div class="field"><label>Descripci√≥n</label><input type="text" id="g_desc" placeholder="Ej: Papel, marcadores..."></div>
        <div class="field"><label>Fecha</label><input type="date" id="g_fecha"></div>
        <div class="field"><label>Monto</label><input type="number" id="g_monto" placeholder="Ej: 25000"></div>
        <div class="field"><label>Categor√≠a</label>
          <select id="g_cat">
            <option>Materiales y papeler√≠a</option>
            <option>Plataformas o apps</option>
            <option>Publicidad</option>
            <option>Arriendo</option>
            <option>Otro</option>
          </select>
        </div>
      </div>
      <button class="btn primary" style="margin-top:16px" onclick="registrarGasto()">Guardar gasto</button>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div class="fin-screen" id="fin-historial">
    <div class="mes-nav">
      <button class="arrow" onclick="cambiarMes(-1)">‚Äπ</button>
      <h2 id="mesTitle2"></h2>
      <button class="arrow" onclick="cambiarMes(1)">‚Ä∫</button>
    </div>
    <div id="historial-lista"></div>
  </div>

  <!-- DEUDORES -->
  <div class="fin-screen" id="fin-deudores">
    <h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:20px">Pacientes con pago pendiente</h2>
    <div id="deudores-lista"></div>
  </div>
</div>

<!-- MODAL RECIBO -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Recibo de pago</div>
      <button class="modal-close" onclick="cerrarModalBtn()">‚úï</button>
    </div>
    <div class="recibo" id="reciboContent"></div>
    <div id="recibo-estado-badge" style="margin-bottom:12px;display:none"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn-wa" onclick="enviarReciboWA()">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
      <button id="btn-marcar-pagado" class="btn-secondary-fin" onclick="marcarComoPagado()" style="background:#e8f5e9;color:#2e7d32;border:1.5px solid #6aaa6a;border-radius:20px;padding:9px 18px;font-family:Lato,sans-serif;font-size:0.83rem;cursor:pointer;">‚úì Marcar como pagado</button>
      <button class="btn-secondary-fin" onclick="cerrarModalBtn()">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL CUMPLEA√ëOS -->
<div class="bday-overlay" id="bdayOverlay">
  <div class="bday-modal">
    <div class="bday-canvas-wrap"><canvas id="bdayCanvas" width="800" height="480"></canvas></div>
    <div class="bday-footer">
      <div class="bday-pac-name" id="bdayPacName">Paciente<span id="bdayPacSub"></span></div>
      <div class="bday-btns">
        <button class="btn-bday-dl" onclick="bdayDescargar()">‚¨áÔ∏è Descargar</button>
        <button class="btn-bday-wa" onclick="bdayWA()">üì± WhatsApp</button>
        <button class="btn-bday-close" onclick="document.getElementById('bdayOverlay').classList.remove('open')">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL IMAGEN RECORDATORIO CITA -->
<div class="cita-img-overlay" id="citaImgOverlay">
  <div class="cita-img-modal">
    <div class="cita-img-canvas-wrap"><canvas id="citaImgCanvas" width="800" height="500"></canvas></div>
    <div class="cita-img-footer">
      <button class="btn-cita-dl" onclick="citaImgDescargar()">‚¨áÔ∏è Descargar</button>
      <button class="btn-cita-wa" onclick="citaImgWA()">üì± WhatsApp</button>
      <button class="btn-cita-close" onclick="document.getElementById('citaImgOverlay').classList.remove('open')">Cerrar</button>
    </div>
  </div>
</div>

<!-- ========== DOCUMENTOS ========== -->
<div class="page" id="page-documentos">
  <div class="page-header">
    <h1>Documentos Cl√≠nicos</h1>
    <p>Genera certificados e informes profesionales en Word (.docx)</p>
  </div>

  <!-- PASO 1: Tipo de documento -->
  <div class="card">
    <div class="sec-title">1Ô∏è‚É£ Selecciona el tipo de documento</div>
    <div class="doc-tipos" id="doc-tipos-grid"></div>
  </div>

  <!-- PASO 2: Paciente -->
  <div class="card" id="doc-paso2" style="display:none">
    <div class="sec-title">2Ô∏è‚É£ Datos del paciente</div>
    <div class="row col2">
      <div class="doc-field-group">
        <label class="lbl">Seleccionar paciente del expediente</label>
        <select id="doc-sel-pac" onchange="docCargarPaciente()">
          <option value="">‚Äî O ingresa los datos manualmente ‚Äî</option>
        </select>
      </div>
      <div class="doc-field-group">
        <label class="lbl">Tratamiento (La se√±ora / El se√±or / etc.)</label>
        <input type="text" id="doc-tratamiento" placeholder="La se√±ora / El se√±or">
      </div>
    </div>
    <div class="row col2">
      <div class="doc-field-group">
        <label class="lbl">Nombre completo del paciente *</label>
        <input type="text" id="doc-pac-nombre" placeholder="Nombre completo">
      </div>
      <div class="doc-field-group">
        <label class="lbl">C√©dula de ciudadan√≠a *</label>
        <input type="text" id="doc-pac-cc" placeholder="N√∫mero de c√©dula">
      </div>
    </div>
    <div class="row col2">
      <div class="doc-field-group">
        <label class="lbl">Ciudad de expedici√≥n CC</label>
        <input type="text" id="doc-pac-ciudad" placeholder="Medell√≠n" value="Medell√≠n">
      </div>
      <div class="doc-field-group">
        <label class="lbl">Fecha de nacimiento</label>
        <input type="date" id="doc-pac-fnac">
      </div>
    </div>
  </div>

  <!-- PASO 3: Contenido espec√≠fico seg√∫n tipo -->
  <div class="card" id="doc-paso3" style="display:none">
    <div class="sec-title" id="doc-paso3-titulo">3Ô∏è‚É£ Contenido del documento</div>
    <div id="doc-campos-especificos"></div>
  </div>

  <!-- PASO 4: Vista previa y descarga -->
  <div class="card" id="doc-paso4" style="display:none">
    <div class="sec-title">4Ô∏è‚É£ Vista previa y descarga</div>
    <div id="doc-preview-box" class="doc-preview"></div>
    <div class="btn-row" style="margin-top:18px">
      <button class="btn primary" onclick="docGenerar()">‚¨áÔ∏è Descargar Word (.docx)</button>
      <button class="btn" onclick="docActualizarPreview()">üîÑ Actualizar vista previa</button>
    </div>
    <p style="font-size:.75rem;color:var(--strong);margin-top:10px">‚ö†Ô∏è El archivo Word se descarga listo para editar y firmar. Puedes ajustar el texto antes de imprimir.</p>
  </div>
</div>


<!-- ========== HERRAMIENTAS TCC ========== -->
<div class="page" id="page-herramientas">
  <div class="page-header">
    <h1>Herramientas TCC üîß</h1>
    <p>Banco de t√©cnicas y recursos terap√©uticos cognitivo-conductuales</p>
  </div>
  
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('her','cognitivas')">üß† Cognitivas</button>
    <button class="tab-btn" onclick="switchTab('her','conductuales')">üìã Conductuales</button>
    <button class="tab-btn" onclick="switchTab('her','fisiologicas')">ü´Å Fisiol√≥gicas</button>
    <button class="tab-btn" onclick="switchTab('her','emocionales')">üíö Emocionales</button>
    <button class="tab-btn" onclick="switchTab('her','tareas')">üè† Tareas para Casa</button>
    <button class="tab-btn" onclick="switchTab('her','distorsiones')">‚ö†Ô∏è Distorsiones / Ideas</button>
  </div>

  <!-- COGNITIVAS -->
  <div class="tab-content active" id="her-cognitivas">
    <div class="card">
      <div class="sec-title">üß† T√©cnicas Cognitivas (TCC ‚Äì Beck)</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:8px">
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìù Registro de Pensamientos Autom√°ticos</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Registra situaci√≥n ‚Üí emoci√≥n ‚Üí pensamiento autom√°tico ‚Üí evidencia a favor/en contra ‚Üí pensamiento alternativo.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üîÑ Reestructuraci√≥n Cognitiva</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Identificar, cuestionar y reemplazar pensamientos disfuncionales por alternativas m√°s realistas y equilibradas.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">‚ùì Debate Socr√°tico</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Serie de preguntas guiadas para que el paciente examine la validez y utilidad de sus creencias.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">‚Üì Flecha Descendente</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Profundizar en las creencias nucleares preguntando "¬øY si eso fuera verdad, qu√© significar√≠a?" repetidamente.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üîç B√∫squeda de Evidencia</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Buscar datos reales a favor y en contra del pensamiento autom√°tico para construir una perspectiva m√°s objetiva.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üéØ Reatribuci√≥n</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Identificar factores contextuales que contribuyen a un resultado, reduciendo la auto-culpabilizaci√≥n excesiva.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üåä Descatastrofizaci√≥n</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Evaluar la probabilidad real del peor escenario y explorar la capacidad de afrontamiento ante ese escenario.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìè Continuum Cognitivo</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Situar el pensamiento dicot√≥mico en un continuo (0-100%) para ver los matices entre los extremos.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">‚öñÔ∏è Ventajas y Desventajas</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Examinar los pros y contras de mantener una creencia o conducta a corto y largo plazo.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üí¨ T√©cnica del Abogado Defensor</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">El paciente act√∫a como su propio abogado, construyendo los mejores argumentos a su favor.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">ü™û Doble Est√°ndar</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">¬øAplicar√≠as el mismo criterio a un amigo en la misma situaci√≥n? Detecta y corrige el auto-juicio excesivo.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üÉè Tarjetas Recordatorias</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Pensamientos alternativos escritos en tarjetas que el paciente lleva consigo y lee cuando surge el pensamiento disfuncional.</div></div>
      </div>
    </div>
  </div>

  <!-- CONDUCTUALES -->
  <div class="tab-content" id="her-conductuales">
    <div class="card">
      <div class="sec-title">üìã T√©cnicas Conductuales</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:8px">
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üö∂ Activaci√≥n Conductual</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Programar actividades que generen satisfacci√≥n y dominio para romper el ciclo de inactividad-depresi√≥n.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üéØ Exposici√≥n Gradual (en vivo)</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Jerarqu√≠a de situaciones temidas. Exposici√≥n progresiva sin escapar hasta que la ansiedad disminuye naturalmente.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üß† Exposici√≥n Imaginada</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Visualizar con detalle la situaci√≥n temida para procesar el miedo de forma gradual y controlada.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">ü´Ä Exposici√≥n Interoceptiva</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Inducir intencionalmente s√≠ntomas f√≠sicos (hiperventilaci√≥n, giro) para reducir el miedo a las sensaciones internas.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üõë Prevenci√≥n de Respuesta</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Exposici√≥n al est√≠mulo evitando realizar el ritual o conducta compulsiva. Usado en TOC y conductas de seguridad.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üé≠ Role Playing / Ensayo Conductual</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Practicar situaciones interpersonales en sesi√≥n para desarrollar habilidades y confianza antes de la vida real.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üó£Ô∏è Entrenamiento en Asertividad</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Aprender a expresar necesidades, sentimientos y opiniones de forma directa, sin agresividad ni sumisi√≥n.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìä Autoregistro Conductual</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Observar y anotar antecedentes, conductas y consecuencias (modelo A-B-C) para identificar patrones.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">ü§ù Contrato Conductual</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Acuerdo escrito entre terapeuta y paciente sobre conductas espec√≠ficas a realizar y consecuencias establecidas.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">‚úÖ Reforzamiento Positivo</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Identificar y aplicar consecuencias agradables que aumenten la frecuencia de conductas adaptativas.</div></div>
      </div>
    </div>
  </div>

  <!-- FISIOL√ìGICAS -->
  <div class="tab-content" id="her-fisiologicas">
    <div class="card">
      <div class="sec-title">ü´Å T√©cnicas Fisiol√≥gicas</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:8px">
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üå¨Ô∏è Respiraci√≥n Diafragm√°tica</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Inhalar 4s ‚Üí retener 2s ‚Üí exhalar 6-8s. Activa el sistema nervioso parasimp√°tico y reduce la activaci√≥n fisiol√≥gica del estr√©s.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üí™ Relajaci√≥n Muscular Progresiva</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Jacobson: tensar y relajar progresivamente grupos musculares para reducir la tensi√≥n f√≠sica y el arousal ansioso.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üåÄ Entrenamiento Aut√≥geno (Schultz)</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Autosugesti√≥n de sensaciones de calor y pesadez para inducir relajaci√≥n profunda. 6 fases est√°ndar.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üèùÔ∏è Visualizaci√≥n Guiada</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Imaginar con detalle sensorial un lugar seguro y tranquilo para reducir la activaci√≥n emocional y promover la calma.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üì° Biofeedback</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Uso de sensores para monitorear se√±ales corporales (frecuencia card√≠aca, sudoraci√≥n) y aprender a regularlas conscientemente.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üßò Relajaci√≥n Aplicada</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">√ñst: combinar relajaci√≥n progresiva con discriminaci√≥n de se√±ales de tensi√≥n para una respuesta de relajaci√≥n r√°pida ante el estr√©s.</div></div>
      </div>
    </div>
  </div>

  <!-- EMOCIONALES -->
  <div class="tab-content" id="her-emocionales">
    <div class="card">
      <div class="sec-title">üíö T√©cnicas Emocionales</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:8px">
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üí´ Exposici√≥n Emocional</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Permitir sentir y tolerar las emociones evitadas sin escapar, para reducir el miedo a las propias emociones.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üè∑Ô∏è Etiquetado Emocional</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Nombrar las emociones con precisi√≥n para reducir su intensidad (regulaci√≥n descendente de la am√≠gdala).</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üåä Regulaci√≥n Emocional</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Estrategias DBT: identificar emociones, reducir vulnerabilidad, aumentar emociones positivas, actuar opuesto.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üõ°Ô∏è Tolerancia al Malestar</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Habilidades DBT para sobrevivir crisis sin empeorar la situaci√≥n: TIPP, distracci√≥n, auto-calmarse, pro/contras.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üíâ Inoculaci√≥n de Estr√©s</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Meichenbaum: fases educativa, ensayo de habilidades y aplicaci√≥n para prepararse ante situaciones estresantes.</div></div>
      </div>
    </div>
  </div>

  <!-- TAREAS PARA CASA -->
  <div class="tab-content" id="her-tareas">
    <div class="card">
      <div class="sec-title">üè† Herramientas y Tareas para Casa</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:8px">
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìî Autorregistro Diario</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Registro cotidiano de situaciones, emociones e intensidad para identificar patrones a lo largo de la semana.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìä Registro ABC</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Antecedente ‚Üí Creencia/Pensamiento ‚Üí Consecuencia. Modelo conductual para an√°lisis funcional del comportamiento.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìù Registro Pensamientos Disfuncionales (RPD)</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">5 o 7 columnas: situaci√≥n, emoci√≥n, pensamiento autom√°tico, distorsi√≥n, evidencia, pensamiento alternativo, resultado.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìÖ Diario de Actividades + Programaci√≥n Semanal</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Registrar actividades diarias, calificando placer y dominio (0-10). Planificar actividades para la pr√≥xima semana.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üß™ Experimento Conductual Domiciliario</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Dise√±ar y ejecutar en casa una situaci√≥n para poner a prueba una predicci√≥n o creencia disfuncional.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üÉè Tarjetas de Afrontamiento</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Tarjetas con pensamientos alternativos, recordatorios de habilidades o frases de afrontamiento para momentos dif√≠ciles.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìö Lecturas Psicoeducativas</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">Material de lectura adaptado al nivel del paciente sobre su problem√°tica, el modelo TCC, t√©cnicas espec√≠ficas.</div></div>
        <div style="background:var(--soft);border-left:4px solid var(--border);border-radius:0 12px 12px 0;padding:12px 16px"><div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:4px">üìã Autoevaluaciones Estructuradas</div><div style="font-size:.78rem;color:var(--strong);line-height:1.5">PHQ-9, GAD-7, u otras escalas que el paciente completa semanalmente para monitorear su evoluci√≥n.</div></div>
      </div>
    </div>
  </div>

  <!-- DISTORSIONES REFERENCIA -->
  <div class="tab-content" id="her-distorsiones">
    <div class="card">
      <div class="sec-title">‚ö†Ô∏è Distorsiones Cognitivas e Ideas Irracionales ‚Äî Referencia Cl√≠nica</div>
      <p style="font-size:.82rem;color:var(--strong);margin-bottom:16px">Modelo de Aaron T. Beck (TCC) y Albert Ellis (TREC)</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px">
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Pensamiento Dicot√≥mico</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Ver en blanco o negro, sin matices intermedios. <em>Ejemplo: "Si no soy perfecto, soy un fracaso total."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Sobregeneralizaci√≥n</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Una experiencia negativa = regla universal. <em>Ejemplo: "Siempre me pasa lo mismo, nunca me sale nada bien."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Abstracci√≥n Selectiva</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Enfoque exclusivo en un detalle negativo ignorando el contexto positivo. <em>"Comet√≠ un error, todo sali√≥ mal."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Inferencia Arbitraria</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Sacar conclusiones negativas sin evidencia suficiente. Incluye lectura de mente y adivinaci√≥n del futuro.</div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Catastrofizaci√≥n</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Amplificar la importancia negativa de un evento hasta el extremo. <em>"Si me equivoco, ser√° catastr√≥fico."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Razonamiento Emocional</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Las emociones como evidencia de la realidad. <em>"Me siento tonta, luego debo ser tonta."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Personalizaci√≥n</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Atribuirse responsabilidad de eventos externos negativos. <em>"Si mi hijo tiene problemas, es mi culpa."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Etiquetaci√≥n Global</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Asignarse etiquetas globales y fijas. <em>"Soy un/a in√∫til", "Soy un fracasado/a", "Soy un perdedor/a."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Afirmaciones Imperativas ("deber√≠a")</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Reglas r√≠gidas. <em>Ellis: musturbation. "Deber√≠a ser siempre fuerte", "Tengo que caerle bien a todos."</em></div></div>
        <div style="background:var(--soft);border-radius:10px;padding:12px 16px;border:1.5px solid var(--bg)"><div style="font-weight:700;font-size:.85rem;color:var(--text)">Culpabilizaci√≥n</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">Atribuir a otros toda la responsabilidad. Complementaria a la personalizaci√≥n.</div></div>
      </div>
      
      <div class="subsec" style="margin-top:24px">üß† Creencias Nucleares Disfuncionales (Beck)</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;margin-top:8px">
        <div style="background:#fff8f9;border:1.5px solid var(--border);border-radius:10px;padding:12px 16px"><div style="font-weight:700;font-size:.82rem;color:var(--text)">Desvalorizaci√≥n Personal</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">"Soy incompetente / in√∫til / defectuoso/a." Base del dominio de desamparo.</div></div>
        <div style="background:#fff8f9;border:1.5px solid var(--border);border-radius:10px;padding:12px 16px"><div style="font-weight:700;font-size:.82rem;color:var(--text)">Indeseabilidad</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">"No soy digno/a de amor / soy diferente / no pertenezco." Base del dominio de desconexi√≥n.</div></div>
        <div style="background:#fff8f9;border:1.5px solid var(--border);border-radius:10px;padding:12px 16px"><div style="font-weight:700;font-size:.82rem;color:var(--text)">Vulnerabilidad</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">"El mundo es peligroso / algo malo pasar√°." Base de la hipervigilancia y ansiedad.</div></div>
        <div style="background:#fff8f9;border:1.5px solid var(--border);border-radius:10px;padding:12px 16px"><div style="font-weight:700;font-size:.82rem;color:var(--text)">Desamparo / Impotencia</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">"No puedo hacer nada para cambiar mi situaci√≥n." Relacionada con la depresi√≥n y la desesperanza.</div></div>
        <div style="background:#fff8f9;border:1.5px solid var(--border);border-radius:10px;padding:12px 16px"><div style="font-weight:700;font-size:.82rem;color:var(--text)">Falta de Control</div><div style="font-size:.77rem;color:var(--strong);line-height:1.5;margin-top:3px">"No puedo controlar mis emociones / conductas / pensamientos." Vinculada a impulsividad y ansiedad.</div></div>
      </div>
    </div>
  </div>
</div>


<!-- ========== CUMPLEA√ëOS ========== -->
<div class="page" id="page-cumpleanos">
  <div class="page-header">
    <h1>Cumplea√±os üéÇ</h1>
    <p>Recordatorios de cumplea√±os de tus pacientes</p>
  </div>
  <div class="card" id="cumple-hoy-card" style="border:2px solid #cd8e9d;background:linear-gradient(135deg,#fff8f9,#fadae1);display:none">
    <div class="sec-title" style="color:#cd8e9d">üéâ ¬°Cumplea√±os Hoy!</div>
    <div id="cumple-hoy-list"></div>
  </div>
  <div class="card">
    <div class="sec-title">üìÖ Cumplea√±os por mes</div>
    <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap" id="cumple-meses-btns"></div>
    <div id="cumple-lista"></div>
  </div>
</div>
</main>

<!-- TOAST -->
<div id="toast"></div>

<!-- MODAL PACIENTE VER/EDITAR -->
<div class="pac-modal-overlay" id="pac-modal-overlay" onclick="if(event.target===this)cerrarPacModal()">
  <div class="pac-modal">
    <div class="pac-modal-header">
      <div class="pac-modal-title" id="pac-modal-title">Perfil del Paciente</div>
      <button class="pac-modal-close" onclick="cerrarPacModal()">‚úï</button>
    </div>
    <!-- Editar datos -->
    <div id="pac-modal-datos"></div>
    <div class="pac-historia-tabs">
      <button class="pac-hist-btn active" onclick="switchPacTab('datos',this)">üìã Datos biogr√°ficos</button>
      <button class="pac-hist-btn" onclick="switchPacTab('sesiones',this)">üìù Sesiones</button>
      <button class="pac-hist-btn" onclick="switchPacTab('tests',this)">üß™ Tests</button>
      <button class="pac-hist-btn" onclick="switchPacTab('cancelaciones',this)">‚ùå Cancelaciones</button>
      <button class="pac-hist-btn" onclick="switchPacTab('histclinica',this)">üè• Historia Cl√≠nica</button>
    </div>
    <div class="pac-hist-section active" id="pac-tab-datos"></div>
    <div class="pac-hist-section" id="pac-tab-sesiones"></div>
    <div class="pac-hist-section" id="pac-tab-tests"></div>
    <div class="pac-hist-section" id="pac-tab-cancelaciones"></div>
    <div class="pac-hist-section" id="pac-tab-histclinica"></div>
    <div class="btn-row" style="margin-top:20px">
      <button class="btn danger" onclick="eliminarPaciente(_pacModalId)">üóë Eliminar Paciente</button>
      <button class="btn primary" onclick="guardarPacienteModal()">üíæ Guardar Cambios</button>
    </div>
  </div>
</div>

<!-- MODAL DETALLE SESI√ìN -->
<div class="ses-detail-overlay" id="ses-detail-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="ses-detail-modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--border)" id="ses-detail-title">Detalle Sesi√≥n</div>
      <button style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--strong)" onclick="document.getElementById('ses-detail-overlay').classList.remove('open')">‚úï</button>
    </div>
    <div id="ses-detail-content"></div>
  </div>
</div>

<!-- MODAL EDITAR CITA -->
<div class="pac-modal-overlay" id="ag-edit-overlay" onclick="if(event.target===this)this.classList.remove('open')" style="z-index:700">
  <div class="pac-modal" style="max-width:480px">
    <div class="pac-modal-header">
      <div class="pac-modal-title">‚úèÔ∏è Editar cita</div>
      <button class="pac-modal-close" onclick="document.getElementById('ag-edit-overlay').classList.remove('open')">‚úï</button>
    </div>
    <input type="hidden" id="ag-edit-id">
    <div class="fg" style="margin-bottom:12px"><label class="lbl">T√≠tulo / Paciente</label><input type="text" id="ag-edit-titulo"></div>
    <div class="row col2" style="margin-bottom:12px">
      <div class="fg"><label class="lbl">Inicio</label><input type="datetime-local" id="ag-edit-inicio"></div>
      <div class="fg"><label class="lbl">Fin</label><input type="datetime-local" id="ag-edit-fin"></div>
    </div>
    <div class="fg" style="margin-bottom:12px"><label class="lbl">Tipo</label>
      <select id="ag-edit-tipo">
        <option value="presencial">Presencial</option>
        <option value="virtual">Virtual</option>
        <option value="admin">Administrativo</option>
      </select>
    </div>
    <div class="fg" style="margin-bottom:16px"><label class="lbl">Descripci√≥n / Notas</label><textarea id="ag-edit-desc" rows="2"></textarea></div>
    <div class="btn-row">
      <button class="btn" onclick="document.getElementById('ag-edit-overlay').classList.remove('open')">Cancelar</button>
      <button class="btn primary" onclick="agGuardarEdicion()">üíæ Guardar cambios</button>
    </div>
  </div>
</div>

<!-- MODAL NEW PATIENT -->
<div class="modal-overlay" id="modal-pac">
  <div class="modal">
    <h3>Nuevo Paciente</h3>
    <div class="fg" style="margin-bottom:12px"><label class="lbl">Nombre completo *</label><input type="text" id="m-nombre"></div>
    <div class="btn-row">
      <button class="btn" onclick="document.getElementById('modal-pac').classList.remove('open')">Cancelar</button>
      <button class="btn primary" onclick="crearPacienteModal()">Crear</button>
    </div>
  </div>
</div>

<script>
// ===================== LOGO =====================
(function(){
  const LOGO_B64 = '/9j/4AAQSkZJRgABAgAAAQABAAD/wAARCAH4AfgDACIAAREBAhEB/9sAQwAIBgYHBgUIBwcHCQkICgwUDQwLCwwZEhMPFB0aHx4dGhwcICQuJyAiLCMcHCg3KSwwMTQ0NB8nOT04MjwuMzQy/9sAQwEJCQkMCwwYDQ0YMiEcITIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIy/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMAAAERAhEAPwD36iiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAUUUCigBKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAFFFAooASiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAUUUCigBKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAFFFAooASiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAUUUCigBKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAFFFAooASiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKZLKsS5Y0APpC6r1YD8azZbqSTgEqvt1/OoDzQaqk3ubIYEcEGlrGVijAqce9aFtciUbW4cfrSTFKm46lmiiimZhRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFBIA56UAFFV/OeT/Uplf77HCn6ev6D3qrdQz3MqWrXBCspaQxqBlRgY5z1J/IGgaV2WDf2wyd5YDqyIWUfUgYqwjpLGHjZWVhkMpyCPrVY28sKfJdsAB/y0RSoH4AfzrKGoPbXYkjQXEMhCyNbq20seAwz8o54PzHOR6UilG+x0FFZsOr+epZbK6wOGHyEqfQqGyD+FWIb+2nDbJfmQfMrAqy/VTyKZPK10J5ZFiQs1ZcsrSuWb8B2Ap08xmfJ+6OgqKk2b06dtWFFFFI1ClVirAjqOaSigDXikEsYYd6fWdaS+XJsbhW/Q1o0zlnHlYUUUUyAopGYKMsQAPWs2XXLZXMduslzIOCIRkA+7HgfnQNJvY06KxhqGoSn5YbeAf8ATRmc/kAB+tTo+psuVlsXP+6y/wBTQU4NbmlRWeb68hP+kWDFR/Hbv5g/IgH8gasW15b3iFoJA2OGHQqfQg8g/WgmzLFFFFAgooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiigkKMkgD3NABVcj7RI2f9Uhxj+83f8B0+v0ps95FFE7B1LAHAHOT2qrCbdoEDyy5xxtdl/kRz6nuc0FKLsalZs11Ha6hcO+T+5iCooyzEs/A9ScdPaopdT/s9C07maADiQL8wPow6fQ/n61DbPnVRdXRTzZITsUDIiAI4B7k7uT9c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sJ2qFUkc4ySOOMmuoAwKKKSjYbd9BAqgkgDJ6mlooqhBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFACiigUUAJRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAoooFFACUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFACiigUUAJRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAoooFFACUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFACiigUUAJRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAoooFFACUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAUUUUAf/2Q==';
  document.getElementById('logo-img').src = 'data:image/png;base64,' + LOGO_B64;
})();

// ===================== STORAGE ‚Äî DB definido en el <head> con Firebase =====================
// DB ya esta definido arriba junto con Firebase. Solo se inicializan los datos al arrancar.

// ===================== PATIENTS =====================
function getPacientes(){ return DB.get('pacientes') || []; }
function savePacientes(p){ DB.set('pacientes',p); }

// ===================== UNIVERSAL DOWNLOAD (fixes blob:null on iOS/Safari) =====================

// EXPORTACION SEGURA - evita window.open vacio que bloquea antivirus
function abrirDocumentoSeguro(htmlContent, nombreArchivo){
  // Modal interno: funciona en Windows, iPad e iPhone sin bloqueos
  var modal = document.getElementById('_doc_modal_');
  if(!modal){
    modal = document.createElement('div');
    modal.id = '_doc_modal_';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;background:rgba(100,48,0,0.45);display:flex;flex-direction:column;';
    document.body.appendChild(modal);
  }
  var barra = '<div style="background:linear-gradient(135deg,#fadae1,#f5c0ce);padding:10px 16px;display:flex;align-items:center;gap:10px;border-bottom:2px solid #cd8e9d;flex-shrink:0;">'
    + '<span style="font-family:Georgia,serif;font-style:italic;color:#643000;font-size:.88rem;flex:1">Luisa Fernanda Garc\u00e9s &middot; Psi\u00f3loga</span>'
    + '<button onclick="var f=document.getElementById(\'_docIframe_\');if(f)f.contentWindow.print();" style="background:#643000;color:#fff;border:none;padding:9px 20px;border-radius:20px;font-size:.85rem;cursor:pointer;">Imprimir / PDF</button>'
    + '<button onclick="document.getElementById(\'_doc_modal_\').style.display=\'none\';" style="background:transparent;border:1.5px solid #cd8e9d;color:#643000;padding:9px 14px;border-radius:20px;font-size:.82rem;cursor:pointer;">Cerrar</button>'
    + '</div>';
  modal.innerHTML = barra + '<iframe id="_docIframe_" style="flex:1;width:100%;border:none;background:#fff;"></iframe>';
  modal.style.display = 'flex';
  var iframe = document.getElementById('_docIframe_');
  var doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write(htmlContent);
  doc.close();
}

function descargarArchivo(contenido, nombreArchivo, tipo){
  try {
    // M√©todo universal: URL.createObjectURL funciona en Chrome/Edge/Firefox incluso con file://
    var blob = new Blob([contenido], {type: tipo || 'application/octet-stream'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
      try{ URL.revokeObjectURL(url); document.body.removeChild(a); }catch(er){}
    }, 2000);
  } catch(err){
    toast('Error al descargar: ' + err.message);
  }
}

function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

// ‚îÄ‚îÄ‚îÄ Firma de la psic√≥loga (imagen embedded) ‚îÄ‚îÄ‚îÄ
var FIRMA_B64 = 'data:image/jpeg;base64,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';
var FIRMA_DATA = FIRMA_B64;

function crearPaciente(){
  const nombre = document.getElementById('np-nombre').value.trim();
  if(!nombre){ toast('Ingresa el nombre del paciente'); return; }
  const pacs = getPacientes();
  const nuevo = {
    id: genId(),
    nombre,
    fnac: document.getElementById('np-fnac').value,
    genero: document.getElementById('np-genero').value,
    tel: document.getElementById('np-tel').value,
    email: document.getElementById('np-email').value,
    ocup: document.getElementById('np-ocup').value,
    cc: document.getElementById('np-cc').value,
    emergNombre: document.getElementById('np-emerg-nombre').value,
    emergParentesco: document.getElementById('np-emerg-parentesco').value,
    emergTel: document.getElementById('np-emerg-tel').value,
    dx: document.getElementById('np-dx').value,
    creado: new Date().toISOString()
  };
  pacs.push(nuevo);
  savePacientes(pacs);
  // Limpiar formulario
  ['np-nombre','np-fnac','np-tel','np-email','np-ocup','np-cc','np-emerg-nombre','np-emerg-tel','np-dx'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('np-genero').value='';
  document.getElementById('np-emerg-parentesco').value='';
  renderPacientes();
  fillSelects();
  toast('Paciente creado ‚úì');
}

function renderPacientes(){
  const pacs = getPacientes();
  const busq = (document.getElementById('buscar-pac')?.value||'').toLowerCase();
  const grid = document.getElementById('lista-pacientes');
  let filtrados = pacs;
  if(busq) filtrados = pacs.filter(p=>p.nombre.toLowerCase().includes(busq));
  if(!filtrados.length){ grid.innerHTML='<p style="color:var(--border);font-size:.85rem">No se encontraron pacientes.</p>'; return; }
  grid.innerHTML = filtrados.map(p => {
    const nCancels = getCancelacionesCount(p.id);
    const cancelBadge = nCancels ? `<span class="cancel-badge">${nCancels} cancel.</span>` : '';
    return `<div class="patient-card" onclick="abrirPacModal('${p.id}')">
      <h3>${p.nombre}${cancelBadge}</h3>
      <div class="meta">${p.ocup||'‚Äî'} ¬∑ ${calcEdad(p.fnac)}</div>
      ${p.dx ? `<div style="font-size:.72rem;color:var(--strong);margin-top:3px;font-style:italic">${p.dx.slice(0,50)}${p.dx.length>50?'...':''}</div>` : ''}
      <div class="badge">${getSesionesCount(p.id)} sesi√≥n(es)</div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn" style="font-size:.72rem;padding:4px 10px" onclick="event.stopPropagation();seleccionarPacienteDirecto('${p.id}')">Seleccionar</button>
        <button class="btn" style="font-size:.72rem;padding:4px 10px" onclick="event.stopPropagation();abrirPacModal('${p.id}')">Ver historial</button>
      </div>
    </div>`;
  }).join('');
}

function getCancelacionesCount(pid){
  const ses = DB.get('sesiones_'+pid)||[];
  return ses.filter(s=>s.tipo==='cancelacion').length;
}

function seleccionarPacienteDirecto(id){
  ['an-sel-pac','pl-sel-pac','ses-sel-pac','tst-sel-pac','seg-sel-pac'].forEach(sid=>{
    const el=document.getElementById(sid); if(el) el.value=id;
  });
  toast('Paciente seleccionado ‚úì');
}

function calcEdad(fnac){
  if(!fnac) return '';
  const diff = Date.now() - new Date(fnac).getTime();
  const age = Math.floor(diff / (1000*60*60*24*365.25));
  return age + ' a√±os';
}

function getSesionesCount(pid){
  const ses = DB.get('sesiones_'+pid) || [];
  return ses.length;
}

function selectPaciente(id){
  ['an-sel-pac','pl-sel-pac','ses-sel-pac','tst-sel-pac','seg-sel-pac'].forEach(sid => {
    const el = document.getElementById(sid);
    if(el) el.value = id;
  });
  toast('Paciente seleccionado');
}

function fillSelects(){
  const pacs = getPacientes();
  const opts = '<option value="">‚Äî Seleccionar paciente ‚Äî</option>' + pacs.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
  ['an-sel-pac','pl-sel-pac','ses-sel-pac','tst-sel-pac','seg-sel-pac'].forEach(sid => {
    const el = document.getElementById(sid);
    if(el){ const v=el.value; el.innerHTML=opts; el.value=v; }
  });
  // Poblar selector de pacientes en finanzas
  const rSel = document.getElementById('r_pac_selector');
  if(rSel){
    const optsR = '<option value="">‚Äî Seleccionar paciente registrada ‚Äî</option>' + pacs.map(p=>`<option value="${p.nombre}">${p.nombre}</option>`).join('');
    rSel.innerHTML = optsR;
  }
}

function rellenarPacienteDesdeSelector(){
  var sel = document.getElementById('r_pac_selector');
  if(!sel || !sel.value) return;
  var input = document.getElementById('r_paciente');
  if(input) input.value = sel.value;
}

// ===================== NAV =====================
function goPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(name==='cumpleanos') renderCumpleanos();
  event.currentTarget.classList.add('active');
  if(name==='dashboard') renderDashboard();
  if(name==='pacientes') renderPacientes();
  if(name==='tests') loadTest();
  if(name==='seguimiento') loadSeguimiento();
  if(name==='agenda'){ renderAgenda(); agActualizarBadgeCumple(); }
  if(name==='finanzas') renderAll();
  if(name==='documentos') renderDocumentos();
}

// ===================== TABS =====================
function switchTab(prefix, name){
  const page = document.getElementById('page-'+prefix) || document.querySelector('.page.active');
  page.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  page.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const el = document.getElementById(prefix+'-'+name);
  if(el) el.classList.add('active');
  event.currentTarget.classList.add('active');
}

// ===================== ANAMNESIS =====================
// nombre, edad, genero, tel, email, ocup come from the patient profile ‚Äî not duplicated here
const AN_FIELDS = ['fecha','estado','edu','estrato','ciudad','emergN','emergParent','emergT','motivo','decision','duracion','intensidad','intentos','dx','ttoPrev','hosp','hospD','med','desarrollo','famMental','relFam','pens','creencias','conductas','placer','emociones','sinFis','mant','dc-obs','salc','salcD','stab','stabD','scan','scanD','sotras','sobs','alCond','alImag','alPeso','alEmoc','suCal','suHoras','suAcost','suLev','suAlter','suObs','trEv','trImp','trAten','raCal','raAis','raPers','raRel','raCrisis','mCorto','mMedio','mLargo','oAfront','oActit','oFortal','oRiesgo','oNotas','cc-situacion','cc-pa','cc-significado','cc-emocion','cc-hipotesis'];

function loadAnamnesis(){
  const pid = document.getElementById('an-sel-pac').value;
  if(!pid) return;
  // Si Firebase aun no cargo, esperar y reintentar
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ loadAnamnesis(); }); return; }

  // Pull patient profile data and show in read-only card
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{};
  const edad = calcEdad(pac.fnac);
  document.getElementById('an-pac-nombre-disp').textContent = pac.nombre||'‚Äî';
  const meta = [pac.genero, edad, pac.ocup, pac.tel, pac.email].filter(Boolean).join(' ¬∑ ');
  document.getElementById('an-pac-meta-disp').textContent = meta||'‚Äî';

  // Load saved anamnesis fields (excluding fields now in patient profile)
  const data = DB.get('anamnesis_'+pid) || {};
  AN_FIELDS.forEach(f=>{
    const el = document.getElementById('an-'+f);
    if(el) el.value = data[f]||'';
  });
  // radio
  const modalidad = data['modalidad'];
  if(modalidad){ document.querySelectorAll('input[name="an-modalidad"]').forEach(r=>{ r.checked = r.value===modalidad; }); }
  document.getElementById('an-ival').textContent = data['intensidad']||5;
  // Load distortions
  window._dcSeleccionadas = data['distorsiones'] || {};
  renderDCGrid();
}

function guardarAnamnesis(){
  const pid = document.getElementById('an-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente primero'); return; }
  const data = {};
  AN_FIELDS.forEach(f=>{ const el=document.getElementById('an-'+f); if(el) data[f]=el.value; });
  const rad = document.querySelector('input[name="an-modalidad"]:checked');
  data['modalidad'] = rad ? rad.value : '';
  // Save distortions
  data['distorsiones'] = window._dcSeleccionadas || {};
  DB.set('anamnesis_'+pid, data);
  toast('Anamnesis guardada ‚úì');
  // Limpiar formulario
  AN_FIELDS.forEach(function(f){ var el=document.getElementById('an-'+f); if(el) el.value=''; });
  document.querySelectorAll('input[name="an-modalidad"]').forEach(function(r){ r.checked=false; });
  window._dcSeleccionadas = {};
  renderDCGrid();
  document.getElementById('an-sel-pac').value='';
  var ndEl=document.getElementById('an-pac-nombre-disp');
  var mdEl=document.getElementById('an-pac-meta-disp');
  if(ndEl) ndEl.textContent='‚Äî';
  if(mdEl) mdEl.textContent='‚Äî';
}

function exportarAnamnesis(){
  const pid = document.getElementById('an-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const nombrePac = pac.nombre;
  const data = DB.get('anamnesis_'+pid) || {};
  // Merge patient profile data into export
  const d = {...data, nombre: pac.nombre, genero: pac.genero||'', ocup: pac.ocup||'', tel: pac.tel||'', email: pac.email||'', edad: pac.fnac ? calcEdad(pac.fnac) : ''};

  // Convert any character outside ASCII to RTF unicode escape \uN?
  function rtfEncode(str) {
    if(!str) return '';
    let out = '';
    for(let i = 0; i < str.length; i++) {
      const code = str.charCodeAt(i);
      if(code > 127) {
        // RTF unicode: \uN? where N is signed 16-bit, ? is fallback char
        const signed = code > 32767 ? code - 65536 : code;
        out += '\\u' + signed + '?';
      } else if(code === 92) { out += '\\\\'; }
      else if(code === 123) { out += '\\{'; }
      else if(code === 125) { out += '\\}'; }
      else { out += str[i]; }
    }
    return out;
  }

  function sec(t){ return `{\\pard\\sb280\\sa80 {\\b\\fs24\\cf2 ${rtfEncode(t)}}\\par}`; }
  function sub(t){ return `{\\pard\\sb160\\sa40 {\\b\\fs20\\cf3 ${rtfEncode(t)}}\\par}`; }
  function campo(label, val){ if(!val||val==='‚Äî'||val==='') return ''; return `{\\pard\\sb80\\sa40 {\\b\\fs18\\cf1 ${rtfEncode(label)}: }{\\fs18\\cf1 ${rtfEncode(String(val)||'‚Äî')}}\\par}`; }

  const fechaHoy = new Date().toLocaleDateString('es-CO');
  const partes = [
    '{\\rtf1\\ansi\\ansicpg1252\\uc1\\deff0',
    '{\\fonttbl{\\f0\\fswiss Arial;}{\\f1\\froman Georgia;}}',
    '{\\colortbl;\\red100\\green48\\blue0;\\red205\\green142\\blue157;\\red160\\green83\\blue106;}',
    `{\\pard\\sb0\\sa120 {\\f1\\b\\fs32\\cf2 ${rtfEncode('ANAMNESIS PSICOL√ìGICA')}}\\par}`,
    `{\\pard\\sb0\\sa60 {\\f0\\fs20\\cf1 ${rtfEncode('Luisa Fernanda Garc√©s Garc√≠a ¬∑ Psic√≥loga ¬∑ TP 174366')}}\\par}`,
    `{\\pard\\sb0\\sa300 {\\f0\\fs18\\cf3 ${rtfEncode('Fecha: ' + fechaHoy)}}\\par}`,
    sec('I. DATOS PERSONALES'),
    campo('Nombre', d.nombre), campo('Edad', d.edad), campo('G√©nero', d.genero),
    campo('Ocupaci√≥n', d.ocup), campo('Estado civil', d.estado), campo('Tel√©fono', d.tel),
    campo('Email', d.email), campo('Contacto emergencia', (d.emergN||'')+(d.emergT?' | '+d.emergT:'')),
    sec('II. MOTIVO DE CONSULTA'),
    campo('Motivo', d.motivo), campo('¬øPor qu√© ahora?', d.decision),
    campo('Duraci√≥n', d.duracion), campo('Intensidad (1-10)', (d.intensidad||'')+'/10'), campo('Intentos previos', d.intentos),
    sec('III. HISTORIA CL√çNICA'),
    campo('Diagn√≥sticos previos', d.dx), campo('Tratamientos anteriores', d.ttoPrev),
    campo('Hospitalizaciones', d.hosp+(d.hospD?' - '+d.hospD:'')), campo('Medicaci√≥n', d.med),
    campo('Historia del desarrollo', d.desarrollo), campo('Antecedentes familiares', d.famMental),
    sec('IV. EVALUACI√ìN C-C-E'),
    sub('A. Cognitiva'), campo('Pensamientos autom√°ticos', d.pens), campo('Creencias nucleares', d.creencias),
    sub('B. Conductual'), campo('Conductas problema', d.conductas), campo('Actividades placenteras', d.placer),
    sub('C. Emocional'), campo('Emoci√≥n predominante', d.emociones), campo('S√≠ntomas f√≠sicos', d.sinFis),
    sub('D. Distorsiones Cognitivas e Ideas Irracionales'),
    (function(){
      var dcData = d.distorsiones || {};
      if(dcData['__no_aplica']) return campo('Distorsiones', 'No aplica');
      var seleccionadas = Object.keys(dcData).filter(function(k){ return dcData[k] && k!=='__no_aplica'; });
      if(!seleccionadas.length) return '';
      var lineas = seleccionadas.map(function(id){
        var dist = DISTORSIONES.find(function(x){ return x.id===id; });
        var nivel = dcData[id] && dcData[id].nivel ? ' ('+dcData[id].nivel+')' : '';
        return dist ? dist.name + nivel : id + nivel;
      });
      return campo('Distorsiones identificadas', lineas.join(' | ')) + campo('Observaciones', d['dc-obs']||'');
    })(),
    sec('V. CONCEPTUALIZACI√ìN COGNITIVA'),
    campo('Situaci√≥n desencadenante', d['cc-situacion']),
    campo('Pensamientos autom√°ticos', d['cc-pa']),
    campo('Creencia nuclear subyacente', d['cc-significado']),
    campo('Emoci√≥n y conducta resultante', d['cc-emocion']),
    campo('Hip√≥tesis de trabajo', d['cc-hipotesis']),
    sec('X. METAS TERAP√âUTICAS'),
    campo('Corto plazo', d.mCorto), campo('Mediano plazo', d.mMedio), campo('Largo plazo', d.mLargo),
    '{\\pard\\sb300\\sa200\\brdrb\\brdrs\\brdrw10 \\par}',
    `{\\pard\\sb200\\sa80 {\\b\\fs22\\cf2 ${rtfEncode('FIRMAS')}}\\par}`,
    `{\\pard\\sb120\\sa120 {\\f0\\fs20\\cf1 ${rtfEncode('Paciente: _________________________________     Fecha: ___-___-_____')}}\\par}`,
    `{\\pard\\sb60\\sa60 {\\f0\\b\\fs20\\cf1 ${rtfEncode('Terapeuta: Luisa Fernanda Garc√©s Garc√≠a     TP 174366')}}\\par}`,
    '}'
  ];
  const rtf = partes.filter(Boolean).join('\n');
  descargarArchivo(rtf, 'Anamnesis_'+nombrePac.replace(/\s+/g,'_')+'.rtf', 'application/octet-stream');
  toast('Anamnesis exportada ‚úì ‚Äî √Åbrela en Word para editar');
}

// ===================== PLAN =====================
function loadPlan(){
  const pid = document.getElementById('pl-sel-pac').value;
  if(!pid) return;
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ loadPlan(); }); return; }
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ loadPlan(); }); return; }
  const data = DB.get('plan_'+pid) || {};
  ['fecha','modalidad','frecuencia','dx','objetivo','t1','t2','mat','apps','emerg'].forEach(f=>{
    const el = document.getElementById('pl-'+f);
    if(el) el.value = data[f]||'';
  });
  if(!data['fecha']){ document.getElementById('pl-fecha').valueAsDate = new Date(); }
  // fases
  if(data.fases){
    const tbody = document.getElementById('pl-fases-body');
    tbody.innerHTML = '';
    data.fases.forEach((f,i) => {
      tbody.innerHTML += `<tr>
        <td>${i+1}</td>
        <td><input type="text" value="${f[0]||''}"></td>
        <td><textarea>${f[1]||''}</textarea></td>
        <td><textarea>${f[2]||''}</textarea></td>
        <td><input type="text" value="${f[3]||''}"></td>
      </tr>`;
    });
  }
}

function guardarPlan(){
  const pid = document.getElementById('pl-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const data = {};
  ['fecha','modalidad','frecuencia','dx','objetivo','t1','t2','mat','apps','emerg'].forEach(f=>{
    const el = document.getElementById('pl-'+f); if(el) data[f]=el.value;
  });
  const rows = document.querySelectorAll('#pl-fases-body tr');
  data.fases = Array.from(rows).map(r=>{
    const inputs = r.querySelectorAll('input,textarea');
    return [inputs[0]?.value||'', inputs[1]?.value||'', inputs[2]?.value||'', inputs[3]?.value||''];
  });
  try { DB.set('plan_'+pid, data); } catch(e){ console.warn('DB:',e); }
  toast('Plan guardado correctamente');
}

function limpiarPlan(){
  if(!confirm('Limpiar el formulario para ingresar un plan nuevo?')) return;
  ['dx','objetivo','t1','t2','mat','apps','emerg'].forEach(function(f){
    var el = document.getElementById('pl-'+f); if(el) el.value='';
  });
  var m = document.getElementById('pl-modalidad'); if(m) m.selectedIndex=0;
  var fr = document.getElementById('pl-frecuencia'); if(fr) fr.selectedIndex=0;
  var fe = document.getElementById('pl-fecha'); if(fe) fe.value='';
  var tb = document.getElementById('pl-fases-body'); if(tb) tb.innerHTML='';
  var sel = document.getElementById('pl-sel-pac'); if(sel) sel.value='';
  toast('Formulario limpiado');
}

function addFaseRow(){
  const tbody = document.getElementById('pl-fases-body');
  const n = tbody.rows.length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${n}</td><td><input type="text"></td><td><textarea style="min-height:50px"></textarea></td><td><textarea style="min-height:50px"></textarea></td><td><input type="text"></td>`;
  tbody.appendChild(tr);
}

function leerDatosPlan(){
  var data = {};
  ['fecha','modalidad','frecuencia','dx','objetivo','t1','t2','mat','apps','emerg'].forEach(function(f){
    var el = document.getElementById('pl-'+f); if(el) data[f] = el.value;
  });
  var rows = document.querySelectorAll('#pl-fases-body tr');
  data.fases = Array.from(rows).map(function(r){
    var inp = r.querySelectorAll('input,textarea');
    return [inp[0]?inp[0].value:'', inp[1]?inp[1].value:'', inp[2]?inp[2].value:'', inp[3]?inp[3].value:''];
  });
  return data;
}

function entregablePlan(){
  var pid = document.getElementById('pl-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  var pacs = getPacientes();
  var pac = pacs.find(function(p){ return p.id===pid; }) || {nombre:'Paciente'};
  var logoSrc = document.getElementById('logo-img') ? document.getElementById('logo-img').src : '';
  var data = leerDatosPlan();
  var fechaDoc = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});

  function esc(v){ return (v||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  var colores = ['#fadae1','#f5eaec','#fff0f3','#fce8ed'];
  var fasesHtml = (data.fases||[]).filter(function(f){ return f[0]||f[1]||f[2]; }).map(function(f,i){
    return '<div style="background:'+colores[i%4]+';border-radius:12px;padding:14px 18px;margin-bottom:10px;border-left:4px solid #cd8e9d;">'
      +'<div style="font-weight:700;color:#a0536a;font-size:.82rem;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;">Fase '+(i+1)+(f[0]?' ‚Äî '+esc(f[0]):'')+(f[3]?' &nbsp;&middot;&nbsp; <span style=\'color:#cd8e9d\'>'+esc(f[3])+' semanas</span>':'')+'</div>'
      +(f[1]?'<div style="font-size:.85rem;color:#643000;margin-bottom:4px;"><strong>Objetivos:</strong> '+esc(f[1])+'</div>':'')
      +(f[2]?'<div style="font-size:.85rem;color:#643000;"><strong>T√©cnicas:</strong> '+esc(f[2])+'</div>':'')
      +'</div>';
  }).join('');

  var html = '<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">'
  +'<style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;background:#fff;color:#3a1a00;font-size:13px;line-height:1.7;padding:36px 40px;max-width:720px;margin:0 auto;}'
  +'.header{display:flex;align-items:center;justify-content:space-between;padding-bottom:16px;border-bottom:3px solid #cd8e9d;margin-bottom:24px;}'
  +'.logo{height:60px;object-fit:contain;}.prof-name{font-size:1.05rem;color:#643000;font-weight:700;font-style:italic;}.prof-sub{font-size:.7rem;color:#cd8e9d;letter-spacing:.8px;text-transform:uppercase;}'
  +'.portada{background:linear-gradient(135deg,#fadae1,#f5c8d4);border-radius:14px;padding:24px 28px;margin-bottom:24px;text-align:center;}'
  +'.portada h1{font-size:1.4rem;color:#643000;margin-bottom:6px;}.portada p{font-size:.85rem;color:#a0536a;}'
  +'.sec{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:#cd8e9d;margin:20px 0 8px;}'
  +'.caja{background:#fff8f9;border:2px solid #cd8e9d;border-left:6px solid #a0536a;border-radius:0 10px 10px 0;padding:12px 16px;font-size:.9rem;line-height:1.7;margin-bottom:8px;}'
  +'.recurso{background:#fdf5f7;border-radius:10px;padding:10px 14px;margin-bottom:8px;font-size:.85rem;}'
  +'.compromiso{background:linear-gradient(135deg,#fff8f9,#fadae1);border:2px solid #cd8e9d;border-radius:14px;padding:20px 24px;margin-top:24px;text-align:center;}'
  +'.cita{font-style:italic;color:#643000;line-height:1.8;margin-bottom:18px;font-size:.9rem;}'
  +'.firmas{display:flex;gap:36px;justify-content:center;}'
  +'.fb{flex:1;max-width:220px;text-align:center;}.fl{font-size:.65rem;font-weight:700;text-transform:uppercase;color:#a0536a;letter-spacing:.5px;margin-bottom:8px;}'
  +'.fi{height:50px;object-fit:contain;display:block;margin:0 auto 6px;}.fn{border-top:1.5px solid #cd8e9d;padding-top:5px;font-size:.8rem;color:#643000;}.fs{font-size:.62rem;color:#cd8e9d;margin-top:2px;}'
  +'.pie{text-align:center;font-size:.62rem;color:#cd8e9d;margin-top:18px;font-style:italic;}'
  +'@media print{@page{margin:1.5cm}body{padding:0}}</style></head><body>'
  +'<div class="header">'
  +(logoSrc?'<img class="logo" src="'+logoSrc+'" alt="Logo">':'<div style="width:60px;height:60px;background:#fadae1;border-radius:10px;text-align:center;line-height:60px;font-size:1.5rem">üå∏</div>')
  +'<div style="text-align:right"><div class="prof-name">Luisa Fernanda Garc√©s Garc√≠a</div><div class="prof-sub">Psic√≥loga ¬∑ TP 174366</div></div></div>'
  +'<div class="portada"><h1>üåø Mi Plan de Tratamiento</h1><p>'+esc(pac.nombre)+'</p>'
  +(data.fecha||data.modalidad||data.frecuencia?'<p style="margin-top:6px;font-size:.78rem;opacity:.8">'+(data.fecha?'Inicio: '+esc(data.fecha)+' &nbsp;&middot;&nbsp; ':'')+esc(data.modalidad||'')+(data.frecuencia?' &nbsp;&middot;&nbsp; '+esc(data.frecuencia):'')+'</p>':'')
  +'</div>'
  +(data.dx?'<div class="sec">Diagn√≥stico de trabajo</div><div style="background:#fdf5f7;border-radius:10px;padding:12px 16px;font-size:.88rem;">'+esc(data.dx)+'</div>':'')
  +(data.objetivo?'<div class="sec">Objetivo principal</div><div class="caja">'+esc(data.objetivo)+'</div>':'')
  +((data.t1||data.t2)?'<div class="sec">Objetivos espec√≠ficos</div>'+(data.t1?'<div class="caja" style="border-left-color:#cd8e9d;margin-bottom:8px;">'+esc(data.t1)+'</div>':'')+(data.t2?'<div class="caja" style="border-left-color:#cd8e9d;">'+esc(data.t2)+'</div>':''):'')
  +(fasesHtml?'<div class="sec">Fases del proceso</div>'+fasesHtml:'')
  +((data.mat||data.apps||data.emerg)?'<div class="sec">Recursos y apoyos</div>'+(data.mat?'<div class="recurso"><strong>Materiales:</strong> '+esc(data.mat)+'</div>':'')+(data.apps?'<div class="recurso"><strong>Apps:</strong> '+esc(data.apps)+'</div>':'')+(data.emerg?'<div class="recurso"><strong>Plan de emergencias:</strong> '+esc(data.emerg)+'</div>':''):'')
  +'<div class="compromiso"><div class="cita">"He le√≠do y comprendo mi plan de tratamiento. Me comprometo a participar activamente en mi proceso terap√©utico."</div>'
  +'<div class="firmas">'
  +'<div class="fb"><div class="fl">Paciente</div><div style="height:48px;border-bottom:1.5px solid #cd8e9d;margin-bottom:6px;"></div><div class="fn">'+esc(pac.nombre)+'</div><div class="fs">Fecha: ___-___-_____</div></div>'
  +'<div class="fb"><div class="fl">Psic√≥loga Tratante</div><img class="fi" src="'+FIRMA_DATA+'" alt="Firma"><div class="fn"><strong>Luisa Fernanda Garc√©s Garc√≠a</strong></div><div class="fs">TP 174366 ¬∑ '+fechaDoc+'</div></div>'
  +'</div></div>'
  +'<div class="pie">Generado el '+fechaDoc+' ¬∑ Documento confidencial ¬∑ Suite Cl√≠nica</div>'
  +'</body></html>';

  // Agregar botones de imprimir y WhatsApp al HTML antes de mostrarlo
  var telPac = pac.tel ? pac.tel.replace(/\D/g,'') : '';
  // Si el n√∫mero es colombiano de 10 d√≠gitos, agregar c√≥digo de pa√≠s
  if(telPac.length === 10) telPac = '57' + telPac;
  var msgWA = encodeURIComponent('Hola ' + pac.nombre + ', te comparto tu Plan de Tratamiento. Por favor impr√≠melo o gu√°rdalo.');
  var waUrl = telPac ? 'https://wa.me/' + telPac + '?text=' + msgWA : 'https://wa.me/?text=' + msgWA;

  var htmlConBotones = html.replace('</body></html>',
    '<div style="position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999" class="no-print">'
    + '<button onclick="window.print()" style="background:#a0536a;color:#fff;border:none;padding:12px 22px;border-radius:24px;font-size:.88rem;cursor:pointer;box-shadow:0 4px 16px rgba(100,48,0,.25);font-family:Arial,sans-serif">üñ®Ô∏è Guardar como PDF</button>'
    + '</div></body></html>'
  );

  abrirDocumentoSeguro(htmlConBotones, 'PlanTratamiento_'+pac.nombre.replace(/\s+/g,'_')+'.html');

  // Bot√≥n WhatsApp en toast
  toast('üå∏ Entregable listo ‚Äî usa el bot√≥n rojo para guardar PDF');

  // Mostrar bot√≥n WhatsApp flotante en la app principal
  var waBtnExist = document.getElementById('_wa_btn_plan_');
  if(waBtnExist) waBtnExist.remove();
  var waBtn = document.createElement('a');
  waBtn.id = '_wa_btn_plan_';
  waBtn.href = waUrl;
  waBtn.target = '_blank';
  waBtn.innerHTML = 'üí¨ Enviar por WhatsApp a ' + pac.nombre.split(' ')[0];
  waBtn.style.cssText = 'position:fixed;bottom:80px;right:24px;background:#25D366;color:#fff;border-radius:24px;padding:12px 20px;font-size:.85rem;font-family:Arial,sans-serif;text-decoration:none;z-index:9998;box-shadow:0 4px 16px rgba(0,0,0,.2);cursor:pointer;';
  document.body.appendChild(waBtn);
  setTimeout(function(){ if(waBtn.parentNode) waBtn.parentNode.removeChild(waBtn); }, 30000);
}


function exportarPlanDocx(){
  const pid = document.getElementById('pl-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const data = leerDatosPlan();
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const logoSrc = document.getElementById('logo-img').src;

  let fasesTabla = '<table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">Fase</th><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">Objetivos</th><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">T√©cnicas</th><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">Semanas</th></tr></thead><tbody>';
  (data.fases||[]).forEach(f => {
    fasesTabla += `<tr><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[0]}</td><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[1]}</td><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[2]}</td><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[3]}</td></tr>`;
  });
  fasesTabla += '</tbody></table>';

  const fechaDoc = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;color:#643000;background:white;padding:32px 38px;font-size:14px;max-width:900px;margin:0 auto;}
  .header{display:flex;align-items:center;gap:18px;border-bottom:3px solid #cd8e9d;padding-bottom:16px;margin-bottom:24px;background:linear-gradient(135deg,#fff8f9,#fadae1);padding:16px 20px;border-radius:12px;}
  .header img{height:70px;object-fit:contain;}.header-info h1{font-size:1.15rem;color:#643000;margin-bottom:2px;font-family:Georgia,serif;font-style:italic;}.header-info p{font-size:0.7rem;color:#cd8e9d;letter-spacing:1.5px;text-transform:uppercase;margin-top:2px;}
  .header-info .tp{font-size:.68rem;color:#a0536a;margin-top:4px;}
  .doc-title{text-align:center;margin:20px 0 24px;font-family:Georgia,serif;font-size:1.4rem;color:#643000;border-bottom:2px solid #fadae1;padding-bottom:12px;}
  h2{font-size:.95rem;color:#a0536a;margin:20px 0 8px;padding:6px 12px;background:#fadae1;border-left:4px solid #cd8e9d;border-radius:0 8px 8px 0;text-transform:uppercase;letter-spacing:.5px;}
  .dato{margin:5px 0 5px 4px;font-size:.9rem;}.dato strong{color:#cd8e9d;}
  .objetivo{background:#fff8f9;border:1.5px solid #cd8e9d;border-left:5px solid #cd8e9d;padding:12px 16px;border-radius:0 10px 10px 0;margin:10px 0;font-size:.9rem;line-height:1.6;}
  table{width:100%;border-collapse:collapse;margin-top:8px;}th{background:#fadae1;color:#643000;padding:8px 10px;border:1px solid #cd8e9d;font-size:.78rem;text-align:left;}td{padding:8px 10px;border:1px solid #f0d8de;font-size:.84rem;vertical-align:top;line-height:1.5;}
  .firmas{margin-top:40px;border-top:2px solid #fadae1;padding-top:24px;display:flex;gap:40px;flex-wrap:wrap;}
  .firma-bloque{flex:1;min-width:220px;}.firma-label{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#a0536a;margin-bottom:4px;}
  .firma-img{height:60px;display:block;margin-bottom:4px;}
  .firma-linea{border-top:1.5px solid #cd8e9d;padding-top:6px;font-size:.82rem;color:#643000;}
  .fecha-doc{text-align:right;font-size:.72rem;color:#cd8e9d;margin-top:6px;}
  @media print{@page{margin:1.8cm}body{padding:0}}</style></head><body>
  <div class="header"><img src="${logoSrc}" alt="Logo"><div class="header-info"><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p><p class="tp">NIT ¬∑ Consultorio privado</p></div></div>
  <div class="doc-title">Plan de Tratamiento Psicol√≥gico</div>
  <div class="dato"><strong>Paciente:</strong> ${pac.nombre}</div>
  <div class="dato"><strong>Fecha inicio:</strong> ${data.fecha||'‚Äî'}</div>
  <div class="dato"><strong>Modalidad:</strong> ${data.modalidad||'‚Äî'} &nbsp;¬∑&nbsp; <strong>Frecuencia:</strong> ${data.frecuencia||'‚Äî'}</div>
  <div class="dato"><strong>Documento generado:</strong> ${fechaDoc}</div>
  <h2>Diagn√≥stico de Trabajo</h2><div class="dato" style="margin-left:4px">${data.dx||'‚Äî'}</div>
  <h2>Objetivo General</h2><div class="objetivo">${data.objetivo||'‚Äî'}</div>
  ${data.t1?'<h2>Objetivo Espec√≠fico 1</h2><div class="objetivo">'+data.t1+'</div>':''}
  ${data.t2?'<h2>Objetivo Espec√≠fico 2</h2><div class="objetivo">'+data.t2+'</div>':''}
  <h2>Fases del Proceso Terap√©utico</h2>${fasesTabla}
  ${(data.mat||data.apps||data.emerg)?'<h2>Recursos y Consideraciones</h2>':''}
  ${data.mat?'<div class="dato"><strong>üìö Materiales:</strong> '+data.mat+'</div>':''}
  ${data.apps?'<div class="dato"><strong>üì± Apps / herramientas:</strong> '+data.apps+'</div>':''}
  ${data.emerg?'<div class="dato"><strong>üö® Plan de emergencias:</strong> '+data.emerg+'</div>':''}
  <div class="firmas">
    <div class="firma-bloque">
      <div class="firma-label">Paciente</div>
      <div style="height:60px;border-bottom:1.5px solid #cd8e9d;margin-bottom:4px"></div>
      <div class="firma-linea">${pac.nombre}</div>
      <div class="fecha-doc">Fecha: ___-___-_____</div>
    </div>
    <div class="firma-bloque">
      <div class="firma-label">Psic√≥loga Tratante</div>
      <img class="firma-img" src="${FIRMA_DATA}" alt="Firma">
      <div class="firma-linea"><strong>Luisa Fernanda Garc√©s Garc√≠a</strong></div>
      <div class="fecha-doc">TP 174366 &nbsp;¬∑&nbsp; ${fechaDoc}</div>
    </div>
  </div>
  <p style="text-align:center;font-size:.65rem;color:#cd8e9d;margin-top:20px">Documento confidencial de uso cl√≠nico ‚Äî Generado el ${fechaDoc}</p>
  </body></html>`;
  // Descargar directamente como HTML (sin ventana nueva que puede ser bloqueada)
  descargarArchivo(html, 'Plan_Tratamiento_'+pac.nombre.replace(/\s+/g,'_')+'.html', 'application/octet-stream');
  toast('üìÑ Descargado. √Åbrelo en el navegador y usa Imprimir ‚Üí Guardar como PDF');
}// ===================== SESIONES =====================
let currentSesionId = null;

function loadSesiones(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ document.getElementById('lista-sesiones').innerHTML=''; return; }
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ loadSesiones(); }); return; }
  renderListaSesiones(pid);
}

function renderListaSesiones(pid){
  const ses = DB.get('sesiones_'+pid) || [];
  const lista = document.getElementById('lista-sesiones');
  if(!ses.length){ lista.innerHTML='<p style="font-size:.8rem;color:var(--border)">Sin sesiones a√∫n.</p>'; return; }
  lista.innerHTML = ses.slice().reverse().map(s => {
    const esCancelacion = s.tipo==='cancelacion';
    return `<div class="session-item ${esCancelacion?'cancelada':''}" onclick="abrirSesion('${pid}','${s.id}')">
      <h4>${esCancelacion?'‚ùå Cancelaci√≥n':'Sesi√≥n #'+s.num}</h4>
      <p>${s.fecha||'Sin fecha'} ¬∑ ${esCancelacion ? (s.motivoCancelacion||'') : (s.dur||50)+' min'}</p>
    </div>`;
  }).join('');
}

function nuevaSesion(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  currentSesionId = null;
  const ses = DB.get('sesiones_'+pid)||[];
  // Auto-numero: next session number (counting only non-cancelled)
  const numSesiones = ses.filter(s=>s.tipo!=='cancelacion').length;
  document.getElementById('ses-num').value = numSesiones+1;
  document.getElementById('ses-fecha').valueAsDate = new Date();
  document.getElementById('ses-dur').value = 50;
  document.getElementById('ses-estado').value = 5;
  document.getElementById('ses-eval').textContent = 5;
  document.getElementById('ses-tipo-sesion').value = 'sesion';
  document.getElementById('ses-motivo-cancel-wrap').style.display='none';
  window._sesDcSeleccionadas = {};
  renderSesDCGrid();
  document.getElementById('ses-form-title').textContent='Nueva Sesi√≥n';
  document.getElementById('sesion-form').style.display='block';
  document.getElementById('sesion-placeholder').style.display='none';
  document.getElementById('sesion-form').scrollIntoView({behavior:'smooth',block:'start'});
}

function toggleCancelacion(){
  const tipo = document.getElementById('ses-tipo-sesion').value;
  document.getElementById('ses-motivo-cancel-wrap').style.display = tipo==='cancelacion' ? 'block' : 'none';
}

function toggleTestOtro(){
  const chk = document.getElementById('ses-test-otro-chk');
  document.getElementById('ses-test-otro').style.display = chk.checked ? 'inline-block' : 'none';
}

function abrirSesion(pid, sid){
  const ses = DB.get('sesiones_'+pid)||[];
  const s = ses.find(x=>x.id===sid);
  if(!s) return;
  currentSesionId = sid;
  document.getElementById('ses-num').value = s.num||'';
  document.getElementById('ses-fecha').value = s.fecha||'';
  document.getElementById('ses-dur').value = s.dur||50;
  document.getElementById('ses-estado').value = s.estado||5;
  document.getElementById('ses-eval').textContent = s.estado||5;
  document.getElementById('ses-tipo-sesion').value = s.tipo||'sesion';
  document.getElementById('ses-motivo-cancel-wrap').style.display = s.tipo==='cancelacion' ? 'block' : 'none';
  if(s.tipo==='cancelacion') document.getElementById('ses-motivo-cancel').value = s.motivoCancelacion||'';
  document.getElementById('ses-temas').value = s.temas||'';
  document.getElementById('ses-inter').value = s.inter||'';
  document.getElementById('ses-avances').value = s.avances||'';
  document.getElementById('ses-tarea').value = s.tarea||'';
  document.getElementById('ses-acuerdos').value = s.acuerdos||'';
  document.getElementById('ses-notas-priv').value = s.notasPriv||'';
  // New fields
  document.getElementById('ses-eventos').value = s.eventos||'';
  document.getElementById('ses-dif-tarea').value = s.dificultadesTarea||'';
  document.getElementById('ses-pensamiento').value = s.pensamiento||'';
  document.getElementById('ses-ajustes').value = s.ajustes||'';
  // Humores
  document.querySelectorAll('#ses-humores input[type=checkbox]').forEach(c=>{
    c.checked = (s.humores||[]).includes(c.value);
  });
  // T√©cnicas
  document.querySelectorAll('#ses-tecnicas input[type=checkbox]').forEach(c=>{
    c.checked = (s.tecnicas||[]).includes(c.value);
  });
  // Tareas check
  document.querySelectorAll('#ses-tareas-check input[type=checkbox]').forEach(c=>{
    c.checked = (s.tareasCheck||[]).includes(c.value);
  });
  // Riesgos
  document.querySelectorAll('input[name=riesgo]').forEach(c=>{
    c.checked = (s.riesgos||[]).includes(c.value);
  });
  // Recursos
  document.querySelectorAll('input[name=recurso]').forEach(c=>{
    c.checked = (s.recursos||[]).includes(c.value);
  });
  // Tarea revisi√≥n
  document.querySelectorAll('input[name=ses-tarea-rev]').forEach(c=>{
    c.checked = c.value === (s.tareaRevision||'');
  });
  // DC sesi√≥n
  window._sesDcSeleccionadas = s.dcSesion || {};
  renderSesDCGrid();
  // Load tests applied
  document.querySelectorAll('#ses-tests-chk input[type=checkbox]').forEach(c=>{
    if(c.value==='Otro'){
      const otroTests = (s.testsAplicados||[]).filter(t=>!['PHQ-9','GAD-7','YSQ-L3','SMI','Escala impulsividad'].includes(t));
      c.checked = otroTests.length>0;
      if(otroTests.length){ document.getElementById('ses-test-otro').value=otroTests[0]; document.getElementById('ses-test-otro').style.display='inline-block'; }
    } else {
      c.checked = (s.testsAplicados||[]).includes(c.value);
    }
  });
  document.getElementById('ses-form-title').textContent = s.tipo==='cancelacion' ? '‚ùå Cancelaci√≥n '+s.fecha : 'Sesi√≥n #'+s.num;
  document.getElementById('ses-resumen-box').style.display='none';
  document.getElementById('ses-export-btns').style.display='none';
  document.getElementById('sesion-form').style.display='block';
  document.getElementById('sesion-placeholder').style.display='none';
}

function guardarSesion(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const ses = DB.get('sesiones_'+pid)||[];
  const tipo = document.getElementById('ses-tipo-sesion').value;
  // Gather tests applied
  const testsAplicados = [];
  document.querySelectorAll('#ses-tests-chk input[type=checkbox]:checked').forEach(c=>{
    if(c.value==='Otro'){
      const otro = document.getElementById('ses-test-otro').value.trim();
      if(otro) testsAplicados.push(otro);
    } else {
      testsAplicados.push(c.value);
    }
  });
  // Gather humores
  const humores = [];
  document.querySelectorAll('#ses-humores input[type=checkbox]:checked').forEach(c=>humores.push(c.value));
  // Gather t√©cnicas
  const tecnicas = [];
  document.querySelectorAll('#ses-tecnicas input[type=checkbox]:checked').forEach(c=>tecnicas.push(c.value));
  // Gather tareas check
  const tareasCheck = [];
  document.querySelectorAll('#ses-tareas-check input[type=checkbox]:checked').forEach(c=>tareasCheck.push(c.value));
  // Gather riesgos
  const riesgos = [];
  document.querySelectorAll('input[name=riesgo]:checked').forEach(c=>riesgos.push(c.value));
  // Gather recursos
  const recursos = [];
  document.querySelectorAll('input[name=recurso]:checked').forEach(c=>recursos.push(c.value));
  // Tarea revisi√≥n
  const tareaRev = document.querySelector('input[name=ses-tarea-rev]:checked');
  
  const sesData = {
    id: currentSesionId || genId(),
    num: document.getElementById('ses-num').value,
    fecha: document.getElementById('ses-fecha').value,
    dur: document.getElementById('ses-dur').value,
    tipo: tipo,
    estado: tipo==='cancelacion' ? 0 : document.getElementById('ses-estado').value,
    motivoCancelacion: tipo==='cancelacion' ? document.getElementById('ses-motivo-cancel').value : '',
    humores: humores,
    eventos: document.getElementById('ses-eventos').value,
    tareaRevision: tareaRev ? tareaRev.value : '',
    dificultadesTarea: document.getElementById('ses-dif-tarea').value,
    temas: document.getElementById('ses-temas').value,
    tecnicas: tecnicas,
    inter: document.getElementById('ses-inter').value,
    pensamiento: document.getElementById('ses-pensamiento').value,
    dcSesion: window._sesDcSeleccionadas || {},
    avances: document.getElementById('ses-avances').value,
    tareasCheck: tareasCheck,
    tarea: document.getElementById('ses-tarea').value,
    acuerdos: document.getElementById('ses-acuerdos').value,
    riesgos: riesgos,
    recursos: recursos,
    ajustes: document.getElementById('ses-ajustes').value,
    notasPriv: document.getElementById('ses-notas-priv').value,
    testsAplicados: testsAplicados,
    guardada: new Date().toISOString()
  };
  if(currentSesionId){
    const idx = ses.findIndex(x=>x.id===currentSesionId);
    if(idx>=0) ses[idx]=sesData; else ses.push(sesData);
  } else {
    ses.push(sesData);
    currentSesionId = sesData.id;
  }
  DB.set('sesiones_'+pid, ses);
  renderListaSesiones(pid);
  toast(tipo==='cancelacion' ? 'Cancelaci√≥n registrada ‚úì' : 'Sesi√≥n guardada ‚úì');
  // Limpiar formulario completamente
  limpiarFormSesion();
}

function limpiarFormSesion(){
  ['ses-temas','ses-inter','ses-avances','ses-tarea','ses-acuerdos','ses-notas-priv','ses-eventos','ses-dif-tarea','ses-pensamiento','ses-ajustes'].forEach(id=>{
    var el = document.getElementById(id); if(el) el.value='';
  });
  document.querySelectorAll('#ses-tests-chk input[type=checkbox]').forEach(c=>c.checked=false);
  document.querySelectorAll('#ses-humores input[type=checkbox]').forEach(c=>c.checked=false);
  document.querySelectorAll('#ses-tecnicas input[type=checkbox]').forEach(c=>c.checked=false);
  document.querySelectorAll('#ses-tareas-check input[type=checkbox]').forEach(c=>c.checked=false);
  document.querySelectorAll('input[name=riesgo]').forEach(c=>c.checked=false);
  document.querySelectorAll('input[name=recurso]').forEach(c=>c.checked=false);
  document.querySelectorAll('input[name=ses-tarea-rev]').forEach(c=>c.checked=false);
  document.getElementById('ses-test-otro').style.display='none';
  document.getElementById('ses-resumen-box').style.display='none';
  document.getElementById('ses-export-btns').style.display='none';
  document.getElementById('ses-estado').value=5;
  document.getElementById('ses-eval').textContent='5';
  document.getElementById('ses-tipo-sesion').value='sesion';
  window._sesDcSeleccionadas = {};
  renderSesDCGrid();
  currentSesionId = null;
  document.getElementById('sesion-form').style.display='none';
  document.getElementById('sesion-placeholder').style.display='flex';
}

// Distorsiones cognitivas en sesi√≥n
window._sesDcSeleccionadas = {};

function renderSesDCGrid(){
  var el = document.getElementById('ses-dc-grid');
  if(!el) return;
  var noAplica = window._sesDcSeleccionadas && window._sesDcSeleccionadas['__no_aplica'];
  if(noAplica){
    el.innerHTML = '<div style="background:#f5eaec;border-radius:8px;padding:8px 14px;font-size:.8rem;color:var(--strong);font-style:italic">No aplica en esta sesi√≥n</div>';
    return;
  }
  el.innerHTML = DISTORSIONES.map(d=>{
    var info = window._sesDcSeleccionadas[d.id]||null;
    var nivel = info ? info.nivel : '';
    return '<div class="dc-item '+(info?'selected':'')+'" id="ses-dc-'+d.id+'" onclick="toggleSesDC(\''+d.id+'\')" style="font-size:.75rem;padding:8px 10px">'
      +'<div class="dc-name" style="font-size:.78rem">'+d.name+'</div>'
      +'<div class="dc-nivel" onclick="event.stopPropagation()">'
      +['Leve','Moderada','Severa'].map(n=>'<button class="dc-nivel-btn '+(nivel===n?'sel':'')+'" onclick="setSesDCNivel(\''+d.id+'\',\''+n+'\')">'+n+'</button>').join('')
      +'</div></div>';
  }).join('');
}

function toggleSesDC(id){
  if(!window._sesDcSeleccionadas) window._sesDcSeleccionadas = {};
  if(window._sesDcSeleccionadas[id]) delete window._sesDcSeleccionadas[id];
  else window._sesDcSeleccionadas[id] = {nivel:''};
  renderSesDCGrid();
}

function setSesDCNivel(id, nivel){
  if(!window._sesDcSeleccionadas) window._sesDcSeleccionadas = {};
  if(!window._sesDcSeleccionadas[id]) window._sesDcSeleccionadas[id] = {};
  window._sesDcSeleccionadas[id].nivel = nivel;
  window._sesDcSeleccionadas[id].selected = true;
  renderSesDCGrid();
}

function sesDcNoAplica(){
  window._sesDcSeleccionadas = {__no_aplica: true};
  renderSesDCGrid();
}

function generarResumen(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const fecha = document.getElementById('ses-fecha').value;
  const num = document.getElementById('ses-num').value;
  const temas = document.getElementById('ses-temas').value;
  const avances = document.getElementById('ses-avances').value;
  const tarea = document.getElementById('ses-tarea').value;
  const acuerdos = document.getElementById('ses-acuerdos').value;
  const fechaFmt = fecha ? new Date(fecha+'T12:00:00').toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'}) : '‚Äî';

  const texto = `Hola ${pac.nombre.split(' ')[0]} üå∏

Aqu√≠ te comparto el resumen de nuestra sesi√≥n #${num} del ${fechaFmt}.

‚îÄ‚îÄ‚îÄ LO QUE TRABAJAMOS HOY ‚îÄ‚îÄ‚îÄ
${temas||'‚Äî'}

‚îÄ‚îÄ‚îÄ TUS AVANCES ‚îÄ‚îÄ‚îÄ
${avances||'‚Äî'}

‚îÄ‚îÄ‚îÄ TU TAREA PARA CASA üìå ‚îÄ‚îÄ‚îÄ
${tarea||'Sin tarea asignada esta semana.'}

‚îÄ‚îÄ‚îÄ ACUERDOS PARA LA PR√ìXIMA SESI√ìN ‚îÄ‚îÄ‚îÄ
${acuerdos||'‚Äî'}

Con cari√±o,
Luisa Fernanda Garc√©s Garc√≠a
Psic√≥loga ¬∑ TP 174366`;

  const box = document.getElementById('ses-resumen-box');
  box.textContent = texto;
  box.style.display='block';
  document.getElementById('ses-export-btns').style.display='flex';
}

function exportarResumenPDF(){
  const pid = document.getElementById('ses-sel-pac').value;
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const texto = document.getElementById('ses-resumen-box').textContent;
  const logoSrc = document.getElementById('logo-img').src;
  const num = document.getElementById('ses-num').value;
  const fecha = document.getElementById('ses-fecha').value;
  const fechaFmt = fecha ? new Date(fecha+'T12:00:00').toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'}) : '‚Äî';

  const lines = texto.split('\n').map(l => {
    if(l.startsWith('‚îÄ‚îÄ‚îÄ')) return `<div style="font-weight:700;color:#cd8e9d;margin:18px 0 6px;font-size:.85rem;letter-spacing:1px">${l}</div>`;
    if(!l.trim()) return '<br>';
    return `<div style="font-size:.9rem;line-height:1.7;color:#643000">${l}</div>`;
  }).join('');

  const fechaGen = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;background:white;padding:36px 40px;max-width:700px;margin:0 auto;}
  .header{display:flex;align-items:center;gap:18px;border-bottom:3px solid #cd8e9d;padding:16px 20px;margin-bottom:24px;background:linear-gradient(135deg,#fff8f9,#fadae1);border-radius:10px;}
  .header img{height:64px;object-fit:contain;}.header h1{font-size:1.1rem;color:#643000;font-family:Georgia,serif;font-style:italic;margin-bottom:2px;}.header p{font-size:.68rem;color:#cd8e9d;letter-spacing:1.3px;text-transform:uppercase;}
  .titulo{font-family:Georgia,serif;font-size:1.3rem;color:#643000;margin-bottom:4px;border-bottom:2px solid #fadae1;padding-bottom:10px;margin-bottom:18px;}
  .sub{font-size:.78rem;color:#a0536a;margin-bottom:24px;background:#fadae1;display:inline-block;padding:4px 12px;border-radius:20px;}
  .firmas{margin-top:44px;border-top:2px solid #fadae1;padding-top:22px;display:flex;gap:40px;}
  .firma-bloque{flex:1;text-align:center;}
  .firma-label{font-size:.7rem;font-weight:700;text-transform:uppercase;color:#a0536a;letter-spacing:.5px;margin-bottom:8px;}
  .firma-img{height:55px;object-fit:contain;margin:0 auto 6px;display:block;}
  .firma-linea{border-top:1.5px solid #cd8e9d;padding-top:6px;font-size:.82rem;color:#643000;}
  .firma-sub{font-size:.68rem;color:#cd8e9d;margin-top:3px;}
  .pie{text-align:center;font-size:.62rem;color:#cd8e9d;margin-top:20px;font-style:italic;}
  @media print{@page{margin:1.8cm}body{padding:0}}</style></head><body>
  <div class="header"><img src="${logoSrc}" alt="Logo"><div><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p></div></div>
  <div class="titulo">Resumen de Sesi√≥n #${num}</div>
  <div class="sub">${fechaFmt} &nbsp;¬∑&nbsp; ${pac.nombre}</div>
  ${lines}
  <div class="firmas">
    <div class="firma-bloque">
      <div class="firma-label">Paciente</div>
      <div style="height:55px;border-bottom:1.5px solid #cd8e9d;margin-bottom:6px"></div>
      <div class="firma-linea">${pac.nombre}</div>
    </div>
    <div class="firma-bloque">
      <div class="firma-label">Psic√≥loga Tratante</div>
      <img class="firma-img" src="${FIRMA_DATA}" alt="Firma">
      <div class="firma-linea"><strong>Luisa Fernanda Garc√©s Garc√≠a</strong></div>
      <div class="firma-sub">TP 174366</div>
    </div>
  </div>
  <div class="pie">Generado el ${fechaGen} ¬∑ Documento confidencial de uso cl√≠nico</div>
  </body></html>`;

  abrirDocumentoSeguro(html, 'Sesion_'+num+'_'+(pac.nombre||'Paciente').replace(/\s+/g,'_')+'.html');
}

function exportarHistoriaClinica(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const logoSrc = document.getElementById('logo-img').src;
  const num = document.getElementById('ses-num').value;
  const fecha = document.getElementById('ses-fecha').value;
  const fechaFmt = fecha ? new Date(fecha+'T12:00:00').toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'}) : '‚Äî';
  const fechaGen = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  
  // Gather current sesion data
  const temas = document.getElementById('ses-temas').value;
  const inter = document.getElementById('ses-inter').value;
  const avances = document.getElementById('ses-avances').value;
  const tarea = document.getElementById('ses-tarea').value;
  const acuerdos = document.getElementById('ses-acuerdos').value;
  const pensamiento = document.getElementById('ses-pensamiento').value;
  const ajustes = document.getElementById('ses-ajustes').value;
  const estadoEl = document.getElementById('ses-estado');
  const estadoVal = estadoEl ? estadoEl.value : '‚Äî';
  
  // Gather t√©cnicas
  const tecnicas = [];
  document.querySelectorAll('#ses-tecnicas input[type=checkbox]:checked').forEach(c=>tecnicas.push(c.value));
  
  // Gather distorsiones sesi√≥n
  const dcSel = window._sesDcSeleccionadas || {};
  const dcTexto = Object.keys(dcSel).filter(k=>k!=='__no_aplica' && dcSel[k]).map(k=>{
    const d = DISTORSIONES.find(x=>x.id===k);
    return d ? d.name + (dcSel[k].nivel ? ' ('+dcSel[k].nivel+')':'') : k;
  }).join(', ') || (dcSel['__no_aplica'] ? 'No aplica' : '‚Äî');

  // Get all sessions for this patient for count
  const allSes = DB.get('sesiones_'+pid)||[];
  const numSes = allSes.filter(s=>s.tipo!=='cancelacion').length;

  // Get anamnesis data for dx
  const anData = DB.get('anamnesis_'+pid)||{};
  const planData = DB.get('plan_'+pid)||{};

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;background:white;padding:36px 40px;max-width:750px;margin:0 auto;color:#333;}
  .header{display:flex;align-items:center;gap:18px;border-bottom:3px solid #cd8e9d;padding:14px 18px;margin-bottom:20px;background:linear-gradient(135deg,#fff8f9,#fadae1);border-radius:10px;}
  .header img{height:64px;object-fit:contain;}.header-txt h1{font-size:1.05rem;color:#643000;font-family:Georgia,serif;font-style:italic;margin-bottom:2px;}.header-txt p{font-size:.65rem;color:#cd8e9d;letter-spacing:1.3px;text-transform:uppercase;}
  .doc-titulo{text-align:center;font-family:Georgia,serif;font-size:1.35rem;color:#643000;margin:18px 0;border-bottom:2px solid #fadae1;padding-bottom:12px;}
  .meta-box{background:#fadae1;border-radius:10px;padding:12px 18px;margin-bottom:18px;display:flex;flex-wrap:wrap;gap:8px;}
  .meta-item{font-size:.82rem;color:#643000;}.meta-item strong{color:#a0536a;}
  h2{font-size:.88rem;color:#a0536a;margin:18px 0 8px;padding:5px 12px;background:#fadae1;border-left:4px solid #cd8e9d;border-radius:0 7px 7px 0;text-transform:uppercase;letter-spacing:.4px;}
  .dato{font-size:.88rem;line-height:1.7;margin-bottom:6px;padding:0 4px;}
  .tag{display:inline-block;background:#f5eaec;color:#a0536a;border-radius:10px;padding:2px 8px;font-size:.75rem;margin:2px;}
  .firmas{margin-top:44px;border-top:2px solid #fadae1;padding-top:22px;display:flex;gap:40px;}
  .firma-bloque{flex:1;text-align:center;}
  .firma-label{font-size:.68rem;font-weight:700;text-transform:uppercase;color:#a0536a;letter-spacing:.5px;margin-bottom:8px;}
  .firma-img{height:52px;object-fit:contain;margin:0 auto 6px;display:block;}
  .firma-linea{border-top:1.5px solid #cd8e9d;padding-top:6px;font-size:.8rem;color:#643000;}
  .firma-sub{font-size:.65rem;color:#cd8e9d;margin-top:2px;}
  .pie{text-align:center;font-size:.6rem;color:#cd8e9d;margin-top:16px;font-style:italic;}
  @media print{@page{margin:1.8cm}body{padding:0}}</style></head><body>
  <div class="header"><img src="${logoSrc}" alt="Logo"><div class="header-txt"><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p></div></div>
  <div class="doc-titulo">Historia Cl√≠nica de Evoluci√≥n</div>
  <div class="meta-box">
    <div class="meta-item"><strong>Paciente:</strong> ${pac.nombre}</div>
    <div class="meta-item"><strong>Sesi√≥n N¬∞:</strong> ${num} (Total acumuladas: ${numSes})</div>
    <div class="meta-item"><strong>Fecha:</strong> ${fechaFmt}</div>
    ${planData.dx ? '<div class="meta-item"><strong>Diagn√≥stico:</strong> '+planData.dx+'</div>' : ''}
    <div class="meta-item"><strong>Estado emocional al inicio:</strong> ${estadoVal}/10</div>
  </div>
  ${temas ? '<h2>Contenido de la Sesi√≥n</h2><div class="dato">'+temas+'</div>' : ''}
  ${pensamiento ? '<h2>Pensamiento Autom√°tico Clave</h2><div class="dato" style="background:#fff8f9;border-left:3px solid #cd8e9d;padding:10px 14px;border-radius:0 8px 8px 0;font-style:italic">"'+pensamiento+'"</div>' : ''}
  ${dcTexto && dcTexto!=='‚Äî' ? '<h2>Distorsiones / Ideas Irracionales Identificadas</h2><div class="dato">'+dcTexto+'</div>' : ''}
  ${tecnicas.length ? '<h2>T√©cnicas Aplicadas</h2><div class="dato">'+tecnicas.map(t=>'<span class="tag">'+t+'</span>').join('')+'</div>' : ''}
  ${inter ? '<h2>Intervenciones y Descripciones</h2><div class="dato">'+inter+'</div>' : ''}
  ${avances ? '<h2>Avances y Observaciones Cl√≠nicas</h2><div class="dato">'+avances+'</div>' : ''}
  ${tarea ? '<h2>Tarea Asignada para Casa</h2><div class="dato">'+tarea+'</div>' : ''}
  ${acuerdos ? '<h2>Acuerdos y Objetivos Pr√≥xima Sesi√≥n</h2><div class="dato">'+acuerdos+'</div>' : ''}
  ${ajustes ? '<h2>Ajustes Terap√©uticos</h2><div class="dato">'+ajustes+'</div>' : ''}
  <div class="firmas">
    <div class="firma-bloque">
      <div class="firma-label">Paciente</div>
      <div style="height:52px;border-bottom:1.5px solid #cd8e9d;margin-bottom:6px"></div>
      <div class="firma-linea">${pac.nombre}</div>
    </div>
    <div class="firma-bloque">
      <div class="firma-label">Psic√≥loga Tratante</div>
      <img class="firma-img" src="${FIRMA_B64}" alt="Firma">
      <div class="firma-linea"><strong>Luisa Fernanda Garc√©s Garc√≠a</strong></div>
      <div class="firma-sub">TP 174366</div>
    </div>
  </div>
  <div class="pie">Generado el ${fechaGen} ¬∑ Documento confidencial de uso cl√≠nico exclusivo</div>
  </body></html>`;
  abrirDocumentoSeguro(html, 'HistoriaClinica_Ses'+num+'_'+(pac.nombre||'Paciente').replace(/\s+/g,'_')+'.html');
}

// ===================== TESTS =====================
const PHQ9_Q = ['Poco inter√©s o placer en hacer cosas','Sentirse deca√≠do/a, deprimido/a o sin esperanza','Problemas para quedarse o mantenerse dormido/a, o dormir demasiado','Sentirse cansado/a o tener poca energ√≠a','Poco apetito o comer en exceso','Sentirse mal consigo mismo/a, sentir que es un fracaso o que ha fallado a s√≠ mismo/a o a su familia','Dificultad para concentrarse en cosas como leer el peri√≥dico o ver la televisi√≥n','Moverse o hablar tan lento que otras personas podr√≠an notarlo, o estar tan inquieto/a que ha estado movi√©ndose mucho m√°s de lo normal','Pensamientos de que estar√≠a mejor muerto/a o de hacerse da√±o de alguna manera'];
const GAD7_Q = ['Sentirse nervioso/a, ansioso/a o con los nervios de punta','No poder dejar de preocuparse o no poder controlar la preocupaci√≥n','Preocuparse demasiado por diferentes cosas','Dificultad para relajarse','Estar tan inquieto/a que es dif√≠cil mantenerse quieto/a','Irritarse o irritarse f√°cilmente','Sentir miedo como si algo terrible pudiera pasar'];
const PHQ9_OPTS = ['Ning√∫n d√≠a (0)','Varios d√≠as (1)','M√°s de la mitad de los d√≠as (2)','Casi todos los d√≠as (3)'];
const GAD7_OPTS = ['Ning√∫n d√≠a (0)','Varios d√≠as (1)','M√°s de la mitad de los d√≠as (2)','Casi todos los d√≠as (3)'];

const YSQ_DOMAINS = {
  'Desconexi√≥n y Rechazo': ['Abandono/Inestabilidad','Desconfianza/Abuso','Deprivaci√≥n Emocional','Defectuosidad/Verg√ºenza','Aislamiento Social'],
  'Autonom√≠a y Desempe√±o Deteriorados': ['Dependencia/Incompetencia','Vulnerabilidad al Da√±o','Enmara√±amiento','Fracaso'],
  'L√≠mites Deteriorados': ['Grandiosidad/Con Derecho','Autocontrol Insuficiente'],
  'Tendencia hacia el Otro': ['Subyugaci√≥n','Autosacrificio','B√∫squeda de Aprobaci√≥n'],
  'Sobrevigilancia e Inhibici√≥n': ['Negatividad/Pesimismo','Inhibici√≥n Emocional','Metas Inalcanzables','Castigo']
};

const SMI_SCHEMAS = ['Ni√±o Vulnerable','Ni√±o Enfadado/Encolerizado','Ni√±o Impulsivo','Ni√±o Feliz','Rendici√≥n Complaciente','Protecci√≥n Desvinculada','Autoengrandecimiento','Atacante/Bullying','Padre Punitivo','Padre Exigente','Adulto Sano'];

function loadTest(){
  const type = document.getElementById('tst-sel').value;
  const container = document.getElementById('test-container');
  document.getElementById('test-resultados').style.display='none';
  if(!type){ container.innerHTML=''; return; }

  if(type==='phq9'){
    container.innerHTML = `<div class="card"><div class="sec-title">PHQ-9 ¬∑ Cuestionario de Salud del Paciente</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">¬øCon qu√© frecuencia le han afectado los siguientes problemas durante las √∫ltimas 2 semanas?</p>
    ${PHQ9_Q.map((q,i)=>`<div class="test-question"><p><strong>${i+1}.</strong> ${q}</p><div class="likert">${PHQ9_OPTS.map((o,v)=>`<label><input type="radio" name="phq${i}" value="${v}"> ${o}</label>`).join('')}</div></div>`).join('')}
    <div class="btn-row"><button class="btn primary" onclick="calcPHQ9()">Calcular Resultado</button></div></div>`;
  } else if(type==='gad7'){
    container.innerHTML = `<div class="card"><div class="sec-title">GAD-7 ¬∑ Escala de Trastorno de Ansiedad Generalizada</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">¬øCon qu√© frecuencia le han afectado los siguientes problemas durante las √∫ltimas 2 semanas?</p>
    ${GAD7_Q.map((q,i)=>`<div class="test-question"><p><strong>${i+1}.</strong> ${q}</p><div class="likert">${GAD7_OPTS.map((o,v)=>`<label><input type="radio" name="gad${i}" value="${v}"> ${o}</label>`).join('')}</div></div>`).join('')}
    <div class="btn-row"><button class="btn primary" onclick="calcGAD7()">Calcular Resultado</button></div></div>`;
  } else if(type==='ysq'){
    let html = `<div class="card"><div class="sec-title">YSQ-L3 ¬∑ Cuestionario de Esquemas de Young</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">Lee cada afirmaci√≥n y punt√∫a del 1 al 6 qu√© tan bien describe tu forma de ser (1 = Completamente falso, 6 = Me describe perfectamente).</p>`;
    let q = 0;
    Object.entries(YSQ_DOMAINS).forEach(([dom, schemas]) => {
      html += `<div class="subsec">${dom}</div>`;
      schemas.forEach(sch => {
        html += `<div class="test-question"><p><strong>${sch}:</strong> <em style="font-size:.82rem;color:var(--strong)">√çtems representativos del esquema</em></p>
        <div class="fg"><label class="lbl">Puntaje promedio del esquema (1-6)</label><input type="number" name="ysq_${q}" id="ysq_${q}" min="1" max="6" step="0.1" placeholder="Ingresa el promedio"></div></div>`;
        q++;
      });
    });
    html += `<div class="btn-row"><button class="btn primary" onclick="calcYSQ()">Ver Resultados</button></div></div>`;
    container.innerHTML = html;
  } else if(type==='smi'){
    container.innerHTML = `<div class="card"><div class="sec-title">SMI ¬∑ Inventario de Modos de Esquemas</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">Punt√∫a del 1 al 6 con qu√© frecuencia experimentas cada modo (1 = Nunca, 6 = Siempre).</p>
    ${SMI_SCHEMAS.map((s,i)=>`<div class="test-question"><p><strong>${s}</strong></p><div class="likert">
    ${[1,2,3,4,5,6].map(v=>`<label><input type="radio" name="smi${i}" value="${v}"> ${v}</label>`).join('')}</div></div>`).join('')}
    <div class="btn-row"><button class="btn primary" onclick="calcSMI()">Calcular Resultado</button></div></div>`;
  }
}

function calcPHQ9(){
  let total = 0, missing = false;
  PHQ9_Q.forEach((_,i)=>{
    const r = document.querySelector(`input[name="phq${i}"]:checked`);
    if(!r) missing=true; else total+=parseInt(r.value);
  });
  if(missing){ toast('Responde todas las preguntas'); return; }
  let sev, color;
  if(total<=4){sev='M√≠nima o sin depresi√≥n';color='#4caf50';}
  else if(total<=9){sev='Depresi√≥n leve';color='#8bc34a';}
  else if(total<=14){sev='Depresi√≥n moderada';color='#ff9800';}
  else if(total<=19){sev='Depresi√≥n moderadamente grave';color='#f44336';}
  else{sev='Depresi√≥n grave';color='#b71c1c';}
  showTestResult('PHQ-9 ¬∑ Resultados',`
    <div style="text-align:center;padding:20px 0">
      <div style="font-size:3rem;font-family:Playfair Display,serif;color:${color}">${total}</div>
      <div style="font-size:.8rem;color:var(--strong);text-transform:uppercase;letter-spacing:1px">de 27 puntos</div>
      <div style="margin-top:10px;font-size:1.1rem;font-weight:700;color:${color}">${sev}</div>
    </div>
    <div class="result-bar"><div class="result-bar-fill" style="width:${(total/27*100)}%;background:${color}"></div></div>
    <p style="font-size:.82rem;color:var(--strong);margin-top:12px">Puntaje: 0-4 M√≠nima ¬∑ 5-9 Leve ¬∑ 10-14 Moderada ¬∑ 15-19 Moderadamente grave ¬∑ 20-27 Grave</p>
  `, {score: total, severity: sev, test:'PHQ-9', date: new Date().toISOString()});
}

function calcGAD7(){
  let total = 0, missing = false;
  GAD7_Q.forEach((_,i)=>{
    const r = document.querySelector(`input[name="gad${i}"]:checked`);
    if(!r) missing=true; else total+=parseInt(r.value);
  });
  if(missing){ toast('Responde todas las preguntas'); return; }
  let sev, color;
  if(total<=4){sev='Ansiedad m√≠nima';color='#4caf50';}
  else if(total<=9){sev='Ansiedad leve';color='#8bc34a';}
  else if(total<=14){sev='Ansiedad moderada';color='#ff9800';}
  else{sev='Ansiedad grave';color='#f44336';}
  showTestResult('GAD-7 ¬∑ Resultados',`
    <div style="text-align:center;padding:20px 0">
      <div style="font-size:3rem;font-family:Playfair Display,serif;color:${color}">${total}</div>
      <div style="font-size:.8rem;color:var(--strong);text-transform:uppercase;letter-spacing:1px">de 21 puntos</div>
      <div style="margin-top:10px;font-size:1.1rem;font-weight:700;color:${color}">${sev}</div>
    </div>
    <div class="result-bar"><div class="result-bar-fill" style="width:${(total/21*100)}%;background:${color}"></div></div>
    <p style="font-size:.82rem;color:var(--strong);margin-top:12px">Puntaje: 0-4 M√≠nima ¬∑ 5-9 Leve ¬∑ 10-14 Moderada ¬∑ 15-21 Grave</p>
  `, {score: total, severity: sev, test:'GAD-7', date: new Date().toISOString()});
}

function calcYSQ(){
  const schemas = Object.values(YSQ_DOMAINS).flat();
  const results = schemas.map((s,i)=>{
    const val = parseFloat(document.getElementById('ysq_'+i)?.value)||0;
    return {name:s, val};
  });
  const sorted = [...results].sort((a,b)=>b.val-a.val);
  const html = `<p style="font-size:.82rem;color:var(--strong);margin-bottom:16px">Esquemas ordenados por intensidad (1=m√≠nima, 6=m√°xima):</p>` +
    sorted.map(r=>`<div class="result-schema"><h4>${r.name}</h4>
    <div class="result-bar"><div class="result-bar-fill" style="width:${((r.val-1)/5*100).toFixed(0)}%"></div></div>
    <p style="font-size:.78rem;color:var(--strong)">${r.val.toFixed(1)}/6 ¬∑ ${r.val>=4.5?'Alta activaci√≥n':r.val>=3?'Activaci√≥n moderada':'Baja activaci√≥n'}</p>
    </div>`).join('');
  showTestResult('YSQ ¬∑ Perfil de Esquemas', html, {schemas: results, test:'YSQ', date: new Date().toISOString()});
}

function calcSMI(){
  const results = SMI_SCHEMAS.map((s,i)=>{
    const r = document.querySelector(`input[name="smi${i}"]:checked`);
    return {name:s, val: r?parseInt(r.value):0};
  });
  const missing = results.some(r=>r.val===0);
  if(missing){ toast('Responde todas las preguntas'); return; }
  const sorted = [...results].sort((a,b)=>b.val-a.val);
  const html = `<p style="font-size:.82rem;color:var(--strong);margin-bottom:16px">Modos ordenados por frecuencia (1=nunca, 6=siempre):</p>` +
    sorted.map(r=>`<div class="result-schema"><h4>${r.name}</h4>
    <div class="result-bar"><div class="result-bar-fill" style="width:${((r.val-1)/5*100).toFixed(0)}%"></div></div>
    <p style="font-size:.78rem;color:var(--strong)">${r.val}/6</p></div>`).join('');
  showTestResult('SMI ¬∑ Perfil de Modos', html, {modes: results, test:'SMI', date: new Date().toISOString()});
}

function showTestResult(title, html, dataToSave){
  document.getElementById('res-titulo').textContent = title;
  document.getElementById('res-content').innerHTML = html;
  document.getElementById('test-resultados').style.display='block';
  window._lastTestData = dataToSave;
  renderTestHistorial();
}

function guardarTest(){
  const pid = document.getElementById('tst-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  if(!window._lastTestData){ toast('Calcula el resultado primero'); return; }
  const hist = DB.get('tests_'+pid) || [];
  hist.push(window._lastTestData);
  DB.set('tests_'+pid, hist);
  renderTestHistorial();
  toast('Resultado guardado ‚úì');
}

function renderTestHistorial(){
  const pid = document.getElementById('tst-sel-pac').value;
  if(!pid) return;
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ renderTestHistorial(); }); return; }
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ renderTestHistorial(); }); return; }
  const hist = DB.get('tests_'+pid)||[];
  const el = document.getElementById('test-historial');
  if(!hist.length){ el.innerHTML='<p style="font-size:.8rem;color:var(--border)">Sin tests guardados a√∫n.</p>'; return; }
  el.innerHTML = hist.slice().reverse().map(t=>`
    <div class="session-item">
      <h4>${t.test} ¬∑ ${t.score!==undefined ? 'Puntaje: '+t.score : ''}</h4>
      <p>${new Date(t.date).toLocaleDateString('es-CO')} ¬∑ ${t.severity||''}</p>
    </div>
  `).join('');
}

function exportarTestPDF(){
  const pid = document.getElementById('tst-sel-pac').value;
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const titulo = document.getElementById('res-titulo').textContent;
  const contenido = document.getElementById('res-content').innerHTML;
  const logoSrc = document.getElementById('logo-img').src;
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;color:#643000;background:white;padding:32px;font-size:14px;}
  .header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #cd8e9d;padding-bottom:14px;margin-bottom:24px;}
  .header img{height:56px;}.header h1{font-size:1.05rem;color:#643000;}.header p{font-size:.68rem;color:#cd8e9d;letter-spacing:1.2px;text-transform:uppercase;}
  h2{font-size:1.1rem;color:#cd8e9d;margin-bottom:16px;}.result-bar{background:#fadae1;border-radius:10px;height:12px;margin:6px 0;overflow:hidden;}
  .result-bar-fill{height:100%;border-radius:10px;background:#cd8e9d;}.result-schema{background:#f5eaec;border-radius:8px;padding:10px 14px;margin:8px 0;}
  .result-schema h4{font-size:.82rem;font-weight:700;margin-bottom:5px;}
  @media print{@page{margin:1.8cm}}</style></head><body>
  <div class="header"><img src="${logoSrc}"><div><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p></div></div>
  <h2>${titulo}</h2><p style="font-size:.78rem;color:#a0536a;margin-bottom:20px">Paciente: ${pac.nombre} ¬∑ ${new Date().toLocaleDateString('es-CO')}</p>
  ${contenido}
  </body></html>`;

  abrirDocumentoSeguro(html, 'Test_'+new Date().toLocaleDateString('es-CO').replace(/\//g,'-')+'.html');
}

// ===================== SEGUIMIENTO =====================
function loadSeguimiento(){
  const pid = document.getElementById('seg-sel-pac').value;
  if(!pid) return;
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ loadSeguimiento(); }); return; }
  if(!DB._loaded && _firebaseDB){ DB.whenReady(function(){ loadSeguimiento(); }); return; }
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'‚Äî'};
  const ses = DB.get('sesiones_'+pid)||[];
  const tests = DB.get('tests_'+pid)||[];

  // stats
  document.getElementById('seg-stats').innerHTML = `
    <div class="stat-card"><div class="num">${ses.length}</div><div class="lbl2">Sesiones</div></div>
    <div class="stat-card"><div class="num">${tests.length}</div><div class="lbl2">Tests</div></div>
    <div class="stat-card"><div class="num">${ses.length?ses[ses.length-1].num:'‚Äî'}</div><div class="lbl2">√öltima sesi√≥n</div></div>
    <div class="stat-card"><div class="num">${ses.length?(ses.reduce((a,s)=>a+parseInt(s.estado||5),0)/ses.length).toFixed(1):'‚Äî'}</div><div class="lbl2">Estado prom.</div></div>
  `;

  // chart
  drawChart(ses);

  // sesiones lista
  document.getElementById('seg-sesiones-lista').innerHTML = ses.length ?
    ses.slice().reverse().map(s=>{
      const esCancelacion = s.tipo==='cancelacion';
      return `<div class="session-item ${esCancelacion?'cancelada':''}" onclick="abrirDetalleSesion('${pid}','${s.id}')">
        <h4>${esCancelacion?'‚ùå Cancelaci√≥n':'Sesi√≥n #'+s.num} ¬∑ ${s.fecha||'‚Äî'}</h4>
        <p>${esCancelacion ? 'Motivo: '+(s.motivoCancelacion||'‚Äî') : 'Estado: '+(s.estado||'‚Äî')+'/10 ¬∑ '+(s.dur||50)+' min'}</p>
      </div>`;
    }).join('') :
    '<p style="font-size:.8rem;color:var(--border)">Sin sesiones.</p>';

  // tests lista
  document.getElementById('seg-tests-lista').innerHTML = tests.length ?
    tests.slice().reverse().map(t=>`<div class="session-item"><h4>${t.test} ${t.score!==undefined?'¬∑ '+t.score:''}</h4><p>${new Date(t.date).toLocaleDateString('es-CO')} ¬∑ ${t.severity||''}</p></div>`).join('') :
    '<p style="font-size:.8rem;color:var(--border)">Sin tests.</p>';
}

function drawChart(ses){
  const canvas = document.getElementById('seg-chart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth - 48;
  canvas.height = 200;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!ses.length){
    ctx.fillStyle='#cd8e9d'; ctx.font='14px Lato'; ctx.textAlign='center';
    ctx.fillText('Sin datos a√∫n',canvas.width/2,100); return;
  }

  const data = ses.map(s=>parseInt(s.estado||5));
  const labels = ses.map(s=>'#'+s.num);
  const pad = {t:20,r:20,b:40,l:40};
  const W = canvas.width - pad.l - pad.r;
  const H = canvas.height - pad.t - pad.b;
  const max = 10, min = 0;
  const xStep = data.length>1 ? W/(data.length-1) : W/2;

  // grid
  ctx.strokeStyle='#f5eaec'; ctx.lineWidth=1;
  for(let i=0;i<=10;i+=2){
    const y = pad.t + H - (i/max)*H;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+W,y); ctx.stroke();
    ctx.fillStyle='#cd8e9d'; ctx.font='10px Lato'; ctx.textAlign='right';
    ctx.fillText(i, pad.l-6, y+4);
  }

  // line
  ctx.strokeStyle='#cd8e9d'; ctx.lineWidth=2.5; ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = pad.l + (data.length>1?i*xStep:W/2);
    const y = pad.t + H - ((v-min)/(max-min))*H;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();

  // fill
  ctx.fillStyle='rgba(205,142,157,0.12)';
  ctx.beginPath();
  data.forEach((v,i)=>{ const x=pad.l+(data.length>1?i*xStep:W/2); const y=pad.t+H-((v-min)/(max-min))*H; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
  ctx.lineTo(pad.l+(data.length>1?(data.length-1)*xStep:W/2),pad.t+H);
  ctx.lineTo(pad.l,pad.t+H); ctx.closePath(); ctx.fill();

  // dots & labels
  data.forEach((v,i)=>{
    const x = pad.l+(data.length>1?i*xStep:W/2);
    const y = pad.t+H-((v-min)/(max-min))*H;
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#cd8e9d'; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='#643000'; ctx.font='10px Lato'; ctx.textAlign='center';
    ctx.fillText(labels[i], x, pad.t+H+18);
  });
}

// ===================== ENTREGABLE EVOLUCI√ìN =====================
function exportarEvolucionPDF(){
  const pid = document.getElementById('seg-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const pacs = getPacientes();
  const pac  = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const sesAll = DB.get('sesiones_'+pid)||[];
  const tests  = DB.get('tests_'+pid)||[];
  const plan   = DB.get('plan_'+pid)||{};

  // Solo sesiones reales (excluir cancelaciones)
  const ses = sesAll.filter(s=>s.tipo!=='cancelacion');
  const nCancel = sesAll.length - ses.length;

  if(!sesAll.length){ toast('Este paciente a√∫n no tiene sesiones registradas'); return; }

  function esc(v){ return (v||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ‚îÄ‚îÄ GR√ÅFICA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const offCanvas = document.createElement('canvas');
  offCanvas.width = 900; offCanvas.height = 300;
  const ctx = offCanvas.getContext('2d');
  ctx.fillStyle = '#fffafc'; ctx.fillRect(0,0,900,300);
  const data   = ses.map(s=>parseInt(s.estado||5));
  const labels = ses.map(s=>'#'+s.num);
  const fechas = ses.map(s=>s.fecha?new Date(s.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'short'}):'');
  const pad={t:28,r:24,b:56,l:46};
  const W=900-pad.l-pad.r, H=300-pad.t-pad.b;
  const xStep = data.length>1 ? W/(data.length-1) : W/2;
  // grid
  ctx.strokeStyle='#f0dde3'; ctx.lineWidth=1;
  for(let i=0;i<=10;i+=2){
    const y=pad.t+H-(i/10)*H;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+W,y); ctx.stroke();
    ctx.fillStyle='#cd8e9d'; ctx.font='bold 12px Arial'; ctx.textAlign='right';
    ctx.fillText(i,pad.l-6,y+4);
  }
  // eje Y label
  ctx.save(); ctx.translate(13,pad.t+H/2); ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#a0536a'; ctx.font='11px Arial'; ctx.textAlign='center';
  ctx.fillText('Estado emocional (1‚Äì10)',0,0); ctx.restore();
  // √°rea
  if(data.length>0){
    ctx.fillStyle='rgba(205,142,157,0.13)';
    ctx.beginPath();
    data.forEach((v,i)=>{const x=pad.l+(data.length>1?i*xStep:W/2),y=pad.t+H-((v)/10)*H; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.lineTo(pad.l+(data.length>1?(data.length-1)*xStep:W/2),pad.t+H);
    ctx.lineTo(pad.l,pad.t+H); ctx.closePath(); ctx.fill();
    // l√≠nea
    ctx.strokeStyle='#cd8e9d'; ctx.lineWidth=2.5; ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.beginPath();
    data.forEach((v,i)=>{const x=pad.l+(data.length>1?i*xStep:W/2),y=pad.t+H-((v)/10)*H; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.stroke();
    // puntos
    data.forEach((v,i)=>{
      const x=pad.l+(data.length>1?i*xStep:W/2), y=pad.t+H-((v)/10)*H;
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#cd8e9d'; ctx.lineWidth=2.5; ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.stroke();
      ctx.fillStyle='#643000'; ctx.font='bold 12px Arial'; ctx.textAlign='center'; ctx.fillText(v,x,y-12);
      ctx.fillStyle='#a0536a'; ctx.font='11px Arial'; ctx.fillText(labels[i],x,pad.t+H+18);
      if(fechas[i]){ctx.fillStyle='#cd8e9d'; ctx.font='10px Arial'; ctx.fillText(fechas[i],x,pad.t+H+32);}
    });
  }
  const chartDataUrl = offCanvas.toDataURL('image/png');

  // ‚îÄ‚îÄ ESTAD√çSTICAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const prom = data.length ? (data.reduce((a,b)=>a+b,0)/data.length).toFixed(1) : '‚Äî';
  const tend = data.length>1 ? data[data.length-1]-data[0] : 0;
  const tendTxt   = tend>0?`‚Üë Mejora de ${tend} punto(s)`:tend<0?`‚Üì Descenso de ${Math.abs(tend)} punto(s)`:'‚Üí Estable';
  const tendColor = tend>0?'#2e7d32':tend<0?'#c62828':'#a0536a';

  // ‚îÄ‚îÄ TESTS: construir fila por cada test con TODOS sus datos ‚îÄ
  function buildTestRow(t, i){
    let puntaje = '‚Äî', interp = '‚Äî', detalle = '';
    if(t.score !== undefined && t.score !== null){ puntaje = t.score; }
    if(t.severity){ interp = esc(t.severity); }
    // YSQ: mostrar top 5 esquemas
    if(t.schemas && t.schemas.length){
      const top5 = [...t.schemas].sort((a,b)=>b.val-a.val).slice(0,5);
      detalle = '<br><span style="font-size:.75rem;color:#666">Top esquemas: '
        + top5.map(s=>`<strong>${esc(s.name)}</strong> (${parseFloat(s.val).toFixed(1)})`).join(', ')
        + '</span>';
      if(puntaje==='‚Äî') puntaje = 'Perfil';
      if(interp==='‚Äî') interp = top5[0]?esc(top5[0].name)+' predominante':'‚Äî';
    }
    // SMI: mostrar top 3 modos
    if(t.modes && t.modes.length){
      const top3 = [...t.modes].sort((a,b)=>b.val-a.val).slice(0,3);
      detalle = '<br><span style="font-size:.75rem;color:#666">Modos predominantes: '
        + top3.map(s=>`<strong>${esc(s.name)}</strong> (${s.val}/6)`).join(', ')
        + '</span>';
      if(puntaje==='‚Äî') puntaje = 'Perfil';
      if(interp==='‚Äî') interp = top3[0]?esc(top3[0].name):'‚Äî';
    }
    const bg = i%2===0?'#fff':'#fdf0f3';
    return `<tr style="background:${bg};page-break-inside:avoid">
      <td style="padding:8px 10px;border:1px solid #ecd8de;font-weight:700;color:#643000;vertical-align:top">${esc(t.test||'‚Äî')}</td>
      <td style="padding:8px 10px;border:1px solid #ecd8de;text-align:center;font-weight:700;font-size:1rem;vertical-align:top">${puntaje}</td>
      <td style="padding:8px 10px;border:1px solid #ecd8de;vertical-align:top">${interp}${detalle}</td>
      <td style="padding:8px 10px;border:1px solid #ecd8de;white-space:nowrap;vertical-align:top">${t.date?new Date(t.date).toLocaleDateString('es-CO',{day:'numeric',month:'short',year:'numeric'}):'‚Äî'}</td>
    </tr>`;
  }

  const testsHTML = tests.length ? `
    <div style="page-break-inside:avoid;margin-bottom:30px">
      <h2 style="font-size:1rem;font-family:Georgia,serif;color:#cd8e9d;margin:0 0 12px;padding-bottom:7px;border-bottom:2px solid #fadae1">
        üß™ Evaluaciones Psicol√≥gicas Aplicadas <span style="font-size:.8rem;color:#a0536a">(${tests.length} instrumento${tests.length!==1?'s':''})</span>
      </h2>
      <table style="width:100%;border-collapse:collapse;font-size:.85rem">
        <thead><tr>
          <th style="background:#cd8e9d;color:#fff;padding:8px 10px;text-align:left;font-size:.78rem">Instrumento</th>
          <th style="background:#cd8e9d;color:#fff;padding:8px 10px;text-align:center;font-size:.78rem;width:70px">Puntaje</th>
          <th style="background:#cd8e9d;color:#fff;padding:8px 10px;text-align:left;font-size:.78rem">Interpretaci√≥n / Resultados</th>
          <th style="background:#cd8e9d;color:#fff;padding:8px 10px;text-align:left;font-size:.78rem;width:100px">Fecha</th>
        </tr></thead>
        <tbody>${tests.map((t,i)=>buildTestRow(t,i)).join('')}</tbody>
      </table>
      <div style="margin-top:7px;font-size:.7rem;color:#a0536a;font-style:italic;line-height:1.6">
        ${tests.some(t=>t.test==='PHQ-9')?'PHQ-9: 0‚Äì4 Sin depresi√≥n ¬∑ 5‚Äì9 Leve ¬∑ 10‚Äì14 Moderada ¬∑ 15‚Äì19 Mod-grave ¬∑ 20‚Äì27 Grave<br>':''}
        ${tests.some(t=>t.test==='GAD-7')?'GAD-7: 0‚Äì4 M√≠nima ¬∑ 5‚Äì9 Leve ¬∑ 10‚Äì14 Moderada ¬∑ 15‚Äì21 Grave':''}
      </div>
    </div>` : '';

  // ‚îÄ‚îÄ TABLA SESIONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sesTabla = ses.length ? `
    <div style="margin-bottom:30px">
      <h2 style="font-size:1rem;font-family:Georgia,serif;color:#cd8e9d;margin:0 0 12px;padding-bottom:7px;border-bottom:2px solid #fadae1">
        üìã Registro de Sesiones <span style="font-size:.8rem;color:#a0536a">(${ses.length} sesi√≥n${ses.length!==1?'es':''}${nCancel>0?' ¬∑ '+nCancel+' cancelaci√≥n(es)':''})</span>
      </h2>
      <table style="width:100%;border-collapse:collapse;font-size:.83rem">
        <thead><tr>
          <th style="background:#cd8e9d;color:#fff;padding:7px 10px;text-align:center;width:45px">#</th>
          <th style="background:#cd8e9d;color:#fff;padding:7px 10px;text-align:left;width:90px">Fecha</th>
          <th style="background:#cd8e9d;color:#fff;padding:7px 10px;text-align:center;width:60px">E.E.</th>
          <th style="background:#cd8e9d;color:#fff;padding:7px 10px;text-align:left">Temas trabajados</th>
          <th style="background:#cd8e9d;color:#fff;padding:7px 10px;text-align:left">Tarea asignada</th>
        </tr></thead>
        <tbody>
        ${ses.map((s,i)=>{
          const ee = parseInt(s.estado||5);
          const eeColor = ee>=7?'#2e7d32':ee<=3?'#c62828':'#643000';
          return `<tr style="background:${i%2===0?'#fff':'#fdf0f3'};page-break-inside:avoid">
            <td style="padding:7px 10px;border:1px solid #ecd8de;text-align:center;font-weight:700">${esc(s.num)}</td>
            <td style="padding:7px 10px;border:1px solid #ecd8de;white-space:nowrap">${s.fecha?new Date(s.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'short',year:'2-digit'}):'‚Äî'}</td>
            <td style="padding:7px 10px;border:1px solid #ecd8de;text-align:center;font-weight:700;color:${eeColor}">${ee}/10</td>
            <td style="padding:7px 10px;border:1px solid #ecd8de;font-size:.79rem">${esc((s.temas||'').slice(0,150)) + ((s.temas||'').length>150?'‚Ä¶':'')}</td>
            <td style="padding:7px 10px;border:1px solid #ecd8de;font-size:.79rem">${esc(s.tarea||'‚Äî')}</td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>
    </div>` : '';

  // ‚îÄ‚îÄ DATOS GENERALES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const logoSrc    = document.getElementById('logo-img').src;
  const fechaHoy   = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  const nombreCorto = pac.nombre.split(' ')[0];

  // ‚îÄ‚îÄ HTML FINAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Entregable ‚Äî ${esc(pac.nombre)}</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,sans-serif;color:#3a1a00;background:#fff;font-size:13px;line-height:1.55}
  .wrap{max-width:800px;margin:0 auto;padding:36px 40px 50px}
  .hdr{display:flex;align-items:center;justify-content:space-between;border-bottom:2.5px solid #cd8e9d;padding-bottom:14px;margin-bottom:24px}
  .hdr img{height:68px;object-fit:contain}
  .hdr-txt{text-align:right}
  .hdr-nom{font-family:Georgia,serif;font-size:1.05rem;color:#643000;font-weight:700}
  .hdr-sub{font-size:.7rem;color:#cd8e9d;letter-spacing:.08em;text-transform:uppercase;margin-top:2px}
  .hdr-cnt{font-size:.69rem;color:#aaa;margin-top:2px}
  .portada{background:linear-gradient(120deg,#fadae1,#f5c5d2);border-radius:12px;padding:20px 24px;margin-bottom:22px}
  .port-tit{font-family:Georgia,serif;font-size:1.4rem;color:#643000;margin-bottom:4px}
  .port-pac{font-size:.88rem;color:#a0536a;margin-bottom:3px}
  .port-fecha{font-size:.75rem;color:#b0607a}
  .port-obj{font-size:.78rem;color:#643000;margin-top:8px;padding-top:8px;border-top:1px solid rgba(205,142,157,.3)}
  .msg{background:#fdf5f7;border-left:4px solid #cd8e9d;border-radius:0 10px 10px 0;padding:14px 18px;margin-bottom:22px;font-size:.87rem;line-height:1.75;color:#643000}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px}
  .sbox{background:#fadae1;border-radius:10px;padding:12px 8px;text-align:center}
  .sbox-n{font-family:Georgia,serif;font-size:1.75rem;color:#cd8e9d;line-height:1}
  .sbox-l{font-size:.62rem;color:#a0536a;text-transform:uppercase;letter-spacing:.06em;margin-top:4px}
  .graf-wrap{background:#fff8fb;border:1.5px solid #e8d0d8;border-radius:10px;padding:16px;margin-bottom:24px}
  .graf-tit{font-size:.9rem;color:#cd8e9d;font-weight:700;margin-bottom:10px}
  .graf-wrap img{width:100%;display:block;border-radius:6px}
  .tend-badge{display:inline-block;margin-top:8px;font-size:.85rem;font-weight:700;padding:4px 16px;border-radius:20px;background:#fdf0f3;color:${tendColor};border:1.5px solid ${tendColor}44}
  .sec-tit{font-family:Georgia,serif;font-size:1rem;color:#cd8e9d;border-bottom:2px solid #fadae1;padding-bottom:6px;margin-bottom:12px}
  .pie{margin-top:36px;border-top:1px solid #e8d0d6;padding-top:12px;font-size:.69rem;color:#bbb;text-align:center;line-height:1.7}
  .firma{display:inline-block;margin-top:28px;border-top:1px solid #643000;padding-top:7px;min-width:190px;font-size:.78rem;color:#643000;text-align:center}
  @media print{
    *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
    body{font-size:11.5px}
    .wrap{padding:12px 16px;max-width:100%}
    .hdr{margin-bottom:14px}
    .stats{grid-template-columns:repeat(4,1fr)}
    .sbox-n{font-size:1.4rem}
    tr{page-break-inside:avoid}
    table{page-break-inside:auto}
    thead{display:table-header-group}
    .graf-wrap,.portada{page-break-inside:avoid}
    @page{margin:1.5cm;size:A4}
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="hdr">
    <img src="${logoSrc}" alt="Logo">
    <div class="hdr-txt">
      <div class="hdr-nom">Luisa Fernanda Garc√©s Garc√≠a</div>
      <div class="hdr-sub">Psic√≥loga ¬∑ TP 174366</div>
      <div class="hdr-cnt">3246381453 ¬∑ luisafgarces@gmail.com</div>
    </div>
  </div>

  <div class="portada">
    <div class="port-tit">Tu Progreso en Terapia üå∏</div>
    <div class="port-pac">${esc(pac.nombre)}</div>
    <div class="port-fecha">Reporte generado el ${fechaHoy}</div>
    ${plan.objetivo?`<div class="port-obj"><strong>Objetivo terap√©utico:</strong> ${esc(plan.objetivo)}</div>`:''}
  </div>

  <div class="msg">
    Hola <strong>${esc(nombreCorto)}</strong>, este documento refleja tu camino en el proceso terap√©utico.
    Cada sesi√≥n que has asistido es un paso valioso que has dado por ti mismo/a.
    Los datos aqu√≠ registrados nos ayudan a ver juntas c√≥mo has evolucionado. ¬°Tu compromiso es el motor del cambio! üíõ
  </div>

  <div class="stats">
    <div class="sbox"><div class="sbox-n">${ses.length}</div><div class="sbox-l">Sesiones</div></div>
    <div class="sbox"><div class="sbox-n">${prom}</div><div class="sbox-l">E.E. promedio</div></div>
    <div class="sbox"><div class="sbox-n">${data.length?data[data.length-1]:0}/10</div><div class="sbox-l">√öltima sesi√≥n</div></div>
    <div class="sbox"><div class="sbox-n">${tests.length}</div><div class="sbox-l">Evaluaciones</div></div>
  </div>

  ${data.length>0?`<div class="graf-wrap">
    <div class="graf-tit">üìà Evoluci√≥n del Estado Emocional por Sesi√≥n</div>
    <img src="${chartDataUrl}" alt="Gr√°fica">
    <div><span class="tend-badge">${tendTxt}</span></div>
  </div>`:''}

  ${testsHTML}

  ${sesTabla}

  <div class="pie">
    <div class="firma">
      Luisa Fernanda Garc√©s Garc√≠a<br>Psic√≥loga ¬∑ TP 174366<br>
      <em style="font-size:.68rem">Firma y sello</em>
    </div>
    <p style="margin-top:14px">Documento personal y confidencial ¬∑ Luisa Fernanda Garc√©s Garc√≠a, Psic√≥loga ¬∑ TP 174366</p>
    <p>Este reporte es de uso exclusivo del/la paciente y la terapeuta ¬∑ ${fechaHoy}</p>
  </div>

</div>
</body></html>`;

  abrirDocumentoSeguro(html, 'EntregableTerapeutico_'+pac.nombre.replace(/\s+/g,'_')+'_'+new Date().toLocaleDateString('es-CO').replace(/\//g,'-')+'.html');
}


// ===================== BACKUP / RESTORE =====================
function exportarJSON(){
  const backup = { version: '1.0', fecha: new Date().toISOString(), datos: {} };
  const appKeys = ['pacientes','agenda_eventos','finanzas_registros'];
  const pacs = getPacientes();
  pacs.forEach(p => {
    appKeys.push('anamnesis_'+p.id);
    appKeys.push('plan_'+p.id);
    appKeys.push('sesiones_'+p.id);
    appKeys.push('tests_'+p.id);
  });
  appKeys.forEach(k => {
    const val = DB.get(k);
    if(val !== null && val !== undefined) backup.datos[k] = JSON.stringify(val);
  });
  const json = JSON.stringify(backup, null, 2);
  const fecha = new Date().toLocaleDateString('es-CO').replace(/\//g,'-');
  descargarArchivo(json, 'SuiteClinica_Respaldo_' + fecha + '.json', 'application/json');
  toast('Respaldo exportado ‚úì');
}

function importarJSON(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const backup = JSON.parse(e.target.result);
      if(!backup.datos){ toast('Archivo inv√°lido'); return; }
      const fechaBackup = new Date(backup.fecha).toLocaleDateString('es-CO');
      const ok = window.confirm(
        '¬øImportar respaldo del ' + fechaBackup + '?\n\n' +
        'Esto REEMPLAZAR√Å todos los datos actuales en este dispositivo.\n\n¬øContinuar?'
      );
      if(!ok){ event.target.value=''; return; }
      // Escribir datos del respaldo usando DB (se sincronizan a Firebase)
      Object.entries(backup.datos).forEach(([k,v]) => {
        try { DB.set(k, JSON.parse(v)); } catch(e){ DB.set(k, v); }
      });
      event.target.value = '';
      toast('Respaldo importado ‚úì ‚Äî Recargando...');
      setTimeout(() => location.reload(), 1400);
    } catch(err) {
      toast('Error al leer el archivo');
      event.target.value = '';
    }
  };
  reader.readAsText(file);
}

// ===================== DASHBOARD =====================
function renderDashboard(){
  const pacs = getPacientes();
  let totalSes = 0;
  pacs.forEach(p=>{ totalSes += getSesionesCount(p.id); });

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card"><div class="num">${pacs.length}</div><div class="lbl2">Pacientes</div></div>
    <div class="stat-card"><div class="num">${totalSes}</div><div class="lbl2">Sesiones totales</div></div>
    <div class="stat-card"><div class="num">${new Date().toLocaleDateString('es-CO',{day:'numeric',month:'short'})}</div><div class="lbl2">Hoy</div></div>
  `;

  const recent = pacs.slice(-6).reverse();
  document.getElementById('dash-recent-patients').innerHTML = recent.length ?
    `<div class="patient-grid">${recent.map(p=>`<div class="patient-card" onclick="goPageDirect('pacientes')"><h3>${p.nombre}</h3><div class="meta">${p.ocup||'‚Äî'}</div><div class="badge">${getSesionesCount(p.id)} sesi√≥n(es)</div></div>`).join('')}</div>` :
    '<p style="font-size:.85rem;color:var(--border)">A√∫n no tienes pacientes. <a href="#" onclick="goPageDirect(\'pacientes\')" style="color:var(--border)">Crea el primero ‚Üí</a></p>';

  // √∫ltimas sesiones
  let allSes = [];
  pacs.forEach(p=>{ const s=DB.get('sesiones_'+p.id)||[]; s.forEach(x=>allSes.push({...x,pacNombre:p.nombre})); });
  allSes.sort((a,b)=>new Date(b.guardada)-new Date(a.guardada));
  document.getElementById('dash-recent-sessions').innerHTML = allSes.slice(0,5).length ?
    allSes.slice(0,5).map(s=>`<div class="session-item"><h4>${s.pacNombre} ¬∑ Sesi√≥n #${s.num}</h4><p>${s.fecha||'‚Äî'} ¬∑ Estado: ${s.estado||'‚Äî'}/10</p></div>`).join('') :
    '<p style="font-size:.85rem;color:var(--border)">A√∫n no hay sesiones registradas.</p>';

  // Cumplea√±os del d√≠a y pr√≥ximos 7 d√≠as
  const hoyBday = new Date();
  const dH = hoyBday.getDate(), mH = hoyBday.getMonth()+1;
  const cumpleHoy = pacs.filter(p=>{
    if(!p.fnac) return false;
    const pts=p.fnac.split('-');
    return parseInt(pts[1])===mH && parseInt(pts[2])===dH;
  });
  const proximos = pacs.filter(p=>{
    if(!p.fnac) return false;
    const pts=p.fnac.split('-');
    const pM=parseInt(pts[1]), pD=parseInt(pts[2]);
    if(pM===mH && pD===dH) return false; // today already shown
    for(let d=1;d<=7;d++){
      const fd=new Date(hoyBday); fd.setDate(fd.getDate()+d);
      if(parseInt(pts[1])===fd.getMonth()+1 && parseInt(pts[2])===fd.getDate()) return true;
    }
    return false;
  });
  const bdayWid = document.getElementById('dash-bday-widget');
  if(bdayWid){
    let bdayHtml = '';
    if(cumpleHoy.length){
      bdayHtml += `<div class="card" style="border:2px solid #cd8e9d;background:linear-gradient(135deg,#fff8f9,#fadae1)">
        <div class="sec-title" style="color:#cd8e9d">üéÇ ¬°Cumplea√±os hoy!</div>
        <div style="display:flex;flex-wrap:wrap;gap:10px">
        ${cumpleHoy.map(p=>{
          const edad = new Date().getFullYear()-parseInt(p.fnac.split('-')[0]);
          return `<div style="background:#fff;border:1.5px solid #cd8e9d;border-radius:14px;padding:12px 18px;cursor:pointer;transition:all .2s" onclick="abrirBdayModal(getPacientes().find(x=>x.id==='${p.id}'))">
            <div style="font-family:'Playfair Display',serif;font-size:1rem;color:#643000">üå∏ ${p.nombre}</div>
            <div style="font-size:.75rem;color:#a0536a;margin-top:3px">¬°Cumple ${edad} a√±os hoy!</div>
            <div style="font-size:.72rem;color:#cd8e9d;margin-top:4px">Clic para generar imagen de felicitaci√≥n üéâ</div>
          </div>`;
        }).join('')}
        </div>
      </div>`;
    }
    if(proximos.length){
      bdayHtml += `<div class="card">
        <div class="sec-title">üéà Pr√≥ximos Cumplea√±os (7 d√≠as)</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
        ${proximos.map(p=>{
          const pts=p.fnac.split('-');
          const meses=['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
          const fechaCumple=parseInt(pts[2])+' de '+meses[parseInt(pts[1])-1];
          const edad=new Date().getFullYear()-parseInt(pts[0]);
          return `<div style="background:var(--soft);border-radius:12px;padding:10px 14px">
            <div style="font-size:.88rem;font-weight:700;color:var(--text)">${p.nombre}</div>
            <div style="font-size:.75rem;color:var(--strong)">${fechaCumple} ¬∑ ${edad} a√±os</div>
          </div>`;
        }).join('')}
        </div>
      </div>`;
    }
    bdayWid.innerHTML = bdayHtml;
  }
}

function goPageDirect(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(name==='pacientes') renderPacientes();
}

// ===================== TOAST =====================
function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2500);
}


// ===================== AGENDA =====================
var agEventos = (function(){ try{ return JSON.parse(localStorage.getItem('agenda_eventos')||'[]'); }catch(e){return[];} })();
function agGuardar(){ DB.set('agenda_eventos', agEventos); }

var agTabActual = 'hoy';
var agDiaOffset = 0;
var agMeses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
var agDias = ['domingo','lunes','martes','mi√©rcoles','jueves','viernes','s√°bado'];

function agGetFecha(offset){ var d=new Date(); d.setDate(d.getDate()+(offset||0)); return d; }
function agFormatFecha(d){ return agDias[d.getDay()]+', '+d.getDate()+' de '+agMeses[d.getMonth()]; }
function agFormatHora(str){ var d=new Date(str); return d.toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit',hour12:true}); }
function agMismoDia(d1,d2){ return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()&&d1.getDate()===d2.getDate(); }

function renderAgenda(){
  if(agTabActual==='semana'){ agRenderSemana(); return; }
  var offset = agTabActual==='manana'?1:agDiaOffset;
  var fechaRef = agGetFecha(offset);
  var prefijo = agTabActual==='hoy'?'Hoy ¬∑ ':agTabActual==='manana'?'Ma√±ana ¬∑ ':'';
  document.getElementById('ag-fecha-titulo').textContent = prefijo + agFormatFecha(fechaRef);
  document.getElementById('ag-prev').style.display = agTabActual==='semana'?'none':'';
  document.getElementById('ag-next').style.display = agTabActual==='semana'?'none':'';
  var evs = agEventos.filter(e=>agMismoDia(new Date(e.inicio), fechaRef));
  evs.sort((a,b)=>new Date(a.inicio)-new Date(b.inicio));
  var c = document.getElementById('ag-container');
  if(!evs.length){ c.innerHTML='<div class="ag-empty"><div class="emoji">üå∏</div><p>No hay citas este d√≠a.</p></div>'; return; }
  c.innerHTML = evs.map(e=>agCard(e)).join('');
}

function agRenderSemana(){
  document.getElementById('ag-fecha-titulo').textContent = 'Esta semana';
  var c = document.getElementById('ag-container'); var html='';
  for(var i=0;i<7;i++){
    var dia=agGetFecha(i);
    var evs=agEventos.filter(e=>agMismoDia(new Date(e.inicio),dia));
    evs.sort((a,b)=>new Date(a.inicio)-new Date(b.inicio));
    if(evs.length){ html+='<div class="dia-label">'+agFormatFecha(dia)+'</div>'+evs.map(e=>agCard(e)).join(''); }
  }
  c.innerHTML = html||'<div class="ag-empty"><div class="emoji">üå∏</div><p>No hay citas esta semana.</p></div>';
}

var _agEventMap = {};
function agCard(e){
  var hora=agFormatHora(e.inicio); var horaFin=agFormatHora(e.fin);
  var safeId='agwa_'+e.id.replace(/[^a-z0-9]/gi,'_');
  _agEventMap[e.id] = e;
  var tagMap={virtual:'<span class="ag-tag virtual">Virtual</span>',presencial:'<span class="ag-tag presencial">Presencial</span>',admin:'<span class="ag-tag admin">Administrativo</span>'};
  var waBtn='';
  var waDirectBtn='';
  var imgBtn=e.tipo!=='admin'?'<button class="btn primary" style="font-size:.78rem;padding:6px 14px" onclick="abrirImagenCita(\''+e.id+'\')">üñºÔ∏è Imagen recordatorio</button>':'';
  var waBox='';
  var delBtn='<button class="btn" style="font-size:.72rem;padding:5px 12px;color:var(--strong);border-color:var(--bg)" onclick="agEliminar(\''+e.id+'\')">üóë</button>';
  var editBtn='<button class="btn" style="font-size:.72rem;padding:5px 12px" onclick="agEditarEvento(\''+e.id+'\')">‚úèÔ∏è Editar</button>';
  var desc=e.descripcion?'<div class="cita-desc">'+e.descripcion+'</div>':'';
  return '<div class="cita-card"><div class="cita-hora">'+hora+' \u2013 '+horaFin+'</div><div class="cita-nombre">'+e.titulo+'</div>'+desc+(tagMap[e.tipo]||'')+'<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">'+waDirectBtn+imgBtn+editBtn+delBtn+'</div></div>';
}

function agGenerarMsg(e){
  var hora=agFormatHora(e.inicio);
  var nombreLimpio=e.titulo.replace(/CONSULTORIO (VIRTUAL|PRESENCIAL)\s*[-‚Äì]\s*/i,'').replace(/Sesi√≥n #?\d*/i,'sesi√≥n').trim();
  return `Hola üå∏\n\nTe escribo para recordarte tu ${nombreLimpio} conmigo ma√±ana a las *${hora}*.\n\nSi necesitas cancelar o reprogramar, por favor av√≠same con anticipaci√≥n.\n\n¬°Nos vemos pronto! üåø\n\n*Luisa Fernanda Garc√©s Garc√≠a*\n_Psic√≥loga_`;
}

function agEnviarWA(evId){
  var e = _agEventMap[evId];
  if(!e) return;
  var msg = agGenerarMsg(e);
  window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
}
function agToggleWA(id){ var el=document.getElementById(id); if(el) el.classList.toggle('show'); }
function agCopiar(id,btn){
  var txt=document.getElementById(id).querySelector('.wa-texto').textContent.trim();
  navigator.clipboard.writeText(txt).then(()=>{
    btn.textContent='‚úì Copiado'; btn.classList.add('copied');
    toast('¬°Mensaje copiado! P√©galo en WhatsApp üå∏');
    setTimeout(()=>{btn.textContent='Copiar';btn.classList.remove('copied');},2500);
  });
}
function importarICS(event){
  const file = event.target.files[0];
  if(!file){ return; }
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    const eventos = parsearICS(text);
    if(!eventos.length){ toast('No se encontraron eventos en el archivo'); event.target.value=''; return; }
    const reemplazar = confirm(
      `Se encontraron ${eventos.length} evento(s) en el archivo.\n\n` +
      `¬øQuieres REEMPLAZAR todos los eventos actuales con estos?\n\n` +
      `Presiona Cancelar para AGREGAR los nuevos sin borrar los existentes.`
    );
    if(reemplazar){
      agEventos = eventos;
    } else {
      // Add only events not already present (by title+date)
      const existingKeys = new Set(agEventos.map(e => e.titulo+'|'+e.inicio.slice(0,16)));
      const nuevos = eventos.filter(e => !existingKeys.has(e.titulo+'|'+e.inicio.slice(0,16)));
      agEventos = [...agEventos, ...nuevos];
      toast(`${nuevos.length} evento(s) nuevo(s) agregados ‚úì`);
    }
    agGuardar();
    renderAgenda();
    event.target.value = '';
    if(reemplazar) toast(`${eventos.length} evento(s) importados ‚úì`);
  };
  reader.readAsText(file, 'UTF-8');
}

function parsearICS(text){
  const eventos = [];
  // Unfold lines (ICS wraps long lines with \r\n + space/tab)
  const unfolded = text.replace(/\r\n[ \t]/g, '').replace(/\r/g, '');
  const bloques = unfolded.split('BEGIN:VEVENT');
  bloques.shift(); // remove content before first VEVENT

  bloques.forEach(bloque => {
    const get = (key) => {
      // Match KEY or KEY;params=value: VALUE
      const match = bloque.match(new RegExp('^' + key + '(?:;[^:]*)?:(.+)$', 'm'));
      return match ? match[1].trim() : '';
    };

    const summary = decodeICSText(get('SUMMARY'));
    if(!summary) return;

    // Parse DTSTART ‚Äî handle DATE-only, datetime with/without Z, with TZID
    const dtstart = parsearFechaICS(bloque, 'DTSTART');
    const dtend   = parsearFechaICS(bloque, 'DTEND');
    if(!dtstart) return;

    // Determine type from title keywords
    let tipo = 'presencial';
    const tl = summary.toLowerCase();
    if(tl.includes('virtual') || tl.includes('online') || tl.includes('zoom') || tl.includes('meet')) tipo = 'virtual';
    if(tl.includes('admin') || tl.includes('mensaje') || tl.includes('bloque') || tl.includes('preparaci')) tipo = 'admin';

    const desc = decodeICSText(get('DESCRIPTION'));
    const location = decodeICSText(get('LOCATION'));

    eventos.push({
      id: 'ics_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
      titulo: summary,
      inicio: dtstart,
      fin: dtend || dtstart,
      tipo,
      descripcion: desc || location || ''
    });
  });

  // Sort by date
  eventos.sort((a,b) => new Date(a.inicio) - new Date(b.inicio));
  return eventos;
}

function parsearFechaICS(bloque, key){
  // Match KEY, KEY;TZID=..., KEY;VALUE=DATE, etc.
  const match = bloque.match(new RegExp(key + '(?:;[^:]*)?:([\\d{8}T\\d{6}Z?]+)', 'm'));
  if(!match) return '';
  const raw = match[1].trim();

  try {
    if(raw.length === 8){
      // DATE only: YYYYMMDD
      return raw.slice(0,4)+'-'+raw.slice(4,6)+'-'+raw.slice(6,8)+'T08:00:00';
    }
    // YYYYMMDDTHHMMSS or YYYYMMDDTHHMMSSZ
    const y=raw.slice(0,4), mo=raw.slice(4,6), d=raw.slice(6,8);
    const h=raw.slice(9,11), mi=raw.slice(11,13), s=raw.slice(13,15)||'00';
    return `${y}-${mo}-${d}T${h}:${mi}:${s}`;
  } catch(e){ return ''; }
}

function decodeICSText(str){
  if(!str) return '';
  return str
    .replace(/\\n/g, ' ')
    .replace(/\\,/g, ',')
    .replace(/\\;/g, ';')
    .replace(/\\\\/g, '\\')
    .trim();
}

function agLimpiarTodo(){
  agEventos = [];
  agGuardar();
  renderAgenda();
  toast('Agenda limpiada ‚úì');
}
function agSwitchTab(tab,el){
  agTabActual = tab;
  agDiaOffset = 0;
  document.querySelectorAll('.ag-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  var esCumple = (tab==='cumpleanos');
  function dsp(id,show){ var e=document.getElementById(id); if(e) e.style.display=show?'':'none'; }
  dsp('ag-nav-card',    !esCumple);
  dsp('ag-container',   !esCumple);
  dsp('ag-form-card',   !esCumple);
  dsp('ag-panel-cumple', esCumple);
  if(esCumple){ agRenderCumpleanos(); } else { renderAgenda(); }
}
function agCambiarDia(dir){ agDiaOffset+=dir; if(agDiaOffset<0)agDiaOffset=0; renderAgenda(); }
function agAgregarEvento(){
  var titulo=document.getElementById('ag-nuevo-titulo').value.trim();
  var inicio=document.getElementById('ag-nuevo-inicio').value;
  var fin=document.getElementById('ag-nuevo-fin').value;
  var tipo=document.getElementById('ag-nuevo-tipo').value;
  var desc=document.getElementById('ag-nuevo-desc').value.trim();
  if(!titulo||!inicio){ toast('Ingresa t√≠tulo y fecha de inicio'); return; }
  agEventos.push({id:'ev'+Date.now(),titulo,inicio,fin:fin||inicio,tipo,descripcion:desc});
  agGuardar();
  document.getElementById('ag-nuevo-titulo').value='';
  document.getElementById('ag-nuevo-inicio').value='';
  document.getElementById('ag-nuevo-fin').value='';
  document.getElementById('ag-nuevo-desc').value='';
  renderAgenda();
  toast('Evento guardado ‚úì');
}
function agEliminar(id){
  if(!confirm('¬øEliminar este evento?')) return;
  agEventos=agEventos.filter(e=>e.id!==id);
  agGuardar(); renderAgenda();
}

function agEditarEvento(id){
  var e = agEventos.find(ev=>ev.id===id);
  if(!e) return;
  document.getElementById('ag-edit-id').value = e.id;
  document.getElementById('ag-edit-titulo').value = e.titulo;
  document.getElementById('ag-edit-inicio').value = e.inicio ? e.inicio.slice(0,16) : '';
  document.getElementById('ag-edit-fin').value = e.fin ? e.fin.slice(0,16) : '';
  document.getElementById('ag-edit-tipo').value = e.tipo||'presencial';
  document.getElementById('ag-edit-desc').value = e.descripcion||'';
  document.getElementById('ag-edit-overlay').classList.add('open');
}

function agGuardarEdicion(){
  var id = document.getElementById('ag-edit-id').value;
  var idx = agEventos.findIndex(e=>e.id===id);
  if(idx<0){ toast('Evento no encontrado'); return; }
  agEventos[idx].titulo = document.getElementById('ag-edit-titulo').value.trim()||agEventos[idx].titulo;
  agEventos[idx].inicio = document.getElementById('ag-edit-inicio').value;
  agEventos[idx].fin = document.getElementById('ag-edit-fin').value||agEventos[idx].inicio;
  agEventos[idx].tipo = document.getElementById('ag-edit-tipo').value;
  agEventos[idx].descripcion = document.getElementById('ag-edit-desc').value;
  agGuardar(); renderAgenda();
  document.getElementById('ag-edit-overlay').classList.remove('open');
  toast('Cita actualizada ‚úì');
}

// ===================== FINANZAS =====================
var registros = (function(){ try{ return JSON.parse(localStorage.getItem('finanzas_registros')||'[]'); }catch(e){return[];} })();
var mesActual = new Date().getMonth();
var anioActual = new Date().getFullYear();
var reciboActual = null;
var mesesFin = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
var tiposLabel = {'80000':'Sesi√≥n individual','140000':'Sesi√≥n pareja/familia','140000b':'Evaluaci√≥n individual','160000':'Evaluaci√≥n pareja','custom':'Otro'};
var metodoLabel = {'efectivo':'Efectivo','nu':'Nu','davibank':'Davibank','nequi':'Nequi','breve':'Breve'};

function finHoy(){ return new Date().toISOString().split('T')[0]; }
function finGuardar(){ DB.set('finanzas_registros', registros); }
function formatPesos(n){ return '$'+Number(n).toLocaleString('es-CO'); }
function getMonto(){
  var tipo=document.getElementById('r_tipo').value;
  if(tipo==='custom') return parseInt(document.getElementById('r_monto_custom').value)||0;
  if(tipo==='140000b') return 140000;
  return parseInt(tipo);
}

document.addEventListener('DOMContentLoaded',()=>{
  var rTipo=document.getElementById('r_tipo');
  if(rTipo) rTipo.addEventListener('change',function(){
    document.getElementById('campo-monto-custom').style.display=this.value==='custom'?'block':'none';
  });
  var rF=document.getElementById('r_fecha'); if(rF) rF.value=finHoy();
  var gF=document.getElementById('g_fecha'); if(gF) gF.value=finHoy();
});

function finSwitchTab(tab,el){
  document.querySelectorAll('.fin-screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.fin-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('fin-'+tab).classList.add('active');
  el.classList.add('active');
}

function registrarPago(abrirR){
  var paciente=document.getElementById('r_paciente').value.trim();
  var fecha=document.getElementById('r_fecha').value;
  var monto=getMonto();
  var metodo=document.getElementById('r_metodo').value;
  var estado=document.getElementById('r_estado').value;
  var tipoVal=document.getElementById('r_tipo').value;
  if(!paciente||!monto){ toast('Por favor completa el nombre y el monto'); return null; }
  var reg={id:Date.now(),tipo:'ingreso',paciente,fecha,monto,metodo,estado,fechaRecibo:finHoy(),tipoSesion:tipoVal==='custom'?'Otro':(tiposLabel[tipoVal]||'Sesi√≥n')};
  registros.push(reg); finGuardar(); renderAll();
  document.getElementById('r_paciente').value='';
  document.getElementById('r_fecha').value=finHoy();
  if(!abrirR) toast('‚úÖ Pago registrado');
  return reg;
}
function registrarYRecibo(){ var reg=registrarPago(true); if(reg) abrirRecibo(reg); }
function registrarGasto(){
  var desc=document.getElementById('g_desc').value.trim();
  var fecha=document.getElementById('g_fecha').value;
  var monto=parseInt(document.getElementById('g_monto').value)||0;
  var cat=document.getElementById('g_cat').value;
  if(!desc||!monto){ toast('Completa descripci√≥n y monto'); return; }
  registros.push({id:Date.now(),tipo:'gasto',descripcion:desc,fecha,monto,categoria:cat});
  finGuardar(); renderAll();
  document.getElementById('g_desc').value=''; document.getElementById('g_monto').value='';
  toast('‚úÖ Gasto registrado');
}
function eliminar(id){
  if(!confirm('¬øEliminar este registro?')) return;
  registros=registros.filter(r=>r.id!==id); finGuardar(); renderAll();
}
function getById(id){ return registros.find(r=>r.id===id); }

function getRegistrosMes(m,a){ return registros.filter(r=>{ var d=new Date(r.fecha+'T12:00:00'); return d.getMonth()===m&&d.getFullYear()===a; }); }

function renderAll(){
  renderResumen(); renderHistorial(); renderDeudores();
  var t1=document.getElementById('mesTitle'); var t2=document.getElementById('mesTitle2');
  var titulo=mesesFin[mesActual]+' '+anioActual;
  if(t1) t1.textContent=titulo; if(t2) t2.textContent=titulo;
}
function renderResumen(){
  var regs=getRegistrosMes(mesActual,anioActual);
  var ingresos=regs.filter(r=>r.tipo==='ingreso'&&r.estado==='pagado');
  var gastos=regs.filter(r=>r.tipo==='gasto');
  var totalI=ingresos.reduce((s,r)=>s+r.monto,0);
  var totalG=gastos.reduce((s,r)=>s+r.monto,0);
  var pendientes=registros.filter(r=>r.tipo==='ingreso'&&r.estado==='pendiente');
  var totalP=pendientes.reduce((s,r)=>s+r.monto,0);
  document.getElementById('stat-ingresos').textContent=formatPesos(totalI);
  document.getElementById('stat-ingresos-n').textContent=ingresos.length+' sesiones';
  document.getElementById('stat-gastos').textContent=formatPesos(totalG);
  document.getElementById('stat-gastos-n').textContent=gastos.length+' registros';
  document.getElementById('stat-neta').textContent=formatPesos(totalI-totalG);
  document.getElementById('stat-pendientes').textContent=formatPesos(totalP);
  document.getElementById('stat-pendientes-n').textContent=pendientes.length+' pacientes';
  var lista=document.getElementById('resumen-lista');
  var recientes=regs.slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).slice(0,5);
  lista.innerHTML=recientes.length?'<div style="font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;color:var(--border);margin-bottom:10px;font-weight:500">Actividad reciente</div>'+recientes.map(pagoItemHTML).join(''):'<div style="text-align:center;padding:32px;color:var(--border)">Sin registros este mes</div>';
}
function renderHistorial(){
  var regs=getRegistrosMes(mesActual,anioActual).slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
  var lista=document.getElementById('historial-lista');
  lista.innerHTML=regs.length?regs.map(pagoItemHTML).join(''):'<div style="text-align:center;padding:32px;color:var(--border)">Sin registros este mes</div>';
}
function renderDeudores(){
  var pendientes=registros.filter(r=>r.tipo==='ingreso'&&r.estado==='pendiente');
  var lista=document.getElementById('deudores-lista');
  if(!pendientes.length){ lista.innerHTML='<div style="text-align:center;padding:32px;color:var(--border)">üå∏ ¬°Sin pagos pendientes!</div>'; return; }
  var porPac={};
  pendientes.forEach(r=>{ if(!porPac[r.paciente]) porPac[r.paciente]={total:0,sesiones:0}; porPac[r.paciente].total+=r.monto; porPac[r.paciente].sesiones++; });
  lista.innerHTML=Object.keys(porPac).map(nombre=>{
    var d=porPac[nombre];
    return `<div class="deudor-item"><div><div class="deudor-nombre">${nombre}</div><div style="font-size:.75rem;color:var(--strong)">${d.sesiones} sesi√≥n(es) pendiente(s)</div></div><div class="deudor-monto">${formatPesos(d.total)}</div></div>`;
  }).join('');
}
function pagoItemHTML(r){
  var esI=r.tipo==='ingreso';
  var fecha=new Date(r.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'short'});
  var metBadge=esI?`<span class="metodo-badge">${metodoLabel[r.metodo]||r.metodo}</span>`:'';
  var pendBadge=(esI&&r.estado==='pendiente')?'<span style="background:#fff3e0;color:#f57c00;padding:2px 8px;border-radius:10px;font-size:.68rem;font-weight:600;margin-left:4px">Pendiente</span>':'';
  var acciones=esI?`<button class="icon-btn" onclick="abrirRecibo(getById(${r.id}))" title="Ver/Editar recibo">üßæ</button><button class="icon-btn btn-danger" onclick="eliminar(${r.id})" title="Eliminar">‚úï</button>`:`<button class="icon-btn btn-danger" onclick="eliminar(${r.id})" title="Eliminar">‚úï</button>`;
  return `<div class="pago-item"><div class="pago-dot ${r.tipo}"></div><div class="pago-info"><div class="pago-nombre">${esI?r.paciente:r.descripcion}</div><div class="pago-meta">${fecha} ¬∑ ${esI?r.tipoSesion:r.categoria} ${metBadge}${pendBadge}</div></div><div class="pago-monto ${r.tipo}">${esI?'+':'-'}${formatPesos(r.monto)}</div><div class="pago-actions">${acciones}</div></div>`;
}

function abrirRecibo(reg){
  if(!reg) return; reciboActual=reg;
  var fechaRecibo = reg.fechaRecibo || finHoy();
  var fecha=new Date(fechaRecibo+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  var numRecibo='REC-'+reg.id.toString().slice(-6);
  var esPendiente = reg.estado === 'pendiente';
  var totalLabel = esPendiente ? 'Total pendiente' : 'Total pagado';

  var qrHtml = esPendiente ? '<div class="recibo-qr-wrap"><canvas id="reciboQRCanvas" width="120" height="120"></canvas><p>üì≤ Escanea para confirmar el pago</p></div>' : '';

  document.getElementById('reciboContent').innerHTML=
    '<div class="recibo-logo"><p>Luisa Fernanda Garc\u00e9s Garc\u00eda</p><small>Psicc\u00f3loga \u00b7 Consultorio</small></div>'+
    '<hr class="recibo-divider">'+
    '<div class="recibo-fila"><span>N\u00famero</span><span>'+numRecibo+'</span></div>'+
    '<div class="recibo-fila"><span>Fecha</span><span>'+fecha+'</span></div>'+
    '<div class="recibo-fila"><span>Paciente</span><span>'+reg.paciente+'</span></div>'+
    '<div class="recibo-fila"><span>Servicio</span><span>'+reg.tipoSesion+'</span></div>'+
    '<div class="recibo-fila"><span>M\u00e9todo</span><span>'+(metodoLabel[reg.metodo]||reg.metodo)+'</span></div>'+
    '<div class="recibo-total"><span>'+totalLabel+'</span><span>'+formatPesos(reg.monto)+'</span></div>'+
    qrHtml;

  if(esPendiente){
    setTimeout(function(){
      var qrData = 'Pago pendiente | Paciente: '+reg.paciente+' | '+reg.tipoSesion+' | '+formatPesos(reg.monto)+' | Ref: '+numRecibo;
      generarQRCanvas('reciboQRCanvas', qrData, 120);
    }, 100);
  }

  var badge = document.getElementById('recibo-estado-badge');
  if(esPendiente){
    badge.style.display='block';
    badge.innerHTML='<span style="background:#fff3e0;color:#f57c00;padding:5px 14px;border-radius:20px;font-size:.78rem;font-weight:700">\u23f3 Pago pendiente \u00b7 QR adjunto</span>';
  } else {
    badge.style.display='block';
    badge.innerHTML='<span style="background:#e8f5e9;color:#2e7d32;padding:5px 14px;border-radius:20px;font-size:.78rem;font-weight:700">\u2705 Pagado</span>';
  }

  var btnPagado = document.getElementById('btn-marcar-pagado');
  if(btnPagado) btnPagado.style.display = esPendiente ? '' : 'none';

  document.getElementById('modalOverlay').classList.add('open');
}

function marcarComoPagado(){
  if(!reciboActual) return;
  var idx = registros.findIndex(function(r){ return r.id === reciboActual.id; });
  if(idx === -1){ toast('Registro no encontrado'); return; }
  registros[idx].estado = 'pagado';
  registros[idx].fechaRecibo = finHoy();
  reciboActual = registros[idx];
  finGuardar();
  renderAll();
  // Actualizar modal
  document.getElementById('btn-marcar-pagado').style.display = 'none';
  var badge = document.getElementById('recibo-estado-badge');
  badge.innerHTML='<span style="background:#e8f5e9;color:#2e7d32;padding:5px 14px;border-radius:20px;font-size:.78rem;font-weight:700">‚úÖ Marcado como pagado</span>';
  // Actualizar total en recibo
  var totalEl = document.querySelector('#reciboContent .recibo-total span:first-child');
  if(totalEl) totalEl.textContent = 'Total pagado';
  toast('‚úÖ Marcado como pagado y guardado en la nube');
}
function cerrarModalBtn(){ document.getElementById('modalOverlay').classList.remove('open'); }
function cerrarModal(e){ if(e.target===document.getElementById('modalOverlay')) cerrarModalBtn(); }
function enviarReciboWA(){
  if(!reciboActual) return;
  var r=reciboActual;
  var fecha=new Date(r.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  var msg='üå∏ *Recibo de pago*\n\n*Luisa Fernanda Garc√©s Garc√≠a*\n*Psic√≥loga*\n\nN√∫mero: REC-'+r.id.toString().slice(-6)+'\nFecha: '+fecha+'\nPaciente: '+r.paciente+'\nServicio: '+r.tipoSesion+'\nM√©todo: '+(metodoLabel[r.metodo]||r.metodo)+'\n\n*Total: '+formatPesos(r.monto)+'*\n\n_Gracias por tu confianza üå∏_';
  window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
}
function cambiarMes(dir){
  mesActual+=dir;
  if(mesActual>11){mesActual=0;anioActual++;} if(mesActual<0){mesActual=11;anioActual--;}
  renderAll();
}


// ===================== DOCUMENTOS CL√çNICOS =====================
const DOC_TIPOS = [
  { id:'cert_bilingue',    icon:'üåê', nombre:'Certificado Psicol√≥gico', desc:'Biling√ºe espa√±ol/ingl√©s. Con diagn√≥stico y firma profesional.' },
  { id:'cert_espanol',     icon:'üìã', nombre:'Certificado (solo espa√±ol)', desc:'Versi√≥n solo en espa√±ol para uso nacional.' },
  { id:'cert_esa',         icon:'üêæ', nombre:'Certificado ESA', desc:'Animal de soporte emocional. Biling√ºe.' },
  { id:'informe_seguimiento', icon:'üìà', nombre:'Informe de Seguimiento', desc:'Evoluci√≥n terap√©utica del paciente en el per√≠odo.' },
  { id:'informe_diagnostico', icon:'üîç', nombre:'Informe Diagn√≥stico', desc:'Evaluaci√≥n diagn√≥stica completa con resultados.' },
  { id:'informe_legal',    icon:'‚öñÔ∏è', nombre:'Informe Legal / Custodia', desc:'Para procesos judiciales, custodias o peritajes.' },
  { id:'informe_incapacidad', icon:'üè•', nombre:'Incapacidad Laboral', desc:'Certificado de incapacidad por condici√≥n psicol√≥gica.' },
];
var docTipoSeleccionado = null;

function renderDocumentos() {
  const grid = document.getElementById('doc-tipos-grid');
  grid.innerHTML = DOC_TIPOS.map(t => `
    <button class="doc-tipo-btn ${docTipoSeleccionado===t.id?'selected':''}" onclick="docSeleccionarTipo('${t.id}')">
      <div class="dt-icon">${t.icon}</div>
      <div class="dt-nombre">${t.nombre}</div>
      <div class="dt-desc">${t.desc}</div>
    </button>`).join('');
  const sel = document.getElementById('doc-sel-pac');
  const pacs = getPacientes();
  sel.innerHTML = '<option value="">‚Äî O ingresa los datos manualmente ‚Äî</option>' +
    pacs.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
}

function docSeleccionarTipo(id) {
  docTipoSeleccionado = id;
  renderDocumentos();
  ['doc-paso2','doc-paso3','doc-paso4'].forEach(x=>document.getElementById(x).style.display='block');
  const t = DOC_TIPOS.find(x=>x.id===id);
  document.getElementById('doc-paso3-titulo').textContent = `3Ô∏è‚É£ Contenido ¬∑ ${t.icon} ${t.nombre}`;
  renderCamposEspecificos(id);
  docActualizarPreview();
  document.getElementById('doc-paso2').scrollIntoView({behavior:'smooth',block:'start'});
}

function docCargarPaciente() {
  const pid = document.getElementById('doc-sel-pac').value;
  if(!pid) return;
  const pac = getPacientes().find(p=>p.id===pid);
  if(!pac) return;
  document.getElementById('doc-pac-nombre').value = pac.nombre||'';
  document.getElementById('doc-pac-cc').value = '';
  document.getElementById('doc-pac-fnac').value = pac.fnac||'';
  document.getElementById('doc-tratamiento').value = pac.genero==='Femenino'?'La se√±ora':'El se√±or';
  const an = DB.get('anamnesis_'+pid)||{};
  const dxField = document.getElementById('doc-diagnostico');
  if(dxField && an.dx) dxField.value = an.dx;
  const modalField = document.getElementById('doc-modalidad');
  if(modalField){ const plan=DB.get('plan_'+pid)||{}; if(plan.modalidad) modalField.value=plan.modalidad; }
}

const CAMPOS_POR_TIPO = {
  cert_bilingue: [
    {id:'diagnostico',label:'Diagn√≥stico (espa√±ol)',ph:'Ej: Trastorno de Ansiedad Generalizada (TAG)'},
    {id:'diagnostico_en',label:'Diagn√≥stico (ingl√©s)',ph:'Ej: Generalized Anxiety Disorder (GAD)'},
    {id:'manual',label:'Manual diagn√≥stico',ph:'DSM-5',val:'DSM-5'},
    {id:'modalidad',label:'Modalidad de evaluaci√≥n',ph:'virtual / presencial',val:'virtual'},
    {id:'cuerpo',label:'Cuerpo del certificado (espa√±ol)',ph:'Con base en la evaluaci√≥n...',area:true},
    {id:'cuerpo_en',label:'Certificate body (English)',ph:'Based on the clinical assessment...',area:true},
    {id:'observaciones',label:'Observaciones adicionales (opcional)',ph:'',area:true},
  ],
  cert_espanol: [
    {id:'diagnostico',label:'Diagn√≥stico',ph:'Ej: Trastorno Depresivo Mayor (TDM)'},
    {id:'manual',label:'Manual diagn√≥stico',ph:'DSM-5',val:'DSM-5'},
    {id:'modalidad',label:'Modalidad',ph:'virtual / presencial',val:'virtual'},
    {id:'cuerpo',label:'Cuerpo del certificado',ph:'Con base en la evaluaci√≥n cl√≠nica realizada...',area:true},
    {id:'observaciones',label:'Observaciones adicionales (opcional)',ph:'',area:true},
  ],
  cert_esa: [
    {id:'diagnostico',label:'Diagn√≥stico / condici√≥n de salud mental',ph:'Ej: Trastorno de Ansiedad, TEPT...'},
    {id:'nombreAnimal',label:'Nombre del animal',ph:'Ej: Luna'},
    {id:'especieAnimal',label:'Especie / Raza',ph:'Ej: Perro / Golden Retriever'},
    {id:'descAnimal',label:'Descripci√≥n del animal',ph:'Ej: Hembra, color dorado, 3 a√±os'},
  ],
  informe_seguimiento: [
    {id:'diagnostico',label:'Diagn√≥stico',ph:''},
    {id:'periodo',label:'Per√≠odo evaluado',ph:'Ej: Enero ‚Äì Marzo 2025'},
    {id:'modalidad',label:'Modalidad',ph:'virtual / presencial',val:'virtual'},
    {id:'numSesiones',label:'N√∫mero de sesiones en el per√≠odo',ph:'Ej: 8'},
    {id:'motivoConsulta',label:'Motivo de consulta y antecedentes',ph:'',area:true},
    {id:'evolucion',label:'Evoluci√≥n cl√≠nica observada',ph:'',area:true},
    {id:'logros',label:'Logros terap√©uticos',ph:'',area:true},
    {id:'dificultades',label:'Dificultades observadas (opcional)',ph:'',area:true},
    {id:'estadoActual',label:'Estado actual del paciente',ph:'',area:true},
    {id:'estadoEmocional',label:'Estado emocional promedio (1-10)',ph:'Ej: 7'},
    {id:'planContinuidad',label:'Plan de continuidad terap√©utica',ph:'',area:true},
    {id:'conclusiones',label:'Conclusiones',ph:'',area:true},
  ],
  informe_diagnostico: [
    {id:'fechaEval',label:'Fecha(s) de evaluaci√≥n',ph:'Ej: 10, 17 y 24 de febrero de 2025'},
    {id:'modalidad',label:'Modalidad',ph:'virtual / presencial',val:'virtual'},
    {id:'numSesiones',label:'N√∫mero de sesiones de evaluaci√≥n',ph:'Ej: 3'},
    {id:'motivoConsulta',label:'Motivo de consulta',ph:'',area:true},
    {id:'historia',label:'Historia cl√≠nica relevante',ph:'',area:true},
    {id:'instrumentos',label:'Instrumentos y t√©cnicas utilizadas',ph:'Ej: Entrevista cl√≠nica, PHQ-9, GAD-7, YSQ-L3...',area:true},
    {id:'resultados',label:'Resultados de la evaluaci√≥n',ph:'',area:true},
    {id:'diagnostico',label:'Diagn√≥stico principal',ph:'Ej: F41.1 TAG (CIE-11)'},
    {id:'manual',label:'Manual diagn√≥stico',ph:'DSM-5 / CIE-11',val:'DSM-5 / CIE-11'},
    {id:'diagnosticoDif',label:'Diagn√≥stico diferencial (opcional)',ph:''},
    {id:'recomendaciones',label:'Recomendaciones',ph:'',area:true},
    {id:'conclusiones',label:'Conclusiones',ph:'',area:true},
  ],
  informe_legal: [
    {id:'tipoProcess',label:'Tipo de proceso',ph:'Ej: Custodia, Proceso Penal, Evaluaci√≥n Pericial'},
    {id:'solicitante',label:'Solicitado por',ph:'Nombre de la persona o entidad'},
    {id:'entidad',label:'Autoridad / Entidad',ph:'Ej: Juzgado de Familia, Fiscal√≠a...'},
    {id:'proposito',label:'Prop√≥sito del informe',ph:'',area:true},
    {id:'radicado',label:'N√∫mero de radicado / expediente (opcional)',ph:''},
    {id:'relacionProceso',label:'Relaci√≥n del paciente con el proceso',ph:'Ej: Demandante, hijo en disputa de custodia...'},
    {id:'metodologia',label:'Metodolog√≠a de evaluaci√≥n',ph:'',area:true},
    {id:'instrumentos',label:'Instrumentos aplicados',ph:''},
    {id:'hallazgos',label:'Hallazgos cl√≠nicos relevantes',ph:'',area:true},
    {id:'analisis',label:'An√°lisis psicol√≥gico',ph:'',area:true},
    {id:'conclusiones',label:'Conclusiones y concepto profesional',ph:'',area:true},
    {id:'recomendaciones',label:'Recomendaciones',ph:'',area:true},
  ],
  informe_incapacidad: [
    {id:'empleador',label:'Empleador / Empresa',ph:'Nombre del empleador'},
    {id:'cargo',label:'Cargo del paciente',ph:''},
    {id:'diagnostico',label:'Diagn√≥stico',ph:''},
    {id:'codigoDx',label:'C√≥digo CIE-11 / DSM-5',ph:'Ej: F33.1'},
    {id:'justificacion',label:'Justificaci√≥n de la incapacidad',ph:'',area:true},
    {id:'periodo',label:'Per√≠odo de incapacidad recomendado',ph:'Ej: 15 d√≠as'},
    {id:'fechaInicio',label:'Fecha de inicio',ph:'',type:'date'},
    {id:'fechaFin',label:'Fecha de fin estimada',ph:'',type:'date'},
    {id:'recomendaciones',label:'Recomendaciones',ph:'',area:true},
  ],
};

function renderCamposEspecificos(tipo) {
  const campos = CAMPOS_POR_TIPO[tipo]||[];
  document.getElementById('doc-campos-especificos').innerHTML = campos.map(c=>`
    <div class="doc-field-group">
      <label class="lbl">${c.label}</label>
      ${c.area
        ? `<textarea id="doc-${c.id}" placeholder="${c.ph||''}">${c.val||''}</textarea>`
        : `<input type="${c.type||'text'}" id="doc-${c.id}" placeholder="${c.ph||''}" value="${c.val||''}">`
      }
    </div>`).join('');
}

function docGetDatos() {
  const campos = CAMPOS_POR_TIPO[docTipoSeleccionado]||[];
  const datos={};
  campos.forEach(c=>{ const el=document.getElementById('doc-'+c.id); if(el) datos[c.id]=el.value.trim(); });
  return datos;
}

function docGetPaciente() {
  return {
    nombre: document.getElementById('doc-pac-nombre').value.trim()||'___________',
    cc: document.getElementById('doc-pac-cc').value.trim(),
    ciudadExp: document.getElementById('doc-pac-ciudad').value.trim()||'Medell√≠n',
    fnac: document.getElementById('doc-pac-fnac').value,
    tratamiento: document.getElementById('doc-tratamiento').value.trim(),
  };
}

function docActualizarPreview() {
  if(!docTipoSeleccionado) return;
  const pac=docGetPaciente(), datos=docGetDatos();
  const tipo=DOC_TIPOS.find(t=>t.id===docTipoSeleccionado);
  const fecha=new Date().toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  const PSI={nombre:'Luisa Fernanda Garc√©s Garc√≠a',tp:'174366',cc:'1036602429',tel:'3246381453',email:'luisafgarces@gmail.com'};
  let contenido='';
  switch(docTipoSeleccionado){
    case 'cert_bilingue': case 'cert_espanol':
      contenido=`${datos.cuerpo||'[Cuerpo del certificado]'}\n\n${datos.observaciones||''}`;
      break;
    case 'cert_esa':
      contenido=`Condici√≥n: ${datos.diagnostico||'___'}\nAnimal: ${datos.nombreAnimal||'___'} ¬∑ ${datos.especieAnimal||'___'}`;
      break;
    case 'informe_seguimiento':
      contenido=`Per√≠odo: ${datos.periodo||'___'} ¬∑ Sesiones: ${datos.numSesiones||'___'}\n\nEvoluci√≥n: ${(datos.evolucion||'[Por completar]').slice(0,200)}...\n\nConclusiones: ${(datos.conclusiones||'[Por completar]').slice(0,150)}...`;
      break;
    case 'informe_diagnostico':
      contenido=`Diagn√≥stico: ${datos.diagnostico||'___'} (${datos.manual||'DSM-5'})\n\nResultados: ${(datos.resultados||'[Por completar]').slice(0,200)}...\n\nConclusiones: ${(datos.conclusiones||'[Por completar]').slice(0,150)}...`;
      break;
    case 'informe_legal':
      contenido=`Proceso: ${datos.tipoProcess||'___'} ¬∑ Radicado: ${datos.radicado||'___'}\n\nHallazgos: ${(datos.hallazgos||'[Por completar]').slice(0,200)}...\n\nConcepto: ${(datos.conclusiones||'[Por completar]').slice(0,150)}...`;
      break;
    case 'informe_incapacidad':
      contenido=`Empleador: ${datos.empleador||'___'} ¬∑ Diagn√≥stico: ${datos.diagnostico||'___'}\nPer√≠odo: ${datos.periodo||'___'} ¬∑ Del ${datos.fechaInicio||'___'} al ${datos.fechaFin||'___'}\n\n${(datos.justificacion||'[Por completar]').slice(0,200)}...`;
      break;
  }
  document.getElementById('doc-preview-box').innerHTML=`
    <h3>${tipo?.icon} ${tipo?.nombre}</h3>
    <p style="text-align:center;font-size:.75rem;color:var(--border);margin-bottom:14px">Vista previa ¬∑ El Word descargado incluye logo, encabezado y formato completo</p>
    <hr style="border:none;border-top:1px solid var(--bg);margin:10px 0">
    <p style="margin:6px 0;font-size:.82rem"><strong>Paciente:</strong> ${pac.nombre} ¬∑ C.C. ${pac.cc||'___'}</p>
    <div style="margin:12px 0">${contenido.replace(/\n/g,'<br>')}</div>
    <div class="firma-preview">
      <strong>${PSI.nombre}</strong><br>
      Psic√≥loga Titulada ¬∑ T.P. No. ${PSI.tp}<br>
      C.C. ${PSI.cc} ¬∑ ${PSI.tel} ¬∑ ${PSI.email}
    </div>`;
}

function docGenerar() {
  if(!docTipoSeleccionado){ toast('Selecciona un tipo de documento'); return; }
  const pac=docGetPaciente();
  if(pac.nombre==='___________'){ toast('Ingresa el nombre del paciente'); return; }
  const datos=docGetDatos();
  const tipo=DOC_TIPOS.find(t=>t.id===docTipoSeleccionado);
  const rtf=docGenerarRTF(tipo, pac, datos);
  const nombre=(tipo.nombre+'_'+pac.nombre.split(' ')[0]).replace(/\s+/g,'_');
  descargarArchivo(rtf, nombre+'_'+new Date().toLocaleDateString('es-CO').replace(/\//g,'-')+'.rtf', 'application/octet-stream');
  toast('Documento generado ‚úì ‚Äî √Åbrelo en Word para editar y firmar');
}

function docGenerarRTF(tipo, pac, datos) {
  const fecha=new Date().toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  const PSI={nombre:'Luisa Fernanda Garc√©s Garc√≠a',tp:'174366',cc:'1036602429',tel:'3246381453',email:'luisafgarces@gmail.com',dir:'Circular 73A # 39-79, Medell√≠n, Colombia'};
  function re(s){ if(!s) return ''; let o=''; for(let i=0;i<s.length;i++){ const c=s.charCodeAt(i); if(c>127){const n=c>32767?c-65536:c;o+='\\u'+n+'?';} else if(c===92)o+='\\\\'; else if(c===123)o+='\\{'; else if(c===125)o+='\\}'; else if(c===10||c===13)o+='\\line '; else o+=s[i];} return o; }
  function title(t){ return `{\\pard\\sb200\\sa120\\qc{\\f1\\b\\fs30\\cf1 ${re(t)}}\\par}\n`; }
  function subtitle(t){ return `{\\pard\\sb40\\sa160\\qc{\\f0\\fs18\\i\\cf2 ${re(t)}}\\par}\n`; }
  function sec(t){ return `{\\pard\\sb240\\sa60\\brdrb\\brdrs\\brdrw8\\brdrcf2{\\f0\\b\\fs20\\cf1 ${re(t.toUpperCase())}}\\par}\n`; }
  function camp(l,v){ if(!v) return ''; return `{\\pard\\sb60\\sa40{\\f0\\b\\fs19\\cf1 ${re(l+': ')}}{\\f0\\fs19\\cf3 ${re(v)}}\\par}\n`; }
  function par(t,opts={}){ if(!t) return ''; return `{\\pard\\sb80\\sa120\\qj{\\f0\\fs19\\cf3${opts.italic?'\\i':''} ${re(t)}}\\par}\n`; }
  function hr(){ return `{\\pard\\sb80\\sa80\\brdrb\\brdrs\\brdrw6\\brdrcf2\\par}\n`; }
  function enSection(label){ return `{\\pard\\sb80\\sa60{\\f0\\b\\fs18\\cf2 ${re(label)}}\\par}\n`; }

  let body='';
  switch(tipo.id){
    case 'cert_bilingue': case 'cert_espanol': {
      const bil=tipo.id==='cert_bilingue';
      body+=title(bil?'CERTIFICADO PSICOL√ìGICO / PSYCHOLOGICAL CERTIFICATE':'CERTIFICADO PSICOL√ìGICO');
      body+=hr();
      body+=par(`La suscrita, ${PSI.nombre}, Psic√≥loga Titulada con Tarjeta Profesional No. ${PSI.tp}, en el ejercicio de mis funciones profesionales, certifica lo siguiente:`);
      body+=par(`${pac.tratamiento||'El/La paciente'} ${pac.nombre}, identificado(a) con c√©dula de ciudadan√≠a n√∫mero ${pac.cc||'___________'} de ${pac.ciudadExp||'Medell√≠n'}, ha sido sometido(a) a una valoraci√≥n psicol√≥gica integral llevada a cabo mediante modalidad ${datos.modalidad||'virtual'}.`);
      body+=par(datos.cuerpo||(datos.diagnostico?`Con base en la evaluaci√≥n cl√≠nica realizada, se concluye que el/la paciente cumple con los criterios diagn√≥sticos de ${datos.diagnostico} (de acuerdo con el ${datos.manual||'DSM-5'}).`:'[Completar cuerpo del certificado]'));
      if(datos.observaciones) body+=par(datos.observaciones);
      body+=par(`Este certificado se emite a solicitud de la interesada/o para los fines que estime pertinentes, en Medell√≠n, a los ${fecha}.`);
      if(bil){
        body+=`{\\pard\\sb320\\sa40\\par}\n`;
        body+=hr();
        body+=enSection('ENGLISH VERSION');
        body+=par(`The undersigned, ${PSI.nombre}, Licensed Psychologist with Professional License No. ${PSI.tp}, hereby certifies the following:`);
        body+=par(`${pac.tratamiento_en||'The patient'} ${pac.nombre}, identified with citizenship ID number ${pac.cc||'___________'} from ${pac.ciudadExp||'Medell√≠n'}, has undergone a comprehensive psychological evaluation conducted via ${datos.modalidad==='presencial'?'in-person':'virtual'} modality.`);
        body+=par(datos.cuerpo_en||(datos.diagnostico_en||datos.diagnostico?`Based on the clinical assessment, the patient meets diagnostic criteria for ${datos.diagnostico_en||datos.diagnostico} (as per the ${datos.manual||'DSM-5'}).`:'[Add certificate body in English]'));
        body+=par(`This certificate is issued at the request of the interested party for the purposes deemed pertinent, in Medell√≠n, on ${new Date().toLocaleDateString('en-US',{day:'numeric',month:'long',year:'numeric'})}.`);
      }
      break;
    }
    case 'cert_esa': {
      body+=title('CERTIFICADO DE IDONEIDAD PARA ANIMAL DE SOPORTE EMOCIONAL (ESA)');
      body+=subtitle('Emotional Support Animal Certificate');
      body+=hr();
      body+=par(`Yo, ${PSI.nombre}, Psic√≥loga Titulada con Tarjeta Profesional No. ${PSI.tp}, certifico que he evaluado psicol√≥gicamente a:`);
      body+=camp('Paciente',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc); body+=camp('Diagn√≥stico / Condici√≥n',datos.diagnostico);
      body+=par(`Con base en la evaluaci√≥n cl√≠nica, certifico que ${pac.nombre.split(' ')[0]} presenta una condici√≥n de salud mental que justifica m√©dica y psicol√≥gicamente la tenencia de un Animal de Soporte Emocional (ESA).`);
      body+=sec('Informaci√≥n del Animal');
      body+=camp('Nombre',datos.nombreAnimal); body+=camp('Especie / Raza',datos.especieAnimal); body+=camp('Descripci√≥n',datos.descAnimal);
      body+=par(`Este certificado se emite en Medell√≠n, a los ${fecha}.`);
      body+=`{\\pard\\sb280\\sa0\\par}\n`; body+=hr(); body+=enSection('ENGLISH VERSION');
      body+=par(`I, ${PSI.nombre}, Licensed Psychologist (Professional License No. ${PSI.tp}), hereby certify that ${pac.nombre} presents a mental health condition (${datos.diagnostico||'___'}) that medically and psychologically justifies the need for an Emotional Support Animal (ESA).`);
      body+=par(`Animal: ${datos.nombreAnimal||'___'} ¬∑ ${datos.especieAnimal||'___'}${datos.descAnimal?' ¬∑ '+datos.descAnimal:''}. Issued in Medell√≠n, on ${new Date().toLocaleDateString('en-US',{day:'numeric',month:'long',year:'numeric'})}.`);
      break;
    }
    case 'informe_seguimiento': {
      body+=title('INFORME DE SEGUIMIENTO TERAP√âUTICO'); body+=hr();
      body+=sec('I. Datos de Identificaci√≥n');
      body+=camp('Paciente',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc);
      body+=camp('Diagn√≥stico',datos.diagnostico); body+=camp('Per√≠odo evaluado',datos.periodo);
      body+=camp('Modalidad',datos.modalidad); body+=camp('N√∫mero de sesiones',datos.numSesiones);
      body+=sec('II. Motivo de Consulta y Antecedentes'); body+=par(datos.motivoConsulta);
      body+=sec('III. Evoluci√≥n Cl√≠nica'); body+=par(datos.evolucion);
      if(datos.logros) body+=camp('Logros terap√©uticos',datos.logros);
      if(datos.dificultades) body+=camp('Dificultades observadas',datos.dificultades);
      body+=sec('IV. Estado Actual'); body+=par(datos.estadoActual);
      if(datos.estadoEmocional) body+=camp('Estado emocional promedio (1-10)',datos.estadoEmocional);
      body+=sec('V. Plan de Continuidad'); body+=par(datos.planContinuidad);
      body+=sec('VI. Conclusiones'); body+=par(datos.conclusiones);
      break;
    }
    case 'informe_diagnostico': {
      body+=title('INFORME PSICOL√ìGICO DE EVALUACI√ìN DIAGN√ìSTICA'); body+=hr();
      body+=sec('I. Datos de Identificaci√≥n');
      body+=camp('Paciente',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc);
      body+=camp('Fecha(s) de evaluaci√≥n',datos.fechaEval); body+=camp('Modalidad',datos.modalidad); body+=camp('Sesiones',datos.numSesiones);
      body+=sec('II. Motivo de Consulta'); body+=par(datos.motivoConsulta);
      body+=sec('III. Historia Cl√≠nica'); body+=par(datos.historia);
      body+=sec('IV. Instrumentos Utilizados'); body+=par(datos.instrumentos);
      body+=sec('V. Resultados'); body+=par(datos.resultados);
      body+=sec('VI. Diagn√≥stico');
      body+=camp('Diagn√≥stico principal',datos.diagnostico); body+=camp('Manual',datos.manual);
      if(datos.diagnosticoDif) body+=camp('Diagn√≥stico diferencial',datos.diagnosticoDif);
      body+=sec('VII. Recomendaciones'); body+=par(datos.recomendaciones);
      body+=sec('VIII. Conclusiones'); body+=par(datos.conclusiones);
      break;
    }
    case 'informe_legal': {
      body+=title('INFORME PSICOL√ìGICO PARA PROCESO LEGAL');
      body+=subtitle(datos.tipoProcess||'Evaluaci√≥n Pericial'); body+=hr();
      body+=`{\\pard\\sb80\\sa120{\\f0\\b\\fs18\\cf2 ${re('‚ö† DOCUMENTO CONFIDENCIAL ‚Äî USO EXCLUSIVO PARA FINES JUDICIALES')}}\\par}\n`;
      body+=sec('I. Datos del Solicitante');
      body+=camp('Solicitado por',datos.solicitante); body+=camp('Entidad',datos.entidad);
      body+=camp('Prop√≥sito',datos.proposito); body+=camp('Radicado',datos.radicado);
      body+=sec('II. Datos del Evaluado/a');
      body+=camp('Nombre',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc); body+=camp('Relaci√≥n con el proceso',datos.relacionProceso);
      body+=sec('III. Metodolog√≠a'); body+=par(datos.metodologia); body+=camp('Instrumentos',datos.instrumentos);
      body+=sec('IV. Hallazgos Cl√≠nicos'); body+=par(datos.hallazgos);
      body+=sec('V. An√°lisis Psicol√≥gico'); body+=par(datos.analisis);
      body+=sec('VI. Conclusiones y Concepto'); body+=par(datos.conclusiones);
      body+=sec('VII. Recomendaciones'); body+=par(datos.recomendaciones);
      body+=par('La profesional suscrita declara que el presente informe ha sido elaborado de manera objetiva, con base en la evidencia cl√≠nica recopilada.',{italic:true});
      break;
    }
    case 'informe_incapacidad': {
      body+=title('CERTIFICADO PSICOL√ìGICO DE INCAPACIDAD LABORAL'); body+=hr();
      body+=sec('I. Datos del Paciente');
      body+=camp('Nombre completo',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc);
      body+=camp('Empleador / Empresa',datos.empleador); body+=camp('Cargo',datos.cargo);
      body+=sec('II. Diagn√≥stico');
      body+=camp('Diagn√≥stico',datos.diagnostico); body+=camp('C√≥digo CIE-11 / DSM-5',datos.codigoDx);
      body+=sec('III. Justificaci√≥n de Incapacidad'); body+=par(datos.justificacion);
      body+=camp('Per√≠odo recomendado',datos.periodo); body+=camp('Fecha inicio',datos.fechaInicio); body+=camp('Fecha fin estimada',datos.fechaFin);
      body+=sec('IV. Recomendaciones'); body+=par(datos.recomendaciones);
      break;
    }
  }
  // Firma
  body+=`{\\pard\\sb400\\sa0\\par}\n`; body+=hr();
  body+=par(`En constancia se firma en Medell√≠n, a los ${fecha}.`,{italic:true});
  body+=`{\\pard\\sb360\\sa0{\\f0\\fs19\\cf3 ${re('_'.repeat(45))}}\\par}\n`;
  body+=`{\\pard\\sb40\\sa0{\\f0\\b\\fs22\\cf1 ${re(PSI.nombre)}}\\par}\n`;
  body+=`{\\pard\\sb20\\sa0{\\f0\\fs19\\cf2 ${re('Psic√≥loga Titulada ¬∑ T.P. No. '+PSI.tp)}}\\par}\n`;
  body+=`{\\pard\\sb20\\sa0{\\f0\\fs18\\cf3 ${re('C.C. '+PSI.cc+' ¬∑ '+PSI.tel+' ¬∑ '+PSI.email)}}\\par}\n`;
  body+=`{\\pard\\sb10\\sa0{\\f0\\fs18\\cf3 ${re(PSI.dir)}}\\par}\n`;

  return `{\\rtf1\\ansi\\ansicpg1252\\uc1\\deff0\n{\\fonttbl{\\f0\\fswiss Arial;}{\\f1\\froman Georgia;}}\n{\\colortbl;\\red100\\green48\\blue0;\\red205\\green142\\blue157;\\red80\\green80\\blue80;}\n\\widowctrl\\hyphauto\\paperw11906\\paperh16838\\margl1440\\margr1440\\margt1440\\margb1440\n${body}}`;
}


// ===================== PATIENT MODAL =====================
var _pacModalId = null;

function abrirPacModal(id){
  _pacModalId = id;
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===id)||{};
  document.getElementById("pac-modal-title").textContent = pac.nombre;
  document.getElementById("pac-modal-overlay").classList.add("open");
  document.querySelectorAll(".pac-hist-section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".pac-hist-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("pac-tab-datos").classList.add("active");
  document.querySelectorAll(".pac-hist-btn")[0].classList.add("active");
  renderPacModalDatos(pac);
  renderPacTabSesiones(pac);
  renderPacTabTests(pac);
  renderPacTabCancelaciones(pac);
  renderPacTabHistoria(pac);
}

function cerrarPacModal(){ document.getElementById("pac-modal-overlay").classList.remove("open"); _pacModalId=null; }

function switchPacTab(tab,btn){
  document.querySelectorAll(".pac-hist-section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".pac-hist-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("pac-tab-"+tab).classList.add("active");
  btn.classList.add("active");
}

function renderPacModalDatos(pac){
  const PARENTESCOS = ['‚Äî','Madre','Padre','Pareja','Esposo/a','Hijo/a','Hermano/a','Abuel@','T√≠o/a','Amigo/a cercano','Compa√±ero/a de trabajo','Otro familiar'];
  const selOpts = PARENTESCOS.map(p=>`<option ${(pac.emergParentesco||'')==p?'selected':''}>${p}</option>`).join('');
  document.getElementById('pac-tab-datos').innerHTML = `
    <div class="row col3">
      <div class="fg"><label class="lbl">Nombre completo</label><input type="text" id="pm-nombre" value="${pac.nombre||''}"></div>
      <div class="fg"><label class="lbl">Fecha nacimiento</label><input type="date" id="pm-fnac" value="${pac.fnac||''}"></div>
      <div class="fg"><label class="lbl">G√©nero</label>
        <select id="pm-genero"><option value="">‚Äî</option>
          ${['Femenino','Masculino','No binario','Prefiero no decir'].map(g=>`<option ${pac.genero===g?'selected':''}>${g}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="row col3">
      <div class="fg"><label class="lbl">Tel√©fono</label><input type="tel" id="pm-tel" value="${pac.tel||''}"></div>
      <div class="fg"><label class="lbl">Email</label><input type="email" id="pm-email" value="${pac.email||''}"></div>
      <div class="fg"><label class="lbl">Ocupaci√≥n</label><input type="text" id="pm-ocup" value="${pac.ocup||''}"></div>
    </div>
    <div class="row col3">
      <div class="fg"><label class="lbl">C√©dula / ID</label><input type="text" id="pm-cc" value="${pac.cc||''}"></div>
      <div class="fg"><label class="lbl">Contacto emergencia</label><input type="text" id="pm-emerg-nombre" value="${pac.emergNombre||''}"></div>
      <div class="fg"><label class="lbl">Parentesco</label><select id="pm-emerg-parentesco">${selOpts}</select></div>
    </div>
    <div class="row col2">
      <div class="fg"><label class="lbl">Tel. emergencia</label><input type="tel" id="pm-emerg-tel" value="${pac.emergTel||''}"></div>
      <div class="fg"><label class="lbl">Diagn√≥stico</label>
        <div class="cie-wrap">
          <input type="text" id="pm-dx" value="${pac.dx||''}" autocomplete="off" oninput="buscarCIE(this,'pm-dx-sugg')">
          <div class="cie-suggestions" id="pm-dx-sugg" style="display:none"></div>
        </div>
      </div>
    </div>
    <p style="font-size:.73rem;color:var(--border);margin-top:6px">Paciente desde: ${pac.creado ? new Date(pac.creado).toLocaleDateString('es-CO') : '‚Äî'}</p>
  `;
}

function guardarPacienteModal(){
  if(!_pacModalId) return;
  const pacs = getPacientes();
  const idx = pacs.findIndex(p=>p.id===_pacModalId);
  if(idx<0){ toast('Paciente no encontrado'); return; }
  pacs[idx].nombre = document.getElementById('pm-nombre').value.trim()||pacs[idx].nombre;
  pacs[idx].fnac = document.getElementById('pm-fnac').value;
  pacs[idx].genero = document.getElementById('pm-genero').value;
  pacs[idx].tel = document.getElementById('pm-tel').value;
  pacs[idx].email = document.getElementById('pm-email').value;
  pacs[idx].ocup = document.getElementById('pm-ocup').value;
  pacs[idx].cc = document.getElementById('pm-cc').value;
  pacs[idx].emergNombre = document.getElementById('pm-emerg-nombre').value;
  pacs[idx].emergParentesco = document.getElementById('pm-emerg-parentesco').value;
  pacs[idx].emergTel = document.getElementById('pm-emerg-tel').value;
  pacs[idx].dx = document.getElementById('pm-dx').value;
  savePacientes(pacs);
  fillSelects();
  renderPacientes();
  cerrarPacModal();
  toast('Paciente actualizado ‚úì');
}

function eliminarPaciente(id){
  if(!confirm('¬øEliminar este paciente y todos sus datos? Esta acci√≥n no se puede deshacer.')) return;
  const pacs = getPacientes().filter(p=>p.id!==id);
  savePacientes(pacs);
  DB.set('anamnesis_'+id, null);
  DB.set('plan_'+id, null);
  DB.set('sesiones_'+id, null);
  DB.set('tests_'+id, null);
  fillSelects(); renderPacientes(); cerrarPacModal();
  toast('Paciente eliminado ‚úì');
}

function renderPacTabSesiones(pac){
  const ses = DB.get('sesiones_'+pac.id)||[];
  const el = document.getElementById('pac-tab-sesiones');
  if(!ses.length){ el.innerHTML='<p style="font-size:.85rem;color:var(--border)">Sin sesiones registradas.</p>'; return; }
  el.innerHTML = `<p style="font-size:.8rem;color:var(--strong);margin-bottom:12px">${ses.length} sesi√≥n(es) registradas</p>` +
    ses.slice().reverse().map(s=>{
      const esCancelacion = s.tipo==='cancelacion';
      return `<div class="hist-item ${esCancelacion?'cancelada':''}" onclick="abrirDetalleSesionDesdeModal('${pac.id}','${s.id}')" style="cursor:pointer">
        <h5>${esCancelacion?'‚ùå Cancelaci√≥n':'Sesi√≥n #'+s.num} ‚Äî ${s.fecha||'‚Äî'}</h5>
        <p>${esCancelacion ? 'Motivo: '+(s.motivoCancelacion||'‚Äî') : 'Estado: '+(s.estado||5)+'/10 ¬∑ '+(s.dur||50)+' min'}</p>
        ${s.temas ? `<p style="margin-top:4px;font-size:.75rem;color:var(--text)">${s.temas.slice(0,100)}${s.temas.length>100?'...':''}</p>` : ''}
        ${s.tarea ? `<p style="margin-top:4px;font-size:.75rem;background:#fdf5f7;border-left:2px solid var(--border);padding:3px 8px;border-radius:0 5px 5px 0"><strong>üìå Tarea:</strong> ${s.tarea.slice(0,80)}${s.tarea.length>80?'...':''}</p>` : ''}
      </div>`;
    }).join('');
}

function renderPacTabTests(pac){
  const tests = DB.get('tests_'+pac.id)||[];
  const el = document.getElementById('pac-tab-tests');
  if(!tests.length){ el.innerHTML='<p style="font-size:.85rem;color:var(--border)">Sin tests registrados.</p>'; return; }
  el.innerHTML = tests.slice().reverse().map(t=>`
    <div class="hist-item"><h5>${t.test} ${t.score!==undefined ? '¬∑ Puntaje: '+t.score : ''}</h5>
    <p>${new Date(t.date).toLocaleDateString('es-CO')} ¬∑ ${t.severity||'‚Äî'}</p></div>
  `).join('');
}

function renderPacTabCancelaciones(pac){
  const ses = DB.get('sesiones_'+pac.id)||[];
  const cancels = ses.filter(s=>s.tipo==='cancelacion');
  const el = document.getElementById('pac-tab-cancelaciones');
  if(!cancels.length){ el.innerHTML='<p style="font-size:.85rem;color:var(--border)">Sin cancelaciones registradas. ‚úÖ</p>'; return; }
  el.innerHTML = `<p style="font-size:.8rem;color:#e57373;margin-bottom:12px;font-weight:700">${cancels.length} cancelaci√≥n(es) registradas</p>` +
    cancels.slice().reverse().map(s=>`<div class="hist-item cancelada">
      <h5>Cancelaci√≥n ‚Äî ${s.fecha||'‚Äî'}</h5><p>Motivo: ${s.motivoCancelacion||'‚Äî'}</p>
    </div>`).join('');
}

function renderPacTabHistoria(pac){
  const an = DB.get('anamnesis_'+pac.id)||{};
  const plan = DB.get('plan_'+pac.id)||{};
  const ses = DB.get('sesiones_'+pac.id)||[];
  // Collect all tasks from sessions
  const tareas = ses.filter(s=>s.tarea&&s.tarea.trim()&&s.tipo!=='cancelacion').map(s=>({
    sesNum: s.num, fecha: s.fecha, tarea: s.tarea, revision: ''
  }));
  // Try to find revision status from NEXT session
  tareas.forEach((t,i)=>{
    const nextSes = ses.filter(s=>s.tipo!=='cancelacion').find(s=>parseInt(s.num)===(parseInt(t.sesNum)+1));
    if(nextSes && nextSes.tareaRevision) t.revision = nextSes.tareaRevision;
  });
  
  document.getElementById('pac-tab-histclinica').innerHTML = `
    <div style="margin-bottom:14px"><div class="subsec">Motivo de consulta</div>
    <div style="font-size:.87rem;line-height:1.7">${an.motivo||'‚Äî'}</div></div>
    <div style="margin-bottom:14px"><div class="subsec">Diagn√≥stico</div>
    <div style="font-size:.87rem;line-height:1.7">${pac.dx||an.dx||plan.dx||'‚Äî'}</div></div>
    <div style="margin-bottom:14px"><div class="subsec">Medicaci√≥n actual</div>
    <div style="font-size:.87rem;line-height:1.7">${an.med||'‚Äî'}</div></div>
    <div style="margin-bottom:14px"><div class="subsec">Objetivo terap√©utico</div>
    <div style="font-size:.87rem;line-height:1.7">${plan.objetivo||'‚Äî'}</div></div>
    ${plan.objetivo?`<div style="margin-bottom:14px"><div class="subsec">T√©cnicas del plan</div>
    <div style="font-size:.87rem">${[plan.t1,plan.t2].filter(Boolean).join(' ¬∑ ')||'‚Äî'}</div></div>`:''}
    <div style="margin-bottom:14px"><div class="subsec">Contacto de emergencia</div>
    <div style="font-size:.87rem">${pac.emergNombre||an.emergN||'‚Äî'} ${pac.emergParentesco?'('+pac.emergParentesco+')':''} ¬∑ ${pac.emergTel||an.emergT||'‚Äî'}</div></div>
    ${tareas.length?`<div style="margin-bottom:14px"><div class="subsec">üìå Historial de Tareas (todas las sesiones)</div>
    ${tareas.map(t=>`<div class="hist-item" style="margin-bottom:8px">
      <h5>Sesi√≥n #${t.sesNum} ‚Äî ${t.fecha||'‚Äî'} ${t.revision?'<span style="font-size:.72rem;padding:2px 8px;border-radius:10px;background:'+(t.revision==='Completa'?'#d4f5d4':t.revision==='No realizada'?'#fdd':'#fef3cd')+';color:#333;margin-left:6px">'+t.revision+'</span>':''}</h5>
      <p style="font-size:.83rem">${t.tarea}</p>
    </div>`).join('')}
    </div>`:''}
    <div class="btn-row" style="margin-top:12px">
      <button class="btn" onclick="goPageDirect('anamnesis');cerrarPacModal()">üìã Ir a Anamnesis</button>
      <button class="btn" onclick="goPageDirect('plan');cerrarPacModal()">üó∫Ô∏è Ir a Plan</button>
      <button class="btn primary" style="background:var(--border)" onclick="exportarHistoriaClinica('${pac.id}')">üìÑ Generar Historia Cl√≠nica</button>
    </div>`;
}

// ===================== EXPORTAR HISTORIA CL√çNICA =====================
function exportarHistoriaClinica(pacId){
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pacId)||{};
  const an = DB.get('anamnesis_'+pacId)||{};
  const plan = DB.get('plan_'+pacId)||{};
  const ses = DB.get('sesiones_'+pacId)||[];
  const tests = DB.get('tests_'+pacId)||[];

  const sesSinCancel = ses.filter(s=>s.tipo!=='cancelacion');
  const cancels = ses.filter(s=>s.tipo==='cancelacion');

  const LOGO_B64 = document.getElementById('logo-img')&&document.getElementById('logo-img').src ? document.getElementById('logo-img').src : '';

  function esc(v){ return (v||'‚Äî').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  function fila(label, val){
    if(!val||val==='‚Äî') return '';
    return `<tr><td class="lbl-cell">${label}</td><td>${esc(val)}</td></tr>`;
  }

  function edad(fnac){
    if(!fnac) return '';
    const d = new Date(fnac);
    const hoy = new Date();
    let a = hoy.getFullYear()-d.getFullYear();
    if(hoy.getMonth()<d.getMonth()||(hoy.getMonth()===d.getMonth()&&hoy.getDate()<d.getDate())) a--;
    return a+' a√±os';
  }

  const fechaHoy = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});
  const fnacStr = pac.fnac ? new Date(pac.fnac).toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'}) + (edad(pac.fnac)?' ('+edad(pac.fnac)+')':'') : '‚Äî';

  // Sesiones HTML
  let sesHtml = '';
  if(sesSinCancel.length){
    sesHtml = `<h3 class="sec-title">üìù Registro de Sesiones (${sesSinCancel.length})</h3>`;
    sesSinCancel.forEach(s=>{
      sesHtml += `<div class="ses-block">
        <div class="ses-header">Sesi√≥n #${s.num} &mdash; ${esc(s.fecha)} &nbsp;|&nbsp; ${s.dur||50} min &nbsp;|&nbsp; E.E.: ${s.estado||'‚Äî'}/10</div>
        ${s.temas?`<p><strong>Temas:</strong> ${esc(s.temas)}</p>`:''}
        ${s.avances?`<p><strong>Avances:</strong> ${esc(s.avances)}</p>`:''}
        ${s.tarea?`<p><strong>Tarea para casa:</strong> ${esc(s.tarea)}</p>`:''}
        ${s.acuerdos?`<p><strong>Acuerdos:</strong> ${esc(s.acuerdos)}</p>`:''}
        ${(s.testsAplicados&&s.testsAplicados.length)?`<p><strong>Tests:</strong> ${s.testsAplicados.map(esc).join(', ')}</p>`:''}
      </div>`;
    });
  }

  // Tests
  let testsHtml = '';
  if(tests.length){
    testsHtml = `<h3 class="sec-title">üß™ Tests Aplicados</h3><table class="info-table">
      <thead><tr><th>Test</th><th>Fecha</th><th>Puntaje</th><th>Severidad</th></tr></thead><tbody>
      ${tests.map(t=>`<tr><td>${esc(t.test)}</td><td>${t.date?new Date(t.date).toLocaleDateString('es-CO'):'‚Äî'}</td><td>${t.score!==undefined?t.score:'‚Äî'}</td><td>${esc(t.severity)}</td></tr>`).join('')}
      </tbody></table>`;
  }

  // Cancelaciones
  let cancelHtml = '';
  if(cancels.length){
    cancelHtml = `<h3 class="sec-title">‚ùå Cancelaciones (${cancels.length})</h3><table class="info-table">
      <thead><tr><th>Fecha</th><th>Motivo</th></tr></thead><tbody>
      ${cancels.map(s=>`<tr><td>${esc(s.fecha)}</td><td>${esc(s.motivoCancelacion)}</td></tr>`).join('')}
      </tbody></table>`;
  }

  // Distorsiones cognitivas
  let dcHtml = '';
  if(an.distorsiones && Object.keys(an.distorsiones).length){
    const dcActivas = Object.entries(an.distorsiones).filter(([k,v])=>v&&v.selected);
    if(dcActivas.length){
      dcHtml = `<h3 class="sec-title">üß† Distorsiones Cognitivas</h3><ul style="margin-left:18px;line-height:1.9">
        ${dcActivas.map(([k,v])=>`<li>${esc(k.replace(/_/g,' '))}${v.nivel?' ‚Äî <em>'+esc(v.nivel)+'</em>':''}</li>`).join('')}
      </ul>`;
      if(an['dc-obs']) dcHtml += `<p><strong>Observaciones:</strong> ${esc(an['dc-obs'])}</p>`;
    }
  }

  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Historia Cl√≠nica ‚Äî ${esc(pac.nombre)}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400;700&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Lato', Arial, sans-serif; font-size: 13px; color: #3a1a00; background: #fff; line-height: 1.6; }
  .page { max-width: 800px; margin: 0 auto; padding: 40px 40px 60px; }

  /* HEADER */
  .header { display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #cd8e9d; padding-bottom: 18px; margin-bottom: 28px; }
  .logo-wrap img { width: 90px; height: auto; }
  .prof-info { text-align: right; }
  .prof-name { font-family: 'Playfair Display', serif; font-size: 1.15rem; color: #643000; font-weight: 600; }
  .prof-title { font-size: .82rem; color: #cd8e9d; letter-spacing: .05em; }
  .prof-contact { font-size: .78rem; color: #888; margin-top: 3px; }

  /* TITLE BAND */
  .title-band { background: linear-gradient(135deg, #fadae1, #f5c8d4); border-radius: 10px; padding: 16px 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
  .hc-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: #643000; }
  .hc-fecha { font-size: .78rem; color: #a0536a; }

  /* SECTIONS */
  .sec-title { font-family: 'Playfair Display', serif; font-size: .98rem; color: #cd8e9d; border-bottom: 1px solid #fadae1; padding-bottom: 5px; margin: 22px 0 10px; }
  .info-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
  .info-table th { background: #cd8e9d; color: #fff; padding: 7px 10px; font-size: .78rem; text-align: left; }
  .info-table td { padding: 6px 10px; font-size: .82rem; border-bottom: 1px solid #f0dde2; vertical-align: top; }
  .info-table tr:nth-child(even) td { background: #fdf0f3; }
  .lbl-cell { font-weight: 700; color: #a0536a; width: 190px; white-space: nowrap; }

  /* SESSION BLOCK */
  .ses-block { border: 1px solid #e8d0d6; border-radius: 10px; padding: 12px 16px; margin-bottom: 12px; page-break-inside: avoid; }
  .ses-header { background: linear-gradient(90deg, #fadae1, #f9eef1); color: #643000; font-weight: 700; font-size: .82rem; padding: 6px 10px; border-radius: 6px; margin: -12px -16px 10px; border-radius: 9px 9px 0 0; }
  .ses-block p { font-size: .82rem; margin-bottom: 5px; }

  /* FOOTER */
  .footer { margin-top: 48px; border-top: 1px solid #e8d0d6; padding-top: 12px; font-size: .72rem; color: #aaa; text-align: center; }
  .footer .sign-area { display: inline-block; margin-top: 36px; text-align: center; border-top: 1px solid #643000; padding-top: 6px; min-width: 220px; font-size: .78rem; color: #643000; }

  /* APPLE PENCIL ANNOTATION AREA */
  .annotation-area { margin-top: 18px; border: 1.5px dashed #cd8e9d; border-radius: 10px; padding: 12px 14px; min-height: 80px; position: relative; }
  .annotation-label { font-size: .72rem; color: #cd8e9d; position: absolute; top: 8px; right: 12px; }

  @media print {
    body { font-size: 12px; }
    .page { padding: 20px; }
    .no-print { display: none; }
  }
</style>
</head>
<body>
<div class="page">

  <!-- HEADER CORPORATIVO -->
  <div class="header">
    <div class="logo-wrap">
      ${LOGO_B64 ? `<img src="${LOGO_B64}" alt="Logo">` : '<div style="width:80px;height:60px;background:#fadae1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.8rem">üå∏</div>'}
    </div>
    <div class="prof-info">
      <div class="prof-name">Luisa Fernanda Garc√©s Garc√≠a</div>
      <div class="prof-title">Psic√≥loga ¬∑ TP 174366</div>
      <div class="prof-contact">3246381453 ¬∑ luisafgarces@gmail.com</div>
    </div>
  </div>

  <!-- BANDA T√çTULO -->
  <div class="title-band">
    <div class="hc-title">üìã Historia Cl√≠nica</div>
    <div class="hc-fecha">Generada: ${fechaHoy}</div>
  </div>

  <!-- DATOS PERSONALES -->
  <h3 class="sec-title">üë§ Datos del Paciente</h3>
  <table class="info-table">
    ${fila('Nombre completo', pac.nombre)}
    ${fila('C√©dula / ID', pac.cc)}
    ${fila('Fecha de nacimiento', fnacStr)}
    ${fila('G√©nero', pac.genero)}
    ${fila('Tel√©fono', pac.tel)}
    ${fila('Email', pac.email)}
    ${fila('Ocupaci√≥n', pac.ocup)}
    ${fila('Paciente desde', pac.creado ? new Date(pac.creado).toLocaleDateString('es-CO') : null)}
  </table>

  <!-- CONTACTO EMERGENCIA -->
  ${(pac.emergNombre||an.emergN) ? `<h3 class="sec-title">üö® Contacto de Emergencia</h3>
  <table class="info-table">
    ${fila('Nombre', pac.emergNombre||an.emergN)}
    ${fila('Parentesco', pac.emergParentesco||an.emergParent)}
    ${fila('Tel√©fono', pac.emergTel||an.emergT)}
  </table>` : ''}

  <!-- MOTIVO CONSULTA -->
  ${an.motivo ? `<h3 class="sec-title">üí¨ Motivo de Consulta</h3>
  <div style="background:#fdf5f7;border-left:3px solid #cd8e9d;border-radius:0 8px 8px 0;padding:10px 14px;font-size:.85rem;line-height:1.7">${esc(an.motivo)}</div>` : ''}

  <!-- DIAGN√ìSTICO -->
  ${(pac.dx||an.dx||plan.dx) ? `<h3 class="sec-title">üî¨ Diagn√≥stico (CIE-11)</h3>
  <div style="background:#fdf5f7;border-left:3px solid #cd8e9d;border-radius:0 8px 8px 0;padding:10px 14px;font-size:.85rem">${esc(pac.dx||an.dx||plan.dx)}</div>` : ''}

  <!-- ANAMNESIS CLAVE -->
  ${(an.med||an.antPersonales||an.antFamiliares||an.redApoyo) ? `<h3 class="sec-title">üìÑ Datos Cl√≠nicos</h3>
  <table class="info-table">
    ${fila('Medicaci√≥n actual', an.med)}
    ${fila('Antecedentes personales', an.antPersonales)}
    ${fila('Antecedentes familiares', an.antFamiliares)}
    ${fila('Red de apoyo', an.redApoyo)}
  </table>` : ''}

  <!-- PLAN DE TRATAMIENTO -->
  ${(plan.objetivo||plan.estrategia) ? `<h3 class="sec-title">üó∫Ô∏è Plan de Tratamiento</h3>
  <table class="info-table">
    ${fila('Objetivo terap√©utico', plan.objetivo)}
    ${fila('Enfoque/estrategia', plan.estrategia)}
    ${fila('Duraci√≥n estimada', plan.duracion)}
  </table>` : ''}

  <!-- DISTORSIONES COGNITIVAS -->
  ${dcHtml}

  <!-- SESIONES -->
  ${sesHtml}

  <!-- TESTS -->
  ${testsHtml}

  <!-- CANCELACIONES -->
  ${cancelHtml}

  <!-- √ÅREA DE ANOTACIONES (Apple Pencil) -->
  <h3 class="sec-title">‚úèÔ∏è Anotaciones adicionales</h3>
  <div class="annotation-area">
    <span class="annotation-label">√Årea para notas / Apple Pencil</span>
  </div>

  <!-- FIRMA -->
  <div class="footer">
    <div style="display:flex;justify-content:space-around;align-items:flex-end;margin-bottom:16px;">
      <div style="text-align:center;min-width:190px;">
        <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;color:#a0536a;letter-spacing:.5px;margin-bottom:8px;">Paciente</div>
        <div style="height:50px;border-bottom:1.5px solid #cd8e9d;margin-bottom:6px;"></div>
        <div style="font-size:.8rem;color:#643000;">${esc(pac.nombre)}</div>
      </div>
      <div style="text-align:center;min-width:210px;">
        <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;color:#a0536a;letter-spacing:.5px;margin-bottom:6px;">Psic&oacute;loga Tratante</div>
        <img src="${FIRMA_DATA}" alt="Firma" style="height:50px;object-fit:contain;display:block;margin:0 auto 6px;">
        <div style="border-top:1.5px solid #cd8e9d;padding-top:6px;font-size:.8rem;color:#643000;"><strong>Luisa Fernanda Garc&eacute;s Garc&iacute;a</strong></div>
        <div style="font-size:.62rem;color:#cd8e9d;">TP 174366</div>
      </div>
    </div>
    <p style="margin-top:16px">Este documento es confidencial y de uso exclusivo cl&iacute;nico &middot; Generado con Suite Cl&iacute;nica</p>
  </div>

</div>

<!-- BOTONES DE ACCI√ìN (no se imprimen) -->
<div class="no-print" style="position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:10px;z-index:999">
  <button onclick="window.print()" style="background:#cd8e9d;color:#fff;border:none;padding:12px 22px;border-radius:24px;font-size:.9rem;cursor:pointer;box-shadow:0 4px 16px rgba(100,48,0,.2)">üñ®Ô∏è Imprimir / Guardar PDF</button>
  <button onclick="window.close()" style="background:#fadae1;color:#643000;border:1px solid #cd8e9d;padding:10px 22px;border-radius:24px;font-size:.9rem;cursor:pointer">‚úï Cerrar</button>
</div>

</body>
</html>`;

  // Abrir en nueva ventana o descargar con compatibilidad iOS
  var blob = new Blob([html], {type:'text/html;charset=utf-8'});
  var url;
  try { url = URL.createObjectURL(blob); } catch(e){ url = null; }
  
  var opened = false;
  if(url && !url.startsWith('blob:null')){
    var w = window.open(url, '_blank');
    opened = !!w;
  }
  if(!opened){
    descargarArchivo(html, 'HistoriaClinica_'+((pac.nombre||'Paciente').replace(/\s+/g,'_'))+'.html', 'text/html;charset=utf-8');
    toast('Historia cl√≠nica descargada ‚Äî √°brela en el navegador para imprimir');
  } else {
    setTimeout(()=>URL.revokeObjectURL(url), 30000);
  }
}

// ===================== SESSION DETAIL =====================
function abrirDetalleSesion(pid, sid){
  const ses = DB.get('sesiones_'+pid)||[];
  const s = ses.find(x=>x.id===sid);
  if(!s) return;
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  mostrarDetalleSesion(pac, s);
}

function abrirDetalleSesionDesdeModal(pid, sid){
  cerrarPacModal();
  setTimeout(()=>abrirDetalleSesion(pid, sid), 200);
}

function mostrarDetalleSesion(pac, s){
  const esCancelacion = s.tipo==='cancelacion';
  document.getElementById('ses-detail-title').textContent = esCancelacion ? `Cancelaci√≥n ‚Äî ${s.fecha||''}` : `Sesi√≥n #${s.num} ‚Äî ${s.fecha||''}`;
  const testsHtml = (s.testsAplicados && s.testsAplicados.length)
    ? `<div style="margin-top:12px"><div class="subsec">Tests aplicados</div><div>${s.testsAplicados.map(t=>`<span style="background:var(--bg);color:var(--strong);border-radius:10px;font-size:.75rem;padding:3px 10px;margin-right:4px;display:inline-block;margin-bottom:4px">${t}</span>`).join('')}</div></div>`
    : '';
  document.getElementById('ses-detail-content').innerHTML = esCancelacion ? `
    <div class="summary-box"><strong>Paciente:</strong> ${pac.nombre}<br><strong>Fecha:</strong> ${s.fecha||'‚Äî'}<br><strong>Motivo de cancelaci√≥n:</strong> ${s.motivoCancelacion||'‚Äî'}</div>
  ` : `
    <div style="font-size:.78rem;color:var(--strong);margin-bottom:16px">${pac.nombre} ¬∑ Duraci√≥n: ${s.dur||50} min ¬∑ Estado emocional: ${s.estado||5}/10</div>
    ${s.temas ? `<div style="margin-bottom:14px"><div class="subsec">Temas trabajados</div><div style="font-size:.88rem;line-height:1.7">${s.temas}</div></div>` : ''}
    ${s.avances ? `<div style="margin-bottom:14px"><div class="subsec">Avances y observaciones</div><div style="font-size:.88rem;line-height:1.7">${s.avances}</div></div>` : ''}
    ${s.tarea ? `<div style="margin-bottom:14px;background:var(--soft);border-left:3px solid var(--border);border-radius:0 10px 10px 0;padding:12px"><div class="subsec" style="margin-top:0">üìå Tarea para casa</div><div style="font-size:.88rem;line-height:1.7">${s.tarea}</div></div>` : ''}
    ${s.acuerdos ? `<div style="margin-bottom:14px"><div class="subsec">Acuerdos pr√≥xima sesi√≥n</div><div style="font-size:.88rem;line-height:1.7">${s.acuerdos}</div></div>` : ''}
    ${testsHtml}
  `;
  document.getElementById('ses-detail-overlay').classList.add('open');
}

// ===================== CIE-11 =====================
const CIE11_DATA = [
  {code:'6A00',name:'Trastorno de ansiedad generalizada'},
  {code:'6A01',name:'Trastorno de p√°nico'},
  {code:'6A02',name:'Agorafobia'},
  {code:'6A03',name:'Fobia espec√≠fica'},
  {code:'6A04',name:'Trastorno de ansiedad social'},
  {code:'6A05',name:'Trastorno de separaci√≥n'},
  {code:'6B00',name:'Trastorno obsesivo-compulsivo'},
  {code:'6B01',name:'Dismorfofobia'},
  {code:'6B40',name:'Trastorno de estr√©s postraum√°tico (TEPT)'},
  {code:'6B41',name:'Trastorno de estr√©s agudo'},
  {code:'6B42',name:'Trastorno adaptativo'},
  {code:'6B43',name:'Trastorno de duelo prolongado'},
  {code:'6A20',name:'Episodio depresivo sin s√≠ntomas psic√≥ticos'},
  {code:'6A21',name:'Episodio depresivo con s√≠ntomas psic√≥ticos'},
  {code:'6A70',name:'Trastorno depresivo recurrente'},
  {code:'6A60',name:'Trastorno bipolar tipo I'},
  {code:'6A61',name:'Trastorno bipolar tipo II'},
  {code:'6A62',name:'Trastorno ciclot√≠mico'},
  {code:'6D10',name:'Trastorno de personalidad borderline'},
  {code:'6D11',name:'Trastorno narcisista de la personalidad'},
  {code:'6D12',name:'Trastorno de personalidad antisocial'},
  {code:'6D13',name:'Trastorno histri√≥nico de la personalidad'},
  {code:'6D14',name:'Trastorno esquizoide'},
  {code:'6D15',name:'Trastorno paranoide de la personalidad'},
  {code:'6D16',name:'Trastorno de personalidad obsesivo-compulsivo'},
  {code:'6D17',name:'Trastorno de personalidad evitativa'},
  {code:'6D18',name:'Trastorno de personalidad dependiente'},
  {code:'6A50',name:'Anorexia nerviosa'},
  {code:'6A51',name:'Bulimia nerviosa'},
  {code:'6A52',name:'Trastorno por atrac√≥n'},
  {code:'7A00',name:'Insomnio cr√≥nico'},
  {code:'6C00',name:'Trastorno por uso de alcohol'},
  {code:'6C10',name:'Trastorno por uso de cannabis'},
  {code:'HA00',name:'Trastorno de d√©ficit de atenci√≥n e hiperactividad (TDAH)'},
  {code:'6A80',name:'Trastorno del espectro autista'},
  {code:'MB23',name:'Disforia de g√©nero'},
  {code:'6B60',name:'Trastorno disociativo de identidad'},
  {code:'QE84',name:'Duelo no complicado'},
  {code:'MG24',name:'Problemas relacionados con el estr√©s laboral'},
];

function buscarCIE(inputEl, suggId){
  const q = inputEl.value.trim().toLowerCase();
  const sugg = document.getElementById(suggId);
  if(!q || q.length<2){ sugg.style.display='none'; return; }
  const resultados = CIE11_DATA.filter(c=>
    c.code.toLowerCase().includes(q) || c.name.toLowerCase().includes(q)
  ).slice(0,10);
  if(!resultados.length){ sugg.style.display='none'; return; }
  sugg.style.display='block';
  sugg.innerHTML = resultados.map(c=>`
    <div class="cie-item" onclick="seleccionarCIE('${c.code}','${c.name.replace(/'/g,"\\'")}','${inputEl.id}','${suggId}')">
      <span class="cie-code">${c.code}</span>${c.name}
    </div>
  `).join('');
}

function seleccionarCIE(code, name, inputId, suggId){
  const el = document.getElementById(inputId);
  if(!el) return;
  if(el.tagName==='TEXTAREA'){
    const val = el.value.trim();
    el.value = val ? val + '\n' + code + ' - ' + name : code + ' - ' + name;
  } else {
    el.value = code + ' - ' + name;
  }
  document.getElementById(suggId).style.display='none';
}

document.addEventListener('click', function(e){
  document.querySelectorAll('.cie-suggestions').forEach(s=>{
    if(!s.contains(e.target) && !s.previousElementSibling?.contains(e.target)) s.style.display='none';
  });
});

// ===================== DISTORSIONES COGNITIVAS =====================
// Distorsiones cognitivas TCC (Beck)
const DISTORSIONES = [
  {id:'pensamiento_dicotomico',name:'Pensamiento dicot√≥mico (polarizaci√≥n)',desc:'Ver en blanco o negro, sin grises',grupo:'dc'},
  {id:'sobregeneralizacion',name:'Sobregeneralizaci√≥n',desc:'Conclusiones generales a partir de un evento',grupo:'dc'},
  {id:'abstraccion_select',name:'Abstracci√≥n selectiva',desc:'Foco exclusivo en aspectos negativos ignorando el contexto',grupo:'dc'},
  {id:'inferencia_arb',name:'Inferencia arbitraria',desc:'Conclusiones sin evidencia suficiente',grupo:'dc'},
  {id:'lectura_mente',name:'Lectura de mente',desc:'Asumir lo que otros piensan sin evidencia',grupo:'dc'},
  {id:'prediccion',name:'Adivinaci√≥n del futuro',desc:'Anticipar resultados negativos como certeza',grupo:'dc'},
  {id:'catastrofismo',name:'Catastrofizaci√≥n',desc:'Exagerar la magnitud de los problemas',grupo:'dc'},
  {id:'magnificacion',name:'Magnificaci√≥n',desc:'Amplificar lo negativo de forma desproporcionada',grupo:'dc'},
  {id:'minimizacion',name:'Minimizaci√≥n',desc:'Restar importancia a los propios logros o positivos',grupo:'dc'},
  {id:'razon_emocional',name:'Razonamiento emocional',desc:'Sentir algo como prueba de que es verdad',grupo:'dc'},
  {id:'deberia',name:'Afirmaciones imperativas ("deber√≠a")',desc:'Reglas r√≠gidas sobre c√≥mo actuar uno o los dem√°s',grupo:'dc'},
  {id:'etiquetado',name:'Etiquetaci√≥n global',desc:'Asignarse etiquetas globales negativas',grupo:'dc'},
  {id:'personalizacion',name:'Personalizaci√≥n',desc:'Atribuirse responsabilidad excesiva de eventos externos',grupo:'dc'},
  {id:'culpabilizacion',name:'Culpabilizaci√≥n',desc:'Atribuir a otros toda la responsabilidad del propio malestar',grupo:'dc'},
  // Creencias nucleares disfuncionales
  {id:'cn_desvalorizacion',name:'Desvalorizaci√≥n personal',desc:'Creencia: soy in√∫til / incompetente',grupo:'cn'},
  {id:'cn_indeseable',name:'Indeseabilidad',desc:'Creencia: no soy digno/a de amor',grupo:'cn'},
  {id:'cn_vulnerabilidad',name:'Vulnerabilidad',desc:'Creencia: el mundo es peligroso',grupo:'cn'},
  {id:'cn_desamparo',name:'Desamparo / impotencia',desc:'Creencia: no puedo hacer nada para cambiar',grupo:'cn'},
  {id:'cn_control',name:'Falta de control',desc:'Creencia: no tengo control sobre mi vida o emociones',grupo:'cn'},
  // Creencias intermedias
  {id:'ci_supuestos',name:'Supuestos condicionales disfuncionales',desc:'Si... entonces... (reglas impl√≠citas)',grupo:'ci'},
  {id:'ci_reglas',name:'Reglas r√≠gidas de funcionamiento',desc:'Normas inflexibles sobre c√≥mo deben ser las cosas',grupo:'ci'},
  {id:'ci_perfeccionismo',name:'Actitudes perfeccionistas',desc:'Est√°ndares imposiblemente altos como medida de valor',grupo:'ci'},
];

window._dcSeleccionadas = {};

function renderDCGrid(){
  const el = document.getElementById('dc-grid');
  if(!el) return;
  const noAplica = window._dcSeleccionadas && window._dcSeleccionadas['__no_aplica'];
  if(noAplica){
    el.innerHTML = '<div style="background:#f5eaec;border-radius:8px;padding:8px 14px;font-size:.85rem;color:var(--strong);font-style:italic">No aplica ‚Äî sin distorsiones identificadas</div>';
    return;
  }
  function renderGrupo(grupo, titulo) {
    const items = DISTORSIONES.filter(d=>d.grupo===grupo);
    const noApGrupo = window._dcSeleccionadas && window._dcSeleccionadas['__no_aplica_'+grupo];
    const header = '<div style="grid-column:1/-1;font-size:.72rem;font-weight:700;color:var(--border);text-transform:uppercase;letter-spacing:1px;margin:12px 0 4px;padding-bottom:4px;border-bottom:1px solid var(--bg)">'+titulo+'</div>';
    if(noApGrupo) return header+'<div style="grid-column:1/-1;background:#f5eaec;border-radius:8px;padding:6px 14px;font-size:.8rem;color:var(--strong);font-style:italic;margin-bottom:6px">No aplica ‚Äî sin identificar en este grupo &nbsp;<button onclick="delete window._dcSeleccionadas[\'__no_aplica_'+grupo+'\'];renderDCGrid();" style="border:none;background:none;cursor:pointer;font-size:.75rem;color:var(--border)">‚úï Quitar</button></div>';
    return header + items.map(d=>{
        const info = window._dcSeleccionadas[d.id]||null;
        const nivel = info ? info.nivel : '';
        return `<div class="dc-item ${info?'selected':''}" id="dc-${d.id}" onclick="toggleDC('${d.id}')">
          <div class="dc-name">${d.name}</div>
          <div class="dc-desc">${d.desc}</div>
          <div class="dc-nivel" onclick="event.stopPropagation()">
            ${['Leve','Moderada','Severa'].map(n=>`<button class="dc-nivel-btn ${nivel===n?'sel':''}" onclick="setDCNivel('${d.id}','${n}')">${n}</button>`).join('')}
          </div>
        </div>`;
      }).join('');
  }
  el.innerHTML = renderGrupo('dc','üìã Distorsiones Cognitivas (Beck ‚Äì TCC)') + renderGrupo('cn','üß† Creencias Nucleares Disfuncionales') + renderGrupo('ci','üîó Creencias Intermedias');
}

function toggleDC(id){
  if(window._dcSeleccionadas[id]) delete window._dcSeleccionadas[id];
  else window._dcSeleccionadas[id] = {nivel:''};
  renderDCGrid();
}

function setDCNivel(id, nivel){
  if(!window._dcSeleccionadas[id]) window._dcSeleccionadas[id] = {};
  window._dcSeleccionadas[id].nivel = nivel;
  renderDCGrid();
}

function dcNoAplica(){
  window._dcSeleccionadas = {__no_aplica: true};
  renderDCGrid();
}

function dcGrupoNoAplica(grupo){
  if(!window._dcSeleccionadas) window._dcSeleccionadas={};
  window._dcSeleccionadas['__no_aplica_'+grupo]=true;
  DISTORSIONES.filter(function(d){ return d.grupo===grupo; }).forEach(function(d){
    delete window._dcSeleccionadas[d.id];
  });
  renderDCGrid();
}

function dcLimpiarTodo(){
  window._dcSeleccionadas={};
  renderDCGrid();
}

function sincronizarAhora(){
  DB._loaded = false;
  DB.loadAll().then(function(ok){
    if(!ok) return;
    var ag = DB.get('agenda_eventos');
    if(ag){ agEventos.length=0; ag.forEach(function(e){ agEventos.push(e); }); }
    var fin = DB.get('finanzas_registros');
    if(fin){ registros.length=0; fin.forEach(function(r){ registros.push(r); }); }
    renderDashboard();
    fillSelects();
    if(typeof renderAgenda === 'function') renderAgenda();
    if(typeof renderAll === 'function') renderAll();
    toast('Datos actualizados desde la nube ‚úì');
  });
}

document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('an-fecha').valueAsDate = new Date();
  document.getElementById('pl-fecha').valueAsDate = new Date();
  document.getElementById('ses-fecha').valueAsDate = new Date();
  fillSelects();
  renderDashboard();
  renderDCGrid();
  renderSesDCGrid();
  // Verificar cumplea√±os al inicio (esperar un poco para que carguen los datos)
  setTimeout(verificarCumpleanos, 1800);

  // Sincronizar con Firebase y refrescar UI
  DB.loadAll().then(function(ok){
    if(!ok) return;
    // Recargar variables globales con datos de la nube
    var ag = DB.get('agenda_eventos');
    if(ag){ agEventos.length=0; ag.forEach(function(e){ agEventos.push(e); }); }
    var fin = DB.get('finanzas_registros');
    if(fin){ registros.length=0; fin.forEach(function(r){ registros.push(r); }); }
    // Re-renderizar con datos frescos de la nube
    renderDashboard();
    fillSelects();
    if(typeof renderAgenda === 'function') renderAgenda();
    if(typeof renderAll === 'function') renderAll();
    // Verificar cumplea√±os con datos frescos
    setTimeout(verificarCumpleanos, 400);
  });
});

// ===================== QR GENERATOR (via API externa) =====================
function generarQRCanvas(canvasId, texto, size){
  var canvas = document.getElementById(canvasId);
  if(!canvas) return;
  var ctx = canvas.getContext('2d');
  canvas.width = size; canvas.height = size;
  // Fondo de marca mientras carga
  ctx.fillStyle = '#fadae1';
  ctx.fillRect(0,0,size,size);
  ctx.fillStyle = '#cd8e9d';
  ctx.font = 'bold 11px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Cargando QR...', size/2, size/2);
  var url = 'https://api.qrserver.com/v1/create-qr-code/?size='+size+'x'+size+'&color=643000&bgcolor=fadae1&data='+encodeURIComponent(texto);
  var img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = function(){
    ctx.clearRect(0,0,size,size);
    ctx.drawImage(img, 0, 0, size, size);
  };
  img.onerror = function(){
    // Fallback: patr√≥n visual simple
    ctx.fillStyle = '#fadae1'; ctx.fillRect(0,0,size,size);
    ctx.fillStyle = '#643000';
    var sq = size/8;
    for(var r=0;r<8;r++) for(var c=0;c<8;c++){
      if(Math.random()>0.5){ ctx.fillStyle='#cd8e9d'; ctx.fillRect(c*sq+1,r*sq+1,sq-2,sq-2); }
    }
    // Esquinas de QR
    [[0,0],[5,0],[0,5]].forEach(function(pos){
      ctx.strokeStyle='#643000'; ctx.lineWidth=2;
      ctx.strokeRect(pos[0]*sq, pos[1]*sq, sq*2, sq*2);
      ctx.fillStyle='#643000';
      ctx.fillRect(pos[0]*sq+4, pos[1]*sq+4, sq*2-8, sq*2-8);
    });
    ctx.fillStyle='#643000'; ctx.font='bold 9px Arial'; ctx.textAlign='center';
    ctx.fillText('QR', size/2, size/2+3);
  };
  img.src = url;
}


// ‚îÄ‚îÄ‚îÄ Exportar Plan como Word editable ‚îÄ‚îÄ‚îÄ
function exportarPlanWord(){
  var pid = document.getElementById('pl-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  var data = DB.get('plan_'+pid)||{};
  var pacs = getPacientes();
  var pac = pacs.find(function(p){ return p.id===pid; })||{nombre:'Paciente'};
  var fechaDoc = new Date().toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'});

  function rtf(str){
    if(!str) return '';
    var out = '';
    for(var i=0;i<str.length;i++){
      var c=str.charCodeAt(i);
      if(c>127){ var s=c>32767?c-65536:c; out+='\\u'+s+'?'; }
      else if(c===92) out+='\\\\';
      else if(c===123) out+='\\{';
      else if(c===125) out+='\\}';
      else out+=str[i];
    }
    return out;
  }
  function sec(t){ return '{\\pard\\sb240\\sa80{\\b\\fs24\\cf2 '+rtf(t)+'}\\par}'; }
  function par(t){ return t?'{\\pard\\sb60\\sa60{\\fs20\\cf1 '+rtf(t)+'}\\par}':''; }
  function campo(l,v){ return v?'{\\pard\\sb80\\sa40{\\b\\fs20\\cf1 '+rtf(l)+': }{\\fs20\\cf1 '+rtf(String(v))+'}\\par}':''; }

  var fasesRtf = '';
  (data.fases||[]).forEach(function(f,i){
    if(!f[0]&&!f[1]&&!f[2]) return;
    fasesRtf += '{\\pard\\sb120\\sa40{\\b\\fs20\\cf3 Fase '+(i+1)+(f[0]?' ‚Äî '+rtf(f[0]):'')+(f[3]?' ('+rtf(f[3])+' sem.)':'')+'}\\par}';
    if(f[1]) fasesRtf += par('Objetivos: '+f[1]);
    if(f[2]) fasesRtf += par('T√©cnicas: '+f[2]);
  });

  var partes = [
    '{\\rtf1\\ansi\\ansicpg1252\\uc1\\deff0',
    '{\\fonttbl{\\f0\\fswiss Arial;}{\\f1\\froman Georgia;}}',
    '{\\colortbl;\\red100\\green48\\blue0;\\red205\\green142\\blue157;\\red160\\green83\\blue106;}',
    '{\\pard\\sb0\\sa60{\\f1\\b\\fs36\\cf2 '+rtf('Plan de Tratamiento Psicol√≥gico')+'}\\par}',
    '{\\pard\\sb0\\sa40{\\f0\\fs20\\cf1 '+rtf('Luisa Fernanda Garc√©s Garc√≠a ¬∑ Psic√≥loga ¬∑ TP 174366')+'}\\par}',
    '{\\pard\\sb0\\sa200{\\f0\\fs18\\cf3 '+rtf(fechaDoc)+'}\\par}',
    campo('Paciente', pac.nombre),
    campo('Fecha inicio', data.fecha),
    campo('Modalidad', data.modalidad),
    campo('Frecuencia', data.frecuencia),
    data.dx ? sec('Diagn√≥stico de Trabajo') + par(data.dx) : '',
    data.objetivo ? sec('Objetivo General') + par(data.objetivo) : '',
    data.t1 ? sec('Objetivo Espec√≠fico 1') + par(data.t1) : '',
    data.t2 ? sec('Objetivo Espec√≠fico 2') + par(data.t2) : '',
    fasesRtf ? sec('Fases del Proceso Terap√©utico') + fasesRtf : '',
    data.mat ? sec('Materiales y Recursos') + par(data.mat) : '',
    data.apps ? sec('Apps / Herramientas') + par(data.apps) : '',
    data.emerg ? sec('Plan de Emergencias') + par(data.emerg) : '',
    '{\\pard\\sb300\\sa80\\brdrb\\brdrs\\brdrw10 \\par}',
    '{\\pard\\sb200\\sa60{\\b\\fs22\\cf2 '+rtf('FIRMAS')+'}\\par}',
    '{\\pard\\sb120\\sa120{\\f0\\fs20\\cf1 '+rtf('Paciente: _________________________________     Fecha: ___-___-_____')+'}\\par}',
    '{\\pard\\sb60\\sa60{\\f0\\b\\fs20\\cf1 '+rtf('Psic√≥loga: Luisa Fernanda Garc√©s Garc√≠a     TP 174366')+'}\\par}',
    '}'
  ];

  var rtfContent = partes.filter(Boolean).join('\n');
  descargarArchivo(rtfContent, 'Plan_'+pac.nombre.replace(/\s+/g,'_')+'.rtf', 'application/octet-stream');
  toast('üìù Descargado ‚Äî √°brelo con Word o WordPad');
}


// ===================== CUMPLEA√ëOS =====================
var _bdayPac = null;

function verificarCumpleanos(){
  var pacs = getPacientes();
  if(!pacs.length) return;
  var hoy = new Date();
  var dH = hoy.getDate(), mH = hoy.getMonth()+1;
  var cumpleaneros = pacs.filter(function(p){
    if(!p.fnac) return false;
    var pts = p.fnac.split('-');
    return parseInt(pts[1])===mH && parseInt(pts[2])===dH;
  });
  cumpleaneros.forEach(function(p, i){
    setTimeout(function(){ mostrarBadgeBday(p); }, i*700);
  });
}

function mostrarBadgeBday(pac){
  var edad = pac.fnac ? (new Date().getFullYear() - parseInt(pac.fnac.split('-')[0])) : 0;
  var badge = document.createElement('div');
  badge.className = 'bday-badge';
  badge.id = 'bday-badge-'+pac.id;
  badge.innerHTML = '<button class="bday-badge-x" onclick="event.stopPropagation();this.parentElement.remove();">\u2715</button>'+
    '<h4>\uD83C\uDF82 \u00a1Cumplea\u00f1os hoy!</h4>'+
    '<p><strong>'+pac.nombre+'</strong>'+(edad?' \u00b7 '+edad+' a\u00f1os':'')+
    '<br>Toca para generar su imagen de felicitaci\u00f3n \uD83C\uDF38</p>';
  badge.onclick = function(ev){
    if(ev.target.tagName==='BUTTON') return;
    badge.remove();
    abrirBdayModal(pac);
  };
  document.body.appendChild(badge);
  setTimeout(function(){
    if(document.getElementById('bday-badge-'+pac.id)){
      badge.style.transition='opacity 0.5s';
      badge.style.opacity='0';
      setTimeout(function(){ badge.remove(); }, 500);
    }
  }, 14000);
}

function abrirBdayModal(pac){
  _bdayPac = pac;
  var edad = pac.fnac ? (new Date().getFullYear() - parseInt(pac.fnac.split('-')[0])) : 0;
  document.getElementById('bdayPacName').firstChild.textContent = pac.nombre;
  document.getElementById('bdayPacSub').textContent = edad ? '\u00a1Cumple '+edad+' a\u00f1os hoy! \uD83C\uDF89' : '\u00a1Feliz cumplea\u00f1os!';
  document.getElementById('bdayOverlay').classList.add('open');
  setTimeout(function(){ dibujarBday(pac, edad); }, 60);
}

function dibujarBday(pac, edad){
  var canvas = document.getElementById('bdayCanvas');
  var W=800, H=480;
  canvas.width=W; canvas.height=H;
  var ctx = canvas.getContext('2d');

  // Fondo degradado
  var g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0,'#fff8f9'); g.addColorStop(0.5,'#fadae1'); g.addColorStop(1,'#f5c8d4');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // C√≠rculos decorativos
  function circ(x,y,r,color,a){ ctx.save(); ctx.globalAlpha=a; ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  circ(70,70,130,'#cd8e9d',0.10); circ(730,400,170,'#cd8e9d',0.09);
  circ(400,480,220,'#e8b4c0',0.07); circ(0,360,110,'#fadae1',0.28);

  // Flores decorativas
  function flor(x,y,r,color){
    ctx.save(); ctx.globalAlpha=0.5;
    for(var i=0;i<6;i++){
      var a=(i/6)*Math.PI*2;
      ctx.fillStyle=color; ctx.beginPath();
      ctx.ellipse(x+Math.cos(a)*r*0.6,y+Math.sin(a)*r*0.6,r*0.42,r*0.22,a,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=0.85; ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.arc(x,y,r*0.27,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  flor(65,230,38,'#cd8e9d'); flor(735,175,32,'#e8a0b0');
  flor(105,405,27,'#e8a0b0'); flor(695,375,34,'#cd8e9d'); flor(385,450,21,'#f0b8c6');

  // Logo
  var logo = document.getElementById('logo-img');
  if(logo && logo.complete && logo.naturalWidth){ try{ ctx.save(); ctx.globalAlpha=0.93; ctx.drawImage(logo,W/2-58,18,116,78); ctx.restore(); }catch(e){} }

  // Texto principal
  ctx.save(); ctx.textAlign='center';
  ctx.shadowColor='rgba(160,83,106,0.2)'; ctx.shadowBlur=20;
  ctx.font='italic bold 54px "Playfair Display",Georgia,serif';
  var tg=ctx.createLinearGradient(W/2-200,0,W/2+200,0);
  tg.addColorStop(0,'#a0536a'); tg.addColorStop(0.5,'#cd8e9d'); tg.addColorStop(1,'#a0536a');
  ctx.fillStyle=tg;
  ctx.fillText('\u00a1Feliz Cumplea\u00f1os!', W/2, 195);
  ctx.restore();

  // Nombre
  var nombre2 = pac.nombre.split(' ').slice(0,2).join(' ');
  ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#643000';
  ctx.font='bold 36px "Playfair Display",Georgia,serif';
  ctx.shadowColor='rgba(100,48,0,0.12)'; ctx.shadowBlur=8;
  ctx.fillText(nombre2, W/2, 256);
  ctx.restore();

  if(edad){
    ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#a0536a';
    ctx.font='500 22px Lato,Arial,sans-serif';
    ctx.fillText('\uD83C\uDF38 '+edad+' a\u00f1os llenos de luz \uD83C\uDF38', W/2, 296);
    ctx.restore();
  }

  ctx.save(); ctx.textAlign='center'; ctx.globalAlpha=0.82; ctx.fillStyle='#7a3d20';
  ctx.font='18px Lato,Arial,sans-serif';
  ctx.fillText('Que este d\u00eda est\u00e9 lleno de alegr\u00eda, amor y bienestar.', W/2, 340);
  ctx.fillText('\u00a1Que sea un a\u00f1o maravilloso para ti! \uD83C\uDF89', W/2, 366);
  ctx.restore();

  // Separador
  ctx.save(); ctx.strokeStyle='#cd8e9d'; ctx.globalAlpha=0.38; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(W/2-130,400); ctx.lineTo(W/2+130,400); ctx.stroke(); ctx.restore();

  // Firma
  ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#cd8e9d';
  ctx.font='italic 15px "Playfair Display",Georgia,serif';
  ctx.fillText('Con cari\u00f1o \u00b7 Luisa Fernanda Garc\u00e9s Garc\u00eda \u00b7 Psic\u00f3loga', W/2, 422);
  ctx.fillStyle='#a0536a'; ctx.globalAlpha=0.65; ctx.font='13px Lato,Arial';
  ctx.fillText(new Date().toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'}), W/2, 448);
  ctx.restore();
}

function bdayDescargar(){
  var canvas=document.getElementById('bdayCanvas');
  var nombre=_bdayPac?_bdayPac.nombre.replace(/\s+/g,'_'):'Cumpleanos';
  var a=document.createElement('a'); a.download='FelizCumpleanos_'+nombre+'.png'; a.href=canvas.toDataURL('image/png'); a.click();
}
function bdayWA(){
  if(!_bdayPac) return;
  var n   = _bdayPac.nombre.split(' ')[0];
  var msg = '\uD83C\uDF82\uD83C\uDF38 *\u00a1Feliz Cumplea\u00f1os, '+n+'!* \uD83C\uDF38\uD83C\uDF82\n\n'
          + 'Espero que este d\u00eda tan especial est\u00e9 lleno de alegr\u00eda,\n'
          + 'amor y momentos hermosos.\n'
          + '\u00a1Que este nuevo a\u00f1o te traiga todo lo que mereces!\n\n'
          + 'Con mucho cari\u00f1o,\n'
          + '*Luisa Fernanda Garc\u00e9s Garc\u00eda*\n'
          + '_Psic\u00f3loga_';
  var canvas = document.getElementById('bdayCanvas');
  var imgNombre = 'FelizCumpleanos_'+n.replace(/\s+/g,'_')+'.png';

  // Intentar Web Share API (funciona en m√≥vil - comparte imagen directo a WA)
  if(navigator.share && navigator.canShare){
    canvas.toBlob(function(blob){
      if(!blob){ _bdayWAFallback(msg, canvas, imgNombre); return; }
      var file = new File([blob], imgNombre, {type:'image/png'});
      if(navigator.canShare({files:[file]})){
        navigator.share({files:[file], text:msg}).catch(function(){ _bdayWAFallback(msg, canvas, imgNombre); });
      } else { _bdayWAFallback(msg, canvas, imgNombre); }
    },'image/png');
  } else {
    _bdayWAFallback(msg, canvas, imgNombre);
  }
}

function _bdayWAFallback(msg, canvas, imgNombre){
  // Descargar imagen
  var a = document.createElement('a');
  a.download = imgNombre;
  a.href = canvas.toDataURL('image/png');
  a.style.display='none';
  document.body.appendChild(a); a.click();
  setTimeout(function(){ a.remove(); }, 2000);
  // Abrir WhatsApp Web con el mensaje (adjunta la imagen manualmente)
  setTimeout(function(){
    window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
  }, 600);
  toast('\uD83D\uDCF1 Imagen descargada \u2014 en WhatsApp toca el clip \uD83D\uDCCE, adjunta la imagen y env\u00eda \uD83C\uDF38');
}

// ===================== IMAGEN RECORDATORIO CITA =====================
var _citaImg = null;

function abrirImagenCita(evId){
  var ev = _agEventMap[evId];
  if(!ev) return;
  _citaImg = ev;
  document.getElementById('citaImgOverlay').classList.add('open');
  setTimeout(function(){ dibujarImagenCita(ev); }, 60);
}

function dibujarImagenCita(ev){
  var canvas=document.getElementById('citaImgCanvas');
  var W=800, H=500;
  canvas.width=W; canvas.height=H;
  var ctx=canvas.getContext('2d');

  var hora=agFormatHora(ev.inicio), horaFin=agFormatHora(ev.fin);
  var fe=new Date(ev.inicio);
  var dias=['Domingo','Lunes','Martes','Mi\u00e9rcoles','Jueves','Viernes','S\u00e1bado'];
  var meses2=['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
  var diaStr=dias[fe.getDay()]+', '+fe.getDate()+' de '+meses2[fe.getMonth()]+' de '+fe.getFullYear();
  var esVirtual=ev.tipo==='virtual';
  var nombreCita=ev.titulo.replace(/CONSULTORIO (VIRTUAL|PRESENCIAL)\s*[-\u2013]\s*/i,'').trim()||ev.titulo;

  // Fondo
  var g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#fdf5f7'); g.addColorStop(1,'#fadae1');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // Franja superior
  var fg=ctx.createLinearGradient(0,0,W,0);
  fg.addColorStop(0,'#c07d8e'); fg.addColorStop(0.5,'#cd8e9d'); fg.addColorStop(1,'#c07d8e');
  ctx.fillStyle=fg; ctx.fillRect(0,0,W,95);

  // C√≠rculos en franja
  function cf(x,y,r,a){ ctx.save(); ctx.globalAlpha=a; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  cf(55,47,55,0.08); cf(745,47,65,0.08);

  // Logo en franja
  var logo=document.getElementById('logo-img');
  if(logo && logo.complete && logo.naturalWidth){ try{ ctx.save(); ctx.globalAlpha=0.94; ctx.drawImage(logo,W/2-40,6,80,54); ctx.restore(); }catch(e){} }

  ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#fff';
  ctx.shadowColor='rgba(80,30,0,0.3)'; ctx.shadowBlur=10;
  ctx.font='italic bold 20px "Playfair Display",Georgia,serif';
  ctx.fillText('Recordatorio de Cita \uD83C\uDF38', W/2, 82);
  ctx.restore();

  // Tarjeta blanca
  ctx.save(); ctx.fillStyle='rgba(255,255,255,0.9)';
  ctx.shadowColor='rgba(160,83,106,0.13)'; ctx.shadowBlur=28; ctx.shadowOffsetY=5;
  rrect(ctx,55,110,W-110,305,20); ctx.fill(); ctx.restore();

  // √çcono tipo
  ctx.font='40px serif'; ctx.textAlign='center';
  ctx.fillText(esVirtual?'\uD83D\uDCBB':'\uD83C\uDFE5', W/2, 170);

  ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#643000';
  ctx.font='bold 27px "Playfair Display",Georgia,serif';
  ctx.shadowColor='rgba(100,48,0,0.1)'; ctx.shadowBlur=5;
  ctx.fillText(nombreCita, W/2, 212);
  ctx.restore();

  ctx.save(); ctx.strokeStyle='#fadae1'; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(W/2-150,228); ctx.lineTo(W/2+150,228); ctx.stroke(); ctx.restore();

  // Filas datos
  function fila(ic,txt,y){
    ctx.save(); ctx.font='19px serif'; ctx.textAlign='left'; ctx.fillText(ic,W/2-175,y);
    ctx.font='bold 15px Lato,Arial'; ctx.fillStyle='#a0536a';
    ctx.fillText(txt.toUpperCase(), W/2-138, y); ctx.restore();
  }
  fila('\uD83D\uDCC5', diaStr, 265);
  fila('\u23F0', hora+' \u2013 '+horaFin, 300);
  fila('\uD83D\uDCCD', esVirtual?'Sesi\u00f3n virtual':'Presencial \u00b7 Consultorio', 335);
  if(ev.descripcion){ fila('\uD83D\uDCAC', ev.descripcion.slice(0,48)+(ev.descripcion.length>48?'...':''), 370); }

  // Pie
  ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#7a3d20'; ctx.globalAlpha=0.78;
  ctx.font='italic 14px "Playfair Display",Georgia,serif';
  ctx.fillText('Si necesitas cambiar tu cita, por favor av\u00edsame con anticipaci\u00f3n.', W/2, 434);
  ctx.restore();
  ctx.save(); ctx.textAlign='center'; ctx.fillStyle='#cd8e9d'; ctx.font='13px Lato,Arial';
  ctx.fillText('Luisa Fernanda Garc\u00e9s Garc\u00eda \u00b7 Psic\u00f3loga \u00b7 TP 174366', W/2, 460);
  ctx.fillStyle='#a0536a'; ctx.globalAlpha=0.58; ctx.font='12px Lato,Arial';
  ctx.fillText('3246381453 \u00b7 luisafgarces@gmail.com', W/2, 480);
  ctx.restore();
}

function rrect(ctx,x,y,w,h,r){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function citaImgDescargar(){
  var canvas=document.getElementById('citaImgCanvas');
  var titulo=_citaImg?_citaImg.titulo.replace(/\s+/g,'_').slice(0,28):'Recordatorio';
  var a=document.createElement('a'); a.download='Recordatorio_'+titulo+'.png'; a.href=canvas.toDataURL('image/png'); a.click();
}
function citaImgWA(){
  if(!_citaImg) return;
  var hora=agFormatHora(_citaImg.inicio);
  var fe=new Date(_citaImg.inicio);
  var meses2=['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
  var msg='\uD83C\uDF38 *Recordatorio de tu cita* \uD83C\uDF38\n\nHola! Te recuerdo tu cita el *'+fe.getDate()+' de '+meses2[fe.getMonth()]+'* a las *'+hora+'*.\n\n';
  msg+=_citaImg.tipo==='virtual'?'\uD83D\uDCBB Modalidad: *Virtual*\n':'\uD83C\uDFE5 Modalidad: *Presencial*\n';
  if(_citaImg.descripcion) msg+='\n'+_citaImg.descripcion+'\n';
  msg+='\nSi necesitas cambiarla, por favor av\u00edsame con anticipaci\u00f3n \uD83D\uDE4F\n\n*Luisa Fernanda Garc\u00e9s Garc\u00eda*\n_Psic\u00f3loga \u00b7 TP 174366_';
  
  var canvas=document.getElementById('citaImgCanvas');
  // Intentar compartir imagen con Web Share API (funciona en iOS Safari, Android Chrome)
  if(navigator.share && navigator.canShare){
    canvas.toBlob(function(blob){
      if(!blob){ window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank'); return; }
      var file = new File([blob],'Recordatorio.png',{type:'image/png'});
      var shareData = {files:[file], text:msg};
      if(navigator.canShare(shareData)){
        navigator.share(shareData).catch(function(){
          // Si falla compartir con imagen, intentar solo texto
          var shareText = {text:msg};
          if(navigator.canShare(shareText)) navigator.share(shareText).catch(function(){ window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank'); });
          else window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
        });
      } else {
        window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
      }
    },'image/png');
  } else {
    // Fallback: abrir WhatsApp con texto + indicar descarga de imagen
    citaImgDescargar();
    setTimeout(function(){
      window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
    }, 800);
    toast('\uD83D\uDCF1 Imagen descargada \u2014 \u00e1brela en WhatsApp para enviarla');
  }
}
</script>

<!-- Firebase cargado al final del body para garantizar que est√© disponible -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
(function(){
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    _firebaseDB = firebase.firestore();
    console.log("Firebase conectado correctamente");
    // Sincronizar datos al conectar
    DB.loadAll().then(function(ok){
      if(!ok) return;
      var ag = DB.get('agenda_eventos');
      if(ag && typeof agEventos !== 'undefined'){ agEventos.length=0; ag.forEach(function(e){ agEventos.push(e); }); }
      var fin = DB.get('finanzas_registros');
      if(fin && typeof registros !== 'undefined'){ registros.length=0; fin.forEach(function(r){ registros.push(r); }); }
      if(typeof renderDashboard==='function') renderDashboard();
      if(typeof fillSelects==='function') fillSelects();
      if(typeof renderAgenda==='function') renderAgenda();
      if(typeof renderAll==='function') renderAll();
    });
  } catch(e) {
    console.warn("Firebase no disponible:", e);
    showSyncBadge("‚ö†Ô∏è Modo local ‚Äî sin sincronizaci√≥n", "#e57373");
  }
})();

// ‚îÄ‚îÄ‚îÄ P√°gina Cumplea√±os ‚îÄ‚îÄ‚îÄ
function renderCumpleanos(){
  var pacs = getPacientes();
  var hoy = new Date();
  var dH=hoy.getDate(), mH=hoy.getMonth()+1;
  var meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  var mesesMin=['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

  var hoyPacs = pacs.filter(function(p){
    if(!p.fnac) return false;
    var pts=p.fnac.split('-');
    return parseInt(pts[1])===mH && parseInt(pts[2])===dH;
  });
  var cardHoy=document.getElementById('cumple-hoy-card');
  var listHoy=document.getElementById('cumple-hoy-list');
  if(cardHoy){
    if(hoyPacs.length){
      cardHoy.style.display='';
      listHoy.innerHTML=hoyPacs.map(function(p){
        var edad=hoy.getFullYear()-parseInt(p.fnac.split('-')[0]);
        return '<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #fadae1">'
          +'<span style="font-size:2rem">üå∏</span>'
          +'<div style="flex:1"><div style="font-weight:700;color:var(--text)">'+p.nombre+'</div>'
          +'<div style="font-size:.78rem;color:var(--strong)">¬°Cumple '+edad+' a√±os hoy!</div></div>'
          +'<button class="btn primary" style="font-size:.78rem;padding:6px 14px" onclick="(function(){'
          +'var pp=getPacientes().find(function(x){return x.id===\''+p.id+'\';});'
          +'if(pp) abrirBdayModal(pp);})()">üéÇ Generar imagen</button>'
          +'</div>';
      }).join('');
    } else {
      cardHoy.style.display='none';
    }
  }

  var btnsEl=document.getElementById('cumple-meses-btns');
  if(btnsEl){
    btnsEl.innerHTML=meses.map(function(m,i){
      var has=pacs.some(function(p){ return p.fnac && parseInt(p.fnac.split('-')[1])===i+1; });
      return '<button class="btn'+(has?' primary':'')+'" style="font-size:.75rem;padding:5px 12px" onclick="filtrarCumpleMes('+(i+1)+')">'+m+'</button>';
    }).join('');
  }

  var pacFecha=pacs.filter(function(p){ return !!p.fnac; });
  pacFecha.sort(function(a,b){
    var aM=parseInt(a.fnac.split('-')[1]),aD=parseInt(a.fnac.split('-')[2]);
    var bM=parseInt(b.fnac.split('-')[1]),bD=parseInt(b.fnac.split('-')[2]);
    return aM!==bM ? aM-bM : aD-bD;
  });
  var porMes={};
  pacFecha.forEach(function(p){ var m=parseInt(p.fnac.split('-')[1]); if(!porMes[m]) porMes[m]=[]; porMes[m].push(p); });

  var html='';
  meses.forEach(function(mes,i){
    var list=porMes[i+1]||[];
    html+='<div class="cumple-mes-sec" data-mes="'+(i+1)+'">';
    html+='<div style="font-size:.72rem;font-weight:700;color:var(--border);text-transform:uppercase;letter-spacing:1px;margin:14px 0 6px;padding-bottom:4px;border-bottom:1.5px solid var(--bg)">'+mes+(list.length?' ('+list.length+')':'')+'</div>';
    if(list.length){
      list.forEach(function(p){
        var pts=p.fnac.split('-');
        var d=parseInt(pts[2]),m2=parseInt(pts[1]);
        var esHoy=(d===dH&&m2===mH);
        var edad=hoy.getFullYear()-parseInt(pts[0]);
        html+='<div style="display:flex;align-items:center;gap:12px;padding:8px 10px;border-radius:10px;margin-bottom:4px;background:'+(esHoy?'#fadae1':'var(--soft)')+(esHoy?';border:1.5px solid #cd8e9d':'')+'">'
          +'<span style="font-size:1.3rem">'+(esHoy?'üéÇ':'üå∏')+'</span>'
          +'<div style="flex:1">'
            +'<div style="font-weight:700;color:var(--text);font-size:.88rem">'+p.nombre+'</div>'
            +'<div style="font-size:.74rem;color:var(--strong)">'+d+' de '+mesesMin[m2-1]+' ¬∑ '+edad+' a√±os'+(esHoy?' üéâ ¬°Hoy!':'')+'</div>'
          +'</div>'
          +(esHoy ? '<button class="btn" style="font-size:.72rem;padding:4px 10px" onclick="(function(){var pp=getPacientes().find(function(x){return x.id===\''+p.id+'\';});if(pp) abrirBdayModal(pp);})()">üéÇ Imagen</button>' : '')
          +'</div>';
      });
    } else {
      html+='<div style="font-size:.78rem;color:var(--border);padding:4px 6px">Sin pacientes este mes</div>';
    }
    html+='</div>';
  });
  var listaEl=document.getElementById('cumple-lista');
  if(listaEl) listaEl.innerHTML=html||'<p style="font-size:.85rem;color:var(--border)">No hay pacientes con fecha de nacimiento registrada.</p>';
}

function filtrarCumpleMes(mes){
  document.querySelectorAll('.cumple-mes-sec').forEach(function(el){
    el.style.display=(parseInt(el.dataset.mes)===mes)?'':'none';
  });
}
// ===================== PESTA√ëA CUMPLEA√ëOS EN AGENDA =====================
function agRenderCumpleanos(){
  var pacs  = getPacientes().filter(function(p){ return !!p.fnac; });
  var hoy   = new Date();
  var dH=hoy.getDate(), mH=hoy.getMonth()+1, anioH=hoy.getFullYear();
  var MESES_L = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  var MESES_m = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

  function diasHasta(d,m){
    var t = new Date(anioH, m-1, d);
    if(t.getTime() - hoy.getTime() < -86400000) t = new Date(anioH+1, m-1, d);
    return Math.round((t - hoy) / 86400000);
  }

  function cardBday(p, extraBtns){
    var pts=p.fnac.split('-'); var d=parseInt(pts[2]), m=parseInt(pts[1]);
    var edad = anioH - parseInt(pts[0]);
    var esHoy=(d===dH && m===mH);
    var dias = diasHasta(d,m);
    var subtitulo = esHoy ? ('\u00a1Cumple '+edad+' a\u00f1os hoy! \uD83C\uDF89') : ('En '+dias+' d\u00eda'+(dias!==1?'s':'')+' \u00b7 Cumple '+edad);
    return '<div style="display:flex;align-items:center;gap:14px;padding:10px 6px;border-radius:12px;margin-bottom:6px;background:'+(esHoy?'#fadae1':'var(--soft)')+(esHoy?';border:1.5px solid #cd8e9d':'')+'">'
      +'<div style="min-width:46px;text-align:center;background:#fff;border:1.5px solid #fadae1;border-radius:12px;padding:6px 4px;flex-shrink:0">'
        +'<div style="font-size:.62rem;font-weight:700;color:#cd8e9d;text-transform:uppercase;letter-spacing:.8px">'+MESES_m[m-1].slice(0,3)+'</div>'
        +'<div style="font-size:1.35rem;font-weight:800;color:#643000;line-height:1.1">'+d+'</div>'
      +'</div>'
      +'<div style="flex:1;min-width:0">'
        +'<div style="font-family:\'Playfair Display\',serif;font-size:.93rem;color:#643000;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+p.nombre+'</div>'
        +'<div style="font-size:.73rem;color:#a0536a;margin-top:1px">'+subtitulo+'</div>'
      +'</div>'
      +'<div style="display:flex;gap:7px;flex-wrap:wrap;flex-shrink:0">'
        +extraBtns(p, edad)
      +'</div>'
    +'</div>';
  }

  function btnGenerar(p, edad){
    return '<button class="btn primary" style="font-size:.72rem;padding:5px 12px" '
      +'onclick="(function(){ var pp=getPacientes().find(function(x){return x.id===\''+p.id+'\';});'
      +'if(pp){ _bdayPac=pp; document.getElementById(\'bdayPacName\').firstChild.textContent=pp.nombre;'
      +'document.getElementById(\'bdayPacSub\').textContent=\'\\u00a1Cumple '+edad+' a\\u00f1os hoy! \\uD83C\\uDF89\';'
      +'document.getElementById(\'bdayOverlay\').classList.add(\'open\');'
      +'setTimeout(function(){ dibujarBday(pp,'+edad+'); },60); } })()">\uD83C\uDF82 Generar imagen</button>';
  }

  // ‚îÄ‚îÄ HOY ‚îÄ‚îÄ
  var hoyList = pacs.filter(function(p){ var pts=p.fnac.split('-'); return parseInt(pts[1])===mH && parseInt(pts[2])===dH; });
  var cardHoyEl=document.getElementById('ag-cumple-hoy-card'), listHoyEl=document.getElementById('ag-cumple-hoy-list');
  if(cardHoyEl){
    if(hoyList.length){
      cardHoyEl.style.display='';
      listHoyEl.innerHTML = hoyList.map(function(p){
        var edad=anioH-parseInt(p.fnac.split('-')[0]);
        return cardBday(p, function(p2,e){ return btnGenerar(p2,e); });
      }).join('');
    } else { cardHoyEl.style.display='none'; }
  }

  // ‚îÄ‚îÄ PR√ìXIMOS 30 D√çAS ‚îÄ‚îÄ
  var proximos = pacs.filter(function(p){ var pts=p.fnac.split('-'); var dias=diasHasta(parseInt(pts[2]),parseInt(pts[1])); return dias>0 && dias<=30; });
  proximos.sort(function(a,b){
    var ap=a.fnac.split('-'), bp=b.fnac.split('-');
    return diasHasta(parseInt(ap[2]),parseInt(ap[1])) - diasHasta(parseInt(bp[2]),parseInt(bp[1]));
  });
  var proxEl=document.getElementById('ag-cumple-proximos');
  if(proxEl){
    if(proximos.length){
      proxEl.innerHTML = proximos.map(function(p){
        var pts=p.fnac.split('-'); var d=parseInt(pts[2]),m=parseInt(pts[1]);
        var edad=anioH-parseInt(pts[0])+1;
        var dias=diasHasta(d,m);
        return cardBday(p, function(p2,e){ return btnGenerar(p2,e); });
      }).join('');
    } else {
      proxEl.innerHTML='<p style="font-size:.83rem;color:#cd8e9d;padding:6px 4px">Ning\u00fan cumplea\u00f1os en los pr\u00f3ximos 30 d\u00edas.</p>';
    }
  }

  // ‚îÄ‚îÄ TODOS POR MES ‚îÄ‚îÄ
  var btnsEl=document.getElementById('ag-cumple-meses-btns');
  if(btnsEl){
    btnsEl.innerHTML='<button class="btn primary" style="font-size:.7rem;padding:4px 10px" onclick="agCumpleFiltrarMes(0)">Todos</button>'
      + MESES_L.map(function(mes,i){
          var tiene=pacs.some(function(p){ return parseInt(p.fnac.split('-')[1])===i+1; });
          return '<button class="btn'+(tiene?' primary':'')+'" style="font-size:.7rem;padding:4px 10px" onclick="agCumpleFiltrarMes('+(i+1)+')">'+mes+'</button>';
        }).join('');
  }

  var porMes={};
  pacs.forEach(function(p){ var m=parseInt(p.fnac.split('-')[1]); if(!porMes[m]) porMes[m]=[]; porMes[m].push(p); });
  var listaEl=document.getElementById('ag-cumple-lista-mes');
  if(listaEl){
    if(!pacs.length){ listaEl.innerHTML='<p style="font-size:.84rem;color:#cd8e9d;padding:8px">No hay pacientes con fecha de nacimiento registrada.</p>'; return; }
    var htmlMes='';
    MESES_L.forEach(function(mes,i){
      var list=porMes[i+1]||[];
      htmlMes+='<div class="ag-cumple-mes-sec" data-mes="'+(i+1)+'">';
      htmlMes+='<div style="font-size:.69rem;font-weight:700;color:#cd8e9d;text-transform:uppercase;letter-spacing:1.2px;margin:16px 0 6px;padding-bottom:5px;border-bottom:1.5px solid #fadae1">'+mes+(list.length?' ('+list.length+')':'')+'</div>';
      if(list.length){
        list.sort(function(a,b){ return parseInt(a.fnac.split('-')[2])-parseInt(b.fnac.split('-')[2]); });
        htmlMes+=list.map(function(p){
          var pts=p.fnac.split('-'); var d=parseInt(pts[2]),m2=parseInt(pts[1]);
          var edad=anioH-parseInt(pts[0]);
          var esHoy=(d===dH&&m2===mH);
          return cardBday(p, function(p2,e){ return btnGenerar(p2,e); });
        }).join('');
      } else {
        htmlMes+='<p style="font-size:.76rem;color:#cd8e9d;padding:2px 6px;margin:0">Sin pacientes este mes</p>';
      }
      htmlMes+='</div>';
    });
    listaEl.innerHTML=htmlMes;
  }

  // Badge en la pesta√±a
  agActualizarBadgeCumple();
}

function agCumpleFiltrarMes(mes){
  document.querySelectorAll('.ag-cumple-mes-sec').forEach(function(el){
    el.style.display = (mes===0 || parseInt(el.dataset.mes)===mes) ? '' : 'none';
  });
}

function agActualizarBadgeCumple(){
  var hoy=new Date();
  var hoyList=getPacientes().filter(function(p){
    if(!p.fnac) return false;
    var pts=p.fnac.split('-');
    return parseInt(pts[1])===hoy.getMonth()+1 && parseInt(pts[2])===hoy.getDate();
  });
  var badge=document.getElementById('ag-badge-cumple');
  if(badge){ if(hoyList.length){ badge.style.display=''; badge.textContent=hoyList.length; } else { badge.style.display='none'; } }
}


</script>
</body>
</html>