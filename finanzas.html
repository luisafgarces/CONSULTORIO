<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finanzas · Consultorio Luisa</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--rosa:#fadae1;--borde:#cd8e9d;--marron:#643000;--crema:#fff9f5;--verde:#2d6a4f;--verde-claro:#e8f5ee;--rojo:#c0392b;--rojo-claro:#fdecea;--gris:#f5f0ee;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--crema);font-family:'Jost',sans-serif;color:var(--marron);min-height:100vh;}

/* NAV */
.nav{background:var(--rosa);border-bottom:2px solid var(--borde);padding:0 24px;display:flex;align-items:center;gap:0;position:sticky;top:0;z-index:100;}
.nav-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:600;padding:16px 0;margin-right:auto;}
.nav-tab{padding:18px 18px;font-size:0.78rem;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;color:var(--borde);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;background:none;border-top:none;border-left:none;border-right:none;transition:all 0.2s;white-space:nowrap;}
.nav-tab.active{color:var(--marron);border-bottom-color:var(--marron);}

/* MAIN */
.main{padding:24px;max-width:900px;margin:0 auto;}
.screen{display:none;animation:fadeUp 0.3s ease both;}
.screen.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* TARJETAS RESUMEN */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px;}
.stat-card{background:white;border-radius:16px;padding:20px;border:1.5px solid rgba(205,142,157,0.25);box-shadow:0 2px 12px rgba(100,48,0,0.04);}
.stat-card.verde{border-color:rgba(45,106,79,0.2);background:#f0faf4;}
.stat-card.rojo{border-color:rgba(192,57,43,0.2);background:var(--rojo-claro);}
.stat-card.rosa{border-color:var(--borde);background:var(--rosa);}
.stat-label{font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--borde);margin-bottom:6px;font-weight:500;}
.stat-card.verde .stat-label{color:var(--verde);}
.stat-card.rojo .stat-label{color:var(--rojo);}
.stat-value{font-family:'Cormorant Garamond',serif;font-size:1.7rem;font-weight:600;color:var(--marron);}
.stat-card.verde .stat-value{color:var(--verde);}
.stat-card.rojo .stat-value{color:var(--rojo);}
.stat-sub{font-size:0.75rem;color:#a0786e;margin-top:2px;}

/* MES SELECTOR */
.mes-nav{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.mes-nav h2{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:400;flex:1;text-transform:capitalize;}
.arrow{width:32px;height:32px;border-radius:50%;border:1.5px solid var(--borde);background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--marron);transition:background 0.2s;}
.arrow:hover{background:var(--rosa);}

/* FORMULARIO */
.form-card{background:white;border-radius:18px;padding:24px;border:1.5px solid rgba(205,142,157,0.25);margin-bottom:20px;}
.form-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:600;margin-bottom:18px;color:var(--marron);}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-grid.full{grid-template-columns:1fr;}
@media(max-width:500px){.form-grid{grid-template-columns:1fr;}}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:0.78rem;font-weight:500;color:var(--marron);letter-spacing:0.03em;}
.field input,.field select,.field textarea{padding:10px 14px;border-radius:10px;border:1.5px solid rgba(205,142,157,0.35);background:var(--rosa);font-family:'Jost',sans-serif;font-size:0.9rem;color:var(--marron);outline:none;transition:border-color 0.2s;}
.field input:focus,.field select:focus{border-color:var(--borde);box-shadow:0 0 0 3px rgba(205,142,157,0.12);}
.field select{appearance:none;cursor:pointer;}

/* BOTONES */
.btn{padding:11px 22px;border-radius:30px;border:none;font-family:'Jost',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;transition:all 0.2s;letter-spacing:0.04em;}
.btn-primary{background:var(--marron);color:white;}
.btn-primary:hover{opacity:0.85;transform:translateY(-1px);}
.btn-secondary{background:white;color:var(--marron);border:1.5px solid var(--borde);}
.btn-danger{background:var(--rojo-claro);color:var(--rojo);border:1.5px solid rgba(192,57,43,0.2);}
.btn-verde{background:var(--verde-claro);color:var(--verde);border:1.5px solid rgba(45,106,79,0.2);}
.btn-wa{background:#25d366;color:white;display:flex;align-items:center;gap:8px;}
.btn-wa:hover{background:#1ebe5d;}
.btn-wa svg{width:16px;height:16px;fill:white;}

/* LISTA PAGOS */
.pago-item{background:white;border-radius:14px;padding:16px 20px;border:1.5px solid rgba(205,142,157,0.2);margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:box-shadow 0.2s;}
.pago-item:hover{box-shadow:0 4px 16px rgba(100,48,0,0.06);}
.pago-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.pago-dot.ingreso{background:var(--verde);}
.pago-dot.gasto{background:var(--rojo);}
.pago-info{flex:1;}
.pago-nombre{font-weight:500;font-size:0.92rem;color:var(--marron);}
.pago-meta{font-size:0.75rem;color:#a0786e;margin-top:2px;}
.pago-monto{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:600;}
.pago-monto.ingreso{color:var(--verde);}
.pago-monto.gasto{color:var(--rojo);}
.pago-actions{display:flex;gap:8px;}
.icon-btn{width:30px;height:30px;border-radius:50%;border:1.5px solid rgba(205,142,157,0.3);background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.85rem;transition:background 0.2s;}
.icon-btn:hover{background:var(--rosa);}

/* MÉTODO BADGE */
.metodo-badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:0.7rem;font-weight:500;letter-spacing:0.05em;text-transform:uppercase;}
.metodo-efectivo{background:#fff8e1;color:#f57c00;}
.metodo-nu{background:#e8f4fd;color:#1565c0;}
.metodo-davibank{background:#fce4ec;color:#c2185b;}
.metodo-nequi{background:#f3e5f5;color:#7b1fa2;}
.metodo-breve{background:#e8f5e9;color:#2e7d32;}

/* RECIBO MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(100,48,0,0.25);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:white;border-radius:24px;padding:32px;max-width:420px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(100,48,0,0.15);}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:600;}
.modal-close{width:32px;height:32px;border-radius:50%;border:1.5px solid var(--borde);background:white;cursor:pointer;font-size:1rem;color:var(--borde);display:flex;align-items:center;justify-content:center;}
.recibo{background:var(--rosa);border-radius:16px;padding:24px;margin-bottom:20px;}
.recibo-logo{text-align:center;margin-bottom:16px;}
.recibo-logo p{font-family:'Cormorant Garamond',serif;font-size:1.1rem;font-weight:600;color:var(--marron);}
.recibo-logo small{font-size:0.75rem;color:var(--borde);letter-spacing:0.08em;text-transform:uppercase;}
.recibo-divider{height:1px;background:rgba(205,142,157,0.4);margin:14px 0;}
.recibo-fila{display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:8px;}
.recibo-fila span:first-child{color:#a0786e;}
.recibo-fila span:last-child{font-weight:500;color:var(--marron);}
.recibo-total{display:flex;justify-content:space-between;font-size:1.1rem;margin-top:12px;padding-top:12px;border-top:1.5px solid rgba(205,142,157,0.4);}
.recibo-total span:last-child{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:600;color:var(--marron);}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--borde);}
.empty .emoji{font-size:2.2rem;margin-bottom:10px;}
.empty p{font-size:0.88rem;line-height:1.7;}

/* DEUDORES */
.deudor-item{background:var(--rojo-claro);border:1.5px solid rgba(192,57,43,0.15);border-radius:14px;padding:16px 20px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.deudor-nombre{font-weight:500;font-size:0.92rem;color:var(--marron);}
.deudor-monto{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:600;color:var(--rojo);}
</style>
</head>
<body>

<nav class="nav">
  <div class="nav-title">&#128200; Finanzas</div>
  <button class="nav-tab active" onclick="switchTab('resumen',this)">Resumen</button>
  <button class="nav-tab" onclick="switchTab('registrar',this)">Registrar</button>
  <button class="nav-tab" onclick="switchTab('historial',this)">Historial</button>
  <button class="nav-tab" onclick="switchTab('deudores',this)">Deben</button>
</nav>

<div class="main">

  <!-- RESUMEN -->
  <div class="screen active" id="tab-resumen">
    <div class="mes-nav">
      <button class="arrow" onclick="cambiarMes(-1)">&#8249;</button>
      <h2 id="mesTitle"></h2>
      <button class="arrow" onclick="cambiarMes(1)">&#8250;</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card verde">
        <div class="stat-label">Ingresos</div>
        <div class="stat-value" id="stat-ingresos">$0</div>
        <div class="stat-sub" id="stat-ingresos-n">0 sesiones</div>
      </div>
      <div class="stat-card rojo">
        <div class="stat-label">Gastos</div>
        <div class="stat-value" id="stat-gastos">$0</div>
        <div class="stat-sub" id="stat-gastos-n">0 registros</div>
      </div>
      <div class="stat-card rosa">
        <div class="stat-label">Ganancia neta</div>
        <div class="stat-value" id="stat-neta">$0</div>
        <div class="stat-sub">este mes</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Sesiones pendientes</div>
        <div class="stat-value" id="stat-pendientes">$0</div>
        <div class="stat-sub" id="stat-pendientes-n">0 pacientes</div>
      </div>
    </div>
    <div id="resumen-lista"></div>
  </div>

  <!-- REGISTRAR -->
  <div class="screen" id="tab-registrar">
    <!-- INGRESO -->
    <div class="form-card">
      <div class="form-title">&#127800; Registrar pago de paciente</div>
      <div class="form-grid">
        <div class="field">
          <label>Nombre del paciente</label>
          <input type="text" id="r_paciente" placeholder="Ej: María González">
        </div>
        <div class="field">
          <label>Fecha</label>
          <input type="date" id="r_fecha">
        </div>
        <div class="field">
          <label>Tipo de sesi&#243;n</label>
          <select id="r_tipo">
            <option value="80000">Sesi&#243;n individual · $80.000</option>
            <option value="140000">Pareja / Familia · $140.000</option>
            <option value="140000">Evaluaci&#243;n individual · $140.000</option>
            <option value="160000">Evaluaci&#243;n pareja · $160.000</option>
            <option value="custom">Otro monto</option>
          </select>
        </div>
        <div class="field">
          <label>M&#233;todo de pago</label>
          <select id="r_metodo">
            <option value="efectivo">Efectivo</option>
            <option value="nu">Nu</option>
            <option value="davibank">Davibank</option>
            <option value="nequi">Nequi</option>
            <option value="breve">Breve</option>
          </select>
        </div>
        <div class="field" id="campo-monto-custom" style="display:none">
          <label>Monto personalizado</label>
          <input type="number" id="r_monto_custom" placeholder="Ej: 100000">
        </div>
        <div class="field">
          <label>Estado</label>
          <select id="r_estado">
            <option value="pagado">Pagado &#10003;</option>
            <option value="pendiente">Pendiente de pago</option>
          </select>
        </div>
      </div>
      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="registrarPago()">Guardar pago</button>
        <button class="btn btn-verde" onclick="registrarYRecibo()">Guardar + generar recibo</button>
      </div>
    </div>

    <!-- GASTO -->
    <div class="form-card">
      <div class="form-title">&#128722; Registrar gasto</div>
      <div class="form-grid">
        <div class="field">
          <label>Descripci&#243;n</label>
          <input type="text" id="g_desc" placeholder="Ej: Papel, marcadores...">
        </div>
        <div class="field">
          <label>Fecha</label>
          <input type="date" id="g_fecha">
        </div>
        <div class="field">
          <label>Monto</label>
          <input type="number" id="g_monto" placeholder="Ej: 25000">
        </div>
        <div class="field">
          <label>Categor&#237;a</label>
          <select id="g_cat">
            <option>Materiales y papeler&#237;a</option>
            <option>Plataformas o apps</option>
            <option>Publicidad</option>
            <option>Arriendo</option>
            <option>Otro</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" style="margin-top:16px" onclick="registrarGasto()">Guardar gasto</button>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div class="screen" id="tab-historial">
    <div class="mes-nav">
      <button class="arrow" onclick="cambiarMes(-1)">&#8249;</button>
      <h2 id="mesTitle2"></h2>
      <button class="arrow" onclick="cambiarMes(1)">&#8250;</button>
    </div>
    <div id="historial-lista"></div>
  </div>

  <!-- DEUDORES -->
  <div class="screen" id="tab-deudores">
    <h2 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:20px;">Pacientes con pago pendiente</h2>
    <div id="deudores-lista"></div>
  </div>

</div>

<!-- MODAL RECIBO -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Recibo de pago</div>
      <button class="modal-close" onclick="cerrarModalBtn()">&#10005;</button>
    </div>
    <div class="recibo" id="reciboContent"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn btn-wa" onclick="enviarReciboWA()">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
      <button class="btn btn-secondary" onclick="cerrarModalBtn()">Cerrar</button>
    </div>
  </div>
</div>

<script>
// ── ESTADO ──────────────────────────────────────────────────
var registros = JSON.parse(localStorage.getItem('finanzas_registros') || '[]');
var mesActual = new Date().getMonth();
var anioActual = new Date().getFullYear();
var reciboActual = null;

var meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
var tiposLabel = {'80000':'Sesi\u00f3n individual','140000':'Sesi\u00f3n pareja/familia','160000':'Evaluaci\u00f3n pareja','custom':'Otro'};
var metodoLabel = {'efectivo':'Efectivo','nu':'Nu','davibank':'Davibank','nequi':'Nequi','breve':'Breve'};

// Inicializar fechas
document.getElementById('r_fecha').value = hoy();
document.getElementById('g_fecha').value = hoy();

function hoy() {
  return new Date().toISOString().split('T')[0];
}

function guardar() {
  localStorage.setItem('finanzas_registros', JSON.stringify(registros));
}

function formatPesos(n) {
  return '$' + Number(n).toLocaleString('es-CO');
}

function getMonto() {
  var tipo = document.getElementById('r_tipo').value;
  if (tipo === 'custom') return parseInt(document.getElementById('r_monto_custom').value) || 0;
  return parseInt(tipo);
}

document.getElementById('r_tipo').addEventListener('change', function() {
  document.getElementById('campo-monto-custom').style.display = this.value === 'custom' ? 'block' : 'none';
});

// ── REGISTRAR ───────────────────────────────────────────────
function registrarPago(abrirRecibo) {
  var paciente = document.getElementById('r_paciente').value.trim();
  var fecha = document.getElementById('r_fecha').value;
  var monto = getMonto();
  var metodo = document.getElementById('r_metodo').value;
  var estado = document.getElementById('r_estado').value;
  var tipoVal = document.getElementById('r_tipo').value;

  if (!paciente || !monto) { alert('Por favor completa el nombre y el monto.'); return null; }

  var reg = {
    id: Date.now(),
    tipo: 'ingreso',
    paciente: paciente,
    fecha: fecha,
    monto: monto,
    metodo: metodo,
    estado: estado,
    tipoSesion: tipoVal === 'custom' ? 'Otro' : tiposLabel[tipoVal] || 'Sesi\u00f3n'
  };

  registros.push(reg);
  guardar();
  renderAll();
  limpiarFormPago();
  if (!abrirRecibo) mostrarToast('\u2705 Pago registrado');
  return reg;
}

function registrarYRecibo() {
  var reg = registrarPago(true);
  if (reg) abrirRecibo(reg);
}

function registrarGasto() {
  var desc = document.getElementById('g_desc').value.trim();
  var fecha = document.getElementById('g_fecha').value;
  var monto = parseInt(document.getElementById('g_monto').value) || 0;
  var cat = document.getElementById('g_cat').value;
  if (!desc || !monto) { alert('Por favor completa descripci\u00f3n y monto.'); return; }
  registros.push({ id: Date.now(), tipo: 'gasto', descripcion: desc, fecha: fecha, monto: monto, categoria: cat });
  guardar();
  renderAll();
  document.getElementById('g_desc').value = '';
  document.getElementById('g_monto').value = '';
  mostrarToast('\u2705 Gasto registrado');
}

function limpiarFormPago() {
  document.getElementById('r_paciente').value = '';
  document.getElementById('r_fecha').value = hoy();
}

function eliminar(id) {
  if (!confirm('\u00bfEliminar este registro?')) return;
  registros = registros.filter(function(r){ return r.id !== id; });
  guardar();
  renderAll();
}

// ── RENDER ───────────────────────────────────────────────────
function getRegistrosMes(m, a) {
  return registros.filter(function(r){
    var d = new Date(r.fecha + 'T12:00:00');
    return d.getMonth() === m && d.getFullYear() === a;
  });
}

function renderAll() {
  renderResumen();
  renderHistorial();
  renderDeudores();
  var t1 = document.getElementById('mesTitle');
  var t2 = document.getElementById('mesTitle2');
  var titulo = meses[mesActual] + ' ' + anioActual;
  if (t1) t1.textContent = titulo;
  if (t2) t2.textContent = titulo;
}

function renderResumen() {
  var regs = getRegistrosMes(mesActual, anioActual);
  var ingresos = regs.filter(function(r){ return r.tipo==='ingreso' && r.estado==='pagado'; });
  var gastos = regs.filter(function(r){ return r.tipo==='gasto'; });
  var totalI = ingresos.reduce(function(s,r){ return s+r.monto; }, 0);
  var totalG = gastos.reduce(function(s,r){ return s+r.monto; }, 0);
  var pendientes = registros.filter(function(r){ return r.tipo==='ingreso' && r.estado==='pendiente'; });
  var totalP = pendientes.reduce(function(s,r){ return s+r.monto; }, 0);

  document.getElementById('stat-ingresos').textContent = formatPesos(totalI);
  document.getElementById('stat-ingresos-n').textContent = ingresos.length + ' sesiones';
  document.getElementById('stat-gastos').textContent = formatPesos(totalG);
  document.getElementById('stat-gastos-n').textContent = gastos.length + ' registros';
  document.getElementById('stat-neta').textContent = formatPesos(totalI - totalG);
  document.getElementById('stat-pendientes').textContent = formatPesos(totalP);
  document.getElementById('stat-pendientes-n').textContent = pendientes.length + ' pacientes';

  var lista = document.getElementById('resumen-lista');
  var recientes = regs.slice().sort(function(a,b){ return new Date(b.fecha)-new Date(a.fecha); }).slice(0,5);
  if (!recientes.length) {
    lista.innerHTML = '<div class="empty"><div class="emoji">\uD83D\uDCB8</div><p>No hay registros este mes.<br>Ve a "Registrar" para agregar pagos.</p></div>';
    return;
  }
  lista.innerHTML = '<div style="font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--borde);margin-bottom:10px;font-weight:500">Actividad reciente</div>' +
    recientes.map(pagoItemHTML).join('');
}

function renderHistorial() {
  var regs = getRegistrosMes(mesActual, anioActual).slice().sort(function(a,b){ return new Date(b.fecha)-new Date(a.fecha); });
  var lista = document.getElementById('historial-lista');
  if (!regs.length) {
    lista.innerHTML = '<div class="empty"><div class="emoji">\uD83D\uDCC3</div><p>No hay registros este mes.</p></div>';
    return;
  }
  lista.innerHTML = regs.map(pagoItemHTML).join('');
}

function renderDeudores() {
  var pendientes = registros.filter(function(r){ return r.tipo==='ingreso' && r.estado==='pendiente'; });
  var lista = document.getElementById('deudores-lista');
  if (!pendientes.length) {
    lista.innerHTML = '<div class="empty"><div class="emoji">\uD83C\uDF38</div><p>\u00a1Excelente! No hay pagos pendientes.</p></div>';
    return;
  }
  // agrupar por paciente
  var porPaciente = {};
  pendientes.forEach(function(r){
    if (!porPaciente[r.paciente]) porPaciente[r.paciente] = {total:0, sesiones:0};
    porPaciente[r.paciente].total += r.monto;
    porPaciente[r.paciente].sesiones++;
  });
  lista.innerHTML = Object.keys(porPaciente).map(function(nombre){
    var d = porPaciente[nombre];
    return '<div class="deudor-item">' +
      '<div><div class="deudor-nombre">' + nombre + '</div>' +
      '<div style="font-size:0.75rem;color:#a0786e">' + d.sesiones + ' sesi\u00f3n(es) pendiente(s)</div></div>' +
      '<div class="deudor-monto">' + formatPesos(d.total) + '</div>' +
      '</div>';
  }).join('');
}

function pagoItemHTML(r) {
  var esIngreso = r.tipo === 'ingreso';
  var fecha = new Date(r.fecha + 'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'short'});
  var metBadge = esIngreso ? '<span class="metodo-badge metodo-'+r.metodo+'">' + metodoLabel[r.metodo] + '</span>' : '';
  var estadoBadge = (esIngreso && r.estado==='pendiente') ? '<span style="background:#fff3e0;color:#f57c00;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:500">Pendiente</span>' : '';
  var acciones = esIngreso ?
    '<button class="icon-btn" onclick="abrirRecibo(getById('+r.id+'))" title="Recibo">&#128467;</button>' +
    '<button class="icon-btn btn-danger" onclick="eliminar('+r.id+')" title="Eliminar">&#10005;</button>' :
    '<button class="icon-btn btn-danger" onclick="eliminar('+r.id+')" title="Eliminar">&#10005;</button>';

  return '<div class="pago-item">' +
    '<div class="pago-dot ' + r.tipo + '"></div>' +
    '<div class="pago-info">' +
      '<div class="pago-nombre">' + (esIngreso ? r.paciente : r.descripcion) + '</div>' +
      '<div class="pago-meta">' + fecha + (esIngreso ? ' &middot; ' + r.tipoSesion : ' &middot; ' + r.categoria) + ' ' + metBadge + ' ' + estadoBadge + '</div>' +
    '</div>' +
    '<div class="pago-monto ' + r.tipo + '">' + (esIngreso ? '+' : '-') + formatPesos(r.monto) + '</div>' +
    '<div class="pago-actions">' + acciones + '</div>' +
    '</div>';
}

function getById(id) {
  return registros.find(function(r){ return r.id === id; });
}

// ── RECIBO ───────────────────────────────────────────────────
function abrirRecibo(reg) {
  if (!reg) return;
  reciboActual = reg;
  var fecha = new Date(reg.fecha + 'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  var numRecibo = 'REC-' + reg.id.toString().slice(-6);

  document.getElementById('reciboContent').innerHTML =
    '<div class="recibo-logo">' +
      '<p>Luisa Fernanda Garc\u00e9s Garc\u00eda</p>' +
      '<small>Psic\u00f3loga &middot; Consultorio</small>' +
    '</div>' +
    '<div class="recibo-divider"></div>' +
    '<div class="recibo-fila"><span>N\u00famero</span><span>' + numRecibo + '</span></div>' +
    '<div class="recibo-fila"><span>Fecha</span><span>' + fecha + '</span></div>' +
    '<div class="recibo-fila"><span>Paciente</span><span>' + reg.paciente + '</span></div>' +
    '<div class="recibo-fila"><span>Servicio</span><span>' + reg.tipoSesion + '</span></div>' +
    '<div class="recibo-fila"><span>M\u00e9todo de pago</span><span>' + metodoLabel[reg.metodo] + '</span></div>' +
    '<div class="recibo-total"><span>Total pagado</span><span>' + formatPesos(reg.monto) + '</span></div>';

  document.getElementById('modalOverlay').classList.add('open');
}

function cerrarModalBtn() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function cerrarModal(e) {
  if (e.target === document.getElementById('modalOverlay')) cerrarModalBtn();
}

function enviarReciboWA() {
  if (!reciboActual) return;
  var r = reciboActual;
  var fecha = new Date(r.fecha + 'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  var numRecibo = 'REC-' + r.id.toString().slice(-6);
  var msg = '\uD83C\uDF38 *Recibo de pago*\n\n' +
    '*Consultorio:* Luisa Fernanda Garc\u00e9s Garc\u00eda\n' +
    '*Psic\u00f3loga*\n\n' +
    'N\u00famero: ' + numRecibo + '\n' +
    'Fecha: ' + fecha + '\n' +
    'Paciente: ' + r.paciente + '\n' +
    'Servicio: ' + r.tipoSesion + '\n' +
    'M\u00e9todo: ' + metodoLabel[r.metodo] + '\n\n' +
    '*Total: ' + formatPesos(r.monto) + '*\n\n' +
    '_Gracias por tu confianza \uD83C\uDF38_';
  window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
}

// ── NAVEGACIÓN ───────────────────────────────────────────────
function switchTab(tab, el) {
  document.querySelectorAll('.screen').forEach(function(s){ s.classList.remove('active'); });
  document.querySelectorAll('.nav-tab').forEach(function(t){ t.classList.remove('active'); });
  document.getElementById('tab-' + tab).classList.add('active');
  el.classList.add('active');
}

function cambiarMes(dir) {
  mesActual += dir;
  if (mesActual > 11) { mesActual = 0; anioActual++; }
  if (mesActual < 0) { mesActual = 11; anioActual--; }
  renderAll();
}

// ── TOAST ────────────────────────────────────────────────────
function mostrarToast(msg) {
  var t = document.getElementById('toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--marron);color:white;padding:12px 22px;border-radius:30px;font-size:0.85rem;opacity:0;transform:translateY(12px);transition:all 0.3s;pointer-events:none;z-index:999;font-family:Jost,sans-serif;';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1'; t.style.transform = 'translateY(0)';
  setTimeout(function(){ t.style.opacity='0'; t.style.transform='translateY(12px)'; }, 2500);
}

// ── INIT ─────────────────────────────────────────────────────
renderAll();
</script>
</body>
</html>
