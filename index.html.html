<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Psicolog√≠a ¬∑ Hospital</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f5f2ee;--surface:#fff;--surface2:#f0ede8;--border:#e0d9d0;
  --text:#1a1714;--text2:#6b6460;--text3:#9e9894;
  --accent:#2d5a4e;--accent2:#4a8c7c;--accent-light:#e8f2ef;
  --danger:#c0392b;--danger-light:#fdf0ee;
  --warning:#d4820a;--warning-light:#fdf6e3;
  --success:#2d7a4f;--success-light:#eaf4ee;
  --radius:12px;--shadow:0 2px 16px rgba(26,23,20,0.08);--shadow-lg:0 8px 40px rgba(26,23,20,0.14);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex}

/* SIDEBAR */
.sidebar{width:240px;min-height:100vh;background:var(--accent);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100;overflow-y:auto;transition:transform 0.25s}
.sidebar.collapsed{transform:translateX(-240px)}
.sidebar-logo{padding:22px 20px 16px;border-bottom:1px solid rgba(255,255,255,0.1);flex-shrink:0}
.sidebar-logo h1{font-family:'DM Serif Display',serif;font-size:1.2rem;color:#fff;line-height:1.2}
.sidebar-logo span{font-size:0.7rem;color:rgba(255,255,255,0.5);letter-spacing:0.08em;text-transform:uppercase}
.sidebar-nav{padding:10px 10px;flex:1}
.nav-section{font-size:0.65rem;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.1em;padding:12px 8px 4px;font-weight:600}
.nav-item{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:7px;cursor:pointer;color:rgba(255,255,255,0.7);font-size:0.82rem;font-weight:500;transition:all 0.15s;margin-bottom:1px}
.nav-item:hover{background:rgba(255,255,255,0.1);color:#fff}
.nav-item.active{background:rgba(255,255,255,0.18);color:#fff}
.nav-item .icon{width:16px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;background:rgba(255,255,255,0.2);color:#fff;font-size:0.65rem;padding:1px 6px;border-radius:20px;font-weight:600}
.sidebar-footer{padding:12px 16px;border-top:1px solid rgba(255,255,255,0.1);font-size:0.72rem;color:rgba(255,255,255,0.4);display:flex;align-items:center;gap:6px;flex-shrink:0}
.sync-dot{width:7px;height:7px;border-radius:50%;background:#4ade80;flex-shrink:0;animation:pulse 2s infinite}
.sync-dot.offline{background:#f87171;animation:none}.sync-dot.syncing{background:#fbbf24}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

.main{margin-left:240px;flex:1;min-height:100vh;display:flex;flex-direction:column;transition:margin-left 0.25s}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 28px;height:60px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:50}
.topbar-title{font-family:'DM Serif Display',serif;font-size:1.25rem}
.topbar-search{margin-left:auto;display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 12px;width:240px}
.topbar-search input{border:none;background:transparent;outline:none;font-family:'DM Sans',sans-serif;font-size:0.85rem;color:var(--text);width:100%}
.topbar-search input::placeholder{color:var(--text3)}
.topbar-search svg{color:var(--text3);width:15px;height:15px;flex-shrink:0}
.content{padding:28px;flex:1}
.page{display:none}.page.active{display:block}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:24px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px}
.stat-card .label{font-size:0.72rem;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:0.05em}
.stat-card .value{font-family:'DM Serif Display',serif;font-size:1.9rem;line-height:1.1;margin-top:4px}
.stat-card .sub{font-size:0.72rem;color:var(--text3);margin-top:2px}

/* SECTION HEADER */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-header h2{font-family:'DM Serif Display',serif;font-size:1.15rem}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:500;cursor:pointer;border:none;transition:all 0.15s}
.btn svg{width:15px;height:15px}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:var(--accent2)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}
.btn-danger{background:var(--danger-light);color:var(--danger);border:1px solid #f0c0bb}
.btn-sm{padding:5px 11px;font-size:0.78rem}

/* TABLE */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{padding:10px 14px;text-align:left;font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.05em;background:var(--surface2);border-bottom:1px solid var(--border)}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.1s}tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--surface2)}
tbody td{padding:12px 14px;font-size:0.85rem}
.td-sub{font-size:0.75rem;color:var(--text3)}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:0.7rem;font-weight:600}
.badge-green{background:var(--success-light);color:var(--success)}
.badge-yellow{background:var(--warning-light);color:var(--warning)}
.badge-red{background:var(--danger-light);color:var(--danger)}
.badge-gray{background:var(--surface2);color:var(--text2)}
.badge-blue{background:#e8f0fe;color:#1a56db}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(26,23,20,0.5);z-index:200;align-items:center;justify-content:center;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border-radius:16px;width:100%;max-width:660px;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1}
.modal-header h3{font-family:'DM Serif Display',serif;font-size:1.1rem}
.modal-close{background:var(--surface2);border:none;border-radius:7px;padding:5px;cursor:pointer;color:var(--text2);display:flex;align-items:center}.modal-close:hover{background:var(--border)}
.modal-body{padding:22px 24px}
.modal-footer{padding:14px 24px 20px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--border)}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group.full{grid-column:1/-1}
.form-group label{font-size:0.78rem;font-weight:600;color:var(--text2)}
.form-group input,.form-group select,.form-group textarea{padding:8px 11px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem;color:var(--text);background:var(--surface);outline:none;transition:border-color 0.15s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent2)}
.form-group textarea{resize:vertical;min-height:75px}

/* ANAMNESIS */
.anamnesis-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:14px;overflow:hidden}
.anamnesis-section-header{padding:12px 18px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
.anamnesis-section-header h4{font-size:0.88rem;font-weight:600;flex:1}
.anamnesis-section-header .chevron{width:15px;height:15px;color:var(--text3);transition:transform 0.2s}
.anamnesis-section-header.open .chevron{transform:rotate(180deg)}
.anamnesis-section-body{padding:18px;display:none}
.anamnesis-section-body.open{display:block}
.checkgroup{display:flex;flex-wrap:wrap;gap:7px;margin-top:5px}
.checkgroup label{display:flex;align-items:center;gap:5px;padding:4px 10px;border:1px solid var(--border);border-radius:20px;font-size:0.78rem;cursor:pointer;transition:all 0.1s;color:var(--text);font-weight:400!important}
.checkgroup input[type=checkbox],.checkgroup input[type=radio]{display:none}
.checkgroup label:has(input:checked){background:var(--accent-light);border-color:var(--accent2);color:var(--accent)}
.risk-selector{display:flex;gap:8px;margin-top:5px}
.risk-btn{flex:1;padding:9px;border-radius:8px;border:2px solid var(--border);cursor:pointer;text-align:center;font-size:0.8rem;font-weight:600;transition:all 0.15s}
.risk-btn.low{color:var(--success)}.risk-btn.low.sel{background:var(--success-light);border-color:var(--success)}
.risk-btn.med{color:var(--warning)}.risk-btn.med.sel{background:var(--warning-light);border-color:var(--warning)}
.risk-btn.high{color:var(--danger)}.risk-btn.high.sel{background:var(--danger-light);border-color:var(--danger)}
.timer-bar{display:flex;gap:7px;margin-bottom:18px;flex-wrap:wrap}
.timer-step{flex:1;min-width:110px;padding:7px 10px;border-radius:8px;border:1px solid var(--border);font-size:0.72rem;color:var(--text2);background:var(--surface)}
.timer-step .ts-time{font-weight:600;color:var(--text);font-size:0.78rem}
.nota-output{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;font-size:0.8rem;line-height:1.7;white-space:pre-wrap;min-height:100px;font-family:'DM Sans',sans-serif}

/* INTERCONSULTAS */
.ic-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;margin-bottom:10px;display:flex;gap:14px;align-items:flex-start;transition:box-shadow 0.15s}
.ic-card:hover{box-shadow:var(--shadow)}
.ic-icon{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1rem}
.ic-icon.pending{background:var(--warning-light)}.ic-icon.done{background:var(--success-light)}.ic-icon.urgent{background:var(--danger-light)}
.ic-body{flex:1}
.ic-body h4{font-size:0.9rem;font-weight:600;margin-bottom:3px}
.ic-body p{font-size:0.78rem;color:var(--text2)}
.ic-meta{display:flex;gap:7px;align-items:center;margin-top:7px;flex-wrap:wrap}
.ic-actions{display:flex;gap:7px}

/* TESTS */
.tests-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px}
.test-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;cursor:pointer;transition:all 0.15s;position:relative}
.test-card:hover{box-shadow:var(--shadow);border-color:var(--accent2);transform:translateY(-1px)}
.test-card .tc-icon{font-size:1.6rem;margin-bottom:10px}
.test-card h4{font-size:0.9rem;font-weight:600;margin-bottom:4px}
.test-card p{font-size:0.76rem;color:var(--text2);line-height:1.4}
.test-card .tc-meta{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.test-card .tc-tag{background:var(--surface2);color:var(--text2);font-size:0.68rem;padding:2px 7px;border-radius:20px;font-weight:500}
.test-section-label{font-size:0.72rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;margin-top:20px}

/* MODO LECTURA ASISTIDA */
.assisted-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
.assisted-bar label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.85rem;font-weight:500}
.toggle{width:36px;height:20px;background:var(--border);border-radius:20px;position:relative;transition:background 0.2s;flex-shrink:0}
.toggle::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.2)}
input.toggle-cb:checked+.toggle{background:var(--accent)}
input.toggle-cb:checked+.toggle::after{transform:translateX(16px)}
input.toggle-cb{display:none}
.assisted-mode .test-question-text{font-size:1.3rem!important;line-height:1.6!important}
.assisted-mode .test-option-label{font-size:1.1rem!important;padding:12px 16px!important}
.pac-bar{display:flex;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:16px;flex-wrap:wrap}
.pac-bar .form-group{flex:1;min-width:140px;margin:0}

/* TEST SCREEN */
.test-screen{display:none}.test-screen.active{display:block}
.test-header{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;margin-bottom:18px;display:flex;align-items:center;gap:16px}
.test-header .th-icon{font-size:2rem}
.test-header h2{font-family:'DM Serif Display',serif;font-size:1.2rem}
.test-header p{font-size:0.8rem;color:var(--text2);margin-top:2px}
.test-header .btn{margin-left:auto}
.clinician-note{background:var(--warning-light);border:1px solid #f0d080;border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:0.8rem;color:#5a4000;line-height:1.5}
.test-question{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;margin-bottom:12px}
.test-question-num{font-size:0.72rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px}
.test-question-text{font-size:0.92rem;color:var(--text);line-height:1.5;margin-bottom:14px}
.test-options{display:flex;flex-direction:column;gap:6px}
.test-option{display:flex;align-items:center;gap:10px}
.test-option input{display:none}
.test-option-label{flex:1;padding:9px 14px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:0.85rem;transition:all 0.15s;display:flex;align-items:center;gap:8px}
.test-option input:checked+.test-option-label{background:var(--accent-light);border-color:var(--accent2);color:var(--accent)}
.test-options-row{display:flex;gap:8px;flex-wrap:wrap}
.test-options-row .test-option-label{flex:unset;padding:8px 14px}
.test-result{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:22px;margin-top:20px;text-align:center}
.test-result.normal{border-color:var(--success)}.test-result.moderate{border-color:var(--warning)}.test-result.high{border-color:var(--danger)}.test-result.critical{border-color:#7b1fa2}
.result-score{font-family:'DM Serif Display',serif;font-size:3rem;line-height:1}
.result-label{font-size:1.1rem;font-weight:600;margin-top:6px}
.result-interpretation{font-size:0.85rem;color:var(--text2);margin-top:10px;line-height:1.5}
.result-actions{display:flex;gap:10px;justify-content:center;margin-top:18px;flex-wrap:wrap}

/* HISTORIAL TESTS */
.hist-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:8px;display:flex;align-items:center;gap:14px}
.hist-icon{font-size:1.3rem;flex-shrink:0}
.hist-body{flex:1}
.hist-body h4{font-size:0.88rem;font-weight:600}
.hist-body p{font-size:0.76rem;color:var(--text2);margin-top:2px}
.hist-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px}

/* EMPTY / LOADING */
.empty{text-align:center;padding:40px 20px;color:var(--text3)}
.empty svg{width:36px;height:36px;margin-bottom:10px;opacity:0.4}
.empty p{font-size:0.88rem}
.loading{text-align:center;padding:36px;color:var(--text3);font-size:0.88rem}
.spinner{display:inline-block;width:22px;height:22px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;bottom:20px;right:20px;background:var(--text);color:#fff;padding:11px 18px;border-radius:10px;font-size:0.85rem;box-shadow:var(--shadow-lg);z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s}
#toast.show{transform:translateY(0);opacity:1}
.text-sm{font-size:0.8rem;color:var(--text2)}.mt-4{margin-top:14px}
.flex{display:flex}.gap-2{gap:8px}.items-center{align-items:center}
@media(max-width:768px){
  .sidebar{transform:translateX(-240px);transition:transform 0.25s ease;z-index:200}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .stats-grid{grid-template-columns:1fr 1fr 1fr}.tests-grid{grid-template-columns:1fr 1fr}
  .form-grid{grid-template-columns:1fr}.content{padding:14px}
  .topbar-search{width:160px}
  .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:199}
  .sidebar-overlay.open{display:block}
}
.hamburger{display:flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:8px;border:none;background:var(--surface2);cursor:pointer;flex-shrink:0;margin-right:8px}
.hamburger svg{width:20px;height:20px;color:var(--text)}

/* RONDA DEL D√çA */
.piso-group{margin-bottom:18px}
.piso-header{display:flex;align-items:center;gap:10px;padding:8px 14px;background:var(--accent);color:#fff;border-radius:9px 9px 0 0;font-weight:700;font-size:0.85rem}
.piso-header .piso-count{margin-left:auto;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:20px;font-size:0.75rem}
.ronda-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;padding:12px;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 9px 9px}
.ronda-card{background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:13px 15px;cursor:pointer;transition:all 0.15s;position:relative}
.ronda-card:hover{box-shadow:var(--shadow);border-color:var(--accent2)}
.ronda-card.riesgo-alto{border-left:4px solid var(--danger)}
.ronda-card.riesgo-medio{border-left:4px solid var(--warning)}
.ronda-card.riesgo-bajo{border-left:4px solid var(--success)}
.ronda-card.riesgo-sin{border-left:4px solid var(--border)}
.ronda-card .rc-hab{font-size:0.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em}
.ronda-card .rc-nombre{font-size:0.92rem;font-weight:700;color:var(--text);margin:2px 0 5px}
.ronda-card .rc-dx{font-size:0.75rem;color:var(--text2);line-height:1.4;margin-bottom:7px}
.ronda-card .rc-badges{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.ronda-card .rc-proxima{font-size:0.7rem;color:var(--text3);margin-top:5px}
.alerta-card{display:flex;align-items:flex-start;gap:10px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:12px 15px;margin-bottom:8px}
.alerta-card.alerta-rojo{border-left:4px solid var(--danger);background:var(--danger-light)}
.alerta-card.alerta-amarillo{border-left:4px solid var(--warning);background:var(--warning-light)}
.alerta-card .al-icon{font-size:1.2rem;flex-shrink:0}
.alerta-card .al-body h4{font-size:0.85rem;font-weight:700}
.alerta-card .al-body p{font-size:0.75rem;color:var(--text2);margin-top:2px}
@media(max-width:768px){.ronda-cards{grid-template-columns:1fr}}
.ic-form-section{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden}
.ic-form-head{display:flex;align-items:center;gap:8px;padding:9px 16px;background:var(--surface2);border-bottom:1px solid var(--border);border-left:4px solid var(--accent2)}
.ic-form-head.red{border-left-color:var(--danger)}.ic-form-head.green{border-left-color:var(--success)}.ic-form-head.amber{border-left-color:var(--warning)}.ic-form-head.slate{border-left-color:#475569}
.ic-form-head .ft{font-size:0.72rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;flex:1}
.ic-form-badge{font-size:0.66rem;font-weight:700;padding:2px 7px;border-radius:4px}
.ic-form-badge.red{background:var(--danger-light);color:var(--danger)}.ic-form-badge.blue{background:#e8f0fe;color:#1a56db}.ic-form-badge.green{background:var(--success-light);color:var(--success)}.ic-form-badge.amber{background:var(--warning-light);color:var(--warning)}
.ic-form-body{padding:14px 16px;display:flex;flex-direction:column;gap:11px}
.ic-sublabel{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text2);margin-bottom:5px}
.ic-chips{display:flex;flex-wrap:wrap;gap:5px}
.ic-chip{display:inline-flex;align-items:center;gap:5px;border:1.5px solid var(--border);border-radius:6px;padding:4px 10px;cursor:pointer;font-size:0.8rem;background:var(--surface2);transition:all 0.12s;user-select:none}
.ic-chip:hover{border-color:var(--accent2)}
.ic-chip.on{background:var(--accent-light);border-color:var(--accent2);color:var(--accent)}
.ic-chip.on-r{background:var(--danger-light);border-color:var(--danger);color:var(--danger)}
.ic-chip.on-g{background:var(--success-light);border-color:var(--success);color:var(--success)}
.ic-chip.on-a{background:var(--warning-light);border-color:var(--warning);color:var(--warning)}
.ic-g2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.ic-g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.ic-field{display:flex;flex-direction:column}
.ic-field textarea,.ic-field input[type=text]{background:var(--surface2);border:1.5px solid var(--border);border-radius:7px;padding:7px 10px;font-size:0.82rem;font-family:'DM Sans',sans-serif;color:var(--text);outline:none;transition:border-color 0.15s;width:100%}
.ic-field textarea:focus,.ic-field input[type=text]:focus{border-color:var(--accent2);background:#fff}
.ic-field textarea{resize:vertical;min-height:52px;line-height:1.5}
.sev-row{display:flex;gap:7px;margin-top:5px}
.sev-btn{flex:1;padding:8px;border-radius:7px;border:2px solid var(--border);cursor:pointer;text-align:center;font-size:0.78rem;font-weight:700;transition:all 0.15s;background:var(--surface)}
.sev-btn.bajo{color:var(--success)}.sev-btn.bajo.on{background:var(--success-light);border-color:var(--success)}
.sev-btn.medio{color:var(--warning)}.sev-btn.medio.on{background:var(--warning-light);border-color:var(--warning)}
.sev-btn.alto{color:var(--danger)}.sev-btn.alto.on{background:var(--danger-light);border-color:var(--danger)}
.ic-mode-bar{display:flex;gap:5px;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:4px;margin-bottom:16px}
.ic-mode-btn{flex:1;padding:7px 10px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--text2);transition:all 0.15s}
.ic-mode-btn.active{background:var(--accent);color:#fff}
.ic-patient-bar{display:grid;grid-template-columns:80px 1fr 160px 1fr 100px;gap:10px;background:#1a1714;border-radius:var(--radius);padding:14px 18px;margin-bottom:14px;align-items:end}
.ic-pat-field label{font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:#6b7280;display:block;margin-bottom:3px}
.ic-pat-field input{background:transparent;border:none;border-bottom:1px solid #3a3835;color:#fff;font-size:0.85rem;font-family:'DM Sans',sans-serif;outline:none;padding:2px 0;width:100%}
.ic-pat-field input::placeholder{color:#4b5563;font-style:italic;font-size:0.78rem}
.ic-pat-field input:focus{border-bottom-color:var(--accent2)}
.risk-alert-bar{background:var(--danger-light);border:1.5px solid var(--danger);border-radius:8px;padding:9px 14px;font-size:0.82rem;color:var(--danger);font-weight:600;margin-bottom:12px;display:none}
.risk-alert-bar.show{display:block}
.out-section{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-top:16px}
.out-section-head{background:var(--surface2);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.out-section-head span{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text2)}
.out-fields{display:grid;grid-template-columns:1fr 1fr;gap:0}
.out-field-ic{border-right:1px solid var(--border);padding:14px 16px}
.out-field-ic:nth-child(2){border-right:none}.out-field-ic:nth-child(3){border-top:1px solid var(--border)}.out-field-ic:nth-child(4){border-top:1px solid var(--border);border-right:none}
.out-field-label-ic{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text2);margin-bottom:7px}
.out-text-ic{font-size:0.8rem;line-height:1.65;white-space:pre-wrap;min-height:60px;color:var(--text)}
.out-text-ic.ph{color:var(--text3);font-style:italic}
.copy-field-btn-ic{font-size:0.7rem;padding:3px 8px;border-radius:5px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;font-family:'DM Sans',sans-serif;color:var(--text2);float:right;margin-bottom:6px;transition:all 0.15s}
.copy-field-btn-ic:hover{background:var(--border)}.copy-field-btn-ic.done{background:var(--success-light);border-color:var(--success);color:var(--success)}
.out-seg-wrap{padding:16px}
.esp-preview{background:var(--surface2);border:1.5px solid var(--border);border-radius:8px;padding:14px;font-size:0.82rem;line-height:1.65;white-space:pre-wrap;margin-top:10px}
@media(max-width:768px){.ic-g2,.ic-g3,.ic-patient-bar,.out-fields{grid-template-columns:1fr}.out-field-ic{border-right:none;border-top:1px solid var(--border)}}

</style>
</head>
<body>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <h1>Psicolog√≠a<br>Hospital</h1>
    <span>Psicolog√≠a ¬∑ Hospitalaria</span>
  </div>
  <div class="sidebar-nav">
    <div class="nav-section">General</div>
    <div class="nav-item active" onclick="goTo('dashboard')"><span class="icon">üè†</span>Inicio</div>
    <div class="nav-item" onclick="goTo('pacientes')"><span class="icon">üë•</span>Pacientes<span class="nav-badge" id="badge-pac">0</span></div>
    <div class="nav-item" onclick="goTo('interconsultas')"><span class="icon">üí¨</span>Interconsultas<span class="nav-badge" id="badge-ic">0</span></div>
    <div class="nav-item" onclick="goTo('anamnesis')"><span class="icon">üìã</span>Anamnesis</div>
    <div class="nav-section">Tests Cognitivos</div>
    <div class="nav-item" onclick="goTo('tests');showTest('mmse')"><span class="icon">üß†</span>MMSE<span class="nav-badge">30pts</span></div>
    <div class="nav-item" onclick="goTo('tests');showTest('moca')"><span class="icon">üß©</span>MoCA<span class="nav-badge">30pts</span></div>
    <div class="nav-item" onclick="goTo('tests');showTest('cam')"><span class="icon">üåÄ</span>CAM</div>
    <div class="nav-section">Tests de √Ånimo</div>
    <div class="nav-item" onclick="goTo('tests');showTest('phq9')"><span class="icon">üíô</span>PHQ-9<span class="nav-badge">27pts</span></div>
    <div class="nav-item" onclick="goTo('tests');showTest('gad7')"><span class="icon">‚ö°</span>GAD-7<span class="nav-badge">21pts</span></div>
    <div class="nav-item" onclick="goTo('tests');showTest('hads')"><span class="icon">üè•</span>HADS<span class="nav-badge">42pts</span></div>
    <div class="nav-section">Riesgo & Adherencia</div>
    <div class="nav-item" onclick="goTo('tests');showTest('cssrs')"><span class="icon">üî¥</span>C-SSRS</div>
    <div class="nav-item" onclick="goTo('tests');showTest('mmas4')"><span class="icon">üíä</span>MMAS-4</div>
    <div class="nav-item" onclick="goTo('tests');showTest('duelo')"><span class="icon">üïäÔ∏è</span>Duelo</div>
    <div class="nav-section">Valoraciones Especiales</div>
    <div class="nav-item" onclick="goTo('capacidad')"><span class="icon">‚öñÔ∏è</span>Capacidad Decisional</div>
    <div class="nav-section">Historial</div>
    <div class="nav-item" onclick="goTo('historial')"><span class="icon">üìä</span>Historial Tests</div>
  </div>
  <div class="sidebar-footer">
    <span class="sync-dot" id="sync-dot"></span>
    <span id="sync-status">Conectando‚Ä¶</span>
  </div>
</nav>

<div class="main">
  <div class="topbar">
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Men√∫">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <div class="topbar-title" id="topbar-title">Inicio</div>
    <div class="topbar-search">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <input type="text" id="global-search" placeholder="Buscar‚Ä¶" oninput="globalSearch(this.value)">
    </div>
  </div>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="content">

    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="stats-grid">
        <div class="stat-card"><div class="label">Pacientes</div><div class="value" id="stat-pac">‚Äî</div><div class="sub">En seguimiento</div></div>
        <div class="stat-card"><div class="label">IC Pendientes</div><div class="value" id="stat-ic">‚Äî</div><div class="sub">Sin responder</div></div>
        <div class="stat-card"><div class="label">Riesgo alto</div><div class="value" id="stat-riesgo" style="color:var(--danger)">‚Äî</div><div class="sub">Requieren atenci√≥n</div></div>
        <div class="stat-card"><div class="label">Tests hoy</div><div class="value" id="stat-tests">‚Äî</div><div class="sub">Aplicados</div></div><div class="stat-card" id="stat-altas-card" onclick="toggleAltasPanel()" style="cursor:pointer;border:1px solid var(--border)"><div class="label">Altas</div><div class="value" id="stat-altas" style="color:var(--success)">‚Äî</div><div class="sub">Este mes &#128196;</div></div>
      </div>

      <div class="section-header" style="margin-top:8px">
        <h2 id="ronda-titulo">üìã Pacientes para hoy</h2>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn btn-secondary btn-sm" id="btn-todos-dash" onclick="toggleDashView(false)" style="opacity:.5">Ver todos</button>
          <button class="btn btn-primary btn-sm" id="btn-hoy-dash" onclick="toggleDashView(true)">Solo hoy</button>
          <button class="btn btn-secondary btn-sm" onclick="renderDashboard()">‚Ü∫</button>
        </div>
      </div>
      <div id="ronda-pisos"></div>

      <div class="section-header" style="margin-top:20px">
        <h2>‚ö†Ô∏è Pendientes y alertas</h2>
      </div>
      <div id="dashboard-alertas"></div>

      <!-- PANEL ALTAS -->
      <div id="altas-panel" style="display:none;margin-top:20px">
        <div class="section-header">
          <h2>&#127937; Pacientes con alta</h2>
          <button class="btn btn-secondary btn-sm" onclick="toggleAltasPanel()">&#10005; Cerrar</button>
        </div>
        <div id="altas-list"></div>
      </div>

      <div class="section-header" style="margin-top:20px">
        <h2>Actividad reciente</h2>
      </div>
      <div id="recent-activity"><div class="loading"><div class="spinner"></div><br>Conectando con Firebase‚Ä¶</div></div>
    </div>

    <!-- PACIENTES -->
    <div id="page-pacientes" class="page">
      <div class="section-header">
        <h2>Registro de Pacientes</h2>
        <button class="btn btn-primary" onclick="openModal('modal-paciente')">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M12 4v16m8-8H4"/></svg>Nuevo paciente
        </button>
      </div>

      <!-- BUSCADOR INTERNO - grande y visible -->
      <div style="margin-bottom:14px;display:flex;gap:8px;align-items:center">
        <div style="flex:1;position:relative">
          <svg style="position:absolute;left:12px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:var(--text3)" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input
            type="search"
            id="pac-search-local"
            placeholder="Buscar por nombre, c√©dula, habitaci√≥n‚Ä¶"
            oninput="buscarPacientesLocal(this.value)"
            style="width:100%;padding:10px 12px 10px 36px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface2);color:var(--text);font-size:0.9rem;outline:none;transition:border-color .15s"
            onfocus="this.style.borderColor='var(--primary)'"
            onblur="this.style.borderColor='var(--border)'"
          >
        </div>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('pac-search-local').value='';buscarPacientesLocal('')">‚úï Limpiar</button>
      </div>

      <div class="table-wrap"><table>
        <thead><tr><th>Paciente</th><th>C√©dula</th><th>Edad/Sexo</th><th>Dx / Motivo IC</th><th>Riesgo</th><th>Estado</th><th style="min-width:110px">Pr√≥xima sesi√≥n</th><th>Acciones</th></tr></thead>
        <tbody id="tabla-pacientes"><tr><td colspan="8"><div class="loading"><div class="spinner"></div><br>Cargando‚Ä¶</div></td></tr></tbody>
      </table></div>
    </div>

    <!-- INTERCONSULTAS -->
    <div id="page-interconsultas" class="page">
      <div class="section-header">
        <h2>Interconsultas Hospitalarias</h2>
        <button class="btn btn-secondary btn-sm" onclick="toggleICView()">üìã Historial</button>
      </div>
      <div id="ic-historial-view" style="display:none;margin-bottom:18px">
        <div id="lista-ic"><div class="loading"><div class="spinner"></div><br>Cargando‚Ä¶</div></div>
        <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="toggleICView()">‚Üê Volver al formulario</button>
      </div>
      <div id="ic-form-view">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px">
          <label style="font-size:0.78rem;font-weight:600;color:var(--text2);flex-shrink:0">Paciente</label>
          <select id="ic-paciente-sel" onchange="selectICPaciente(this.value)" style="flex:1;padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem">
            <option value="">‚Äî Seleccionar paciente (opcional, o llenar manualmente) ‚Äî</option>
          </select>
          <button class="btn btn-secondary btn-sm" onclick="limpiarFormIC()">üîÑ Limpiar</button>
        </div>
        <div class="ic-mode-bar">
          <button class="ic-mode-btn active" id="ic-btn-nueva" onclick="setICMode('nueva')">üí¨ IC Nueva</button>
          <button class="ic-mode-btn" id="ic-btn-seg" onclick="setICMode('seg')">üìù Seguimiento</button>
          <button class="ic-mode-btn" id="ic-btn-esp" onclick="setICMode('esp')">‚ö†Ô∏è Nota Especial</button>
        </div>
        <div class="ic-patient-bar">
          <div class="ic-pat-field"><label>Hab.</label><input type="text" id="ic-hab" placeholder="304B"></div>
          <div class="ic-pat-field"><label>Nombre del paciente</label><input type="text" id="ic-pnombre" placeholder="Nombre completo"></div>
          <div class="ic-pat-field"><label>Edad / Sexo</label><input type="text" id="ic-edad" placeholder="42 a√±os, F"></div>
          <div class="ic-pat-field"><label>Diagn√≥stico m√©dico / Motivo IC</label><input type="text" id="ic-pdx" placeholder="Ca. de mama, impacto emocional dx reciente"></div>
          <div class="ic-pat-field"><label>Fecha</label><input type="text" id="ic-pfecha" placeholder="dd/mm/aa"></div>
        </div>
        <div class="risk-alert-bar" id="ic-risk-alert">‚ö†Ô∏è RIESGO ALTO ‚Äî Verificar protocolo de seguridad antes de cerrar la nota</div>
        <!-- MODO IC NUEVA + SEGUIMIENTO -->
        <div id="ic-mode-nueva">
          <div class="ic-form-section ic-only-nueva">
            <div class="ic-form-head slate"><span class="ft">üè• Contexto m√©dico</span></div>
            <div class="ic-form-body">
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Tipo de hospitalizaci√≥n</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Aguda / reciente</span><span class="ic-chip" onclick="icTog(this)">Hospitalizaci√≥n prolongada</span><span class="ic-chip" onclick="icTog(this)">UCI / urgencias</span><span class="ic-chip" onclick="icTog(this)">Cirug√≠a reciente</span></div></div>
                <div class="ic-field"><div class="ic-sublabel">Evento cr√≠tico reciente</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Ninguno</span><span class="ic-chip" onclick="icTog(this)">Diagn√≥stico nuevo</span><span class="ic-chip" onclick="icTogR(this)">Malas noticias</span><span class="ic-chip" onclick="icTog(this)">Empeoramiento cl√≠nico</span><span class="ic-chip" onclick="icTogR(this)">Techo terap√©utico</span><span class="ic-chip" onclick="icTog(this)">Procedimiento invasivo pr√≥ximo</span></div></div>
              </div>
            </div>
          </div>
          <div class="ic-form-section">
            <div class="ic-form-head"><span class="ft">üí¨ An√°lisis subjetivo ‚Äî Reporte del paciente</span><span class="ic-form-badge blue">SUBJETIVO</span></div>
            <div class="ic-form-body">
              <div class="ic-field"><div class="ic-sublabel">Estado emocional referido</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Ansioso/a</span><span class="ic-chip" onclick="icTog(this)">Triste</span><span class="ic-chip" onclick="icTogR(this)">Desesperanzado/a</span><span class="ic-chip" onclick="icTog(this)">Irritable</span><span class="ic-chip" onclick="icTog(this)">Asustado/a</span><span class="ic-chip" onclick="icTog(this)">Confundido/a</span><span class="ic-chip" onclick="icTogG(this)">Relativamente tranquilo/a</span><span class="ic-chip" onclick="icTog(this)">Abrumado/a</span><span class="ic-chip" onclick="icTog(this)">Ambivalente</span></div></div>
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Principales preocupaciones</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Pron√≥stico incierto</span><span class="ic-chip" onclick="icTog(this)">Dolor / malestar f√≠sico</span><span class="ic-chip" onclick="icTog(this)">Familia / hijos</span><span class="ic-chip" onclick="icTog(this)">Rol laboral / econ√≥mico</span><span class="ic-chip" onclick="icTog(this)">Dependencia / autonom√≠a</span><span class="ic-chip" onclick="icTog(this)">Miedo a morir</span><span class="ic-chip" onclick="icTog(this)">Proceso diagn√≥stico</span><span class="ic-chip" onclick="icTog(this)">Aislamiento</span><span class="ic-chip" onclick="icTogA(this)">Demoras del alta</span></div></div>
                <div class="ic-field"><div class="ic-sublabel">Pensamientos autom√°ticos (CC)</div><div class="ic-chips"><span class="ic-chip" onclick="icTogR(this)">No voy a mejorar</span><span class="ic-chip" onclick="icTogR(this)">Soy una carga</span><span class="ic-chip" onclick="icTogR(this)">No puedo con esto</span><span class="ic-chip" onclick="icTogR(this)">Lo peor est√° por venir</span><span class="ic-chip" onclick="icTogR(this)">Nunca volver√© a ser el mismo/a</span><span class="ic-chip" onclick="icTogA(this)">Catastrofizaci√≥n</span><span class="ic-chip" onclick="icTogA(this)">Pensamiento todo-o-nada</span><span class="ic-chip" onclick="icTogA(this)">Minimizaci√≥n de recursos propios</span></div></div>
              </div>
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Cita textual / narrativa relevante</div><textarea id="ic-sub-cita" placeholder="Ej: No s√© c√≥mo decirle a mis hijos..." rows="2"></textarea></div>
                <div class="ic-field"><div class="ic-sublabel">Intensidad malestar (1‚Äì10) / Desde el ingreso</div><input type="text" id="ic-sub-intensidad" placeholder="Ej: 8/10 ‚Äî Desde el ingreso describe..."></div>
              </div>
            </div>
          </div>
          <div class="ic-form-section">
            <div class="ic-form-head amber"><span class="ft">üß© An√°lisis objetivo ‚Äî Examen mental</span><span class="ic-form-badge amber">OBJETIVO</span></div>
            <div class="ic-form-body">
              <div class="ic-g3">
                <div><div class="ic-sublabel">Orientaci√≥n</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Tiempo</span><span class="ic-chip on-g" onclick="icTogG(this)">Espacio</span><span class="ic-chip on-g" onclick="icTogG(this)">Persona</span><span class="ic-chip" onclick="icTogR(this)">Desorientado/a</span></div></div>
                <div><div class="ic-sublabel">Conciencia / Colaboraci√≥n</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Consciente</span><span class="ic-chip on-g" onclick="icTogG(this)">Colaborador/a</span><span class="ic-chip" onclick="icTog(this)">Poco colaborador/a</span><span class="ic-chip" onclick="icTogR(this)">Obnubilado/a</span></div></div>
                <div><div class="ic-sublabel">Conducta</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Adecuada</span><span class="ic-chip" onclick="icTog(this)">Inhibida</span><span class="ic-chip" onclick="icTog(this)">Agitada</span><span class="ic-chip" onclick="icTog(this)">Lloroso/a</span><span class="ic-chip" onclick="icTog(this)">Retra√≠do/a</span></div></div>
                <div><div class="ic-sublabel">Afecto</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Eut√≠mico</span><span class="ic-chip" onclick="icTog(this)">Depresivo</span><span class="ic-chip" onclick="icTog(this)">Ansioso</span><span class="ic-chip" onclick="icTog(this)">L√°bil</span><span class="ic-chip" onclick="icTog(this)">Aplanado</span><span class="ic-chip on-g" onclick="icTogG(this)">Congruente</span></div></div>
                <div><div class="ic-sublabel">Pensamiento</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Organizado</span><span class="ic-chip on-g" onclick="icTogG(this)">L√≥gico</span><span class="ic-chip" onclick="icTogR(this)">Ideas irracionales</span><span class="ic-chip" onclick="icTogR(this)">Bloqueo</span><span class="ic-chip" onclick="icTogR(this)">Bradipsiquia</span></div></div>
                <div><div class="ic-sublabel">Lenguaje / Insight</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Coherente</span><span class="ic-chip on-g" onclick="icTogG(this)">Insight conservado</span><span class="ic-chip" onclick="icTog(this)">Insight parcial</span><span class="ic-chip" onclick="icTogR(this)">Sin insight</span></div></div>
              </div>
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Regulaci√≥n emocional</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Tolera el malestar</span><span class="ic-chip" onclick="icTog(this)">Llanto contenido</span><span class="ic-chip" onclick="icTogR(this)">Llanto incontenible</span><span class="ic-chip" onclick="icTogR(this)">Ansiedad desbordada</span><span class="ic-chip" onclick="icTog(this)">Bloqueo emocional</span></div></div>
                <div class="ic-field"><div class="ic-sublabel">Estrategias de afrontamiento</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Hablar / verbalizar</span><span class="ic-chip on-g" onclick="icTogG(this)">Espiritualidad / fe</span><span class="ic-chip" onclick="icTog(this)">Evitaci√≥n</span><span class="ic-chip" onclick="icTog(this)">Control excesivo</span><span class="ic-chip" onclick="icTogR(this)">Afrontamiento desorganizado</span><span class="ic-chip on-g" onclick="icTogG(this)">Red de apoyo activa</span></div></div>
              </div>
              <div class="ic-field"><div class="ic-sublabel">Comprensi√≥n del Dx / pron√≥stico</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Comprensi√≥n adecuada</span><span class="ic-chip" onclick="icTog(this)">Comprensi√≥n parcial</span><span class="ic-chip" onclick="icTogR(this)">Negaci√≥n</span><span class="ic-chip" onclick="icTogA(this)">Expectativas irreales</span><span class="ic-chip" onclick="icTog(this)">Alta incertidumbre / miedo</span></div></div>
            </div>
          </div>
          <div class="ic-form-section ic-only-nueva">
            <div class="ic-form-head slate"><span class="ft">üçΩÔ∏è H√°bitos ‚Äî Alimentaci√≥n, sue√±o y sustancias</span></div>
            <div class="ic-form-body">
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Alimentaci√≥n</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Adecuada</span><span class="ic-chip" onclick="icTogA(this)">Reducida / poco apetito</span><span class="ic-chip" onclick="icTogR(this)">Muy escasa / ayuno</span><span class="ic-chip" onclick="icTogA(this)">Ingesta aumentada</span><span class="ic-chip" onclick="icTog(this)">Condicionada por dieta m√©dica</span></div></div>
                <div class="ic-field"><div class="ic-sublabel">Sue√±o</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Conservado</span><span class="ic-chip" onclick="icTogA(this)">Insomnio de conciliaci√≥n</span><span class="ic-chip" onclick="icTogA(this)">Insomnio de mantenimiento</span><span class="ic-chip" onclick="icTogR(this)">Insomnio severo</span><span class="ic-chip" onclick="icTog(this)">Hipersomnia</span><span class="ic-chip" onclick="icTog(this)">Alterado por hospitalizaci√≥n</span></div></div>
              </div>
              <div class="ic-field"><div class="ic-sublabel">Consumo de sustancias psicoactivas</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Niega consumo</span><span class="ic-chip" onclick="icTogA(this)">Consumo ocasional de alcohol</span><span class="ic-chip" onclick="icTogR(this)">Consumo problem√°tico de alcohol</span><span class="ic-chip" onclick="icTogA(this)">Tabaco</span><span class="ic-chip" onclick="icTogR(this)">Marihuana</span><span class="ic-chip" onclick="icTogR(this)">Coca√≠na / bazuco</span><span class="ic-chip" onclick="icTogR(this)">Benzodiacepinas sin prescripci√≥n</span><span class="ic-chip" onclick="icTog(this)">Otro</span></div>
              <textarea id="ic-sustancias-notas" placeholder="Detalles sobre consumo, frecuencia, impacto..." rows="2" style="margin-top:8px;width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:7px;padding:7px 10px;font-size:0.82rem;font-family:'DM Sans',sans-serif;color:var(--text);outline:none"></textarea></div>
            </div>
          </div>
          <div class="ic-form-section">
            <div class="ic-form-head red"><span class="ft">üî¥ Riesgo suicida / autolesivo</span><span class="ic-form-badge red">SIEMPRE ‚Äî NUNCA OMITIR</span></div>
            <div class="ic-form-body">
              <div class="ic-g2">
                <div><div class="ic-sublabel">Ideaci√≥n actual</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Ninguna</span><span class="ic-chip" onclick="icTogA(this)">Pasiva ‚Äî deseo de que termine</span><span class="ic-chip" onclick="icTogR(this)">Activa</span><span class="ic-chip" onclick="icTogR(this)">Con plan estructurado</span></div></div>
                <div><div class="ic-sublabel">Clasificaci√≥n de riesgo</div><div class="sev-row"><div class="sev-btn bajo" onclick="setICSev(this,'BAJO')">BAJO</div><div class="sev-btn medio" onclick="setICSev(this,'MEDIO')">MEDIO</div><div class="sev-btn alto" onclick="setICSev(this,'ALTO',true)">ALTO</div></div><input type="hidden" id="ic-riesgo-nivel" value=""></div>
              </div>
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Intentos previos</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Ninguno</span><span class="ic-chip" onclick="icTogR(this)">S√≠ ‚Äî relevantes</span></div></div>
                <div class="ic-field"><div class="ic-sublabel">Factores protectores</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Red de apoyo presente</span><span class="ic-chip on-g" onclick="icTogG(this)">Motivaci√≥n para recuperarse</span><span class="ic-chip on-g" onclick="icTogG(this)">Hijos / familia</span><span class="ic-chip on-g" onclick="icTogG(this)">Fe / espiritualidad</span></div></div>
              </div>
              <div class="ic-field"><div class="ic-sublabel">Notas de riesgo</div><textarea id="ic-riesgo-notas" placeholder="Deseo de morir vs. deseo de que termine el sufrimiento..." rows="2"></textarea></div>
            </div>
          </div>
          <div class="ic-form-section ic-only-nueva">
            <div class="ic-form-head slate"><span class="ft">‚öïÔ∏è Factores de interferencia con el manejo m√©dico</span></div>
            <div class="ic-form-body">
              <div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Sin interferencia identificada</span><span class="ic-chip" onclick="icTogR(this)">Rechazo de procedimientos</span><span class="ic-chip" onclick="icTog(this)">Negaci√≥n del Dx</span><span class="ic-chip" onclick="icTog(this)">Desmotivaci√≥n para el tratamiento</span><span class="ic-chip" onclick="icTog(this)">Ansiedad anticipatoria a ex√°menes</span><span class="ic-chip" onclick="icTog(this)">Dependencia emocional del personal</span><span class="ic-chip" onclick="icTogA(this)">No adherencia a indicaciones</span></div>
            </div>
          </div>
          <div class="ic-form-section">
            <div class="ic-form-head green"><span class="ft">üéØ Respuesta ‚Äî Impresi√≥n cl√≠nica CC</span><span class="ic-form-badge green">RESPUESTA</span></div>
            <div class="ic-form-body">
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Tipo de respuesta emocional</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Esperable / adaptativa</span><span class="ic-chip" onclick="icTogA(this)">Desproporcionada al est√≠mulo</span><span class="ic-chip" onclick="icTogR(this)">Patol√≥gica ‚Äî requiere intervenci√≥n</span></div></div>
                <div class="ic-field"><div class="ic-sublabel">Impresi√≥n cl√≠nica</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Respuesta adaptativa al estr√©s m√©dico</span><span class="ic-chip" onclick="icTog(this)">Trastorno adaptativo</span><span class="ic-chip" onclick="icTog(this)">S√≠ntomas depresivos reactivos</span><span class="ic-chip" onclick="icTog(this)">Sintomatolog√≠a ansiosa</span><span class="ic-chip" onclick="icTog(this)">Distorsiones cognitivas relevantes</span><span class="ic-chip" onclick="icTogR(this)">Cuadro depresivo mayor</span><span class="ic-chip" onclick="icTog(this)">Reacci√≥n de duelo</span></div></div>
              </div>
              <div class="ic-field"><div class="ic-sublabel">An√°lisis cognitivo-conductual</div><textarea id="ic-resp-analisis" placeholder="Describir relaci√≥n pensamientos autom√°ticos, emociones y conductas. Ej: Se identifica patr√≥n de catastrofizaci√≥n centrado en pron√≥stico que genera evitaci√≥n..." rows="3"></textarea></div>
              <div class="ic-field"><div class="ic-sublabel">Red de apoyo funcional</div><div class="ic-chips"><span class="ic-chip on-g" onclick="icTogG(this)">Presente y activa</span><span class="ic-chip" onclick="icTogA(this)">Presente pero ambivalente</span><span class="ic-chip" onclick="icTogR(this)">Ausente</span><span class="ic-chip" onclick="icTog(this)">Conflictos familiares activos</span></div></div>
            </div>
          </div>
          <div class="ic-form-section">
            <div class="ic-form-head slate"><span class="ft">üõ†Ô∏è Tratamiento ‚Äî Intervenci√≥n y plan</span><span class="ic-form-badge">TRATAMIENTO</span></div>
            <div class="ic-form-body">
              <div class="ic-field"><div class="ic-sublabel">Intervenci√≥n realizada hoy</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Escucha activa y validaci√≥n emocional</span><span class="ic-chip" onclick="icTog(this)">Contenci√≥n emocional</span><span class="ic-chip" onclick="icTog(this)">Psicoeducaci√≥n sobre respuesta emocional al Dx</span><span class="ic-chip" onclick="icTog(this)">Reestructuraci√≥n cognitiva</span><span class="ic-chip" onclick="icTog(this)">T√©cnicas de regulaci√≥n emocional</span><span class="ic-chip" onclick="icTog(this)">Activaci√≥n conductual</span><span class="ic-chip" onclick="icTog(this)">T√©cnicas de respiraci√≥n / relajaci√≥n</span><span class="ic-chip" onclick="icTog(this)">Reforzamiento de red de apoyo</span><span class="ic-chip" onclick="icTog(this)">Exploraci√≥n de recursos y factores protectores</span><span class="ic-chip" onclick="icTog(this)">Orientaci√≥n familiar</span><span class="ic-chip" onclick="icTog(this)">Evaluaci√≥n y manejo de riesgo suicida</span></div></div>
              <div class="ic-g2">
                <div class="ic-field"><div class="ic-sublabel">Plan</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Contin√∫a seguimiento por psicolog√≠a</span><span class="ic-chip" onclick="icTogR(this)">Remisi√≥n a psiquiatr√≠a</span><span class="ic-chip" onclick="icTog(this)">Orientaci√≥n a trabajo social</span><span class="ic-chip on-g" onclick="icTogG(this)">Alta de psicolog√≠a</span><span class="ic-chip" onclick="icTog(this)">Reinterconsulta si hay cambios</span></div></div>
                <div class="ic-field"><div class="ic-sublabel">Frecuencia de seguimiento</div><div class="ic-chips"><span class="ic-chip" onclick="icTog(this)">Diario</span><span class="ic-chip" onclick="icTog(this)">Cada 2 d√≠as</span><span class="ic-chip" onclick="icTog(this)">Interdiario</span><span class="ic-chip" onclick="icTog(this)">Seg√∫n evoluci√≥n</span></div></div>
              </div>
              <div class="ic-field"><div class="ic-sublabel">Notas / recomendaciones al equipo</div><textarea id="ic-trat-notas" placeholder="Indicaciones espec√≠ficas para el equipo m√©dico, enfermer√≠a o trabajo social..." rows="2"></textarea></div>
            </div>
          </div>
        </div><!-- end ic-mode-nueva -->
        <!-- MODO ESPECIALES -->
        <div id="ic-mode-esp" style="display:none">
          <div class="ic-form-section">
            <div class="ic-form-head slate"><span class="ft">üìã Notas especiales ‚Äî Selecciona la situaci√≥n</span></div>
            <div class="ic-form-body">
              <div class="ic-sublabel">Tipo de nota</div>
              <div class="ic-chips"><span class="ic-chip" onclick="setIcEsp('intubado',this)">Paciente intubado</span><span class="ic-chip" onclick="setIcEsp('dolor',this)">Dolor / no disponible para entrevista</span><span class="ic-chip" onclick="setIcEsp('nodisponible',this)">Paciente no disponible</span><span class="ic-chip" onclick="setIcEsp('fuga',this)">Fuga hospitalaria</span><span class="ic-chip" onclick="setIcEsp('repetida',this)">IC reiterada sin justificaci√≥n</span></div>
              <div id="ic-esp-preview" style="display:none"><div class="ic-sublabel" style="margin-top:12px">Vista previa de la nota</div><div class="esp-preview" id="ic-esp-text"></div></div>
            </div>
          </div>
        </div>
        <!-- BOTONES -->
        <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="generarNotaIC()">‚ú® Generar nota cl√≠nica</button>
          <button class="btn btn-secondary" onclick="guardarICFirebase()">üíæ Guardar en Firebase</button>
        </div>
        <!-- OUTPUT -->
        <div id="ic-output-wrap" style="display:none;margin-top:16px">
          <div class="out-section">
            <div class="out-section-head"><span>Nota cl√≠nica ‚Äî lista para copiar al sistema</span><button class="btn btn-secondary btn-sm" onclick="copiarTodoIC()">Copiar todo</button></div>
            <div id="ic-out-4campos">
              <div class="out-fields">
                <div class="out-field-ic"><button class="copy-field-btn-ic" onclick="copiarCampoIC('ic-out-sub',this)">Copiar</button><div class="out-field-label-ic">An√°lisis Subjetivo</div><div class="out-text-ic ph" id="ic-out-sub">Genera la nota para ver el contenido‚Ä¶</div></div>
                <div class="out-field-ic"><button class="copy-field-btn-ic" onclick="copiarCampoIC('ic-out-obj',this)">Copiar</button><div class="out-field-label-ic">An√°lisis Objetivo</div><div class="out-text-ic ph" id="ic-out-obj">Genera la nota para ver el contenido‚Ä¶</div></div>
                <div class="out-field-ic"><button class="copy-field-btn-ic" onclick="copiarCampoIC('ic-out-resp',this)">Copiar</button><div class="out-field-label-ic">Respuesta</div><div class="out-text-ic ph" id="ic-out-resp">Genera la nota para ver el contenido‚Ä¶</div></div>
                <div class="out-field-ic"><button class="copy-field-btn-ic" onclick="copiarCampoIC('ic-out-trat',this)">Copiar</button><div class="out-field-label-ic">Tratamiento</div><div class="out-text-ic ph" id="ic-out-trat">Genera la nota para ver el contenido‚Ä¶</div></div>
              </div>
            </div>
            <div id="ic-out-seg" style="display:none"><div class="out-seg-wrap"><button class="copy-field-btn-ic" onclick="copiarCampoIC('ic-out-seg-texto',this)">Copiar</button><div class="out-field-label-ic">Nota de seguimiento</div><div class="out-text-ic ph" id="ic-out-seg-texto">Genera la nota para ver el contenido‚Ä¶</div></div></div>
          </div>
        </div>
      </div><!-- end ic-form-view -->
    </div>

    <!-- ANAMNESIS -->
    <div id="page-anamnesis" class="page">
      <div class="section-header">
        <h2>Anamnesis Psicol√≥gica ¬∑ Primera vez</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="anamnesis-paciente-sel" onchange="selectAnamPaciente(this.value)" style="padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem;min-width:190px">
            <option value="">‚Äî Seleccionar paciente ‚Äî</option>
          </select>
          <button class="btn btn-secondary" onclick="clearAnamnesis()">Nueva</button>
        </div>
      </div>
      <div class="timer-bar">
        <div class="timer-step"><div class="ts-time">0‚Äì5 min</div>Escucha / motivo</div>
        <div class="timer-step"><div class="ts-time">5‚Äì15 min</div>Historia</div>
        <div class="timer-step"><div class="ts-time">15‚Äì20 min</div>Examen mental</div>
        <div class="timer-step"><div class="ts-time">20‚Äì25 min</div>Diagn√≥stico</div>
        <div class="timer-step"><div class="ts-time">25‚Äì30 min</div>Plan</div>
      </div>
      <form id="form-anamnesis">
        <div class="anamnesis-section">
          <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>ü™™</span><h4>Datos de identificaci√≥n</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body open"><div class="form-grid">
            <div class="form-group"><label>Fecha</label><input type="date" id="an-fecha"></div>
            <div class="form-group"><label>Nombre completo</label><input type="text" id="an-nombre"></div>
            <div class="form-group"><label>Edad</label><input type="number" id="an-edad" min="0" max="120"></div>
            <div class="form-group"><label>C√©dula</label><input type="text" id="an-cedula"></div>
            <div class="form-group"><label>Estado civil</label><select id="an-ecivil"><option value="">Seleccionar...</option><option>Soltero/a</option><option>Casado/a</option><option>Uni√≥n libre</option><option>Separado/a</option><option>Divorciado/a</option><option>Viudo/a</option></select></div>
            <div class="form-group"><label>Escolaridad</label><select id="an-esc"><option value="">Seleccionar...</option><option>Ninguna</option><option>Primaria</option><option>Secundaria</option><option>T√©cnico/Tecn√≥logo</option><option>Universitario</option><option>Posgrado</option></select></div>
            <div class="form-group"><label>Ocupaci√≥n</label><input type="text" id="an-ocupacion"></div>
            <div class="form-group"><label>Remitido por</label><input type="text" id="an-remitido"></div>
          </div></div>
        </div>
        <div class="anamnesis-section">
          <div class="anamnesis-section-header" onclick="toggleSection(this)"><span>üí¨</span><h4>Motivo de consulta</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body"><div class="form-group"><label>En palabras del paciente</label><textarea id="an-motivo" placeholder='"¬øQu√© le trae por aqu√≠ hoy?"'></textarea></div></div>
        </div>
        <div class="anamnesis-section">
          <div class="anamnesis-section-header" onclick="toggleSection(this)"><span>üìñ</span><h4>Historia del problema actual</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body"><div class="form-grid">
            <div class="form-group"><label>Inicio</label><div class="checkgroup"><label><input type="radio" name="an-inicio" value="Repentino"><span>Repentino</span></label><label><input type="radio" name="an-inicio" value="Gradual"><span>Gradual</span></label></div></div>
            <div class="form-group"><label>Tiempo de evoluci√≥n</label><input type="text" id="an-evolucion" placeholder="Ej: 3 meses"></div>
            <div class="form-group full"><label>Desencadenantes</label><div class="checkgroup" id="an-desenc"><label><input type="checkbox" value="Laboral"><span>Laboral</span></label><label><input type="checkbox" value="Familiar"><span>Familiar</span></label><label><input type="checkbox" value="Pareja"><span>Pareja</span></label><label><input type="checkbox" value="Acad√©mico"><span>Acad√©mico</span></label><label><input type="checkbox" value="Duelo"><span>Duelo</span></label><label><input type="checkbox" value="Salud propia"><span>Salud propia</span></label><label><input type="checkbox" value="Econ√≥mico"><span>Econ√≥mico</span></label><label><input type="checkbox" value="Otro"><span>Otro</span></label></div></div>
            <div class="form-group full"><label>S√≠ntomas principales</label><div class="checkgroup" id="an-sint"><label><input type="checkbox" value="Tristeza"><span>Tristeza</span></label><label><input type="checkbox" value="Ansiedad"><span>Ansiedad</span></label><label><input type="checkbox" value="Miedo"><span>Miedo</span></label><label><input type="checkbox" value="Irritabilidad"><span>Irritabilidad</span></label><label><input type="checkbox" value="Insomnio"><span>Insomnio</span></label><label><input type="checkbox" value="Apat√≠a"><span>Apat√≠a</span></label><label><input type="checkbox" value="Anhedonia"><span>Anhedonia</span></label><label><input type="checkbox" value="Desesperanza"><span>Desesperanza</span></label><label><input type="checkbox" value="Ataques de p√°nico"><span>Ataques de p√°nico</span></label><label><input type="checkbox" value="Alucinaciones"><span>Alucinaciones</span></label></div></div>
            <div class="form-group"><label>Intensidad (1‚Äì10): <strong id="an-intens-val">5</strong></label><input type="range" id="an-intens" min="1" max="10" value="5" oninput="document.getElementById('an-intens-val').textContent=this.value" style="margin-top:8px"></div>
            <div class="form-group full"><label>Impacto funcional</label><div class="checkgroup" id="an-impacto"><label><input type="checkbox" value="Laboral"><span>Laboral</span></label><label><input type="checkbox" value="Familiar"><span>Familiar</span></label><label><input type="checkbox" value="Social"><span>Social</span></label><label><input type="checkbox" value="Pareja"><span>Pareja</span></label><label><input type="checkbox" value="Autocuidado"><span>Autocuidado</span></label></div></div>
            <div class="form-group full"><label>Descripci√≥n</label><textarea id="an-descripcion" rows="3"></textarea></div>
          </div></div>
        </div>
        <div class="anamnesis-section">
          <div class="anamnesis-section-header" onclick="toggleSection(this)"><span>üóÇÔ∏è</span><h4>Antecedentes</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body"><div class="form-grid">
            <div class="form-group"><label>Tto. psicol√≥gico previo</label><div class="checkgroup"><label><input type="radio" name="an-tpsi" value="No"><span>No</span></label><label><input type="radio" name="an-tpsi" value="S√≠"><span>S√≠</span></label></div></div>
            <div class="form-group"><label>Tto. psiqui√°trico previo</label><div class="checkgroup"><label><input type="radio" name="an-tpsiq" value="No"><span>No</span></label><label><input type="radio" name="an-tpsiq" value="S√≠"><span>S√≠</span></label></div></div>
            <div class="form-group"><label>Intentos de suicidio</label><div class="checkgroup"><label><input type="radio" name="an-is" value="No"><span>No</span></label><label><input type="radio" name="an-is" value="S√≠"><span>S√≠</span></label></div></div>
            <div class="form-group"><label>Medicamentos actuales</label><input type="text" id="an-meds"></div>
            <div class="form-group"><label>Enfermedades m√©dicas</label><input type="text" id="an-enf"></div>
            <div class="form-group full"><label>Red de apoyo</label><div class="checkgroup"><label><input type="radio" name="an-red" value="Adecuada"><span>Adecuada</span></label><label><input type="radio" name="an-red" value="Escasa"><span>Escasa</span></label><label><input type="radio" name="an-red" value="Ausente"><span>Ausente</span></label><label><input type="radio" name="an-red" value="Conflictiva"><span>Conflictiva</span></label></div></div>
          </div></div>
        </div>
        <div class="anamnesis-section">
          <div class="anamnesis-section-header" onclick="toggleSection(this)"><span>üß©</span><h4>Examen mental</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body"><div class="form-grid">
            <div class="form-group full"><label>Orientaci√≥n</label><div class="checkgroup" id="an-orient"><label><input type="checkbox" value="Tiempo"><span>Tiempo</span></label><label><input type="checkbox" value="Espacio"><span>Espacio</span></label><label><input type="checkbox" value="Persona"><span>Persona</span></label><label><input type="checkbox" value="Desorientado/a"><span>Desorientado/a</span></label></div></div>
            <div class="form-group full"><label>Afecto</label><div class="checkgroup" id="an-afecto"><label><input type="checkbox" value="Eut√≠mico"><span>Eut√≠mico</span></label><label><input type="checkbox" value="Depresivo"><span>Depresivo</span></label><label><input type="checkbox" value="Ansioso"><span>Ansioso</span></label><label><input type="checkbox" value="L√°bil"><span>L√°bil</span></label><label><input type="checkbox" value="Aplanado"><span>Aplanado</span></label></div></div>
            <div class="form-group full"><label>Pensamiento ‚Äî Curso</label><div class="checkgroup"><label><input type="radio" name="an-pcurso" value="L√≥gico"><span>L√≥gico</span></label><label><input type="radio" name="an-pcurso" value="Bradipsiquia"><span>Bradipsiquia</span></label><label><input type="radio" name="an-pcurso" value="Taquipsiquia"><span>Taquipsiquia</span></label><label><input type="radio" name="an-pcurso" value="Bloqueo"><span>Bloqueo</span></label></div></div>
            <div class="form-group full"><label>Insight</label><div class="checkgroup" id="an-insight"><label><input type="checkbox" value="Conservado"><span>Conservado</span></label><label><input type="checkbox" value="Parcial"><span>Parcial</span></label><label><input type="checkbox" value="Sin insight"><span>Sin insight</span></label></div></div>
            <div class="form-group full"><label>Memoria y atenci√≥n</label><div class="checkgroup"><label><input type="radio" name="an-mem" value="Conservadas"><span>Conservadas</span></label><label><input type="radio" name="an-mem" value="Atenci√≥n deteriorada"><span>Atenci√≥n deteriorada</span></label><label><input type="radio" name="an-mem" value="Memoria deteriorada"><span>Memoria deteriorada</span></label><label><input type="radio" name="an-mem" value="Ambas deterioradas"><span>Ambas deterioradas</span></label></div></div>
          </div></div>
        </div>
        <div class="anamnesis-section">
          <div class="anamnesis-section-header" onclick="toggleSection(this)"><span>üî¥</span><h4>Riesgo suicida ‚Äî NUNCA OMITIR</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body"><div class="form-grid">
            <div class="form-group full"><label>Ideaci√≥n actual</label><div class="checkgroup"><label><input type="radio" name="an-ideacion" value="Ninguna"><span>Ninguna</span></label><label><input type="radio" name="an-ideacion" value="Pasiva"><span>Pasiva</span></label><label><input type="radio" name="an-ideacion" value="Activa"><span>Activa</span></label><label><input type="radio" name="an-ideacion" value="Con plan"><span>Con plan</span></label></div></div>
            <div class="form-group full"><label>Clasificaci√≥n de riesgo</label>
              <div class="risk-selector"><div class="risk-btn" style="color:var(--text2)" onclick="setRisk('SIN RIESGO',this)">SIN RIESGO</div><div class="risk-btn low" onclick="setRisk('BAJO',this)">BAJO</div><div class="risk-btn med" onclick="setRisk('MEDIO',this)">MEDIO</div><div class="risk-btn high" onclick="setRisk('ALTO',this)">ALTO</div></div>
              <input type="hidden" id="an-riesgo" value="">
            </div>
            <div class="form-group full"><label>Notas riesgo</label><textarea id="an-riesgo-notas"></textarea></div>
          </div></div>
        </div>
        <div class="anamnesis-section">
          <div class="anamnesis-section-header" onclick="toggleSection(this)"><span>üéØ</span><h4>Impresi√≥n diagn√≥stica y plan</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body"><div class="form-grid">
            <div class="form-group full"><label>Diagn√≥stico</label><div class="checkgroup" id="an-dx"><label><input type="checkbox" value="Trastorno adaptativo"><span>T. adaptativo</span></label><label><input type="checkbox" value="Trastorno depresivo leve"><span>Dep. leve</span></label><label><input type="checkbox" value="Trastorno depresivo moderado"><span>Dep. moderado</span></label><label><input type="checkbox" value="Trastorno depresivo grave"><span>Dep. grave</span></label><label><input type="checkbox" value="TAG"><span>TAG</span></label><label><input type="checkbox" value="Trastorno de p√°nico"><span>P√°nico</span></label><label><input type="checkbox" value="TEPT"><span>TEPT</span></label><label><input type="checkbox" value="TOC"><span>TOC</span></label></div></div>
            <div class="form-group"><label>CIE-11</label><input type="text" id="an-cie"></div>
            <div class="form-group full"><label>Observaciones</label><textarea id="an-dx-obs"></textarea></div>
            <div class="form-group full"><label>Plan terap√©utico</label><div class="checkgroup" id="an-enfoque"><label><input type="checkbox" value="TCC"><span>TCC</span></label><label><input type="checkbox" value="Terapia de apoyo"><span>Apoyo</span></label><label><input type="checkbox" value="Psicoeducaci√≥n"><span>Psicoeducaci√≥n</span></label><label><input type="checkbox" value="Relajaci√≥n"><span>Relajaci√≥n</span></label></div></div>
            <div class="form-group full"><label>Remisiones</label><div class="checkgroup" id="an-remisiones"><label><input type="checkbox" value="Ninguna"><span>Ninguna</span></label><label><input type="checkbox" value="Psiquiatr√≠a"><span>Psiquiatr√≠a</span></label><label><input type="checkbox" value="Trabajo social"><span>Trabajo social</span></label></div></div>
            <div class="form-group"><label>Pr√≥xima cita</label><input type="date" id="an-proxcita"></div>
          </div></div>
        </div>
        <div class="anamnesis-section">
          <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>üìÑ</span><h4>Nota cl√≠nica generada</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
          <div class="anamnesis-section-body open">
            <div id="nota-output" class="nota-output">Completa los campos y presiona "Generar nota cl√≠nica"‚Ä¶</div>
            <div class="flex gap-2 mt-4" style="flex-wrap:wrap">
              <button type="button" class="btn btn-primary" onclick="generarNota()">‚ú® Generar nota</button>
              <button type="button" class="btn btn-secondary" onclick="copiarNota()">Copiar</button>
              <button type="button" class="btn btn-primary" onclick="guardarAnamnesis()" style="margin-left:auto">üíæ Guardar en Firebase</button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- TESTS -->
    <div id="page-tests" class="page">
      <!-- Selector de paciente SIEMPRE visible -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <label style="font-size:0.78rem;font-weight:600;color:var(--text2);flex-shrink:0">üë§ Paciente para este test</label>
        <select id="test-pac-sel" onchange="selectTestPaciente(this.value)" style="flex:1;min-width:200px;padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem">
          <option value="">‚Äî Seleccionar paciente ‚Äî</option>
        </select>
        <input type="text" id="test-pac-nombre" placeholder="O escribe nombre manualmente" style="flex:1;min-width:160px;padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem">
        <input type="number" id="test-pac-edad" placeholder="Edad" min="0" max="120" style="width:80px;padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem">
        <select id="test-pac-esc" onchange="updateEscolaridad(this.value)" style="padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem">
          <option value="0">Sin escolaridad</option>
          <option value="1">Primaria incompleta</option>
          <option value="2">Primaria completa</option>
          <option value="3">Bachillerato</option>
          <option value="4">T√©cnico/Tecn√≥logo</option>
          <option value="5" selected>Universidad o m√°s</option>
        </select>
      </div>
      <!-- Panel de tests -->
      <div id="tests-home" class="test-screen active">
        <div class="assisted-bar">
          <label><input type="checkbox" class="toggle-cb" id="assisted-mode-toggle" onchange="toggleAssisted(this.checked)"><span class="toggle"></span><span>üî§ <strong>Modo lectura asistida</strong> ‚Äî Texto grande + pictogramas para baja escolaridad</span></label>
        </div>
        <div class="test-section-label">Cognitivo</div>
        <div class="tests-grid">
          <div class="test-card" onclick="showTest('mmse')"><div class="tc-icon">üß†</div><h4>MMSE</h4><p>Tamizaje cognitivo general. Ajustado por escolaridad.</p><div class="tc-meta"><span class="tc-tag">‚è± 7‚Äì10 min</span><span class="tc-tag">30 pts</span><span class="tc-tag">‚ö† Ajuste escolaridad</span></div></div>
          <div class="test-card" onclick="showTest('moca')"><div class="tc-icon">üß©</div><h4>MoCA</h4><p>M√°s sensible para deterioro leve y funci√≥n ejecutiva.</p><div class="tc-meta"><span class="tc-tag">‚è± 10 min</span><span class="tc-tag">30 pts</span><span class="tc-tag">+1pt ‚â§bachillerato</span></div></div>
          <div class="test-card" onclick="showTest('cam')"><div class="tc-icon">üåÄ</div><h4>CAM</h4><p>Delirium en hospitalizaci√≥n. Algoritmo de 4 criterios.</p><div class="tc-meta"><span class="tc-tag">‚è± 3‚Äì5 min</span><span class="tc-tag">4 criterios</span></div></div>
        </div>
        <div class="test-section-label">√Ånimo</div>
        <div class="tests-grid">
          <div class="test-card" onclick="showTest('phq9')"><div class="tc-icon">üíô</div><h4>PHQ-9</h4><p>Depresi√≥n + ideaci√≥n suicida.</p><div class="tc-meta"><span class="tc-tag">‚è± 3‚Äì5 min</span><span class="tc-tag">27 pts</span></div></div>
          <div class="test-card" onclick="showTest('gad7')"><div class="tc-icon">‚ö°</div><h4>GAD-7</h4><p>Ansiedad generalizada.</p><div class="tc-meta"><span class="tc-tag">‚è± 3 min</span><span class="tc-tag">21 pts</span></div></div>
          <div class="test-card" onclick="showTest('hads')"><div class="tc-icon">üè•</div><h4>HADS</h4><p>Ansiedad y depresi√≥n sin √≠tems som√°ticos. Hospitalizaci√≥n.</p><div class="tc-meta"><span class="tc-tag">‚è± 5‚Äì7 min</span><span class="tc-tag">42 pts</span></div></div>
        </div>
        <div class="test-section-label">Riesgo & Adherencia</div>
        <div class="tests-grid">
          <div class="test-card" onclick="showTest('cssrs')"><div class="tc-icon">üî¥</div><h4>C-SSRS</h4><p>Riesgo suicida. Protocolo Columbia.</p><div class="tc-meta"><span class="tc-tag">‚è± 5 min</span><span class="tc-tag">Alta sensibilidad</span></div></div>
          <div class="test-card" onclick="showTest('mmas4')"><div class="tc-icon">üíä</div><h4>MMAS-4</h4><p>Adherencia al tratamiento farmacol√≥gico.</p><div class="tc-meta"><span class="tc-tag">‚è± 2 min</span><span class="tc-tag">4 preguntas</span></div></div>
          <div class="test-card" onclick="showTest('duelo')"><div class="tc-icon">üïäÔ∏è</div><h4>Duelo</h4><p>Adaptado al contexto colombiano vulnerable.</p><div class="tc-meta"><span class="tc-tag">‚è± 5 min</span><span class="tc-tag">5 preguntas</span></div></div>
        </div>
        <div style="background:var(--warning-light);border:1px solid #f0d080;border-radius:var(--radius);padding:14px 18px;margin-top:20px;font-size:0.8rem;color:#5a4000;line-height:1.6">
          üí° <strong>Adaptaciones para poblaci√≥n vulnerable colombiana</strong> ‚Äî Todos los tests usan lenguaje sencillo y cercano. Active el modo lectura asistida para texto grande. Los puntos de corte del MMSE y MoCA se ajustan autom√°ticamente seg√∫n la escolaridad.
        </div>
      </div>

      <!-- PHQ-9 -->
      <div id="test-phq9" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üíô</div>
          <div><h2>PHQ-9 ‚Äî Preguntas sobre el √°nimo</h2><p>¬øCu√°nto le han molestado estas cosas en las √∫ltimas 2 semanas? ¬∑ 0‚Äì27 pts ¬∑ 3‚Äì5 min</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">üìå <strong>Para la psic√≥loga:</strong> Leer cada pregunta en voz alta con calma. Si el paciente no entiende, use el ejemplo entre par√©ntesis.</div>
        <div id="phq9-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcPHQ9()">Ver resultado ‚Üí</button></div>
        <div id="phq9-result" style="display:none"></div>
      </div>

      <!-- GAD-7 -->
      <div id="test-gad7" class="test-screen">
        <div class="test-header">
          <div class="th-icon">‚ö°</div>
          <div><h2>GAD-7 ‚Äî Preguntas sobre los nervios</h2><p>¬øCu√°nto le han molestado estas cosas en las √∫ltimas 2 semanas? ¬∑ 0‚Äì21 pts ¬∑ 3 min</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">üìå <strong>Para la psic√≥loga:</strong> Si el paciente pregunta qu√© es "preocuparse demasiado", use ejemplos del contexto: la familia, la plata, la salud.</div>
        <div id="gad7-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcGAD7()">Ver resultado ‚Üí</button></div>
        <div id="gad7-result" style="display:none"></div>
      </div>

      <!-- HADS -->
      <div id="test-hads" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üè•</div>
          <div><h2>HADS ‚Äî C√≥mo se ha sentido esta semana</h2><p>Ansiedad y depresi√≥n sin √≠tems som√°ticos ¬∑ 5‚Äì7 min</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">üìå <strong>Para la psic√≥loga:</strong> Preguntar: <em>"¬øC√≥mo se ha sentido durante esta semana que est√° aqu√≠?"</em> No pregunta por s√≠ntomas f√≠sicos ‚Äî ideal para hospitalizados.</div>
        <div id="hads-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcHADS()">Ver resultado ‚Üí</button></div>
        <div id="hads-result" style="display:none"></div>
      </div>

      <!-- MMSE -->
      <div id="test-mmse" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üß†</div>
          <div><h2>MMSE ‚Äî Evaluaci√≥n de la memoria y el pensamiento</h2><p>Administrar verbalmente ¬∑ 0‚Äì30 pts ¬∑ 7‚Äì10 min ¬∑ ‚ö† Ajuste por escolaridad</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">‚ö† <strong>Nota cl√≠nica Colombia:</strong> En pacientes sin escolaridad o analfabetos, tolerar 3‚Äì4 pts menos. No penalizar por √≠tems de escritura/lectura si nunca aprendieron. Para orientaci√≥n usar referencias locales (municipio, vereda, barrio).</div>
        <div id="mmse-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcMMSE()">Ver resultado ‚Üí</button></div>
        <div id="mmse-result" style="display:none"></div>
      </div>

      <!-- MoCA -->
      <div id="test-moca" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üß©</div>
          <div><h2>MoCA ‚Äî Evaluaci√≥n cognitiva completa</h2><p>M√°s sensible para deterioro leve y funci√≥n ejecutiva ¬∑ 0‚Äì30 pts ¬∑ 10 min</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">‚ö† <strong>Nota cl√≠nica Colombia:</strong> En analfabetos, omitir √≠tems de escritura y ajustar interpretaci√≥n. Correcci√≥n autom√°tica de +1 pt si escolaridad ‚â§ bachillerato.</div>
        <div id="moca-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcMoCA()">Ver resultado ‚Üí</button></div>
        <div id="moca-result" style="display:none"></div>
      </div>

      <!-- CAM -->
      <div id="test-cam" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üåÄ</div>
          <div><h2>CAM ‚Äî ¬øHay confusi√≥n mental?</h2><p>Diagn√≥stico de delirium ¬∑ 4 criterios ¬∑ 3‚Äì5 min</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">üìå <strong>Algoritmo CAM:</strong> Delirium = C1 (inicio agudo + fluctuante) <strong>Y</strong> C2 (inatenci√≥n) <strong>Y</strong> (C3 √≥ C4)</div>
        <div id="cam-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcCAM()">Evaluar ‚Üí</button></div>
        <div id="cam-result" style="display:none"></div>
      </div>

      <!-- C-SSRS -->
      <div id="test-cssrs" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üî¥</div>
          <div><h2>C-SSRS ‚Äî Pensamientos de hacerse da√±o</h2><p>Versi√≥n corta de tamizaje ¬∑ Protocolo Columbia ¬∑ 5 min</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">‚ö† <strong>Importante:</strong> Preguntar con calma, sin prisa y con empat√≠a. En contexto colombiano: desplazamiento, p√©rdida por violencia y pobreza son factores adicionales. Positivo en √≠tems 4‚Äì5 requiere evaluaci√≥n inmediata.</div>
        <div id="cssrs-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcCSSRS()">Evaluar riesgo ‚Üí</button></div>
        <div id="cssrs-result" style="display:none"></div>
      </div>

      <!-- MMAS-4 -->
      <div id="test-mmas4" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üíä</div>
          <div><h2>MMAS-4 ‚Äî ¬øEst√° tomando bien sus pastillas?</h2><p>4 preguntas sobre adherencia al tratamiento ¬∑ 2 min</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">üìå <strong>Para la psic√≥loga:</strong> Preguntar en relaci√≥n al tratamiento actual. En pacientes vulnerables, explorar barreras: costo, acceso a farmacia, red de apoyo.</div>
        <div id="mmas4-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcMMAS4()">Ver resultado ‚Üí</button></div>
        <div id="mmas4-result" style="display:none"></div>
      </div>

      <!-- DUELO -->
      <div id="test-duelo" class="test-screen">
        <div class="test-header">
          <div class="th-icon">üïäÔ∏è</div>
          <div><h2>Duelo ‚Äî ¬øC√≥mo lleva la p√©rdida?</h2><p>Adaptado para poblaci√≥n colombiana vulnerable ¬∑ 5 min ¬∑ 0‚Äì10 pts</p></div>
          <button class="btn btn-secondary" onclick="showTest('home')">‚Üê Volver</button>
        </div>
        <div class="clinician-note">üìå <strong>Contexto:</strong> Aplicar ante p√©rdida reciente (persona querida, funci√≥n corporal, hogar, desplazamiento forzado). Validar con: <em>"Entiendo que ha sido muy dif√≠cil para usted‚Ä¶"</em></div>
        <div id="duelo-questions"></div>
        <div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="calcDuelo()">Ver resultado ‚Üí</button></div>
        <div id="duelo-result" style="display:none"></div>
      </div>
    </div>

    <!-- CAPACIDAD DECISIONAL -->
    <div id="page-capacidad" class="page">
      <div class="section-header">
        <h2>‚öñÔ∏è Valoraci√≥n de Capacidad Decisional</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <select id="cap-pac-sel" onchange="selectCapPaciente(this.value)" style="padding:7px 11px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.85rem;min-width:200px">
            <option value="">‚Äî Seleccionar paciente ‚Äî</option>
          </select>
          <button class="btn btn-secondary btn-sm" onclick="limpiarCapacidad()">Nueva</button>
        </div>
      </div>

      <div style="background:var(--warning-light);border:1px solid #f0d080;border-radius:var(--radius);padding:13px 18px;margin-bottom:18px;font-size:0.82rem;color:#5a4000;line-height:1.6">
        ‚öñÔ∏è <strong>Criterio legal y cl√≠nico (Colombia):</strong> La capacidad decisional no es global ni permanente ‚Äî es espec√≠fica para cada decisi√≥n y momento cl√≠nico. Se eval√∫an 4 criterios: Comprensi√≥n, Apreciaci√≥n, Razonamiento y Expresi√≥n de una decisi√≥n. Todos deben estar presentes para determinar capacidad conservada.
      </div>

      <!-- Datos del paciente -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>ü™™</span><h4>Datos de identificaci√≥n</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body open"><div class="form-grid">
          <div class="form-group"><label>Fecha de valoraci√≥n</label><input type="date" id="cap-fecha"></div>
          <div class="form-group"><label>Nombre del paciente</label><input type="text" id="cap-nombre"></div>
          <div class="form-group"><label>Edad / Sexo</label><input type="text" id="cap-edad" placeholder="Ej: 54 a√±os, F"></div>
          <div class="form-group"><label>Habitaci√≥n</label><input type="text" id="cap-hab" placeholder="Ej: 304B"></div>
          <div class="form-group full"><label>Diagn√≥stico m√©dico / Situaci√≥n cl√≠nica</label><input type="text" id="cap-dx" placeholder="Ej: Ca. g√°strico estadio IV, decisi√≥n sobre quimioterapia paliativa"></div>
          <div class="form-group full"><label>Decisi√≥n espec√≠fica a evaluar</label><textarea id="cap-decision" rows="2" placeholder="Ej: El paciente desea rechazar la quimioterapia propuesta por oncolog√≠a..."></textarea></div>
          <div class="form-group full"><label>Solicitado por</label><input type="text" id="cap-solicitante" placeholder="Ej: Dr. P√©rez, Medicina Interna"></div>
        </div></div>
      </div>

      <!-- Criterio 1: Comprensi√≥n -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>1Ô∏è‚É£</span><h4>Comprensi√≥n ‚Äî ¬øEntiende la informaci√≥n?</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body open">
          <div style="background:var(--surface2);border-radius:8px;padding:10px 14px;font-size:0.8rem;color:var(--text2);margin-bottom:12px">
            üìå <strong>Preguntar:</strong> "¬øPuede contarme con sus propias palabras qu√© le dijeron los m√©dicos sobre su situaci√≥n?" / "¬øQu√© entiende que va a pasar si acepta/rechaza este tratamiento?"
          </div>
          <div class="form-grid">
            <div class="form-group full"><label>Resultado</label>
              <div class="risk-selector">
                <div class="risk-btn" style="color:var(--success);flex:1" onclick="setCapCriterio('cap-c1','CONSERVADA',this)">‚úÖ CONSERVADA</div>
                <div class="risk-btn" style="color:var(--warning);flex:1" onclick="setCapCriterio('cap-c1','PARCIAL',this)">‚ö†Ô∏è PARCIAL</div>
                <div class="risk-btn" style="color:var(--danger);flex:1" onclick="setCapCriterio('cap-c1','AUSENTE',this)">‚ùå AUSENTE</div>
              </div>
              <input type="hidden" id="cap-c1" value="">
            </div>
            <div class="form-group full"><label>Observaciones</label><textarea id="cap-c1-obs" rows="2" placeholder="Describir qu√© pudo repetir el paciente, errores de comprensi√≥n, factores que la afectan..."></textarea></div>
          </div>
        </div>
      </div>

      <!-- Criterio 2: Apreciaci√≥n -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>2Ô∏è‚É£</span><h4>Apreciaci√≥n ‚Äî ¬øAplica la informaci√≥n a su caso?</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body open">
          <div style="background:var(--surface2);border-radius:8px;padding:10px 14px;font-size:0.8rem;color:var(--text2);margin-bottom:12px">
            üìå <strong>Preguntar:</strong> "¬øCree que esta enfermedad le est√° afectando a usted?" / "¬øQu√© cree que pasar√° con su salud si toma esta decisi√≥n?"
          </div>
          <div class="form-grid">
            <div class="form-group full"><label>Resultado</label>
              <div class="risk-selector">
                <div class="risk-btn" style="color:var(--success);flex:1" onclick="setCapCriterio('cap-c2','CONSERVADA',this)">‚úÖ CONSERVADA</div>
                <div class="risk-btn" style="color:var(--warning);flex:1" onclick="setCapCriterio('cap-c2','PARCIAL',this)">‚ö†Ô∏è PARCIAL</div>
                <div class="risk-btn" style="color:var(--danger);flex:1" onclick="setCapCriterio('cap-c2','AUSENTE',this)">‚ùå AUSENTE</div>
              </div>
              <input type="hidden" id="cap-c2" value="">
            </div>
            <div class="form-group full"><label>Observaciones</label><textarea id="cap-c2-obs" rows="2" placeholder="¬øReconoce que est√° enfermo? ¬øNiega su situaci√≥n? ¬øAtribuye s√≠ntomas a causas externas?..."></textarea></div>
          </div>
        </div>
      </div>

      <!-- Criterio 3: Razonamiento -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>3Ô∏è‚É£</span><h4>Razonamiento ‚Äî ¬øPuede comparar opciones?</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body open">
          <div style="background:var(--surface2);border-radius:8px;padding:10px 14px;font-size:0.8rem;color:var(--text2);margin-bottom:12px">
            üìå <strong>Preguntar:</strong> "¬øPor qu√© prefiere esta opci√≥n sobre las otras?" / "¬øQu√© factores tuvo en cuenta para tomar esta decisi√≥n?" / "¬øQu√© le preocupa m√°s de cada opci√≥n?"
          </div>
          <div class="form-grid">
            <div class="form-group full"><label>Resultado</label>
              <div class="risk-selector">
                <div class="risk-btn" style="color:var(--success);flex:1" onclick="setCapCriterio('cap-c3','CONSERVADA',this)">‚úÖ CONSERVADA</div>
                <div class="risk-btn" style="color:var(--warning);flex:1" onclick="setCapCriterio('cap-c3','PARCIAL',this)">‚ö†Ô∏è PARCIAL</div>
                <div class="risk-btn" style="color:var(--danger);flex:1" onclick="setCapCriterio('cap-c3','AUSENTE',this)">‚ùå AUSENTE</div>
              </div>
              <input type="hidden" id="cap-c3" value="">
            </div>
            <div class="form-group full"><label>Observaciones</label><textarea id="cap-c3-obs" rows="2" placeholder="¬øPuede sopesar riesgos y beneficios? ¬øEl razonamiento es l√≥gico y consistente?..."></textarea></div>
          </div>
        </div>
      </div>

      <!-- Criterio 4: Expresi√≥n -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>4Ô∏è‚É£</span><h4>Expresi√≥n ‚Äî ¬øComunica una decisi√≥n estable?</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body open">
          <div style="background:var(--surface2);border-radius:8px;padding:10px 14px;font-size:0.8rem;color:var(--text2);margin-bottom:12px">
            üìå <strong>Evaluar:</strong> Consistencia de la decisi√≥n en el tiempo. Si cambia con cada pregunta o cada interlocutor, puede indicar incapacidad.
          </div>
          <div class="form-grid">
            <div class="form-group full"><label>Resultado</label>
              <div class="risk-selector">
                <div class="risk-btn" style="color:var(--success);flex:1" onclick="setCapCriterio('cap-c4','CONSERVADA',this)">‚úÖ CONSERVADA</div>
                <div class="risk-btn" style="color:var(--warning);flex:1" onclick="setCapCriterio('cap-c4','PARCIAL',this)">‚ö†Ô∏è PARCIAL</div>
                <div class="risk-btn" style="color:var(--danger);flex:1" onclick="setCapCriterio('cap-c4','AUSENTE',this)">‚ùå AUSENTE</div>
              </div>
              <input type="hidden" id="cap-c4" value="">
            </div>
            <div class="form-group full"><label>Observaciones</label><textarea id="cap-c4-obs" rows="2" placeholder="¬øLa decisi√≥n es estable? ¬øCambia bajo presi√≥n? ¬øEs coherente con sus valores previos?..."></textarea></div>
          </div>
        </div>
      </div>

      <!-- Factores que afectan -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header" onclick="toggleSection(this)"><span>üß©</span><h4>Factores que afectan la capacidad</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body"><div class="form-grid">
          <div class="form-group full"><label>Factores identificados</label>
            <div class="checkgroup" id="cap-factores">
              <label><input type="checkbox" value="Delirium activo"><span>Delirium activo</span></label>
              <label><input type="checkbox" value="Deterioro cognitivo"><span>Deterioro cognitivo</span></label>
              <label><input type="checkbox" value="Trastorno depresivo mayor"><span>Depresi√≥n mayor</span></label>
              <label><input type="checkbox" value="Psicosis activa"><span>Psicosis activa</span></label>
              <label><input type="checkbox" value="Ansiedad severa"><span>Ansiedad severa</span></label>
              <label><input type="checkbox" value="Dolor no controlado"><span>Dolor no controlado</span></label>
              <label><input type="checkbox" value="Sedaci√≥n por medicamentos"><span>Sedaci√≥n por medicamentos</span></label>
              <label><input type="checkbox" value="Presi√≥n familiar"><span>Presi√≥n familiar</span></label>
              <label><input type="checkbox" value="Barrera idiom√°tica"><span>Barrera idiom√°tica</span></label>
              <label><input type="checkbox" value="Bajo nivel educativo"><span>Bajo nivel educativo</span></label>
              <label><input type="checkbox" value="Ninguno identificado"><span>Ninguno identificado</span></label>
            </div>
          </div>
          <div class="form-group full"><label>Observaciones adicionales</label><textarea id="cap-factores-obs" rows="2"></textarea></div>
        </div></div>
      </div>

      <!-- Conclusi√≥n -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>‚öñÔ∏è</span><h4>Conclusi√≥n y recomendaciones</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body open"><div class="form-grid">
          <div class="form-group full"><label>Conclusi√≥n de capacidad decisional</label>
            <div class="risk-selector">
              <div class="risk-btn" style="color:var(--success);flex:1" onclick="setCapConclusion('CONSERVADA',this)">‚úÖ CAPACIDAD CONSERVADA</div>
              <div class="risk-btn" style="color:var(--warning);flex:1" onclick="setCapConclusion('DISMINUIDA',this)">‚ö†Ô∏è CAPACIDAD DISMINUIDA</div>
              <div class="risk-btn" style="color:var(--danger);flex:1" onclick="setCapConclusion('AUSENTE',this)">‚ùå CAPACIDAD AUSENTE</div>
            </div>
            <input type="hidden" id="cap-conclusion" value="">
          </div>
          <div class="form-group full"><label>Recomendaciones al equipo m√©dico</label>
            <div class="checkgroup" id="cap-recom">
              <label><input type="checkbox" value="Respetar la decisi√≥n del paciente"><span>Respetar decisi√≥n del paciente</span></label>
              <label><input type="checkbox" value="Reevaluar capacidad una vez resuelto el factor causal"><span>Reevaluar tras resolver factor causal</span></label>
              <label><input type="checkbox" value="Involucrar a la familia como red de apoyo"><span>Involucrar familia como apoyo</span></label>
              <label><input type="checkbox" value="Activar representante legal o familiar sustituto"><span>Activar representante legal/familiar</span></label>
              <label><input type="checkbox" value="Solicitar interconsulta a psiquiatr√≠a"><span>Interconsulta a psiquiatr√≠a</span></label>
              <label><input type="checkbox" value="Documentar decisi√≥n del paciente en historia cl√≠nica"><span>Documentar en historia cl√≠nica</span></label>
              <label><input type="checkbox" value="Considerar intervenci√≥n de trabajo social"><span>Trabajo social</span></label>
            </div>
          </div>
          <div class="form-group full"><label>Notas cl√≠nicas adicionales</label><textarea id="cap-notas" rows="3" placeholder="Observaciones relevantes para el equipo tratante..."></textarea></div>
        </div></div>
      </div>

      <!-- Nota generada -->
      <div class="anamnesis-section">
        <div class="anamnesis-section-header open" onclick="toggleSection(this)"><span>üìÑ</span><h4>Nota cl√≠nica generada</h4><svg class="chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg></div>
        <div class="anamnesis-section-body open">
          <div id="cap-nota-output" class="nota-output">Completa los campos y presiona "Generar nota"‚Ä¶</div>
          <div class="flex gap-2 mt-4" style="flex-wrap:wrap">
            <button class="btn btn-primary" onclick="generarNotaCapacidad()">‚ú® Generar nota</button>
            <button class="btn btn-secondary" onclick="copiarNotaCapacidad()">Copiar</button>
            <button class="btn btn-primary" onclick="guardarCapacidadFirebase()" style="margin-left:auto">üíæ Guardar en Firebase</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORIAL TESTS -->
    <div id="page-historial" class="page">
      <div class="section-header"><h2>Historial de Tests</h2><button class="btn btn-danger btn-sm" onclick="clearTestHistory()">üóë Borrar todo</button></div>
      <div id="historial-list"><div class="loading"><div class="spinner"></div><br>Cargando‚Ä¶</div></div>
    </div>

  </div>
</div>

<!-- MODAL PACIENTE -->
<div class="modal-overlay" id="modal-paciente">
  <div class="modal">
    <div class="modal-header"><h3>Nuevo Paciente</h3><button class="modal-close" onclick="closeModal('modal-paciente')"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
    <div class="modal-body"><div class="form-grid">
      <div class="form-group full"><label>Nombre completo *</label><input type="text" id="p-nombre" placeholder="Apellidos, Nombres"></div>
      <div class="form-group"><label>C√©dula *</label><input type="text" id="p-cedula"></div>
      <div class="form-group"><label>Edad</label><input type="number" id="p-edad" min="0" max="120"></div>
      <div class="form-group"><label>Sexo</label><select id="p-sexo"><option value="">Seleccionar...</option><option>Femenino</option><option>Masculino</option><option>No binario</option></select></div>
      <div class="form-group"><label>Fecha de ingreso</label><input type="date" id="p-fecha"></div>
      <div class="form-group"><label>Habitaci√≥n</label><input type="text" id="p-hab" placeholder="Ej: 304B"></div>
      <div class="form-group full"><label>Diagn√≥stico m√©dico / Motivo de interconsulta</label><textarea id="p-motivo" rows="2" placeholder="Ej: Ca. de mama, impacto emocional dx reciente"></textarea></div>
      <div class="form-group full"><label>Impresi√≥n diagn√≥stica psicol√≥gica</label><textarea id="p-dxpsi" rows="2" placeholder="Ej: Trastorno adaptativo con sintomatolog√≠a ansiosa"></textarea></div>
      <div class="form-group full"><label>Riesgo suicida</label>
        <div class="risk-selector" style="margin-top:4px">
          <div class="risk-btn" style="color:var(--text2)" onclick="setPRisk('SIN RIESGO',this)">SIN RIESGO</div>
          <div class="risk-btn low" onclick="setPRisk('BAJO',this)">BAJO</div>
          <div class="risk-btn med" onclick="setPRisk('MEDIO',this)">MEDIO</div>
          <div class="risk-btn high" onclick="setPRisk('ALTO',this)">ALTO</div>
        </div>
        <input type="hidden" id="p-riesgo" value="">
      </div>
      <div class="form-group full"><label>Observaciones de riesgo</label><textarea id="p-riesgo-obs" rows="2" placeholder="Ideaci√≥n, plan, factores protectores..."></textarea></div>
      <div class="form-group full"><label>Estado actual</label>
        <select id="p-estado"><option value="seguimiento">Seguimiento</option><option value="nueva-interconsulta-pendiente">Nueva interconsulta pendiente</option><option value="alta">Alta</option><option value="revaloracion">Revaluaci√≥n</option></select>
      </div>
      <div class="form-group"><label>Pr√≥xima sesi√≥n</label><input type="date" id="p-proxsesion"></div>
      <div class="form-group full"><label>Notas generales del caso</label><textarea id="p-notas" rows="3" placeholder="Observaciones, evoluci√≥n general, consideraciones cl√≠nicas..."></textarea></div>
    </div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-paciente')">Cancelar</button><button class="btn btn-primary" onclick="guardarPaciente()">Registrar</button></div>
  </div>
</div>

<!-- MODAL IC -->
<div class="modal-overlay" id="modal-ic">
  <div class="modal">
    <div class="modal-header"><h3>Nueva Interconsulta</h3><button class="modal-close" onclick="closeModal('modal-ic')"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
    <div class="modal-body"><div class="form-grid">
      <div class="form-group full"><label>Paciente *</label><select id="ic-paciente"><option value="">‚Äî Seleccionar ‚Äî</option></select></div>
      <div class="form-group"><label>Especialidad *</label><select id="ic-especialidad"><option value="">Seleccionar...</option><option>Psiquiatr√≠a</option><option>Neurolog√≠a</option><option>Medicina interna</option><option>Trabajo social</option><option>Nutrici√≥n</option><option>Fisioterapia</option><option>Otra</option></select></div>
      <div class="form-group"><label>Prioridad</label><select id="ic-prioridad"><option value="normal">Normal</option><option value="urgente">Urgente</option><option value="electiva">Electiva</option></select></div>
      <div class="form-group full"><label>Motivo *</label><textarea id="ic-motivo" rows="3"></textarea></div>
      <div class="form-group full"><label>Informaci√≥n cl√≠nica relevante</label><textarea id="ic-info" rows="2"></textarea></div>
      <div class="form-group"><label>Fecha</label><input type="date" id="ic-fecha"></div>
      <div class="form-group"><label>M√©dico solicitante</label><input type="text" id="ic-medico"></div>
    </div></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-ic')">Cancelar</button><button class="btn btn-primary" onclick="guardarIC()">Enviar</button></div>
  </div>
</div>

<div id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCsqumG_BRCWwnFEOcoNfLXtfaUlzvPqYE",
  authDomain:"seguimiento-pacientes-a842f.firebaseapp.com",
  projectId:"seguimiento-pacientes-a842f",
  storageBucket:"seguimiento-pacientes-a842f.firebasestorage.app",
  messagingSenderId:"641640192728",
  appId:"1:641640192728:web:14a1d4074e2a6fa6e3d5ad"
});
const db = getFirestore(app);
let pacientes=[],interconsultas=[],anamnesisList=[],testHistory=[];

function setSyncStatus(s){
  const dot=document.getElementById('sync-dot'),txt=document.getElementById('sync-status');
  dot.className='sync-dot'+(s==='online'?'':' '+s);
  txt.textContent=s==='online'?'Sincronizado':s==='syncing'?'Guardando‚Ä¶':'Sin conexi√≥n';
}

onSnapshot(query(collection(db,'pacientes'),orderBy('creado','desc')),snap=>{
  pacientes=snap.docs.map(d=>({id:d.id,...d.data()}));
  setSyncStatus('online');updateBadges();updateStats();populateAnamPacientes();populateICPacientes();
  if(document.getElementById('page-pacientes').classList.contains('active'))renderPacientes();
  if(document.getElementById('page-dashboard').classList.contains('active'))renderDashboard();
});
onSnapshot(query(collection(db,'interconsultas'),orderBy('creado','desc')),snap=>{
  interconsultas=snap.docs.map(d=>({id:d.id,...d.data()}));
  updateBadges();updateStats();
  if(document.getElementById('page-interconsultas').classList.contains('active'))renderIC();
  if(document.getElementById('page-dashboard').classList.contains('active'))renderDashboard();
});
onSnapshot(query(collection(db,'anamnesis'),orderBy('creado','desc')),snap=>{
  anamnesisList=snap.docs.map(d=>({id:d.id,...d.data()}));
  updateStats();
  if(document.getElementById('page-dashboard').classList.contains('active'))renderDashboard();
});
onSnapshot(query(collection(db,'test_resultados'),orderBy('creado','desc')),snap=>{
  testHistory=snap.docs.map(d=>({id:d.id,...d.data()}));
  updateStats();
  if(document.getElementById('page-historial').classList.contains('active'))renderHistorial();
  if(document.getElementById('page-dashboard').classList.contains('active'))renderDashboard();
});

window.guardarPaciente=async()=>{
  const nombre=document.getElementById('p-nombre').value.trim(),cedula=document.getElementById('p-cedula').value.trim();
  if(!nombre||!cedula)return toast('‚ö†Ô∏è Nombre y c√©dula son obligatorios');
  // Verificar duplicado
  const dup=pacientes.find(p=>p.cedula===cedula);
  if(dup){
    if(!confirm(`‚ö†Ô∏è PACIENTE YA REGISTRADO\n\nYa existe un paciente con la c√©dula ${cedula}:\n"${dup.nombre}"\n\n¬øDeseas editarlo en vez de crear uno nuevo?`))return;
    // Abrir edici√≥n del existente
    editarPaciente(dup.id);return;
  }
  const dupNombre=pacientes.find(p=>p.nombre.toLowerCase()===nombre.toLowerCase());
  if(dupNombre){
    if(!confirm(`‚ö†Ô∏è NOMBRE SIMILAR\n\nYa existe un paciente con nombre "${dupNombre.nombre}" (CC: ${dupNombre.cedula}).\n\n¬øConfirmas que es un paciente diferente y deseas continuar?`))return;
  }
  setSyncStatus('syncing');
  try{
    await addDoc(collection(db,'pacientes'),{
      nombre,cedula,
      edad:document.getElementById('p-edad').value,
      sexo:document.getElementById('p-sexo').value,
      fecha:document.getElementById('p-fecha').value,
      hab:document.getElementById('p-hab').value,
      motivo:document.getElementById('p-motivo').value,
      dxpsi:document.getElementById('p-dxpsi').value,
      riesgo:document.getElementById('p-riesgo').value,
      riesgoObs:document.getElementById('p-riesgo-obs').value,
      estado:document.getElementById('p-estado').value||'seguimiento',
      proxSesion:document.getElementById('p-proxsesion').value,
      notas:document.getElementById('p-notas').value,
      creado:serverTimestamp()
    });
    closeModal('modal-paciente');toast('‚úÖ Paciente registrado');
    ['p-nombre','p-cedula','p-edad','p-hab','p-motivo','p-dxpsi','p-riesgo-obs','p-notas','p-proxsesion'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('p-riesgo').value='';
    document.querySelectorAll('#modal-paciente .risk-btn').forEach(b=>b.classList.remove('sel'));
  }
  catch(e){setSyncStatus('offline');toast('‚ùå Error: '+e.message);}
};

window.renderPacientes=(lista)=>{
  const data=lista!==undefined?lista:pacientes;
  const tbody=document.getElementById('tabla-pacientes');
  if(!tbody)return;

  // Leer b√∫squeda: input local de la p√°gina > topbar > variable global
  const localEl=document.getElementById('pac-search-local');
  const topbarEl=document.getElementById('global-search');
  const raw=((localEl&&localEl.value.trim())||(topbarEl&&topbarEl.value.trim())||(window._searchQ||'')).trim();
  const q=raw.toLowerCase();

  const filtered=q
    ? data.filter(p=>{
        const cedula=String(p.cedula||'').replace(/\s/g,'');
        const busq=raw.replace(/\s/g,'');
        return (p.nombre||'').toLowerCase().includes(q)
          || cedula.includes(busq)
          || (p.hab||'').toLowerCase().includes(q)
          || (p.motivo||'').toLowerCase().includes(q)
          || (p.dxpsi||'').toLowerCase().includes(q);
      })
    : data;
  // Usar filtered (con b√∫squeda aplicada)
  if(!filtered.length){
    tbody.innerHTML=q
      ?`<tr><td colspan="8"><div class="empty"><p>üîç Sin resultados para "<strong>${q}</strong>"</p></div></td></tr>`
      :'<tr><td colspan="8"><div class="empty"><p>No hay pacientes registrados.</p></div></td></tr>';
    return;
  }
  const getPiso=(hab)=>{if(!hab)return'Sin piso';const u=hab.toUpperCase();if(u.includes('UCI')||u.includes('UTI')||u.includes('CUIDADOS INTENSIVOS'))return'üî¥ UCI';if(u.includes('URG'))return'üü° Urgencias';const m=hab.match(/^(\d)/);return m?'Piso '+m[1]:'Sin piso';};
  const grouped={};
  filtered.forEach(p=>{const piso=getPiso(p.hab);if(!grouped[piso])grouped[piso]=[];grouped[piso].push(p);});
  const pisoOrder=Object.keys(grouped).sort((a,b)=>{if(a.includes('UCI'))return-1;if(b.includes('UCI'))return 1;if(a.includes('Urgencias'))return-1;if(b.includes('Urgencias'))return 1;const na=parseInt(a.replace('Piso ','')),nb=parseInt(b.replace('Piso ',''));return isNaN(na)?1:isNaN(nb)?-1:na-nb;});
  const riskBadge=(r)=>{if(!r||r==='SIN RIESGO')return'<span class="badge badge-green">Sin riesgo</span>';if(r==='BAJO')return'<span class="badge badge-green">Bajo</span>';if(r==='MEDIO')return'<span class="badge badge-yellow">Medio</span>';if(r==='ALTO')return'<span class="badge badge-red">Alto</span>';return'<span class="badge badge-gray">‚Äî</span>';};
  const estadoBadge=(e)=>{const m={'seguimiento':'badge-blue','nueva-interconsulta-pendiente':'badge-yellow','alta':'badge-gray','revaloracion':'badge-purple','alta-revaloracion':'badge-gray'};return`<span class="badge ${m[e]||'badge-gray'}">${e==='seguimiento'?'Seguimiento':e==='nueva-interconsulta-pendiente'?'IC pendiente':e==='alta'?'Alta':e==='revaloracion'?'Revaluaci√≥n':'Alta/Revaluaci√≥n'}</span>`;};
  const hoyStr=new Date().toISOString().split('T')[0];
  const proxBadge=(p)=>{
    if(!p.proxSesion)return'<span style="color:var(--text3);font-size:12px">‚Äî</span>';
    const diff=Math.round((new Date(p.proxSesion)-new Date(hoyStr))/(1000*60*60*24));
    const label=formatDate(p.proxSesion);
    if(diff<0)  return`<div style="display:flex;flex-direction:column;gap:2px"><span style="background:#3d1515;color:#F87171;border-radius:6px;padding:3px 8px;font-size:11px;font-weight:700">‚ö† Vencida</span><span style="font-size:11px;color:#F87171">${label}</span></div>`;
    if(diff===0)return`<div style="display:flex;flex-direction:column;gap:2px"><span style="background:#3d3015;color:#FBBF24;border-radius:6px;padding:3px 8px;font-size:11px;font-weight:700">üìÖ HOY</span><span style="font-size:11px;color:#FBBF24">${label}</span></div>`;
    if(diff===1)return`<div style="display:flex;flex-direction:column;gap:2px"><span style="background:#0e2d3a;color:#38BDF8;border-radius:6px;padding:3px 8px;font-size:11px;font-weight:700">Ma√±ana</span><span style="font-size:11px;color:#38BDF8">${label}</span></div>`;
    if(diff<=7) return`<div style="display:flex;flex-direction:column;gap:2px"><span style="background:#0e2d3a;color:#38BDF8;border-radius:6px;padding:3px 8px;font-size:11px">En ${diff} d√≠as</span><span style="font-size:11px;color:#38BDF8">${label}</span></div>`;
    return`<span style="font-size:12px;color:var(--text2)">${label}</span>`;
  };
  let html=q?`<tr><td colspan="8" style="background:#1a3a2a;font-size:0.75rem;color:#34D399;padding:7px 14px;">üîç Mostrando ${filtered.length} resultado${filtered.length>1?'s':''} para "<strong>${q}</strong>" ‚Äî <a href="#" onclick="window._searchQ='';document.getElementById('global-search').value='';renderPacientes();return false;" style="color:#34D399">Limpiar</a></td></tr>`:'';
  pisoOrder.forEach(piso=>{
    if(!q)html+=`<tr><td colspan="8" style="background:var(--surface2);font-size:0.72rem;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.06em;padding:7px 14px;">üè¢ ${piso}</td></tr>`;
    html+=grouped[piso].map(p=>`<tr><td><strong>${p.nombre}</strong><div class="td-sub">${p.hab?'Hab. '+p.hab:''} ${p.fecha?'¬∑ '+formatDate(p.fecha):''}</div></td><td>${p.cedula}</td><td>${p.edad?p.edad+' a.':''} ${p.sexo?p.sexo.charAt(0):''}</td><td>${p.motivo?p.motivo.slice(0,40)+(p.motivo.length>40?'‚Ä¶':''):'‚Äî'}</td><td>${riskBadge(p.riesgo)}</td><td>${estadoBadge(p.estado)}</td><td>${proxBadge(p)}</td><td><div style="display:flex;gap:5px;flex-wrap:wrap"><button class="btn btn-sm btn-secondary" onclick="nuevaAnamnesisParaPaciente('${p.id}')">üìã</button><button class="btn btn-sm btn-secondary" onclick="abrirICParaPaciente('${p.id}')">üí¨ IC</button><button class="btn btn-sm btn-secondary" onclick="irTestsPaciente('${p.id}')">üß™</button><button class="btn btn-sm btn-secondary" onclick="mhicAbrir('${p.id}')">üìÇ</button><button class="btn btn-sm btn-secondary" onclick="editarPaciente('${p.id}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="eliminarPaciente('${p.id}')">‚úï</button></div></td></tr>`).join('');
  });
  tbody.innerHTML=html;
};

window.eliminarPaciente=async(id)=>{if(!confirm('¬øEliminar este paciente?'))return;try{await deleteDoc(doc(db,'pacientes',id));toast('üóëÔ∏è Paciente eliminado');}catch(e){toast('‚ùå '+e.message);}};

window.populateICPacientes=()=>{
  const sel=document.getElementById('ic-paciente');
  if(sel)sel.innerHTML='<option value="">‚Äî Seleccionar paciente ‚Äî</option>'+pacientes.map(p=>`<option value="${p.id}">${p.nombre} (${p.cedula})</option>`).join('');
  const sel2=document.getElementById('ic-paciente-sel');
  if(sel2)sel2.innerHTML='<option value="">‚Äî Seleccionar paciente (opcional, o llenar manualmente) ‚Äî</option>'+pacientes.map(p=>`<option value="${p.id}">${p.nombre}${p.hab?' ‚Äî Hab. '+p.hab:''} (${p.cedula})</option>`).join('');
  const sel3=document.getElementById('test-pac-sel');
  if(sel3)sel3.innerHTML='<option value="">‚Äî Seleccionar o llenar manualmente ‚Äî</option>'+pacientes.map(p=>`<option value="${p.id}">${p.nombre}${p.hab?' ‚Äî Hab. '+p.hab:''} (${p.cedula})</option>`).join('');
  const sel4=document.getElementById('cap-pac-sel');
  if(sel4)sel4.innerHTML='<option value="">‚Äî Seleccionar paciente ‚Äî</option>'+pacientes.map(p=>`<option value="${p.id}">${p.nombre}${p.hab?' ‚Äî Hab. '+p.hab:''}</option>`).join('');
};

window.selectCapPaciente=(id)=>{
  if(!id)return;
  const p=pacientes.find(x=>x.id===id);
  if(!p)return;
  const set=(eid,v)=>{const el=document.getElementById(eid);if(el)el.value=v||'';};
  set('cap-nombre',p.nombre);
  set('cap-edad',(p.edad?p.edad+' a√±os':'')+(p.sexo?' ¬∑ '+p.sexo:''));
  set('cap-hab',p.hab);
  set('cap-dx',p.motivo);
  window._capPacienteId=p.id;
};

window.setCapCriterio=(id,valor,btn)=>{
  document.getElementById(id).value=valor;
  const parent=btn.parentElement;
  parent.querySelectorAll('.risk-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  if(valor==='CONSERVADA')btn.style.background='var(--success-light)',btn.style.borderColor='var(--success)';
  else if(valor==='PARCIAL')btn.style.background='var(--warning-light)',btn.style.borderColor='var(--warning)';
  else btn.style.background='var(--danger-light)',btn.style.borderColor='var(--danger)';
};

window.setCapConclusion=(valor,btn)=>{
  document.getElementById('cap-conclusion').value=valor;
  btn.parentElement.querySelectorAll('.risk-btn').forEach(b=>{b.style.background='';b.style.borderColor='';b.style.fontWeight='';});
  btn.style.fontWeight='800';
  if(valor==='CONSERVADA')btn.style.background='var(--success-light)',btn.style.borderColor='var(--success)';
  else if(valor==='DISMINUIDA')btn.style.background='var(--warning-light)',btn.style.borderColor='var(--warning)';
  else btn.style.background='var(--danger-light)',btn.style.borderColor='var(--danger)';
};

window.limpiarCapacidad=()=>{
  ['cap-nombre','cap-edad','cap-hab','cap-dx','cap-decision','cap-solicitante','cap-c1-obs','cap-c2-obs','cap-c3-obs','cap-c4-obs','cap-factores-obs','cap-notas'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['cap-c1','cap-c2','cap-c3','cap-c4','cap-conclusion'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.querySelectorAll('#cap-factores input, #cap-recom input').forEach(cb=>cb.checked=false);
  document.querySelectorAll('#page-capacidad .risk-btn').forEach(b=>{b.style.background='';b.style.borderColor='';b.style.fontWeight='';});
  const sel=document.getElementById('cap-pac-sel');if(sel)sel.value='';
  document.getElementById('cap-nota-output').textContent='Completa los campos y presiona "Generar nota"‚Ä¶';
  window._capPacienteId=null;
  const fd=document.getElementById('cap-fecha');if(fd)fd.value=new Date().toISOString().split('T')[0];
};

window.generarNotaCapacidad=()=>{
  const v=id=>document.getElementById(id)?.value||'';
  const cb=id=>Array.from(document.querySelectorAll(`#${id} input:checked`)).map(x=>x.value).join(', ')||'Ninguno';
  const crit=(id,label)=>{const val=v(id)||'No evaluado';const obs=v(id+'-obs');return`${label}: ${val}${obs?' ‚Äî '+obs:''}`;};
  const nombre=v('cap-nombre')||'Paciente';
  const fecha=v('cap-fecha')||new Date().toLocaleDateString('es-CO');
  const conclusion=v('cap-conclusion')||'No determinada';
  const nota=`VALORACI√ìN DE CAPACIDAD DECISIONAL
Fecha: ${fecha}
Paciente: ${nombre}${v('cap-edad')?' ¬∑ '+v('cap-edad'):''}${v('cap-hab')?' ¬∑ Hab. '+v('cap-hab'):''}
Situaci√≥n cl√≠nica: ${v('cap-dx')||'‚Äî'}
Decisi√≥n a evaluar: ${v('cap-decision')||'‚Äî'}
Solicitado por: ${v('cap-solicitante')||'‚Äî'}

‚îÅ‚îÅ‚îÅ EVALUACI√ìN DE LOS 4 CRITERIOS ‚îÅ‚îÅ‚îÅ

${crit('cap-c1','1. Comprensi√≥n')}
${crit('cap-c2','2. Apreciaci√≥n')}
${crit('cap-c3','3. Razonamiento')}
${crit('cap-c4','4. Expresi√≥n de la decisi√≥n')}

‚îÅ‚îÅ‚îÅ FACTORES QUE AFECTAN LA CAPACIDAD ‚îÅ‚îÅ‚îÅ
${cb('cap-factores')}
${v('cap-factores-obs')?'Observaciones: '+v('cap-factores-obs'):''}

‚îÅ‚îÅ‚îÅ CONCLUSI√ìN ‚îÅ‚îÅ‚îÅ
CAPACIDAD DECISIONAL: ${conclusion}

Recomendaciones al equipo m√©dico:
${cb('cap-recom')}
${v('cap-notas')?'\nNotas adicionales:\n'+v('cap-notas'):''}

Valoraci√≥n realizada por: Psicolog√≠a Cl√≠nica ¬∑ Hospitalaria`;

  document.getElementById('cap-nota-output').textContent=nota;
  return nota;
};

window.copiarNotaCapacidad=()=>{
  const txt=document.getElementById('cap-nota-output').textContent;
  if(!txt||txt.includes('Completa los campos'))return toast('‚ö†Ô∏è Genera la nota primero');
  navigator.clipboard.writeText(txt).then(()=>toast('‚úÖ Nota copiada')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('‚úÖ Nota copiada');
  });
};

window.guardarCapacidadFirebase=async()=>{
  const nombre=document.getElementById('cap-nombre')?.value?.trim();
  if(!nombre)return toast('‚ö†Ô∏è Ingresa el nombre del paciente');
  const nota=generarNotaCapacidad();
  const v=id=>document.getElementById(id)?.value||'';
  const cb=id=>Array.from(document.querySelectorAll(`#${id} input:checked`)).map(x=>x.value);
  setSyncStatus('syncing');
  try{
    await addDoc(collection(db,'capacidad_decisional'),{
      pacienteId:window._capPacienteId||null,
      pacienteNombre:nombre,
      fecha:v('cap-fecha'),
      hab:v('cap-hab'),
      dx:v('cap-dx'),
      decision:v('cap-decision'),
      solicitante:v('cap-solicitante'),
      c1:v('cap-c1'),c1obs:v('cap-c1-obs'),
      c2:v('cap-c2'),c2obs:v('cap-c2-obs'),
      c3:v('cap-c3'),c3obs:v('cap-c3-obs'),
      c4:v('cap-c4'),c4obs:v('cap-c4-obs'),
      factores:cb('cap-factores'),
      conclusion:v('cap-conclusion'),
      recomendaciones:cb('cap-recom'),
      notas:v('cap-notas'),
      nota,
      creado:serverTimestamp()
    });
    setSyncStatus('online');
    toast('‚úÖ Valoraci√≥n guardada en Firebase');
  }catch(e){setSyncStatus('offline');toast('‚ùå '+e.message);}
};

window.selectTestPaciente=(id)=>{
  if(!id)return;
  const p=pacientes.find(x=>x.id===id);
  if(!p)return;
  const nombre=document.getElementById('test-pac-nombre');
  const edad=document.getElementById('test-pac-edad');
  if(nombre)nombre.value=p.nombre;
  if(edad&&p.edad)edad.value=p.edad;
  // guardar id para asociar resultado
  window._testPacienteId=p.id;
};

window.selectICPaciente=(id)=>{
  if(!id)return;
  const p=pacientes.find(x=>x.id===id);
  if(!p)return;
  const hab=document.getElementById('ic-hab');
  const nombre=document.getElementById('ic-pnombre');
  const edad=document.getElementById('ic-edad');
  const dx=document.getElementById('ic-pdx');
  const fecha=document.getElementById('ic-pfecha');
  if(hab&&p.hab)hab.value=p.hab;
  if(nombre)nombre.value=p.nombre;
  if(edad&&(p.edad||p.sexo))edad.value=(p.edad?p.edad+' a√±os':'')+(p.sexo?' '+p.sexo.charAt(0):'');
  if(dx&&p.motivo)dx.value=p.motivo;
  if(fecha&&p.fecha)fecha.value=formatDate(p.fecha);
};

window.abrirICParaPaciente=(id)=>{
  goTo('interconsultas');
  setTimeout(()=>{
    const sel=document.getElementById('ic-paciente-sel');
    if(sel){sel.value=id;selectICPaciente(id);}
  },200);
};

window.editarPaciente=(id)=>{
  const p=pacientes.find(x=>x.id===id);
  if(!p)return;
  // Pre-fill modal and switch to edit mode
  document.getElementById('p-nombre').value=p.nombre||'';
  document.getElementById('p-cedula').value=p.cedula||'';
  document.getElementById('p-edad').value=p.edad||'';
  document.getElementById('p-sexo').value=p.sexo||'';
  document.getElementById('p-fecha').value=p.fecha||'';
  document.getElementById('p-hab').value=p.hab||'';
  document.getElementById('p-motivo').value=p.motivo||'';
  document.getElementById('p-dxpsi').value=p.dxpsi||'';
  document.getElementById('p-riesgo').value=p.riesgo||'';
  document.getElementById('p-riesgo-obs').value=p.riesgoObs||'';
  document.getElementById('p-estado').value=p.estado||'seguimiento';
  document.getElementById('p-proxsesion').value=p.proxSesion||'';
  document.getElementById('p-notas').value=p.notas||'';
  document.querySelectorAll('#modal-paciente .risk-btn').forEach(b=>{b.classList.toggle('sel',b.textContent.trim()===p.riesgo);});
  // Change button to update
  const btn=document.querySelector('#modal-paciente .btn-primary');
  btn.textContent='Actualizar';btn.onclick=()=>actualizarPaciente(id);
  openModal('modal-paciente');
};

window.actualizarPaciente=async(id)=>{
  setSyncStatus('syncing');
  try{
    await updateDoc(doc(db,'pacientes',id),{
      nombre:document.getElementById('p-nombre').value.trim(),
      cedula:document.getElementById('p-cedula').value.trim(),
      edad:document.getElementById('p-edad').value,
      sexo:document.getElementById('p-sexo').value,
      fecha:document.getElementById('p-fecha').value,
      hab:document.getElementById('p-hab').value,
      motivo:document.getElementById('p-motivo').value,
      dxpsi:document.getElementById('p-dxpsi').value,
      riesgo:document.getElementById('p-riesgo').value,
      riesgoObs:document.getElementById('p-riesgo-obs').value,
      estado:document.getElementById('p-estado').value,
      proxSesion:document.getElementById('p-proxsesion').value,
      notas:document.getElementById('p-notas').value
    });
    closeModal('modal-paciente');toast('‚úÖ Paciente actualizado');
    const btn=document.querySelector('#modal-paciente .btn-primary');
    btn.textContent='Registrar';btn.onclick=guardarPaciente;
  }catch(e){setSyncStatus('offline');toast('‚ùå '+e.message);}
};

window.guardarIC=async()=>{
  const pacId=document.getElementById('ic-paciente')?.value;
  const esp=document.getElementById('ic-especialidad')?.value||'';
  const motivo=document.getElementById('ic-motivo')?.value?.trim()||'';
  if(!pacId||!motivo)return toast('‚ö†Ô∏è Paciente y motivo son obligatorios');
  const pac=pacientes.find(p=>p.id===pacId);setSyncStatus('syncing');
  try{
    await addDoc(collection(db,'interconsultas'),{
      pacienteId:pacId,pacienteNombre:pac?pac.nombre:'?',pacienteCedula:pac?pac.cedula:'',
      hab:pac?pac.hab||'':'',
      especialidad:esp,
      prioridad:document.getElementById('ic-prioridad')?.value||'normal',
      motivo,
      info:document.getElementById('ic-info')?.value||'',
      fecha:document.getElementById('ic-fecha')?.value||'',
      medico:document.getElementById('ic-medico')?.value||'',
      estado:'pendiente',creado:serverTimestamp()
    });
    closeModal('modal-ic');toast('‚úÖ Interconsulta enviada');
  }catch(e){setSyncStatus('offline');toast('‚ùå '+e.message);}
};

window.renderIC=()=>{
  const cont=document.getElementById('lista-ic');
  if(!cont)return;
  if(!interconsultas.length){cont.innerHTML='<div class="empty"><p>No hay interconsultas registradas.</p></div>';return;}
  cont.innerHTML=interconsultas.map(ic=>{
    const nombre=ic.pacienteNombre||'Sin nombre';
    const titulo=ic.especialidad?`${ic.especialidad} ‚Äî ${nombre}`:(ic.hab?`Hab. ${ic.hab} ‚Äî ${nombre}`:nombre);
    const desc=ic.motivo?(ic.motivo.slice(0,100)+(ic.motivo.length>100?'‚Ä¶':'')):(ic.dx||'‚Äî');
    const prioridad=ic.prioridad||'normal';
    const estado=ic.estado||'pendiente';
    return`<div class="ic-card"><div class="ic-icon ${prioridad==='urgente'?'urgent':estado==='respondida'?'done':'pending'}">${prioridad==='urgente'?'üö®':estado==='respondida'?'‚úÖ':'üì§'}</div><div class="ic-body"><h4>${titulo}</h4><p>${desc}</p><div class="ic-meta"><span class="badge ${prioridad==='urgente'?'badge-red':prioridad==='electiva'?'badge-blue':'badge-gray'}">${prioridad}</span><span class="badge ${estado==='respondida'?'badge-green':'badge-yellow'}">${estado}</span><span class="text-sm">${ic.fecha?ic.fecha:''}</span></div></div><div class="ic-actions">${estado==='pendiente'?`<button class="btn btn-sm btn-secondary" onclick="responderIC('${ic.id}')">Respondida</button>`:''}<button class="btn btn-sm btn-danger" onclick="eliminarIC('${ic.id}')">‚úï</button></div></div>`;
  }).join('');
};

window.responderIC=async(id)=>{try{await updateDoc(doc(db,'interconsultas',id),{estado:'respondida'});toast('‚úÖ Marcada como respondida');}catch(e){toast('‚ùå '+e.message);}};
window.eliminarIC=async(id)=>{if(!confirm('¬øEliminar?'))return;try{await deleteDoc(doc(db,'interconsultas',id));toast('üóëÔ∏è Eliminada');}catch(e){toast('‚ùå '+e.message);}};

window.guardarICFirebase=async()=>{
  const nombre=document.getElementById('ic-pnombre').value.trim()||'Sin nombre';
  const hab=document.getElementById('ic-hab').value.trim()||'‚Äî';
  const dx=document.getElementById('ic-pdx').value.trim()||'‚Äî';
  const riesgo=document.getElementById('ic-riesgo-nivel').value||'No clasificado';
  const edad=document.getElementById('ic-edad')?.value||'';
  const fecha=document.getElementById('ic-pfecha').value||new Date().toLocaleDateString('es-CO');
  // Buscar paciente vinculado por nombre o selector
  const selPac=document.getElementById('ic-paciente-sel');
  const pacId=selPac?.value||null;
  const pacObj=pacId?pacientes.find(p=>p.id===pacId):pacientes.find(p=>p.nombre===nombre)||null;
  // Capturar nota generada si existe
  let notaTexto='';
  try{
    if(icCurrentMode==='nueva')notaTexto=generarNotaIcNueva()||'';
    else if(icCurrentMode==='seg')notaTexto=generarNotaIcSeg()||'';
  }catch(e){}
  setSyncStatus('syncing');
  // Capturar campos estructurados del output si existen
  let sub='',obj='',resp='',trat='';
  try{
    if(icCurrentMode==='nueva'){
      const gs=t=>{ const el=document.getElementById(t); if(!el)return''; const v=el.textContent||''; return v.startsWith('Genera')?'':v; };
      sub=gs('ic-out-sub');obj=gs('ic-out-obj');resp=gs('ic-out-resp');trat=gs('ic-out-trat');
    } else if(icCurrentMode==='seg'){
      const el=document.getElementById('ic-out-seg-texto'); if(el){const v=el.textContent||'';obj=v.startsWith('Genera')?'':v;}
    }
  }catch(ex){}
  try{
    await addDoc(collection(db,'interconsultas'),{
      pacienteId:pacObj?.id||pacId||null,
      pacienteNombre:nombre,
      pacienteCedula:pacObj?.cedula||'',
      hab,edad,dx,riesgo,
      modo:icCurrentMode==='nueva'?'IC Nueva':icCurrentMode==='seg'?'Seguimiento':'Nota especial',
      fecha,nota:notaTexto,sub,obj,resp,trat,
      estado:'respondida',
      creado:serverTimestamp()
    });
    toast('‚úÖ IC guardada en Firebase');
    setSyncStatus('online');
  }catch(e){setSyncStatus('offline');toast('‚ùå '+e.message);}
};

window.guardarAnamnesis=async()=>{
  const nombre=document.getElementById('an-nombre').value.trim();
  if(!nombre)return toast('‚ö†Ô∏è Ingresa el nombre del paciente');
  const nota=generarNota();setSyncStatus('syncing');
  try{await addDoc(collection(db,'anamnesis'),{pacienteId:document.getElementById('anamnesis-paciente-sel').value||null,pacienteNombre:nombre,pacienteCedula:document.getElementById('an-cedula').value,fecha:document.getElementById('an-fecha').value,riesgo:document.getElementById('an-riesgo').value,dx:getChecked('an-dx'),nota,creado:serverTimestamp()});toast('‚úÖ Anamnesis guardada');}
  catch(e){setSyncStatus('offline');toast('‚ùå '+e.message);}
};

window.guardarResultadoTest=async(testName,score,level,paciente,extra)=>{
  setSyncStatus('syncing');
  const nombre=paciente||document.getElementById('test-pac-nombre').value||'Sin nombre';
  const pacId=window._testPacienteId||null;
  try{
    await addDoc(collection(db,'test_resultados'),{
      test:testName,score,level,
      paciente:nombre,
      pacienteId:pacId,
      fecha:new Date().toISOString().split('T')[0],
      extra:extra||'',
      creado:serverTimestamp()
    });
    setSyncStatus('online');
    toast('‚úÖ Resultado guardado para '+nombre);
  }
  catch(e){setSyncStatus('offline');}
};

window.renderHistorial=()=>{
  const cont=document.getElementById('historial-list');
  if(!cont)return;
  if(!testHistory.length){cont.innerHTML='<div class="empty"><p>No hay tests registrados.</p></div>';return;}
  const iconos={PHQ9:'üíô',GAD7:'‚ö°',HADS:'üè•',MMSE:'üß†',MoCA:'üß©',CAM:'üåÄ','C-SSRS':'üî¥','MMAS-4':'üíä',Duelo:'üïäÔ∏è'};
  const levelLabel={normal:'Normal',moderate:'Leve/Moderado',high:'Alto',critical:'Cr√≠tico'};
  cont.innerHTML=testHistory.map(t=>{
    const pac=t.pacienteId?pacientes.find(p=>p.id===t.pacienteId):null;
    const nombre=pac?pac.nombre:(t.paciente||'Sin nombre');
    const hab=pac&&pac.hab?` ¬∑ Hab. ${pac.hab}`:'';
    return`<div class="hist-item"><div class="hist-icon">${iconos[t.test]||'üìä'}</div><div class="hist-body"><h4>${t.test} ‚Äî ${nombre}</h4><p>${hab?hab.trim()+' ¬∑ ':''}${t.extra||''}</p></div><div class="hist-meta"><span class="badge ${t.level==='normal'?'badge-green':t.level==='moderate'?'badge-yellow':t.level==='high'||t.level==='critical'?'badge-red':'badge-gray'}">${levelLabel[t.level]||t.level||'‚Äî'}</span><span class="text-sm">${t.fecha||''}</span>${t.score!==undefined&&t.score!==null?`<strong>${t.score} pts</strong>`:''}</div></div>`;
  }).join('');
};

window.clearTestHistory=async()=>{
  if(!confirm('¬øBorrar todo el historial de tests?'))return;
  for(const t of testHistory){try{await deleteDoc(doc(db,'test_resultados',t.id));}catch(e){}}
  toast('üóëÔ∏è Historial borrado');
};

// ‚îÄ‚îÄ DASHBOARD STATE ‚îÄ‚îÄ
let dashSoloHoy=true;
window.toggleDashView=(soloHoy)=>{
  dashSoloHoy=soloHoy;
  document.getElementById('btn-hoy-dash').style.opacity=soloHoy?'1':'0.5';
  document.getElementById('btn-todos-dash').style.opacity=soloHoy?'0.5':'1';
  document.getElementById('ronda-titulo').textContent=soloHoy?'üìã Pacientes para hoy':'üè• Todos los pacientes ‚Äî por piso';
  renderDashboard();
};

window.renderDashboard=()=>{
  const rondaCont=document.getElementById('ronda-pisos');
  const alertaCont=document.getElementById('dashboard-alertas');
  const actCont=document.getElementById('recent-activity');
  if(!rondaCont)return;

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
  const todayStr=()=>{const d=new Date();const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return`${y}-${m}-${day}`;};
  const hoy=todayStr();
  const getPiso=(hab)=>{if(!hab)return'Sin piso asignado';const u=hab.toUpperCase();if(u.includes('UCI')||u.includes('UTI')||u.includes('CUIDADOS INTENSIVOS'))return'üî¥ UCI';if(u.includes('URG'))return'üü° Urgencias';const m=hab.match(/^(\d+)/);if(!m)return'Sin piso asignado';const n=parseInt(m[1]);if(n>=100)return'Piso '+Math.floor(n/100);return'Piso '+n;};
  const riskClass=(r)=>r==='ALTO'?'riesgo-alto':r==='MEDIO'?'riesgo-medio':r==='BAJO'?'riesgo-bajo':'riesgo-sin';
  const riskBadge=(r)=>{if(!r||r==='SIN RIESGO')return'<span class="badge badge-green">Sin riesgo</span>';if(r==='BAJO')return'<span class="badge badge-green">Riesgo bajo</span>';if(r==='MEDIO')return'<span class="badge badge-yellow">Riesgo medio</span>';if(r==='ALTO')return'<span class="badge badge-red">‚ö†Ô∏è Riesgo alto</span>';return'';};
  const estadoBadge=(e)=>{const m={'seguimiento':'badge-blue','nueva-interconsulta-pendiente':'badge-yellow','alta':'badge-gray','revaloracion':'badge-purple'};const l={'seguimiento':'Seguimiento','nueva-interconsulta-pendiente':'IC pendiente','alta':'Alta','revaloracion':'Revaluaci√≥n'};return`<span class="badge ${m[e]||'badge-gray'}">${l[e]||e||'‚Äî'}</span>`;};

  // ‚îÄ‚îÄ FILTRAR: solo hoy o todos ‚îÄ‚îÄ
  let lista=pacientes.filter(p=>p.estado!=='alta');
  if(dashSoloHoy){
    lista=lista.filter(p=>p.proxSesion===hoy);
  }

  // ‚îÄ‚îÄ AGRUPAR POR PISO ‚îÄ‚îÄ
  const grouped={};
  lista.forEach(p=>{const key=getPiso(p.hab);if(!grouped[key])grouped[key]=[];grouped[key].push(p);});

  if(!lista.length){
    rondaCont.innerHTML=dashSoloHoy
      ?`<div class="empty"><p>‚úÖ No hay pacientes programados para hoy.<br><small>Si acabas de registrar pacientes, verifica que tengan fecha de pr√≥xima sesi√≥n igual a hoy (${hoy}).</small></p><button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="toggleDashView(false)">Ver todos los pacientes</button></div>`
      :`<div class="empty"><p>No hay pacientes activos registrados.</p></div>`;
  } else {
    const pisoKeys=Object.keys(grouped).sort((a,b)=>{
      if(a.includes('UCI'))return-1;if(b.includes('UCI'))return 1;
      if(a.includes('Urgencias'))return-1;if(b.includes('Urgencias'))return 1;
      const na=parseInt(a.replace('Piso ','')),nb=parseInt(b.replace('Piso ',''));
      return isNaN(na)?1:isNaN(nb)?-1:na-nb;
    });
    // Ordenar dentro de cada piso: riesgo ALTO primero
    const riskOrder={'ALTO':0,'MEDIO':1,'BAJO':2,'SIN RIESGO':3,'':4};
    pisoKeys.forEach(k=>grouped[k].sort((a,b)=>(riskOrder[a.riesgo]||4)-(riskOrder[b.riesgo]||4)));

    rondaCont.innerHTML=pisoKeys.map(piso=>{
      const ps=grouped[piso];
      const cards=ps.map(p=>`
        <div class="ronda-card ${riskClass(p.riesgo)}">
          <div class="rc-hab">üö™ ${p.hab?'Hab. '+p.hab:'Sin hab.'}</div>
          <div class="rc-nombre">${p.nombre}</div>
          ${p.cedula?`<div style="font-size:0.68rem;color:var(--text3);margin-bottom:3px">CC: ${p.cedula}</div>`:''}
          <div class="rc-dx">${p.motivo?p.motivo.slice(0,70)+(p.motivo.length>70?'‚Ä¶':''):'Sin diagn√≥stico registrado'}</div>
          <div class="rc-badges">${riskBadge(p.riesgo)} ${estadoBadge(p.estado)}</div>
          ${p.proxSesion?`<div class="rc-proxima">üìÖ Pr√≥x. sesi√≥n: ${formatDate(p.proxSesion)}</div>`:''}
          <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap">
            <button class="btn btn-sm btn-secondary" onclick="abrirICParaPaciente('${p.id}')">üí¨ IC</button>
            <button class="btn btn-sm btn-secondary" onclick="irTestsPaciente('${p.id}')">üß™ Test</button>
            <button class="btn btn-sm btn-secondary" onclick="editarPaciente('${p.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-sm btn-secondary" onclick="mhicAbrir('${p.id}')">üìÇ Historial IC</button>
          </div>
        </div>`).join('');
      return`<div class="piso-group">
        <div class="piso-header">üè¢ ${piso}<span class="piso-count">${ps.length} paciente${ps.length>1?'s':''}</span></div>
        <div class="ronda-cards">${cards}</div>
      </div>`;
    }).join('');
  }

  // ‚îÄ‚îÄ ALERTAS ‚îÄ‚îÄ
  const alertas=[];
  pacientes.filter(p=>p.riesgo==='ALTO'&&p.estado!=='alta').forEach(p=>alertas.push({tipo:'rojo',icon:'üî¥',titulo:`Riesgo ALTO ‚Äî ${p.nombre}`,desc:`Hab. ${p.hab||'‚Äî'} ¬∑ ${p.motivo||'Sin diagn√≥stico'}`}));
  pacientes.filter(p=>p.estado==='nueva-interconsulta-pendiente').forEach(p=>alertas.push({tipo:'amarillo',icon:'üìã',titulo:`IC pendiente ‚Äî ${p.nombre}`,desc:`Hab. ${p.hab||'‚Äî'}`}));
  pacientes.filter(p=>p.riesgo==='MEDIO'&&p.estado!=='alta').forEach(p=>alertas.push({tipo:'amarillo',icon:'‚ö†Ô∏è',titulo:`Riesgo MEDIO ‚Äî ${p.nombre}`,desc:`Hab. ${p.hab||'‚Äî'}`}));
  if(alertaCont){
    alertaCont.innerHTML=alertas.length
      ?alertas.map(a=>`<div class="alerta-card alerta-${a.tipo}"><div class="al-icon">${a.icon}</div><div class="al-body"><h4>${a.titulo}</h4><p>${a.desc}</p></div></div>`).join('')
      :'<div class="empty" style="padding:16px"><p>‚úÖ Sin alertas activas.</p></div>';
  }

  // ‚îÄ‚îÄ ACTIVIDAD RECIENTE ‚îÄ‚îÄ
  if(actCont){
    const all=[
      ...interconsultas.map(ic=>({tipo:'IC',txt:`${ic.hab?'Hab. '+ic.hab+' ¬∑ ':''}${ic.pacienteNombre||''}`,badge:'badge-blue',ts:ic.creado?.toDate?.()??new Date()})),
      ...anamnesisList.map(a=>({tipo:'Anamnesis',txt:a.pacienteNombre,badge:'badge-yellow',ts:a.creado?.toDate?.()??new Date()})),
      ...testHistory.map(t=>({tipo:t.test,txt:t.paciente,badge:'badge-gray',ts:t.creado?.toDate?.()??new Date()}))
    ].sort((a,b)=>b.ts-a.ts).slice(0,8);
    actCont.innerHTML=all.length
      ?'<div class="table-wrap"><table><thead><tr><th>Tipo</th><th>Descripci√≥n</th><th>Fecha</th></tr></thead><tbody>'+all.map(a=>`<tr><td><span class="badge ${a.badge}">${a.tipo}</span></td><td>${a.txt}</td><td class="td-sub">${a.ts.toLocaleString('es-CO',{dateStyle:'short',timeStyle:'short'})}</td></tr>`).join('')+'</tbody></table></div>'
      :'<div class="empty"><p>Sin actividad reciente.</p></div>';
  }
};
window.updateStats=()=>{
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('stat-pac',pacientes.filter(p=>p.estado!=='alta').length);
  const icPendIC=interconsultas.filter(x=>x.estado==='pendiente').length;const icPendPac=pacientes.filter(x=>x.estado==='nueva-interconsulta-pendiente').length;set('stat-ic',icPendIC+icPendPac);
  set('stat-riesgo',pacientes.filter(p=>p.riesgo==='ALTO').length);
  const hoy=new Date().toISOString().split('T')[0];
  set('stat-tests',testHistory.filter(t=>t.fecha===hoy).length);
  set('stat-altas',pacientes.filter(p=>p.estado==='alta').length);
};
window.toggleAltasPanel=()=>{
  const panel=document.getElementById('altas-panel');
  if(!panel)return;
  const visible=panel.style.display!=='none';
  panel.style.display=visible?'none':'block';
  if(!visible)renderAltasList();
};
window.renderAltasList=()=>{
  const list=document.getElementById('altas-list');
  if(!list)return;
  const altas=pacientes.filter(p=>p.estado==='alta');
  if(!altas.length){list.innerHTML='<p style="color:var(--text3);padding:12px">No hay pacientes con alta registrada.</p>';return;}
  list.innerHTML=altas.map(p=>`<div class="patient-row" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px">
    <div>
      <div style="font-weight:600">${p.nombre}</div>
      <div style="font-size:0.75rem;color:var(--text3)">Hab. ${p.hab||'‚Äî'} ¬∑ C√©d. ${p.cedula||'‚Äî'} ¬∑ ${p.dx||'Sin diagn√≥stico'}</div>
      <div style="font-size:0.75rem;color:var(--text3)">Ingreso: ${p.ingreso||'‚Äî'}</div>
    </div>
    <span class="badge badge-gray">Alta</span>
  </div>`).join('');
};
window.updateBadges=()=>{
  const bp=document.getElementById('badge-pac'),bi=document.getElementById('badge-ic');
  if(bp)bp.textContent=pacientes.length;
  const biVal=interconsultas.filter(x=>x.estado==='pendiente').length+pacientes.filter(x=>x.estado==='nueva-interconsulta-pendiente').length;if(bi)bi.textContent=biVal;
};
window.populateAnamPacientes=()=>{const sel=document.getElementById('anamnesis-paciente-sel');if(!sel)return;const cur=sel.value;sel.innerHTML='<option value="">‚Äî Seleccionar paciente ‚Äî</option>'+pacientes.map(p=>`<option value="${p.id}">${p.nombre} (${p.cedula})</option>`).join('');if(cur)sel.value=cur;};

setSyncStatus('syncing');
['p-fecha','ic-fecha','an-fecha'].forEach(id=>{try{document.getElementById(id).value=new Date().toISOString().split('T')[0];}catch(e){}});
</script>

<script>
// ‚îÄ‚îÄ UI & NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const pages=['dashboard','pacientes','interconsultas','anamnesis','tests','capacidad','historial'];
const titles={dashboard:'Inicio',pacientes:'Registro de Pacientes',interconsultas:'Interconsultas',anamnesis:'Nueva Anamnesis',tests:'Tests Cl√≠nicos',capacidad:'Valoraci√≥n de Capacidad Decisional',historial:'Historial de Tests'};

window.goTo=(page)=>{
  pages.forEach(p=>document.getElementById('page-'+p).classList.toggle('active',p===page));
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('topbar-title').textContent=titles[page]||page;
  if(page==='pacientes'&&typeof renderPacientes==='function')renderPacientes();
  if(page==='interconsultas'){populateICPacientes();if(typeof renderIC==='function')renderIC();}
  if(page==='tests')populateICPacientes();
  if(page==='capacidad'){populateICPacientes();const fd=document.getElementById('cap-fecha');if(fd&&!fd.value)fd.value=new Date().toISOString().split('T')[0];}
  if(page==='dashboard'&&typeof renderDashboard==='function')renderDashboard();
  if(page==='historial'&&typeof renderHistorial==='function')renderHistorial();
  // Cerrar sidebar en m√≥vil al navegar
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
};

window.toggleSidebar=()=>{
  const isMobile=window.innerWidth<=768;
  if(isMobile){
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebar-overlay').classList.toggle('open');
  } else {
    const sb=document.getElementById('sidebar');
    const mn=document.querySelector('.main');
    const collapsed=sb.classList.toggle('collapsed');
    mn.style.marginLeft=collapsed?'0':'240px';
  }
};
window.openModal=(id)=>{document.getElementById(id).classList.add('open');if(id==='modal-ic')populateICPacientes();};
window.closeModal=(id)=>document.getElementById(id).classList.remove('open');
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open')}));
window.nuevaAnamnesisParaPaciente=(id)=>{goTo('anamnesis');setTimeout(()=>{document.getElementById('anamnesis-paciente-sel').value=id;selectAnamPaciente(id);},200);};
window.nuevaICParaPaciente=(id)=>{abrirICParaPaciente(id);};
window.irTestsPaciente=(id)=>{
  const p=pacientes.find(x=>x.id===id);
  if(p){
    document.getElementById('test-pac-nombre').value=p.nombre;
    if(p.edad)document.getElementById('test-pac-edad').value=p.edad;
    window._testPacienteId=p.id;
  }
  goTo('tests');
  setTimeout(()=>{
    const sel=document.getElementById('test-pac-sel');
    if(sel)sel.value=id;
  },200);
};
window.selectAnamPaciente=(id)=>{if(!id||typeof pacientes==='undefined')return;const p=pacientes.find(x=>x.id===id);if(!p)return;document.getElementById('an-nombre').value=p.nombre;document.getElementById('an-cedula').value=p.cedula;if(p.edad)document.getElementById('an-edad').value=p.edad;if(p.motivo)document.getElementById('an-motivo').value=p.motivo;};
window.clearAnamnesis=()=>{document.getElementById('form-anamnesis').reset();document.getElementById('anamnesis-paciente-sel').value='';document.getElementById('an-riesgo').value='';document.querySelectorAll('.risk-btn').forEach(b=>b.classList.remove('sel'));document.getElementById('nota-output').textContent='Completa los campos y presiona "Generar nota cl√≠nica"‚Ä¶';document.getElementById('an-intens-val').textContent='5';};
window.setRisk=(level,el)=>{document.querySelectorAll('.risk-btn').forEach(b=>b.classList.remove('sel'));el.classList.add('sel');document.getElementById('an-riesgo').value=level;};
window.setPRisk=(level,el)=>{document.querySelectorAll('#modal-paciente .risk-btn').forEach(b=>b.classList.remove('sel'));el.classList.add('sel');document.getElementById('p-riesgo').value=level;};
window.getChecked=(id)=>[...document.querySelectorAll(`#${id} input:checked`)].map(i=>i.value).join(', ');
window.getRadio=(name)=>{const el=document.querySelector(`input[name="${name}"]:checked`);return el?el.value:'';};
window.generarNota=()=>{
  const v=id=>document.getElementById(id)?.value||'';
  const nota=`NOTA CL√çNICA ¬∑ PSICOLOG√çA ¬∑ CONSULTA EXTERNA EPS
Fecha: ${v('an-fecha')||new Date().toLocaleDateString('es-CO')}
${'‚îÅ'.repeat(40)}

DATOS DE IDENTIFICACI√ìN
Paciente: ${v('an-nombre')}${v('an-cedula')?' ¬∑ CC: '+v('an-cedula'):''}${v('an-edad')?' ¬∑ '+v('an-edad')+' a√±os':''}
${v('an-ecivil')?'Estado civil: '+v('an-ecivil'):''}${v('an-esc')?' ¬∑ Escolaridad: '+v('an-esc'):''}
${v('an-ocupacion')?'Ocupaci√≥n: '+v('an-ocupacion'):''}
${v('an-remitido')?'Remitido por: '+v('an-remitido'):''}

MOTIVO DE CONSULTA
${v('an-motivo')||'[No registrado]'}

HISTORIA DEL PROBLEMA ACTUAL
Inicio: ${getRadio('an-inicio')||'‚Äî'} | Evoluci√≥n: ${v('an-evolucion')||'‚Äî'} | Intensidad: ${v('an-intens')}/10
Desencadenantes: ${getChecked('an-desenc')||'‚Äî'}
S√≠ntomas: ${getChecked('an-sint')||'‚Äî'}
Impacto: ${getChecked('an-impacto')||'‚Äî'}
${v('an-descripcion')?'Descripci√≥n: '+v('an-descripcion'):''}

ANTECEDENTES
Tto. psicol√≥gico: ${getRadio('an-tpsi')||'‚Äî'} | Psiqui√°trico: ${getRadio('an-tpsiq')||'‚Äî'} | IS previos: ${getRadio('an-is')||'‚Äî'}
${v('an-meds')?'Medicamentos: '+v('an-meds'):''}${v('an-enf')?'\nEnfermedades: '+v('an-enf'):''}
Red de apoyo: ${getRadio('an-red')||'‚Äî'}

EXAMEN MENTAL
Orientaci√≥n: ${getChecked('an-orient')||'‚Äî'}
Afecto: ${getChecked('an-afecto')||'‚Äî'}
Pensamiento ‚Äî Curso: ${getRadio('an-pcurso')||'‚Äî'}
Insight: ${getChecked('an-insight')||'‚Äî'}
Memoria y atenci√≥n: ${getRadio('an-mem')||'‚Äî'}

RIESGO SUICIDA
Ideaci√≥n: ${getRadio('an-ideacion')||'‚Äî'} | Clasificaci√≥n: ${v('an-riesgo')||'‚Äî'}
${v('an-riesgo-notas')?'Notas: '+v('an-riesgo-notas'):''}

IMPRESI√ìN DIAGN√ìSTICA
${getChecked('an-dx')||'‚Äî'}${v('an-cie')?' ('+v('an-cie')+')':''}
${v('an-dx-obs')||''}

PLAN TERAP√âUTICO
Enfoque: ${getChecked('an-enfoque')||'‚Äî'}
Remisiones: ${getChecked('an-remisiones')||'‚Äî'}
Pr√≥xima cita: ${v('an-proxcita')||'‚Äî'}

${'‚îÅ'.repeat(40)}
${new Date().toLocaleString('es-CO')}`;
  document.getElementById('nota-output').textContent=nota;return nota;
};
window.copiarNota=()=>{const t=document.getElementById('nota-output').textContent;if(t.startsWith('Completa'))return toast('‚ö†Ô∏è Genera la nota primero');navigator.clipboard.writeText(t).then(()=>toast('üìã Nota copiada')).catch(()=>toast('‚ùå No se pudo copiar'));};
window.toggleSection=(header)=>{header.classList.toggle('open');header.nextElementSibling.classList.toggle('open');};
window.globalSearch=(q)=>{
  window._searchQ=q.trim();
  const local=document.getElementById('pac-search-local');
  if(local)local.value=q;
  if(!document.getElementById('page-pacientes').classList.contains('active')){
    goTo('pacientes');
  } else {
    renderPacientes();
  }
};
window.buscarPacientesLocal=(q)=>{
  window._searchQ=q.trim();
  const topbar=document.getElementById('global-search');
  if(topbar)topbar.value=q;
  renderPacientes();
};
window.formatDate=(d)=>{if(!d)return'';const[y,m,day]=d.split('-');return`${day}/${m}/${y}`;};
window.toast=(msg)=>{const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3200);};

// ‚îÄ‚îÄ HISTORIAL IC POR PACIENTE ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ HISTORIAL PACIENTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _hPacId=null, _hPacNombre='';
const _hMap={}; // indice numerico -> {id, col} evita escaping

function mhicAbrir(pacId){
  const p=pacientes.find(x=>x.id===pacId);
  _hPacId=pacId;
  _hPacNombre=p?p.nombre:'';
  document.getElementById('mhic-title').textContent='üìÇ Historial ‚Äî '+(p?p.nombre:'Paciente');
  document.getElementById('mhic-sub').textContent=p?(p.cedula?'CC: '+p.cedula+' ¬∑ ':'')+('Hab. '+(p.hab||'‚Äî')):'';
  mhicRender();
  const m=document.getElementById('modal-historial-ic');
  m.style.display='flex';
  m.style.alignItems='flex-start';
}
window.verHistorialIC=(pacId,pacNombre)=>mhicAbrir(pacId);

function mhicCerrar(){document.getElementById('modal-historial-ic').style.display='none';}
window.mhicCerrar=mhicCerrar;

function mhicRender(){
  const body=document.getElementById('mhic-body');
  if(!body)return;
  const ics=interconsultas.filter(ic=>ic.pacienteId===_hPacId||ic.pacienteNombre===_hPacNombre);
  const anas=anamnesisList.filter(a=>a.pacienteId===_hPacId||a.pacienteNombre===_hPacNombre);
  const all=[
    ...ics.map(x=>({...x,_col:'interconsultas'})),
    ...anas.map(x=>({...x,_col:'anamnesis',modo:x.modo||'Anamnesis'}))
  ].sort((a,b)=>(b.creado?.toDate?.()??new Date())-(a.creado?.toDate?.()??new Date()));

  // limpiar mapa
  for(const k in _hMap) delete _hMap[k];

  if(!all.length){
    body.innerHTML='<div style="text-align:center;padding:36px;color:var(--text3)"><p>Sin notas registradas.</p><p style="font-size:0.8rem;margin-top:6px">Usa "‚úèÔ∏è Nueva nota" para agregar la primera.</p></div>';
    return;
  }

  const colores={'IC Nueva':'var(--accent2)','Seguimiento':'#1a56db','Anamnesis':'#7b1fa2','Nota especial':'var(--warning)'};
  const rBadge=r=>{if(!r||r==='No clasificado'||r==='SIN RIESGO')return'<span style="background:var(--success-light);color:var(--success);padding:2px 7px;border-radius:20px;font-size:0.68rem;font-weight:600">Sin riesgo</span>';const c=r==='ALTO'?'var(--danger)':r==='MEDIO'?'var(--warning)':'var(--success)';const bg=r==='ALTO'?'var(--danger-light)':r==='MEDIO'?'var(--warning-light)':'var(--success-light)';return`<span style="background:${bg};color:${c};padding:2px 7px;border-radius:20px;font-size:0.68rem;font-weight:600">‚ö† ${r}</span>`;};
  const eBadge=e=>e==='pendiente'?'<span style="background:var(--warning-light);color:var(--warning);padding:2px 7px;border-radius:20px;font-size:0.68rem;font-weight:600">Pendiente</span>':'<span style="background:var(--success-light);color:var(--success);padding:2px 7px;border-radius:20px;font-size:0.68rem;font-weight:600">Completada</span>';

  body.innerHTML=all.map((e,ni)=>{
    _hMap[ni]={id:e.id,col:e._col};
    const col=colores[e.modo]||'var(--accent)';
    const hasFields=e.sub||e.obj||e.resp||e.trat;
    const nota=e.nota||'';
    let contenido='';
    if(hasFields){
      const campos=[{l:'Subjetivo',v:e.sub},{l:'Objetivo',v:e.obj},{l:'Respuesta',v:e.resp},{l:'Tratamiento',v:e.trat}].filter(c=>c.v);
      contenido=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px;margin-top:10px">${campos.map(c=>`<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px"><div style="font-size:0.63rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text3);margin-bottom:5px">${c.l}</div><div style="font-size:0.78rem;color:var(--text);line-height:1.55;white-space:pre-wrap">${c.v}</div></div>`).join('')}</div>`;
      if(nota)contenido+=`<div style="margin-top:8px;font-size:0.77rem;color:var(--text2);line-height:1.5;white-space:pre-wrap;background:var(--surface2);border-radius:8px;padding:10px">${nota}</div>`;
    } else if(nota){
      contenido=`<div style="margin-top:10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:0.8rem;line-height:1.65;white-space:pre-wrap;color:var(--text)">${nota}</div>`;
    } else {
      contenido=`<div style="margin-top:8px;font-size:0.77rem;color:var(--text3);font-style:italic">Sin nota guardada</div>`;
    }
    return `<div style="background:var(--surface2);border:1px solid var(--border);border-left:4px solid ${col};border-radius:10px;padding:14px 16px;margin-bottom:12px">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div>
          <div style="font-weight:700;font-size:0.88rem">${e.modo||'Nota'} ‚Äî <span style="color:${col}">${e.fecha||'Sin fecha'}</span></div>
          ${e.hab||e.dx?`<div style="font-size:0.72rem;color:var(--text3);margin-top:2px">${e.hab?'üè• Hab. '+e.hab+' ¬∑ ':''}${e.dx||''}</div>`:''}
        </div>
        <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap">
          ${rBadge(e.riesgo||'')}${eBadge(e.estado||'respondida')}
          <button class="btn btn-sm btn-secondary" style="padding:3px 9px;font-size:0.72rem" onclick="mhicEditar(${ni})">‚úèÔ∏è Editar</button>
          <button class="btn btn-sm btn-secondary" style="padding:3px 9px;font-size:0.72rem" onclick="mhicCopiar(${ni})">üìã Copiar</button>
        </div>
      </div>${contenido}
    </div>`;
  }).join('');
}

window.mhicNuevaNota=()=>{
  document.getElementById('mne-title').textContent='‚úèÔ∏è Nueva nota';
  document.getElementById('mne-fecha').value=new Date().toISOString().split('T')[0];
  document.getElementById('mne-tipo').value='Seguimiento';
  document.getElementById('mne-riesgo').value='';
  document.getElementById('mne-estado').value='respondida';
  ['mne-sub','mne-obj','mne-resp','mne-trat','mne-nota'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mne-del-btn').style.display='none';
  window._mneId=null; window._mneCol='interconsultas';
  document.getElementById('modal-nota-edit').style.display='flex';
};

window.mhicEditar=(ni)=>{
  const m=_hMap[ni]; if(!m)return;
  const e=m.col==='interconsultas'?interconsultas.find(x=>x.id===m.id):anamnesisList.find(x=>x.id===m.id);
  if(!e)return;
  document.getElementById('mne-title').textContent='‚úèÔ∏è Editar nota';
  document.getElementById('mne-fecha').value=e.fecha||'';
  document.getElementById('mne-tipo').value=e.modo||'IC Nueva';
  document.getElementById('mne-riesgo').value=e.riesgo||'';
  document.getElementById('mne-estado').value=e.estado||'respondida';
  document.getElementById('mne-sub').value=e.sub||'';
  document.getElementById('mne-obj').value=e.obj||'';
  document.getElementById('mne-resp').value=e.resp||'';
  document.getElementById('mne-trat').value=e.trat||'';
  document.getElementById('mne-nota').value=e.nota||'';
  document.getElementById('mne-del-btn').style.display='';
  window._mneId=m.id; window._mneCol=m.col;
  document.getElementById('modal-nota-edit').style.display='flex';
};

window.mhicCopiar=(ni)=>{
  const m=_hMap[ni]; if(!m)return;
  const e=m.col==='interconsultas'?interconsultas.find(x=>x.id===m.id):anamnesisList.find(x=>x.id===m.id);
  if(!e)return;
  let txt=e.nota||'';
  if(e.sub||e.obj||e.resp||e.trat){
    const partes=[];
    if(e.sub)partes.push('AN√ÅLISIS SUBJETIVO\n'+e.sub);
    if(e.obj)partes.push('AN√ÅLISIS OBJETIVO\n'+e.obj);
    if(e.resp)partes.push('RESPUESTA\n'+e.resp);
    if(e.trat)partes.push('TRATAMIENTO\n'+e.trat);
    if(e.nota)partes.push('NOTAS\n'+e.nota);
    txt=partes.join('\n\n---\n\n');
  }
  if(!txt)txt='Sin nota guardada';
  navigator.clipboard.writeText(txt).then(()=>toast('üìã Nota copiada')).catch(()=>toast('‚ùå No se pudo copiar'));
};

window.mneCerrar=()=>{document.getElementById('modal-nota-edit').style.display='none';};

window.mneGuardar=async()=>{
  const v=id=>document.getElementById(id)?.value||'';
  const sub=v('mne-sub'),obj=v('mne-obj'),resp=v('mne-resp'),trat=v('mne-trat'),nota=v('mne-nota');
  const fecha=v('mne-fecha'),modo=v('mne-tipo'),riesgo=v('mne-riesgo'),estado=v('mne-estado');
  let notaFinal=nota;
  if(sub||obj||resp||trat){
    const p=[];
    if(sub)p.push('AN√ÅLISIS SUBJETIVO\n'+sub);
    if(obj)p.push('AN√ÅLISIS OBJETIVO\n'+obj);
    if(resp)p.push('RESPUESTA\n'+resp);
    if(trat)p.push('TRATAMIENTO\n'+trat);
    if(nota)p.push('NOTAS ADICIONALES\n'+nota);
    notaFinal=p.join('\n\n---\n\n');
  }
  setSyncStatus('syncing');
  try{
    if(window._mneId){
      await updateDoc(doc(db,window._mneCol,window._mneId),{fecha,modo,riesgo,estado,sub,obj,resp,trat,nota:notaFinal,editado:serverTimestamp()});
      toast('‚úÖ Nota actualizada');
    } else {
      const pac=pacientes.find(p=>p.id===_hPacId);
      await addDoc(collection(db,'interconsultas'),{
        pacienteId:_hPacId,pacienteNombre:_hPacNombre,
        pacienteCedula:pac?.cedula||'',hab:pac?.hab||'',dx:pac?.motivo||'',
        fecha,modo,riesgo,estado,sub,obj,resp,trat,nota:notaFinal,
        creado:serverTimestamp()
      });
      toast('‚úÖ Nota guardada');
    }
    setSyncStatus('online');
    mneCerrar();
    setTimeout(mhicRender,500);
  }catch(ex){setSyncStatus('offline');toast('‚ùå '+ex.message);}
};

window.mneEliminar=async()=>{
  if(!window._mneId||!confirm('¬øEliminar esta nota permanentemente?'))return;
  try{
    await deleteDoc(doc(db,window._mneCol,window._mneId));
    toast('üóëÔ∏è Nota eliminada');
    mneCerrar();
    setTimeout(mhicRender,500);
  }catch(ex){toast('‚ùå '+ex.message);}
};

// ‚îÄ‚îÄ ESCOLARIDAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ IC ENRIQUECIDA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let icCurrentMode='nueva';
let icCurrentEsp=null;

window.setICMode=function(m){
  icCurrentMode=m;
  ['nueva','seg','esp'].forEach(function(x){
    var el=document.getElementById('ic-btn-'+x);
    if(el)el.classList.toggle('active',x===m);
  });
  var mnueva=document.getElementById('ic-mode-nueva');
  var mesp=document.getElementById('ic-mode-esp');
  if(mnueva)mnueva.style.display=(m==='nueva'||m==='seg')?'':'none';
  if(mesp)mesp.style.display=m==='esp'?'':'none';
  document.querySelectorAll('.ic-only-nueva').forEach(function(el){el.style.display=m==='seg'?'none':'';});
  var f4=document.getElementById('ic-out-4campos');
  var seg=document.getElementById('ic-out-seg');
  if(f4)f4.style.display=m==='seg'?'none':'';
  if(seg)seg.style.display=m==='seg'?'':'none';
};

window.toggleICView=function(){
  var hv=document.getElementById('ic-historial-view');
  var fv=document.getElementById('ic-form-view');
  var showing=hv&&hv.style.display!=='none';
  if(hv)hv.style.display=showing?'none':'';
  if(fv)fv.style.display=showing?'':'none';
  if(!showing&&typeof renderIC==='function')renderIC();
};

window.icTog=function(el){el.classList.toggle('on');};
window.icTogR=function(el){el.classList.toggle('on-r');};
window.icTogG=function(el){el.classList.toggle('on-g');};
window.icTogA=function(el){el.classList.toggle('on-a');};

window.setICSev=function(el,nivel,isHigh){
  document.querySelectorAll('.sev-btn').forEach(function(s){s.classList.remove('on');});
  el.classList.add('on');
  document.getElementById('ic-riesgo-nivel').value=nivel;
  var alert=document.getElementById('ic-risk-alert');
  if(alert)alert.classList.toggle('show',!!isHigh);
};

var icEspNotes={
  intubado:'Al momento de la valoraci√≥n, el paciente se encuentra intubado y sin posibilidad de comunicaci√≥n, lo que impide la realizaci√≥n de valoraci√≥n e intervenci√≥n psicol√≥gica. No se realiza intervenci√≥n en este momento. Se sugiere reinterconsulta a psicolog√≠a en caso de mejor√≠a del estado cl√≠nico que permita interacci√≥n adecuada. Se cierra seguimiento actual.',
  dolor:'An√°lisis subjetivo:\nNo se obtiene informaci√≥n subjetiva relevante en esta oportunidad. El paciente manifiesta no encontrarse en condiciones f√≠sicas/emocionales para realizar la entrevista psicol√≥gica, solicitando reagendar la intervenci√≥n.\n\nAn√°lisis objetivo:\nAl momento de la interconsulta, el paciente se observa con malestar f√≠sico significativo / agotamiento / limitaci√≥n para la comunicaci√≥n, lo que impide la realizaci√≥n de una valoraci√≥n psicol√≥gica adecuada. Se respeta la condici√≥n cl√≠nica actual.\n\nRespuesta:\nInterconsulta psicol√≥gica no efectiva en esta fecha. Se deja constancia de intento de valoraci√≥n. Se reagenda intervenci√≥n psicol√≥gica seg√∫n evoluci√≥n cl√≠nica y disponibilidad del servicio.\n\nTratamiento:\nNo se realiza intervenci√≥n psicol√≥gica en esta oportunidad. Pendiente valoraci√≥n cuando el paciente se encuentre en mejores condiciones.',
  nodisponible:'Al momento de la visita, no es posible realizar intervenci√≥n psicol√≥gica debido a que el paciente no se encuentra disponible para valoraci√≥n. Se deja constancia de intento de abordaje por parte de psicolog√≠a. Se programa nuevo intento de intervenci√≥n para el d√≠a siguiente, condicionado a disponibilidad y condiciones cl√≠nicas del paciente.',
  fuga:'Al momento de la visita por psicolog√≠a, el paciente no se encuentra en el servicio debido a fuga hospitalaria, por lo que no es posible realizar valoraci√≥n ni intervenci√≥n psicol√≥gica. Se deja constancia de intento de abordaje. Se cierra intervenci√≥n de psicolog√≠a por ausencia del paciente, quedando sujeta a nueva interconsulta en caso de reingreso o solicitud del equipo tratante.',
  repetida:'Nota aclaratoria:\nPaciente actualmente en seguimiento por psicolog√≠a, con valoraci√≥n realizada el d√≠a anterior y pr√≥ximo control ya programado.\nEn la solicitud actual no se describen cambios cl√≠nicos nuevos que justifiquen una nueva interconsulta.\nSe mantiene el plan de seguimiento previamente establecido.'
};

window.setIcEsp=function(type,el){
  icCurrentEsp=type;
  document.querySelectorAll('#ic-mode-esp .ic-chip').forEach(function(c){c.classList.remove('on');});
  el.classList.add('on');
  var preview=document.getElementById('ic-esp-preview');
  var text=document.getElementById('ic-esp-text');
  if(preview)preview.style.display='';
  if(text)text.textContent=icEspNotes[type]||'';
};

function icChipsFrom(container){
  if(!container)return[];
  return Array.from(container.querySelectorAll('.ic-chip.on,.ic-chip.on-r,.ic-chip.on-g,.ic-chip.on-a'))
    .map(function(c){return c.textContent.trim();}).filter(Boolean);
}
function icChipsBySubLabel(labelText){
  var sublabels=document.querySelectorAll('.ic-sublabel');
  for(var i=0;i<sublabels.length;i++){
    if(sublabels[i].textContent.includes(labelText)){
      return icChipsFrom(sublabels[i].parentElement);
    }
  }
  return[];
}
function icv(id){var el=document.getElementById(id);return el?el.value.trim():'';}
function icList(arr){
  if(!arr||!arr.length)return null;
  if(arr.length===1)return arr[0];
  return arr.slice(0,-1).join(', ')+' y '+arr[arr.length-1];
}

window.generarNotaIC=function(){
  var wrap=document.getElementById('ic-output-wrap');
  if(wrap)wrap.style.display='';
  if(icCurrentMode==='esp'){generarNotaIcEsp();return;}
  if(icCurrentMode==='seg'){generarNotaIcSeg();return;}
  generarNotaIcNueva();
};

function generarNotaIcNueva(){
  var nombre=icv('ic-pnombre')||'el/la paciente';
  var pn=nombre.split(' ')[0];
  var edad=icv('ic-edad');
  var dx=icv('ic-pdx')||'[diagn√≥stico m√©dico]';
  var hab=icv('ic-hab')||'[habitaci√≥n]';
  var sev=icv('ic-riesgo-nivel')||'No clasificado';

  var estadoEmoc=icList(icChipsBySubLabel('Estado emocional referido'))||'variable';
  var preocup=icChipsBySubLabel('Principales preocupaciones');
  var pensamientos=icChipsBySubLabel('Pensamientos autom√°ticos');
  var cita=icv('ic-sub-cita');
  var intensidad=icv('ic-sub-intensidad');

  var subjetivo=nombre+(edad?', '+edad:'')+', hospitalizado/a en hab. '+hab+' por '+dx+', es valorado/a por psicolog√≠a a solicitud del equipo tratante.\n\nDurante la entrevista, '+pn+' refiere encontrarse emocionalmente '+estadoEmoc+'.';
  if(intensidad)subjetivo+=' '+intensidad+'.';
  if(preocup.length)subjetivo+='\n\nLas principales preocupaciones referidas incluyen: '+icList(preocup)+'.';
  if(pensamientos.length)subjetivo+='\n\nDesde una perspectiva cognitivo-conductual, se identifican los siguientes pensamientos autom√°ticos: '+icList(pensamientos)+', los cuales generan un impacto significativo en su estado emocional y conducta durante la hospitalizaci√≥n.';
  if(cita)subjetivo+='\n\n'+pn+' expresa textualmente: "'+cita+'"';

  var colabora=icChipsBySubLabel('Conciencia / Colaboraci√≥n').filter(function(c){return c==='Consciente'||c==='Colaborador/a';});
  var conducta=icChipsBySubLabel('Conducta');
  var afecto=icChipsBySubLabel('Afecto');
  var pensamiento=icChipsBySubLabel('Pensamiento');
  var lenguaje=icChipsBySubLabel('Lenguaje / Insight');
  var orientChips=icChipsBySubLabel('Orientaci√≥n');
  var desorient=orientChips.includes('Desorientado/a');
  var regulacion=icChipsBySubLabel('Regulaci√≥n emocional');
  var afrontamiento=icChipsBySubLabel('Estrategias de afrontamiento');
  var comprension=icChipsBySubLabel('Comprensi√≥n del Dx');
  var interferenciaAll=icChipsBySubLabel('Factores de interferencia');
  var interferencia=interferenciaAll.filter(function(c){return c!=='Sin interferencia identificada';});

  var objetivo='Al momento de la interconsulta, '+pn+' se presenta '+(icList(colabora)||'consciente y colaborador/a')+', con conducta '+(icList(conducta)||'adecuada al contexto hospitalario')+'.';
  if(!desorient)objetivo+=' Orientado/a en las tres esferas (tiempo, espacio y persona).';
  else objetivo+=' Con alteraci√≥n en la orientaci√≥n.';
  objetivo+='\n\nEn el examen mental: afecto '+(icList(afecto)||'observable')+'. Lenguaje '+(icList(lenguaje)||'coherente')+'. Pensamiento de curso '+(icList(pensamiento)||'organizado')+'.';
  if(regulacion.length)objetivo+='\n\nRegulaci√≥n emocional: '+icList(regulacion)+'.';
  if(afrontamiento.length)objetivo+=' Estrategias de afrontamiento presentes: '+icList(afrontamiento)+'.';
  if(comprension.length)objetivo+='\n\nComprensi√≥n del Dx/pron√≥stico: '+icList(comprension)+'.';
  if(interferencia.length)objetivo+='\n\nFactores de interferencia con el manejo m√©dico: '+icList(interferencia)+'.';

  var habAlim=icChipsBySubLabel('Alimentaci√≥n');
  var habSueno=icChipsBySubLabel('Sue√±o');
  var habSust=icChipsBySubLabel('Consumo de sustancias');
  var sustNotas=icv('ic-sustancias-notas');
  if(habAlim.length||habSueno.length||habSust.length){
    objetivo+='\n\nH√°bitos:';
    if(habAlim.length)objetivo+=' Alimentaci√≥n: '+icList(habAlim)+'.';
    if(habSueno.length)objetivo+=' Sue√±o: '+icList(habSueno)+'.';
    if(habSust.length)objetivo+=' Sustancias psicoactivas: '+icList(habSust)+(sustNotas?'. '+sustNotas:'')+'.';
    else if(sustNotas)objetivo+=' Sustancias: '+sustNotas+'.';
  }

  var ideacion=icChipsBySubLabel('Ideaci√≥n actual');
  var protectores=icChipsBySubLabel('Factores protectores');
  var riesgoNotas=icv('ic-riesgo-notas');
  objetivo+='\n\nEvaluaci√≥n de riesgo suicida/autolesivo: ideaci√≥n '+(icList(ideacion)||'evaluada')+'. Riesgo clasificado como: '+sev+'.';
  if(protectores.length)objetivo+=' Factores protectores: '+icList(protectores)+'.';
  if(riesgoNotas)objetivo+=' '+riesgoNotas;

  var tipoResp=icList(icChipsBySubLabel('Tipo de respuesta emocional'))||'una respuesta contextualizada al proceso de hospitalizaci√≥n y enfermedad';
  var impresion=icChipsBySubLabel('Impresi√≥n cl√≠nica');
  var red=icChipsBySubLabel('Red de apoyo funcional');
  var analisis=icv('ic-resp-analisis');
  var respuesta='Desde la valoraci√≥n psicol√≥gica con enfoque cognitivo-conductual, la respuesta emocional de '+pn+' se comprende como '+tipoResp+'.';
  if(impresion.length)respuesta+='\n\nImpresi√≥n cl√≠nica: '+icList(impresion)+'.';
  if(analisis)respuesta+='\n\n'+analisis;
  if(red.length)respuesta+='\n\nRed de apoyo: '+icList(red)+'.';

  var intervencion=icChipsBySubLabel('Intervenci√≥n realizada hoy');
  var planAll=icChipsBySubLabel('Plan');
  var plan=planAll.filter(function(c){return['Contin√∫a seguimiento por psicolog√≠a','Remisi√≥n a psiquiatr√≠a','Orientaci√≥n a trabajo social','Alta de psicolog√≠a','Reinterconsulta si hay cambios'].includes(c);});
  var frecuencia=icChipsBySubLabel('Frecuencia de seguimiento');
  var tratNotas=icv('ic-trat-notas');
  var tratamiento='Se realiza intervenci√≥n psicol√≥gica hospitalaria que incluye: '+(icList(intervencion)||'valoraci√≥n cl√≠nica pertinente al caso')+'.';
  if(plan.length)tratamiento+='\n\nPlan: '+icList(plan)+'.';
  if(frecuencia.length)tratamiento+=' Frecuencia de seguimiento: '+icList(frecuencia)+'.';
  if(tratNotas)tratamiento+='\n\n'+tratNotas;

  setIcOut('ic-out-sub',subjetivo);
  setIcOut('ic-out-obj',objetivo);
  setIcOut('ic-out-resp',respuesta);
  setIcOut('ic-out-trat',tratamiento);
  var wrap=document.getElementById('ic-output-wrap');
  if(wrap)wrap.scrollIntoView({behavior:'smooth',block:'start'});
}

function generarNotaIcSeg(){
  var nombre=icv('ic-pnombre')||'el/la paciente';
  var pn=nombre.split(' ')[0];
  var sev=icv('ic-riesgo-nivel')||'No clasificado';
  var colabora=icChipsBySubLabel('Conciencia / Colaboraci√≥n').filter(function(c){return c==='Consciente'||c==='Colaborador/a';});
  var conducta=icChipsBySubLabel('Conducta');
  var afecto=icChipsBySubLabel('Afecto');
  var pensamiento=icChipsBySubLabel('Pensamiento');
  var lenguaje=icChipsBySubLabel('Lenguaje / Insight');
  var ideacion=icChipsBySubLabel('Ideaci√≥n actual');
  var sinIdeacion=ideacion.includes('Ninguna');
  var ideacionActiva=ideacion.filter(function(c){return['Pasiva ‚Äî deseo de que termine','Activa','Con plan estructurado'].includes(c);});
  var intervencion=icChipsBySubLabel('Intervenci√≥n realizada hoy');
  var planAll=icChipsBySubLabel('Plan');
  var plan=planAll.filter(function(c){return['Contin√∫a seguimiento por psicolog√≠a','Remisi√≥n a psiquiatr√≠a','Orientaci√≥n a trabajo social','Alta de psicolog√≠a','Reinterconsulta si hay cambios'].includes(c);});
  var analisis=icv('ic-resp-analisis');
  var tratNotas=icv('ic-trat-notas');
  var riesgoNotas=icv('ic-riesgo-notas');
  var orientChips=icChipsBySubLabel('Orientaci√≥n');
  var desorient=orientChips.includes('Desorientado/a');
  var lsi=lenguaje.filter(function(c){return!['Insight conservado','Insight parcial','Sin insight'].includes(c);});

  var p=pn+' se muestra '+(icList(colabora)||'consciente y colaborador/a')+' durante la entrevista, con conducta '+(icList(conducta)||'adecuada')+'. ';
  if(!desorient)p+='Orientado/a en las tres esferas. ';
  else p+='Con alteraci√≥n en la orientaci√≥n. ';
  p+='Afecto '+(icList(afecto)||'observable')+(afecto.includes('Congruente')?', congruente con el discurso':'')+'. Lenguaje '+(icList(lsi)||'coherente')+', pensamiento '+(icList(pensamiento)||'organizado')+', sin alteraciones del contenido ni de la percepci√≥n. ';
  if(lenguaje.includes('Insight conservado'))p+='Juicio conservado e insight adecuado. ';
  else if(lenguaje.includes('Insight parcial'))p+='Insight parcial. ';
  else if(lenguaje.includes('Sin insight'))p+='Sin insight para la situaci√≥n actual. ';
  if(sinIdeacion)p+='Niega ideaci√≥n suicida, heteroagresiva o s√≠ntomas psic√≥ticos. ';
  else if(ideacionActiva.length)p+='Refiere '+icList(ideacionActiva).toLowerCase()+'. Riesgo clasificado como '+sev+'. '+(riesgoNotas?riesgoNotas+' ':'');
  if(analisis)p+=analisis+' ';
  if(intervencion.length)p+='Se realiza '+icList(intervencion)+'. ';
  if(plan.length)p+=icList(plan)+'. ';
  if(tratNotas)p+=tratNotas+' ';
  p=p.trim();

  setIcOut('ic-out-seg-texto',p);
  var wrap=document.getElementById('ic-output-wrap');
  if(wrap)wrap.scrollIntoView({behavior:'smooth',block:'start'});
}

function generarNotaIcEsp(){
  if(!icCurrentEsp||!icEspNotes[icCurrentEsp]){
    if(typeof toast==='function')toast('‚ö†Ô∏è Selecciona el tipo de nota especial');
    return;
  }
  setIcOut('ic-out-trat',icEspNotes[icCurrentEsp]);
  setIcOut('ic-out-sub','N/A ‚Äî Ver tratamiento.');
  setIcOut('ic-out-obj','N/A ‚Äî Ver tratamiento.');
  setIcOut('ic-out-resp','N/A ‚Äî Ver tratamiento.');
  var f4=document.getElementById('ic-out-4campos');
  var seg=document.getElementById('ic-out-seg');
  if(f4)f4.style.display='';
  if(seg)seg.style.display='none';
  var wrap=document.getElementById('ic-output-wrap');
  if(wrap)wrap.scrollIntoView({behavior:'smooth',block:'start'});
}

function setIcOut(id,text){
  var el=document.getElementById(id);
  if(!el)return;
  el.textContent=text;
  el.classList.remove('ph');
}

window.copiarCampoIC=function(id,btn){
  var el=document.getElementById(id);
  if(!el)return;
  navigator.clipboard.writeText(el.textContent).then(function(){
    btn.textContent='‚úì Copiado';btn.classList.add('done');
    setTimeout(function(){btn.textContent='Copiar';btn.classList.remove('done');},2000);
  });
};

window.copiarTodoIC=function(){
  var text;
  if(icCurrentMode==='seg'){
    var el=document.getElementById('ic-out-seg-texto');
    text=el?el.textContent:'';
  }else{
    var labels=['AN√ÅLISIS SUBJETIVO','AN√ÅLISIS OBJETIVO','RESPUESTA','TRATAMIENTO'];
    var ids=['ic-out-sub','ic-out-obj','ic-out-resp','ic-out-trat'];
    text=ids.map(function(id,i){
      var el=document.getElementById(id);
      return labels[i]+'\n'+(el?el.textContent:'');
    }).join('\n\n---\n\n');
  }
  navigator.clipboard.writeText(text).then(function(){if(typeof toast==='function')toast('üìã Nota copiada al portapapeles');});
};

window.limpiarFormIC=function(){
  if(!confirm('¬øLimpiar el formulario?'))return;
  document.querySelectorAll('#ic-form-view input[type=text], #ic-form-view textarea').forEach(function(i){i.value='';});
  document.querySelectorAll('#ic-form-view .ic-chip').forEach(function(c){c.classList.remove('on','on-r','on-g','on-a');});
  document.querySelectorAll('.sev-btn').forEach(function(s){s.classList.remove('on');});
  var rn=document.getElementById('ic-riesgo-nivel');if(rn)rn.value='';
  var ra=document.getElementById('ic-risk-alert');if(ra)ra.classList.remove('show');
  var wrap=document.getElementById('ic-output-wrap');if(wrap)wrap.style.display='none';
  icCurrentEsp=null;
  var ep=document.getElementById('ic-esp-preview');if(ep)ep.style.display='none';
};

let escolaridadLevel=5;
window.updateEscolaridad=(v)=>{escolaridadLevel=parseInt(v);};

// ‚îÄ‚îÄ MODO LECTURA ASISTIDA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.toggleAssisted=(on)=>{document.getElementById('page-tests').classList.toggle('assisted-mode',on);};

// ‚îÄ‚îÄ TEST NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showTest=(id)=>{
  document.querySelectorAll('.test-screen').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id==='home'?'tests-home':`test-${id}`);
  if(el)el.classList.add('active');
  if(id!=='home'){
    renderTestQuestions(id);
    const res=document.getElementById(`${id}-result`);
    if(res)res.style.display='none';
  }
};

// ‚îÄ‚îÄ TEST DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const freq4=['Para nada (0)','Varios d√≠as (1)','M√°s de la mitad de los d√≠as (2)','Casi todos los d√≠as (3)'];
const phq9Qs=['Poco inter√©s o placer en hacer cosas (perdi√≥ las ganas de hacer cosas que antes le gustaban)','Se ha sentido deca√≠do/a, deprimido/a o sin esperanza','Ha tenido dificultad para quedarse o mantenerse dormido/a, o ha dormido demasiado','Se ha sentido cansado/a o con poca energ√≠a','Poco apetito o ha comido en exceso','Se ha sentido mal consigo mismo/a, ha sentido que es un fracaso o que ha defraudado a su familia','Ha tenido dificultad para concentrarse en cosas como leer el peri√≥dico o ver televisi√≥n','¬øSe ha movido o hablado tan lento que otras personas lo han notado? O lo contrario ‚Äî ha estado tan inquieto/a que se ha movido mucho m√°s de lo normal','Ha tenido pensamientos de que ser√≠a mejor estar muerto/a o de hacerse da√±o'];
const gad7Qs=['Se ha sentido nervioso/a, ansioso/a o muy alterado/a','No ha podido dejar de preocuparse o no ha podido controlar sus preocupaciones','Se ha preocupado demasiado por distintas cosas','Ha tenido dificultad para relajarse','Ha estado tan inquieto/a que no pod√≠a quedarse quieto/a','Se ha molestado o irritado f√°cilmente','Ha sentido miedo como si algo terrible pudiera ocurrir'];

const hadsQs=[
  {q:'Me siento tenso/a o nervioso/a',opts:['Casi todo el d√≠a (3)','Gran parte del d√≠a (2)','De vez en cuando (1)','Nunca (0)'],type:'A'},
  {q:'Todav√≠a disfruto con lo que antes me gustaba',opts:['Como siempre (0)','No tanto como antes (1)','S√≥lo un poco (2)','Ya no disfruto con nada (3)'],type:'D'},
  {q:'Tengo una sensaci√≥n de miedo, como si algo horrible me fuera a suceder',opts:['Muy claramente y bastante fuerte (3)','S√≠, pero no muy fuerte (2)','Un poco, pero no me preocupa (1)','Nada (0)'],type:'A'},
  {q:'Puedo re√≠rme y ver el lado gracioso de las cosas',opts:['Al igual que siempre lo hac√≠a (0)','No tanto ahora (1)','Casi nunca (2)','Nunca (3)'],type:'D'},
  {q:'Tengo mi mente llena de preocupaciones',opts:['La mayor√≠a del tiempo (3)','Con bastante frecuencia (2)','De vez en cuando, aunque no muy a menudo (1)','S√≥lo ocasionalmente (0)'],type:'A'},
  {q:'Me siento alegre',opts:['Nunca (3)','No muy a menudo (2)','A veces (1)','Gran parte del d√≠a (0)'],type:'D'},
  {q:'Puedo estar sentado/a tranquilamente y sentirme relajado/a',opts:['Siempre (0)','Por lo general (1)','No muy a menudo (2)','Nunca (3)'],type:'A'},
  {q:'Me siento como si cada d√≠a estuviera m√°s lento/a',opts:['Por lo general, en todo momento (3)','Muy a menudo (2)','A veces (1)','Nunca (0)'],type:'D'},
  {q:'Tengo una sensaci√≥n extra√±a, como si tuviera mariposas en el est√≥mago',opts:['Nunca (0)','Ocasionalmente (1)','Con bastante frecuencia (2)','Muy a menudo (3)'],type:'A'},
  {q:'He perdido el inter√©s en mi apariencia personal',opts:['Totalmente (3)','No me preocupo tanto como debiera (2)','Es posible que no me cuide tanto (1)','Me preocupo al igual que siempre (0)'],type:'D'},
  {q:'Me siento inquieto/a como si no pudiera parar de moverme',opts:['Mucho (3)','Bastante (2)','No muy a menudo (1)','Nunca (0)'],type:'A'},
  {q:'Me siento optimista respecto al futuro',opts:['Igual que siempre (0)','Menos de lo que acostumbraba (1)','Mucho menos de lo que acostumbraba (2)','Nada (3)'],type:'D'},
  {q:'Me asaltan sentimientos repentinos de p√°nico',opts:['Muy frecuentemente (3)','Bastante a menudo (2)','No muy a menudo (1)','Nunca (0)'],type:'A'},
  {q:'Me alegro de antemano con las cosas que me gustan',opts:['Al igual que siempre (0)','Algo menos de lo que acostumbraba (1)','Mucho menos de lo que acostumbraba (2)','Casi nunca (3)'],type:'D'}
];

const mmseQs=[
  {q:'¬øEn qu√© a√±o estamos?',pts:1},{q:'¬øEn qu√© estaci√≥n del a√±o estamos?',pts:1},{q:'¬øEn qu√© mes estamos?',pts:1},{q:'¬øQu√© d√≠a de la semana es hoy?',pts:1},{q:'¬øQu√© d√≠a del mes es hoy?',pts:1},
  {q:'¬øEn qu√© pa√≠s estamos?',pts:1},{q:'¬øEn qu√© departamento (o ciudad) estamos?',pts:1},{q:'¬øEn qu√© municipio o barrio estamos?',pts:1},{q:'¬øEn qu√© lugar estamos ahora (hospital, cl√≠nica, casa)?',pts:1},{q:'¬øEn qu√© piso o habitaci√≥n estamos?',pts:1},
  {q:'Registro: Repita estas 3 palabras: CASA ‚Äì PERRO ‚Äì MESA (1 pto por cada una)',pts:3},
  {q:'Atenci√≥n: Reste de 7 en 7 empezando desde 100 (93, 86, 79, 72, 65) ‚Äî 1 pto por cada correcto, hasta 5',pts:5},
  {q:'Memoria: ¬øCu√°les eran las 3 palabras que le dije antes? (CASA, PERRO, MESA)',pts:3},
  {q:'Nominaci√≥n: Mostrar un reloj y un l√°piz ‚Äî ¬øQu√© es esto? (1 pto c/u)',pts:2},
  {q:'Repetici√≥n: "Ni s√≠, ni no, ni pero"',pts:1},
  {q:'Orden de 3 pasos: "Tome este papel con la mano derecha, d√≥blelo por la mitad y p√≥ngalo en el piso"',pts:3},
  {q:'Lectura: Mostrar papel con "CIERRE LOS OJOS" ‚Äî el paciente debe cerrarlos (omitir si analfabeta)',pts:1},
  {q:'Escritura: Pedir que escriba una frase completa (omitir si analfabeta)',pts:1},
  {q:'Copia: Pedir que copie dos pent√°gonos entrelazados (omitir si analfabeta)',pts:1}
];

const mocaQs=[
  {q:'Sendero alternante (Trazar: 1-A-2-B-3-C-4-D-5-E)',pts:1},{q:'Copia de cubo',pts:1},{q:'Reloj: contorno c√≠rculo',pts:1},{q:'Reloj: n√∫meros correctos',pts:1},{q:'Reloj: agujas correctas',pts:1},
  {q:'Nombrar animales: Le√≥n',pts:1},{q:'Nombrar animales: Rinoceronte',pts:1},{q:'Nombrar animales: Camello',pts:1},
  {q:'Memoria: Repetir CARA ‚Äì SEDA ‚Äì IGLESIA ‚Äì CLAVEL ‚Äì ROJO (no punt√∫a a√∫n)',pts:0},
  {q:'D√≠gitos directos (2-1-8-5-4)',pts:1},{q:'D√≠gitos inversos (7-4-2)',pts:1},
  {q:'Vigilancia: Golpear cuando escuche "A" en lista',pts:1},
  {q:'Resta: 100-7, luego -7 (5 veces: 4pts=3, 3pts=2, 2pts=1)',pts:3},
  {q:'Repetici√≥n: "El gato siempre se escond√≠a bajo el sof√°..."',pts:1},{q:'Repetici√≥n: "Juan siempre ayuda a sus amigos cuando ellos lo necesitan"',pts:1},
  {q:'Fluidez verbal: al menos 11 palabras con letra F en 1 minuto',pts:1},
  {q:'Abstracci√≥n: tren / bicicleta ‚Üí ¬øen qu√© se parecen?',pts:1},{q:'Abstracci√≥n: reloj / regla ‚Üí ¬øen qu√© se parecen?',pts:1},
  {q:'Recuerdo diferido: CARA (con o sin clave)',pts:1},{q:'Recuerdo diferido: SEDA',pts:1},{q:'Recuerdo diferido: IGLESIA',pts:1},{q:'Recuerdo diferido: CLAVEL',pts:1},{q:'Recuerdo diferido: ROJO',pts:1},
  {q:'Orientaci√≥n: Fecha (d√≠a, mes, a√±o)',pts:1},{q:'Orientaci√≥n: D√≠a de la semana',pts:1},{q:'Orientaci√≥n: Lugar y ciudad',pts:1}
];

const camQs=[
  {q:'C1 ‚Äî Inicio agudo y curso fluctuante: ¬øHubo un cambio agudo en el estado mental respecto al nivel basal? ¬øFluct√∫a durante el d√≠a?',opts:['S√≠','No']},
  {q:'C2 ‚Äî Inatenci√≥n: ¬øEl paciente tiene dificultad para mantener la atenci√≥n? ¬øSe distrae f√°cilmente?',opts:['S√≠','No']},
  {q:'C3 ‚Äî Pensamiento desorganizado: ¬øEl pensamiento del paciente es desorganizado o incoherente?',opts:['S√≠','No']},
  {q:'C4 ‚Äî Nivel de conciencia alterado: ¬øEl nivel de conciencia es diferente al normal (alerta)?',opts:['Hiperalerta','Somnoliento','Estuporoso','Normal']}
];

const cssrsQs=[
  {q:'1. ¬øHa deseado estar muerto/a o dormido/a y no despertar?',opts:['S√≠','No']},
  {q:'2. ¬øHa tenido pensamientos de hacerse da√±o o de quitarse la vida?',opts:['S√≠','No']},
  {q:'3. ¬øHa pensado en c√≥mo podr√≠a hacerse da√±o?',opts:['S√≠','No']},
  {q:'4. ¬øHa tenido pensamientos de quitarse la vida con alg√∫n plan?',opts:['S√≠','No']},
  {q:'5. ¬øHa tenido intenci√≥n de actuar seg√∫n esos pensamientos?',opts:['S√≠','No']},
  {q:'6. ¬øHa hecho algo para prepararse para quitarse la vida?',opts:['S√≠','No']}
];

const mmas4Qs=[
  {q:'¬øAlguna vez olvida tomar sus medicamentos?',opts:['S√≠ (1)','No (0)']},
  {q:'¬øA veces no presta atenci√≥n a las horas de tomar sus medicamentos?',opts:['S√≠ (1)','No (0)']},
  {q:'Cuando se siente bien, ¬ødeja alguna vez de tomar sus medicamentos?',opts:['S√≠ (1)','No (0)']},
  {q:'Cuando se siente mal con los medicamentos, ¬ødeja de tomarlos?',opts:['S√≠ (1)','No (0)']}
];

const dueloQs=[
  {q:'¬øTiene pensamientos frecuentes sobre la persona/cosa que perdi√≥ y estos le generan mucho dolor?',opts:['No (0)','A veces (1)','Con frecuencia (2)']},
  {q:'¬øSiente que le es dif√≠cil aceptar la p√©rdida?',opts:['No (0)','Un poco (1)','Mucho (2)']},
  {q:'¬øHa dejado de hacer actividades importantes (trabajo, familia, cuidado personal) desde la p√©rdida?',opts:['No (0)','Algo (1)','Mucho (2)']},
  {q:'¬øSiente que la vida no tiene sentido sin lo que perdi√≥?',opts:['No (0)','A veces (1)','S√≠ (2)']},
  {q:'¬øHa tenido pensamientos de hacerse da√±o o de no querer seguir viviendo desde la p√©rdida?',opts:['No (0)','Algunos pensamientos (1)','S√≠, con frecuencia (2)']}
];

// ‚îÄ‚îÄ RENDER TEST QUESTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.renderTestQuestions=(id)=>{
  const renders={phq9:renderFreq4,gad7:renderFreq4,hads:renderHADS,mmse:renderMMSE,moca:renderMoCA,cam:renderCAM,cssrs:renderCSSRS,mmas4:renderMMAS4,duelo:renderDuelo};
  if(renders[id])renders[id]();
};

function renderFreq4(id,questions){
  const tid=id||(document.querySelector('.test-screen.active')?.id?.replace('test-','')||'phq9');
  const qs=tid==='phq9'?phq9Qs:gad7Qs;
  const cont=document.getElementById(`${tid}-questions`);
  if(!cont)return;
  cont.innerHTML=qs.map((q,i)=>`<div class="test-question"><div class="test-question-num">Pregunta ${i+1}</div><div class="test-question-text">${q}</div><div class="test-options">${freq4.map((opt,v)=>`<div class="test-option"><input type="radio" name="${tid}_q${i}" id="${tid}_q${i}_${v}" value="${v}"><label class="test-option-label" for="${tid}_q${i}_${v}">${opt}</label></div>`).join('')}</div></div>`).join('');
}
window.renderFreq4=renderFreq4;

function renderHADS(){
  const cont=document.getElementById('hads-questions');
  if(!cont)return;
  cont.innerHTML=hadsQs.map((item,i)=>`<div class="test-question"><div class="test-question-num">Pregunta ${i+1} ‚Äî ${item.type==='A'?'Ansiedad':'Depresi√≥n'}</div><div class="test-question-text">${item.q}</div><div class="test-options">${item.opts.map((opt,v)=>`<div class="test-option"><input type="radio" name="hads_q${i}" id="hads_q${i}_${v}" value="${parseInt(opt.match(/\((\d)\)/)?.[1]??v)}"><label class="test-option-label" for="hads_q${i}_${v}">${opt}</label></div>`).join('')}</div></div>`).join('');
}
window.renderHADS=renderHADS;

function renderMMSE(){
  const cont=document.getElementById('mmse-questions');
  if(!cont)return;
  cont.innerHTML=mmseQs.map((item,i)=>`<div class="test-question"><div class="test-question-num">√çtem ${i+1} ¬∑ ${item.pts} pt${item.pts>1?'s':''}</div><div class="test-question-text">${item.q}</div><div class="test-options"><div class="test-option"><input type="radio" name="mmse_q${i}" id="mmse_q${i}_1" value="${item.pts}"><label class="test-option-label" for="mmse_q${i}_1">‚úÖ Correcto / Completo</label></div><div class="test-option"><input type="radio" name="mmse_q${i}" id="mmse_q${i}_0" value="0"><label class="test-option-label" for="mmse_q${i}_0">‚ùå Incorrecto / No pudo</label></div>${item.pts>1&&item.pts<5?Array.from({length:item.pts-1},(_, k)=>`<div class="test-option"><input type="radio" name="mmse_q${i}" id="mmse_q${i}_p${k+1}" value="${k+1}"><label class="test-option-label" for="mmse_q${i}_p${k+1}">‚ö†Ô∏è Parcial: ${k+1} pt${k+1>1?'s':''}</label></div>`).join(''):''}</div></div>`).join('');
}
window.renderMMSE=renderMMSE;

function renderMoCA(){
  const cont=document.getElementById('moca-questions');
  if(!cont)return;
  cont.innerHTML=mocaQs.map((item,i)=>`<div class="test-question"><div class="test-question-num">√çtem ${i+1}${item.pts>0?' ¬∑ '+item.pts+' pt'+(item.pts>1?'s':''):' ¬∑ No punt√∫a'}</div><div class="test-question-text">${item.q}</div>${item.pts>0?`<div class="test-options"><div class="test-option"><input type="radio" name="moca_q${i}" id="moca_q${i}_1" value="${item.pts}"><label class="test-option-label" for="moca_q${i}_1">‚úÖ Correcto</label></div><div class="test-option"><input type="radio" name="moca_q${i}" id="moca_q${i}_0" value="0"><label class="test-option-label" for="moca_q${i}_0">‚ùå Incorrecto</label></div>${item.pts===3?`<div class="test-option"><input type="radio" name="moca_q${i}" id="moca_q${i}_p1" value="1"><label class="test-option-label" for="moca_q${i}_p1">‚ö†Ô∏è 1 pt</label></div><div class="test-option"><input type="radio" name="moca_q${i}" id="moca_q${i}_p2" value="2"><label class="test-option-label" for="moca_q${i}_p2">‚ö†Ô∏è 2 pts</label></div>`:''}</div>`:''}</div>`).join('');
}
window.renderMoCA=renderMoCA;

function renderCAM(){
  const cont=document.getElementById('cam-questions');
  if(!cont)return;
  cont.innerHTML=camQs.map((item,i)=>`<div class="test-question"><div class="test-question-num">Criterio ${i+1}</div><div class="test-question-text">${item.q}</div><div class="test-options">${item.opts.map((opt,v)=>`<div class="test-option"><input type="radio" name="cam_q${i}" id="cam_q${i}_${v}" value="${opt}"><label class="test-option-label" for="cam_q${i}_${v}">${opt}</label></div>`).join('')}</div></div>`).join('');
}
window.renderCAM=renderCAM;

function renderCSSRS(){
  const cont=document.getElementById('cssrs-questions');
  if(!cont)return;
  cont.innerHTML=cssrsQs.map((item,i)=>`<div class="test-question"><div class="test-question-num">Pregunta ${i+1}</div><div class="test-question-text">${item.q}</div><div class="test-options">${item.opts.map((opt,v)=>`<div class="test-option"><input type="radio" name="cssrs_q${i}" id="cssrs_q${i}_${v}" value="${opt}"><label class="test-option-label" for="cssrs_q${i}_${v}">${opt}</label></div>`).join('')}</div></div>`).join('');
}
window.renderCSSRS=renderCSSRS;

function renderMMAS4(){
  const cont=document.getElementById('mmas4-questions');
  if(!cont)return;
  cont.innerHTML=mmas4Qs.map((item,i)=>`<div class="test-question"><div class="test-question-num">Pregunta ${i+1}</div><div class="test-question-text">${item.q}</div><div class="test-options">${item.opts.map((opt,v)=>`<div class="test-option"><input type="radio" name="mmas4_q${i}" id="mmas4_q${i}_${v}" value="${v}"><label class="test-option-label" for="mmas4_q${i}_${v}">${opt}</label></div>`).join('')}</div></div>`).join('');
}
window.renderMMAS4=renderMMAS4;

function renderDuelo(){
  const cont=document.getElementById('duelo-questions');
  if(!cont)return;
  cont.innerHTML=dueloQs.map((item,i)=>`<div class="test-question"><div class="test-question-num">Pregunta ${i+1}</div><div class="test-question-text">${item.q}</div><div class="test-options">${item.opts.map((opt,v)=>`<div class="test-option"><input type="radio" name="duelo_q${i}" id="duelo_q${i}_${v}" value="${parseInt(opt.match(/\((\d)\)/)?.[1]??v)}"><label class="test-option-label" for="duelo_q${i}_${v}">${opt}</label></div>`).join('')}</div></div>`).join('');
}
window.renderDuelo=renderDuelo;

// ‚îÄ‚îÄ CALCULAR RESULTADOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getScore(name,count){let s=0;for(let i=0;i<count;i++){const el=document.querySelector(`input[name="${name}_q${i}"]:checked`);if(el)s+=parseFloat(el.value)||0;}return s;}

function showResult(divId,score,maxScore,level,interpretation,extra){
  const colors={normal:'var(--success)',moderate:'var(--warning)',high:'var(--danger)',critical:'#7b1fa2'};
  const el=document.getElementById(divId);
  if(!el)return;
  el.style.display='block';
  el.innerHTML=`<div class="test-result ${level}"><div class="result-score" style="color:${colors[level]||'var(--text)'}">${score}${maxScore?' / '+maxScore:''}</div><div class="result-label" style="color:${colors[level]||'var(--text)'}">${interpretation.split('‚Äî')[0].trim()}</div><div class="result-interpretation">${interpretation}</div>${extra?`<div style="margin-top:12px;font-size:0.82rem;color:var(--text2)">${extra}</div>`:''}<div class="result-actions"><button class="btn btn-primary" onclick="guardarResultadoTest('${divId.replace('-result','')}',${score},'${level}',document.getElementById('test-pac-nombre').value,'${interpretation.split('‚Äî')[0].trim()}')">üíæ Guardar resultado</button><button class="btn btn-secondary" onclick="showTest('home')">‚Üê Nuevo test</button></div></div>`;
  el.scrollIntoView({behavior:'smooth',block:'center'});
}

window.calcPHQ9=()=>{
  const s=getScore('phq9',9);
  const q8=document.querySelector('input[name="phq9_q8"]:checked');
  const suicide=q8&&parseFloat(q8.value)>0;
  let level,interp;
  if(s<=4){level='normal';interp='Normal ‚Äî Sin depresi√≥n significativa';}
  else if(s<=9){level='moderate';interp='Leve ‚Äî Seguimiento, considerar psicoeducaci√≥n';}
  else if(s<=14){level='high';interp='Moderado ‚Äî Iniciar intervenci√≥n, considerar remisi√≥n a psiquiatr√≠a';}
  else if(s<=19){level='high';interp='Moderadamente grave ‚Äî Remitir a psiquiatr√≠a';}
  else{level='critical';interp='Grave ‚Äî Remisi√≥n urgente a psiquiatr√≠a';}
  const extra=suicide?'‚ö†Ô∏è <strong>ALERTA: Ideaci√≥n suicida presente (√≠tem 9 positivo)</strong> ‚Äî Evaluar con C-SSRS inmediatamente':'';
  showResult('phq9-result',s,27,level,interp,extra);
};

window.calcGAD7=()=>{
  const s=getScore('gad7',7);
  let level,interp;
  if(s<=4){level='normal';interp='Normal ‚Äî Sin ansiedad significativa';}
  else if(s<=9){level='moderate';interp='Leve ‚Äî Psicoeducaci√≥n y t√©cnicas de relajaci√≥n';}
  else if(s<=14){level='high';interp='Moderado ‚Äî Intervenci√≥n psicol√≥gica estructurada';}
  else{level='critical';interp='Grave ‚Äî Considerar remisi√≥n a psiquiatr√≠a';}
  showResult('gad7-result',s,21,level,interp,'');
};

window.calcHADS=()=>{
  let a=0,d=0;
  hadsQs.forEach((item,i)=>{const el=document.querySelector(`input[name="hads_q${i}"]:checked`);if(el){const v=parseFloat(el.value)||0;if(item.type==='A')a+=v;else d+=v;}});
  const total=a+d;
  const levelA=a<=7?'normal':a<=10?'moderate':'high';
  const levelD=d<=7?'normal':d<=10?'moderate':'high';
  const level=levelA==='high'||levelD==='high'?'high':levelA==='moderate'||levelD==='moderate'?'moderate':'normal';
  const interp=`Ansiedad: ${a}/21 (${levelA==='normal'?'Normal':levelA==='moderate'?'L√≠mite':'Caso probable'}) | Depresi√≥n: ${d}/21 (${levelD==='normal'?'Normal':levelD==='moderate'?'L√≠mite':'Caso probable'})`;
  showResult('hads-result',total,42,level,interp,'');
};

window.calcMMSE=()=>{
  let s=0;mmseQs.forEach((item,i)=>{const el=document.querySelector(`input[name="mmse_q${i}"]:checked`);if(el)s+=parseFloat(el.value)||0;});
  const cutoffs=[17,20,24];const cutoff=cutoffs[Math.min(escolaridadLevel,2)]??24;
  let level,interp;
  if(s>=cutoff){level='normal';interp=`Normal para su escolaridad ‚Äî Sin deterioro cognitivo sugerido (corte: ${cutoff})`;}
  else if(s>=18){level='moderate';interp=`Deterioro leve-moderado ‚Äî Corte ajustado por escolaridad: ${cutoff}`;}
  else if(s>=10){level='high';interp='Deterioro moderado ‚Äî Evaluaci√≥n neuropsicol√≥gica recomendada';}
  else{level='critical';interp='Deterioro grave ‚Äî Remitir a neurolog√≠a o psiquiatr√≠a';}
  const extra=escolaridadLevel<=1?'‚ö†Ô∏è Nota: paciente con baja escolaridad ‚Äî tolerar 3‚Äì4 pts menos. No penalizar √≠tems de escritura/lectura si nunca aprendi√≥.':'';
  showResult('mmse-result',s,30,level,interp,extra);
};

window.calcMoCA=()=>{
  let s=0;mocaQs.forEach((item,i)=>{if(item.pts>0){const el=document.querySelector(`input[name="moca_q${i}"]:checked`);if(el)s+=parseFloat(el.value)||0;}});
  if(escolaridadLevel<=3)s=Math.min(s+1,30);
  let level,interp;
  if(s>=26){level='normal';interp='Normal ‚Äî Sin deterioro cognitivo';}
  else if(s>=22){level='moderate';interp='Deterioro leve ‚Äî Seguimiento cl√≠nico';}
  else if(s>=18){level='high';interp='Deterioro moderado ‚Äî Evaluaci√≥n neuropsicol√≥gica';}
  else{level='critical';interp='Deterioro grave ‚Äî Remitir a neurolog√≠a';}
  const extra=escolaridadLevel<=3?'‚úÖ +1 punto aplicado por escolaridad ‚â§ bachillerato':'';
  showResult('moca-result',s,30,level,interp,extra);
};

window.calcCAM=()=>{
  const c1=document.querySelector('input[name="cam_q0"]:checked')?.value==='S√≠';
  const c2=document.querySelector('input[name="cam_q1"]:checked')?.value==='S√≠';
  const c3=document.querySelector('input[name="cam_q2"]:checked')?.value==='S√≠';
  const c4val=document.querySelector('input[name="cam_q3"]:checked')?.value;
  const c4=c4val&&c4val!=='Normal';
  const delirium=c1&&c2&&(c3||c4);
  const level=delirium?'critical':'normal';
  const interp=delirium?'‚ö†Ô∏è DELIRIUM POSITIVO ‚Äî Requiere evaluaci√≥n m√©dica urgente':'Sin criterios de delirium seg√∫n algoritmo CAM';
  showResult('cam-result','',null,level,interp,`C1 (inicio agudo): ${c1?'‚úÖ':'‚ùå'} | C2 (inatenci√≥n): ${c2?'‚úÖ':'‚ùå'} | C3 (pensamiento desorg.): ${c3?'‚úÖ':'‚ùå'} | C4 (conciencia alterada): ${c4?'‚úÖ':'‚ùå'}`);
};

window.calcCSSRS=()=>{
  const resp=[];for(let i=0;i<6;i++){const el=document.querySelector(`input[name="cssrs_q${i}"]:checked`);resp.push(el?.value==='S√≠');}
  let level,interp;
  if(resp[4]||resp[5]){level='critical';interp='RIESGO CR√çTICO ‚Äî √çtems 5‚Äì6 positivos. Evaluaci√≥n inmediata y protocolo de crisis';}
  else if(resp[3]){level='critical';interp='RIESGO ALTO ‚Äî √çtem 4 positivo (plan suicida). Intervenci√≥n urgente';}
  else if(resp[2]){level='high';interp='RIESGO MODERADO ‚Äî √çtem 3 positivo (m√©todo). Evaluaci√≥n detallada hoy';}
  else if(resp[1]){level='moderate';interp='RIESGO LEVE-MODERADO ‚Äî Ideaci√≥n activa sin plan. Seguimiento estrecho';}
  else if(resp[0]){level='moderate';interp='RIESGO BAJO-MODERADO ‚Äî Deseos pasivos de muerte. Psicoeducaci√≥n y seguimiento';}
  else{level='normal';interp='Sin ideaci√≥n suicida activa reportada';}
  showResult('cssrs-result','',null,level,interp,'');
};

window.calcMMAS4=()=>{
  const s=getScore('mmas4',4);
  let level,interp;
  if(s===0){level='normal';interp='Alta adherencia ‚Äî Continuar reforzando';}
  else if(s<=1){level='moderate';interp='Adherencia media ‚Äî Psicoeducaci√≥n sobre importancia del tratamiento';}
  else{level='high';interp='Baja adherencia ‚Äî Explorar barreras: costo, olvidos, efectos secundarios, red de apoyo';}
  showResult('mmas4-result',s,4,level,interp,'');
};

window.calcDuelo=()=>{
  let s=0;dueloQs.forEach((item,i)=>{const el=document.querySelector(`input[name="duelo_q${i}"]:checked`);if(el)s+=parseFloat(el.value)||0;});
  let level,interp;
  if(s<=3){level='normal';interp='Duelo normal ‚Äî Validaci√≥n emocional y seguimiento';}
  else if(s<=6){level='moderate';interp='Duelo complicado probable ‚Äî Intervenci√≥n psicol√≥gica recomendada';}
  else{level='critical';interp='Duelo complicado severo ‚Äî Intervenci√≥n urgente. Evaluar ideaci√≥n suicida con C-SSRS';}
  const extra=s>=8?'‚ö†Ô∏è Puntaje alto ‚Äî Aplicar C-SSRS por posible riesgo suicida asociado al duelo':'';
  showResult('duelo-result',s,10,level,interp,extra);
};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  renderTestQuestions('phq9');renderTestQuestions('gad7');renderTestQuestions('hads');
  renderTestQuestions('mmse');renderTestQuestions('moca');renderTestQuestions('cam');
  renderTestQuestions('cssrs');renderTestQuestions('mmas4');renderTestQuestions('duelo');
  try{document.getElementById('an-fecha').value=new Date().toISOString().split('T')[0];}catch(e){}
});
</script>

<!-- MODAL HISTORIAL PACIENTE -->
<div class="modal-overlay" id="modal-historial-ic" style="display:none;position:fixed;inset:0;background:rgba(26,23,20,0.5);z-index:300;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto">
  <div style="background:var(--surface);border-radius:16px;width:100%;max-width:740px;margin:auto;box-shadow:0 8px 40px rgba(26,23,20,0.18)">
    <div style="padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;position:sticky;top:0;background:var(--surface);border-radius:16px 16px 0 0;z-index:1">
      <div>
        <div style="font-family:'DM Serif Display',serif;font-size:1.1rem" id="mhic-title">üìÇ Historial del Paciente</div>
        <div style="font-size:0.73rem;color:var(--text3);margin-top:3px" id="mhic-sub"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
        <button class="btn btn-primary btn-sm" onclick="mhicNuevaNota()">‚úèÔ∏è Nueva nota</button>
        <button style="background:var(--surface2);border:none;border-radius:7px;padding:5px;cursor:pointer;display:flex;align-items:center" onclick="mhicCerrar()">
          <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
    <div id="mhic-body" style="padding:18px 22px;max-height:72vh;overflow-y:auto"></div>
  </div>
</div>

<!-- MODAL EDITAR/NUEVA NOTA -->
<div class="modal-overlay" id="modal-nota-edit" style="display:none;position:fixed;inset:0;background:rgba(26,23,20,0.5);z-index:400;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto">
  <div style="background:var(--surface);border-radius:16px;width:100%;max-width:660px;margin:auto;box-shadow:0 8px 40px rgba(26,23,20,0.18)">
    <div style="padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
      <div style="font-family:'DM Serif Display',serif;font-size:1.05rem" id="mne-title">Editar nota</div>
      <button style="background:var(--surface2);border:none;border-radius:7px;padding:5px;cursor:pointer;display:flex" onclick="mneCerrar()">
        <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div style="padding:18px 22px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
        <div class="form-group"><label>Fecha</label><input type="date" id="mne-fecha"></div>
        <div class="form-group"><label>Tipo</label>
          <select id="mne-tipo"><option value="IC Nueva">IC Nueva</option><option value="Seguimiento">Seguimiento</option><option value="Anamnesis">Anamnesis</option><option value="Nota especial">Nota especial</option></select>
        </div>
        <div class="form-group"><label>Riesgo suicida</label>
          <select id="mne-riesgo"><option value="">Sin clasificar</option><option value="BAJO">BAJO</option><option value="MEDIO">MEDIO</option><option value="ALTO">ALTO</option></select>
        </div>
        <div class="form-group"><label>Estado</label>
          <select id="mne-estado"><option value="respondida">Completada</option><option value="pendiente">Pendiente</option></select>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:10px"><label>An√°lisis Subjetivo</label><textarea id="mne-sub" rows="3" placeholder="Estado emocional, preocupaciones, citas textuales..."></textarea></div>
      <div class="form-group" style="margin-bottom:10px"><label>An√°lisis Objetivo</label><textarea id="mne-obj" rows="3" placeholder="Examen mental, h√°bitos, evaluaci√≥n de riesgo..."></textarea></div>
      <div class="form-group" style="margin-bottom:10px"><label>Respuesta / Impresi√≥n cl√≠nica</label><textarea id="mne-resp" rows="3" placeholder="Impresi√≥n diagn√≥stica, an√°lisis CC..."></textarea></div>
      <div class="form-group" style="margin-bottom:10px"><label>Tratamiento / Plan</label><textarea id="mne-trat" rows="3" placeholder="Intervenciones realizadas, plan..."></textarea></div>
      <div class="form-group"><label>Nota libre / Complementaria</label><textarea id="mne-nota" rows="3" placeholder="Nota en formato libre..."></textarea></div>
    </div>
    <div style="padding:12px 22px 18px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;align-items:center">
      <button class="btn btn-danger btn-sm" id="mne-del-btn" onclick="mneEliminar()" style="display:none;margin-right:auto">üóë Eliminar</button>
      <button class="btn btn-secondary" onclick="mneCerrar()">Cancelar</button>
      <button class="btn btn-primary" onclick="mneGuardar()">üíæ Guardar</button>
    </div>
  </div>
</div>

</body>
</html>
