<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suite Cl√≠nica | Luisa Fernanda Garc√©s Garc√≠a</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<!-- Firebase SDK (compat version - funciona con GitHub Pages) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// üîß REEMPLAZA ESTOS VALORES con los de tu proyecto Firebase
// Firebase Console ‚Üí Tu proyecto ‚Üí Configuracion ‚Üí SDK de configuracion
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyB-N6-kZ3_E9CxzKPom79TPJ1pBA3-M11c",
  authDomain: "consultorio-449a6.firebaseapp.com",
  projectId: "consultorio-449a6",
  storageBucket: "consultorio-449a6.firebasestorage.app",
  messagingSenderId: "853876080178",
  appId: "1:853876080178:web:a89b0d5b71ec077c66c62b"
};

let _firebaseDB = null;
try {
  firebase.initializeApp(FIREBASE_CONFIG);
  _firebaseDB = firebase.firestore();
  console.log("Firebase conectado correctamente");
} catch(e) {
  console.warn("Firebase no disponible:", e);
}

function showSyncBadge(msg, color){
  let el = document.getElementById("sync-badge");
  if(!el){
    el = document.createElement("div");
    el.id = "sync-badge";
    el.style.cssText = "position:fixed;bottom:70px;right:24px;padding:7px 16px;border-radius:20px;font-size:0.74rem;font-family:Lato,sans-serif;z-index:9998;transition:opacity 0.6s;pointer-events:none;";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.background = color || "rgba(100,48,0,0.85)";
  el.style.color = "#fff";
  el.style.opacity = "1";
  clearTimeout(el._t);
  el._t = setTimeout(function(){ el.style.opacity = "0"; }, 2800);
}

const DB = {
  _cache: {},
  get: function(k){
    if(this._cache[k] !== undefined) return this._cache[k];
    try { var v = localStorage.getItem(k); return v ? JSON.parse(v) : null; } catch(e){ return null; }
  },
  set: function(k, v){
    this._cache[k] = v;
    try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){}
    if(_firebaseDB){
      _firebaseDB.collection("suitedata").doc(k).set({ value: v })
        .then(function(){ showSyncBadge("Guardado en la nube", "#7ab87a"); })
        .catch(function(err){ console.warn("Error Firebase:", err); showSyncBadge("Error al guardar en nube", "#e57373"); });
    }
  },
  loadAll: function(){
    if(!_firebaseDB) return Promise.resolve(false);
    showSyncBadge("Sincronizando...", "#cd8e9d");
    var self = this;
    return _firebaseDB.collection("suitedata").get()
      .then(function(snap){
        snap.forEach(function(d){
          var v = d.data().value;
          self._cache[d.id] = v;
          try { localStorage.setItem(d.id, JSON.stringify(v)); } catch(e){}
        });
        showSyncBadge("Datos sincronizados", "#7ab87a");
        return true;
      })
      .catch(function(e){
        console.warn("Error cargando Firebase:", e);
        showSyncBadge("Sin conexion - usando datos locales", "#e57373");
        return false;
      });
  }
};
</script>
<style>
:root {
  --border: #cd8e9d;
  --bg: #fadae1;
  --text: #643000;
  --white: #fff8f9;
  --soft: #f5eaec;
  --strong: #a0536a;
  --success: #6aaa6a;
  --sidebar-w: 240px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Lato', sans-serif; background: var(--white); color: var(--text); display: flex; min-height: 100vh; }

/* SIDEBAR */
#sidebar {
  width: var(--sidebar-w); min-height: 100vh; background: var(--bg);
  border-right: 2px solid var(--border); display: flex; flex-direction: column;
  position: fixed; left: 0; top: 0; z-index: 100;
}
#sidebar .logo-area { padding: 20px 16px 14px; border-bottom: 1px solid var(--border); text-align: center; }
#sidebar .logo-area img { height: 70px; object-fit: contain; }
#sidebar .logo-area h2 { font-family: 'Playfair Display', serif; font-size: 0.82rem; color: var(--text); margin-top: 8px; line-height: 1.4; }
#sidebar .logo-area p { font-size: 0.65rem; color: var(--border); letter-spacing: 1.2px; text-transform: uppercase; margin-top: 2px; }

#sidebar nav { flex: 1; padding: 16px 0; }
.nav-section { font-size: 0.62rem; color: var(--border); letter-spacing: 1.5px; text-transform: uppercase; padding: 10px 18px 4px; }
.nav-btn {
  display: flex; align-items: center; gap: 10px;
  width: 100%; padding: 10px 18px; border: none;
  background: transparent; color: var(--text); font-family: 'Lato', sans-serif;
  font-size: 0.85rem; cursor: pointer; transition: all 0.2s; text-align: left;
}
.nav-btn .icon { font-size: 1.1rem; width: 22px; }
.nav-btn:hover { background: rgba(205,142,157,0.18); }
.nav-btn.active { background: var(--border); color: #fff; font-weight: 700; }

#sidebar .version { padding: 12px 18px; font-size: 0.65rem; color: var(--border); border-top: 1px solid var(--border); }

/* MAIN */
#main { margin-left: var(--sidebar-w); flex: 1; padding: 28px 32px; min-height: 100vh; }

.page { display: none; }
.page.active { display: block; }

/* PATIENT SELECTOR BAR */
.patient-bar {
  background: #fff; border: 1.5px solid var(--bg); border-radius: 14px;
  padding: 14px 20px; margin-bottom: 24px; display: flex;
  align-items: center; gap: 14px; flex-wrap: wrap;
}
.patient-bar label { font-size: 0.75rem; color: var(--strong); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.patient-bar select, .patient-bar input { border: 1.5px solid #e8d0d6; border-radius: 10px; padding: 7px 12px; font-family: 'Lato', sans-serif; font-size: 0.87rem; color: var(--text); background: var(--white); }
.patient-bar select:focus, .patient-bar input:focus { outline: none; border-color: var(--border); }

/* PAGE HEADER */
.page-header { margin-bottom: 24px; }
.page-header h1 { font-family: 'Playfair Display', serif; font-size: 1.6rem; color: var(--text); }
.page-header p { font-size: 0.83rem; color: var(--border); margin-top: 4px; }

/* CARDS */
.card { background: #fff; border: 1.5px solid var(--bg); border-radius: 16px; padding: 24px; margin-bottom: 18px; }
.sec-title { font-family: 'Playfair Display', serif; font-size: 1.05rem; color: var(--border); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--bg); }
.subsec { font-size: 0.78rem; font-weight: 700; color: var(--strong); text-transform: uppercase; letter-spacing: 0.5px; margin: 16px 0 8px; }

/* FORM */
.row { display: grid; gap: 14px; margin-bottom: 14px; }
.col2 { grid-template-columns: 1fr 1fr; }
.col3 { grid-template-columns: 1fr 1fr 1fr; }
.fg { display: flex; flex-direction: column; gap: 5px; }
label.lbl { font-size: 0.73rem; color: var(--strong); font-weight: 700; letter-spacing: 0.4px; text-transform: uppercase; }
input[type=text], input[type=date], input[type=number], input[type=email], input[type=tel], select, textarea {
  border: 1.5px solid #e8d0d6; border-radius: 10px; padding: 9px 13px;
  font-family: 'Lato', sans-serif; font-size: 0.88rem; color: var(--text);
  background: var(--white); transition: border-color 0.2s; width: 100%;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--border); }
textarea { resize: vertical; min-height: 80px; }
.checks { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 4px; }
.chk { display: flex; align-items: center; gap: 6px; font-size: 0.87rem; cursor: pointer; }
.chk input[type=checkbox] { accent-color: var(--border); width: 15px; height: 15px; }
.range-row { display: flex; align-items: center; gap: 12px; }
input[type=range] { accent-color: var(--border); flex: 1; }
.rval { background: var(--border); color: #fff; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.88rem; flex-shrink: 0; }

/* BUTTONS */
.btn { padding: 9px 20px; border-radius: 20px; border: 1.5px solid var(--border); font-family: 'Lato', sans-serif; font-size: 0.83rem; cursor: pointer; transition: all 0.2s; background: transparent; color: var(--text); }
.btn:hover { background: var(--border); color: #fff; }
.btn.primary { background: var(--border); color: #fff; }
.btn.primary:hover { background: var(--strong); border-color: var(--strong); }
.btn.success { background: var(--success); border-color: var(--success); color: #fff; }
.btn.danger { background: #e57373; border-color: #e57373; color: #fff; }
.btn-row { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; }

/* TABS */
.tab-nav { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 20px; }
.tab-btn { padding: 6px 14px; border-radius: 18px; border: 1.5px solid var(--border); background: transparent; color: var(--text); font-family: 'Lato', sans-serif; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
.tab-btn.active, .tab-btn:hover { background: var(--border); color: #fff; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* PATIENT CARDS (dashboard) */
.patient-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; margin-bottom: 20px; }
.patient-card { background: #fff; border: 1.5px solid var(--bg); border-radius: 16px; padding: 18px; cursor: pointer; transition: all 0.2s; }
.patient-card:hover { border-color: var(--border); box-shadow: 0 4px 16px rgba(205,142,157,0.18); }
.patient-card.selected { border-color: var(--border); background: var(--soft); }
.patient-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--text); margin-bottom: 4px; }
.patient-card .meta { font-size: 0.75rem; color: var(--border); }
.patient-card .badge { display: inline-block; background: var(--bg); color: var(--strong); border-radius: 10px; font-size: 0.68rem; padding: 2px 8px; margin-top: 6px; }

/* SESSION LIST */
.session-item { background: var(--soft); border-left: 4px solid var(--border); border-radius: 0 12px 12px 0; padding: 12px 16px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
.session-item:hover { background: var(--bg); }
.session-item h4 { font-size: 0.9rem; color: var(--text); font-weight: 700; }
.session-item p { font-size: 0.78rem; color: var(--strong); margin-top: 3px; }

/* SUMMARY BOX */
.summary-box { background: var(--soft); border: 1.5px solid var(--border); border-radius: 14px; padding: 20px; margin-top: 16px; white-space: pre-wrap; font-size: 0.88rem; line-height: 1.8; }

/* TESTS */
.test-question { margin-bottom: 18px; }
.test-question p { font-size: 0.9rem; margin-bottom: 8px; line-height: 1.5; }
.likert { display: flex; gap: 8px; flex-wrap: wrap; }
.likert label { display: flex; align-items: center; gap: 4px; font-size: 0.78rem; cursor: pointer; background: var(--soft); border: 1.5px solid var(--bg); border-radius: 10px; padding: 5px 10px; transition: all 0.2s; }
.likert label:hover { border-color: var(--border); }
.likert input[type=radio] { accent-color: var(--border); }
.result-bar { background: var(--bg); border-radius: 10px; height: 12px; margin: 6px 0; overflow: hidden; }
.result-bar-fill { background: var(--border); height: 100%; border-radius: 10px; transition: width 0.6s; }
.result-schema { background: #fff; border: 1px solid var(--bg); border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; }
.result-schema h4 { font-size: 0.82rem; color: var(--strong); font-weight: 700; margin-bottom: 6px; }

/* TOAST */
#toast { position: fixed; bottom: 28px; right: 28px; background: var(--strong); color: #fff; padding: 12px 22px; border-radius: 20px; font-size: 0.85rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 9999; }
#toast.show { opacity: 1; }

/* MODAL */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(100,48,0,0.18); z-index: 500; align-items: center; justify-content: center; }
.modal-overlay.open { display: flex; }
.modal { background: #fff; border-radius: 20px; padding: 28px; max-width: 480px; width: 90%; border: 1.5px solid var(--border); }
.modal h3 { font-family: 'Playfair Display', serif; color: var(--border); margin-bottom: 16px; }

/* PROGRESS */
.progress-wrap { background: var(--bg); border-radius: 10px; height: 6px; margin-bottom: 4px; overflow: hidden; }
.progress-bar { background: var(--border); height: 100%; border-radius: 10px; transition: width 0.4s; }
.progress-label { font-size: 0.72rem; color: var(--border); text-align: right; margin-bottom: 18px; }

/* FASE TABLE */
.fase-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.fase-table th { background: var(--bg); color: var(--text); font-size: 0.76rem; text-transform: uppercase; letter-spacing: 0.5px; padding: 9px 11px; text-align: left; border: 1px solid var(--border); }
.fase-table td { padding: 9px 11px; border: 1px solid #f0d8de; font-size: 0.84rem; vertical-align: top; }
.fase-table tr:nth-child(even) td { background: #fdf0f3; }
.fase-table input, .fase-table textarea { border: 1px solid #e8d0d6; border-radius: 6px; padding: 5px 8px; font-size: 0.82rem; background: white; width: 100%; }
.fase-table textarea { min-height: 50px; }

/* STAT CARDS */
.stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 14px; margin-bottom: 20px; }
.stat-card { background: #fff; border: 1.5px solid var(--bg); border-radius: 14px; padding: 16px; text-align: center; }
.stat-card .num { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--border); }
.stat-card .lbl2 { font-size: 0.72rem; color: var(--strong); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

/* ‚îÄ‚îÄ DOCUMENTOS ‚îÄ‚îÄ */
.doc-tipos { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:14px; margin-bottom:28px; }
.doc-tipo-btn { background:#fff; border:2px solid var(--bg); border-radius:16px; padding:18px 16px; cursor:pointer; text-align:left; transition:all 0.2s; }
.doc-tipo-btn:hover { border-color:var(--border); box-shadow:0 4px 16px rgba(205,142,157,0.2); }
.doc-tipo-btn.selected { border-color:var(--border); background:var(--soft); }
.doc-tipo-btn .dt-icon { font-size:1.6rem; margin-bottom:8px; }
.doc-tipo-btn .dt-nombre { font-weight:700; font-size:.88rem; color:var(--text); margin-bottom:3px; }
.doc-tipo-btn .dt-desc { font-size:.72rem; color:var(--strong); line-height:1.5; }
.doc-form { background:#fff; border:1.5px solid var(--bg); border-radius:16px; padding:24px; margin-bottom:18px; }
.doc-form-title { font-family:'Playfair Display',serif; font-size:1rem; color:var(--border); margin-bottom:18px; border-bottom:1px solid var(--bg); padding-bottom:10px; }
.doc-field-group { margin-bottom:16px; }
.doc-field-group .lbl { display:block; font-size:.72rem; font-weight:700; color:var(--strong); text-transform:uppercase; letter-spacing:.4px; margin-bottom:5px; }
.doc-field-group textarea { width:100%; border:1.5px solid #e8d0d6; border-radius:10px; padding:10px 13px; font-family:'Lato',sans-serif; font-size:.88rem; color:var(--text); resize:vertical; min-height:80px; }
.doc-field-group input, .doc-field-group select { width:100%; border:1.5px solid #e8d0d6; border-radius:10px; padding:9px 13px; font-family:'Lato',sans-serif; font-size:.88rem; color:var(--text); }
.doc-field-group textarea:focus, .doc-field-group input:focus, .doc-field-group select:focus { outline:none; border-color:var(--border); }
.doc-preview { background:var(--soft); border:1.5px solid var(--border); border-radius:14px; padding:22px; font-size:.88rem; line-height:1.8; color:var(--text); margin-top:16px; white-space:pre-wrap; font-family:'Georgia',serif; }
.doc-preview h3 { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--border); text-align:center; margin-bottom:6px; }
.doc-preview .firma-preview { margin-top:32px; border-top:1px solid var(--border); padding-top:16px; font-size:.82rem; }

.fin-screen { display:none; }
.fin-screen.active { display:block; }
.fin-tab-nav { display:flex; gap:0; border-bottom:1.5px solid var(--border); margin-bottom:24px; background:#fff; border-radius:14px 14px 0 0; overflow:hidden; }
.fin-tab { padding:12px 20px; font-size:0.78rem; font-weight:500; letter-spacing:0.08em; text-transform:uppercase; color:var(--border); cursor:pointer; border:none; background:none; border-bottom:3px solid transparent; margin-bottom:-1.5px; transition:all 0.2s; }
.fin-tab.active { color:var(--text); border-bottom-color:var(--text); background:var(--soft); }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:14px; margin-bottom:20px; }
.stat-card-fin { background:#fff; border:1.5px solid var(--bg); border-radius:14px; padding:16px; }
.stat-card-fin.verde { border-left:4px solid #6aaa6a; }
.stat-card-fin.rojo { border-left:4px solid #e57373; }
.stat-card-fin.rosa { border-left:4px solid var(--border); }
.stat-label { font-size:0.72rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--strong); margin-bottom:6px; }
.stat-value { font-family:'Playfair Display',serif; font-size:1.5rem; color:var(--text); }
.stat-sub { font-size:0.72rem; color:var(--border); margin-top:3px; }
.form-card { background:#fff; border:1.5px solid var(--bg); border-radius:16px; padding:22px; margin-bottom:18px; }
.form-title { font-family:'Playfair Display',serif; font-size:1rem; color:var(--border); margin-bottom:16px; }
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.field { display:flex; flex-direction:column; gap:5px; }
.field label { font-size:0.72rem; font-weight:700; color:var(--strong); text-transform:uppercase; letter-spacing:0.4px; }
.field input, .field select { border:1.5px solid #e8d0d6; border-radius:10px; padding:9px 13px; font-family:'Lato',sans-serif; font-size:0.88rem; color:var(--text); background:var(--white); }
.field input:focus, .field select:focus { outline:none; border-color:var(--border); }
.pago-item { display:flex; align-items:center; gap:12px; background:#fff; border:1.5px solid var(--bg); border-radius:12px; padding:14px 16px; margin-bottom:10px; }
.pago-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.pago-dot.ingreso { background:#6aaa6a; }
.pago-dot.gasto { background:#e57373; }
.pago-info { flex:1; }
.pago-nombre { font-size:0.9rem; font-weight:600; color:var(--text); }
.pago-meta { font-size:0.75rem; color:var(--strong); margin-top:2px; }
.pago-monto { font-family:'Playfair Display',serif; font-size:1rem; font-weight:600; white-space:nowrap; }
.pago-monto.ingreso { color:#6aaa6a; }
.pago-monto.gasto { color:#e57373; }
.pago-actions { display:flex; gap:6px; }
.icon-btn { background:none; border:1.5px solid var(--bg); border-radius:8px; width:30px; height:30px; cursor:pointer; font-size:0.85rem; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.icon-btn:hover { background:var(--bg); }
.icon-btn.btn-danger:hover { background:#fdecea; border-color:#e57373; }
.metodo-badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:0.68rem; font-weight:600; background:var(--bg); color:var(--strong); margin-left:4px; }
.deudor-item { display:flex; align-items:center; justify-content:space-between; background:#fff; border:1.5px solid var(--bg); border-radius:12px; padding:14px 18px; margin-bottom:10px; }
.deudor-nombre { font-weight:700; font-size:0.9rem; }
.deudor-monto { font-family:'Playfair Display',serif; font-size:1.1rem; color:#e57373; }
.mes-nav { display:flex; align-items:center; gap:12px; margin-bottom:20px; }
.mes-nav h2 { font-family:'Playfair Display',serif; font-size:1.3rem; font-weight:400; flex:1; text-transform:capitalize; }
.arrow { width:34px; height:34px; border-radius:50%; border:1.5px solid var(--border); background:white; cursor:pointer; font-size:1.1rem; transition:background 0.2s; }
.arrow:hover { background:var(--bg); }
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(100,48,0,0.2); z-index:500; align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:#fff; border-radius:20px; padding:28px; max-width:420px; width:90%; border:1.5px solid var(--border); }
.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
.modal-title { font-family:'Playfair Display',serif; font-size:1.1rem; color:var(--border); }
.modal-close { background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--strong); }
.recibo { background:var(--soft); border-radius:12px; padding:18px; margin-bottom:18px; }
.recibo-logo { text-align:center; margin-bottom:12px; }
.recibo-logo p { font-family:'Playfair Display',serif; font-size:1rem; color:var(--text); }
.recibo-logo small { font-size:0.72rem; color:var(--border); }
.recibo-divider { border:none; border-top:1px solid var(--border); margin:10px 0; }
.recibo-fila { display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:6px; }
.recibo-total { display:flex; justify-content:space-between; font-size:1rem; font-weight:700; color:var(--text); margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
.btn-wa { background:#25D366; color:white; border:none; border-radius:20px; padding:9px 18px; font-family:'Lato',sans-serif; font-size:0.83rem; cursor:pointer; display:flex; align-items:center; gap:7px; }
.btn-wa svg { width:16px; height:16px; fill:white; }
.btn-secondary-fin { background:white; color:var(--text); border:1.5px solid var(--border); border-radius:20px; padding:9px 18px; font-family:'Lato',sans-serif; font-size:0.83rem; cursor:pointer; }

/* ‚îÄ‚îÄ AGENDA ‚îÄ‚îÄ */
.ag-tab-nav { display:flex; gap:0; border-bottom:1.5px solid var(--border); margin-bottom:24px; background:#fff; border-radius:14px 14px 0 0; overflow:hidden; }
.ag-tab { padding:12px 20px; font-size:0.78rem; font-weight:500; letter-spacing:0.08em; text-transform:uppercase; color:var(--border); cursor:pointer; border:none; background:none; border-bottom:3px solid transparent; margin-bottom:-1.5px; transition:all 0.2s; }
.ag-tab.active { color:var(--text); border-bottom-color:var(--text); background:var(--soft); }
.cita-card { background:white; border:1.5px solid var(--border); border-radius:14px; padding:18px 22px; margin-bottom:12px; position:relative; overflow:hidden; transition:box-shadow 0.2s; }
.cita-card:hover { box-shadow:0 4px 18px rgba(205,142,157,0.2); }
.cita-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background:var(--border); border-radius:14px 0 0 14px; }
.cita-hora { font-size:0.75rem; font-weight:500; letter-spacing:0.1em; text-transform:uppercase; color:var(--border); margin-bottom:4px; }
.cita-nombre { font-family:'Playfair Display',serif; font-size:1.15rem; font-weight:600; margin-bottom:2px; }
.cita-desc { font-size:0.82rem; color:var(--strong); margin-bottom:10px; }
.ag-tag { display:inline-block; padding:3px 10px; border-radius:20px; font-size:0.7rem; font-weight:600; letter-spacing:0.05em; margin-bottom:8px; }
.ag-tag.virtual { background:#e8f0fe; color:#3b5bdb; }
.ag-tag.presencial { background:#e8f5e9; color:#2e7d32; }
.ag-tag.admin { background:#fff3e0; color:#e65100; }
.wa-box { background:var(--soft); border:1.5px solid var(--border); border-radius:12px; padding:14px 16px; font-size:0.87rem; line-height:1.65; position:relative; margin-top:10px; display:none; }
.wa-box.show { display:block; }
.wa-texto { display:block; white-space:pre-line; padding-right:70px; }
.copy-badge { position:absolute; top:10px; right:12px; background:var(--border); color:white; border:none; border-radius:20px; padding:4px 14px; font-size:0.72rem; cursor:pointer; font-family:'Lato',sans-serif; transition:all 0.2s; }
.copy-badge.copied { background:#7ab87a; }
.dia-label { font-size:0.75rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--border); padding-left:4px; margin-bottom:8px; margin-top:18px; }
.ag-empty { text-align:center; padding:48px 20px; color:var(--border); }
.ag-empty .emoji { font-size:2.2rem; margin-bottom:10px; }

  #sidebar { width: 200px; }
  #main { margin-left: 200px; padding: 16px; }
  .col2, .col3 { grid-template-columns: 1fr; }
}
@media(max-width: 560px) {
  #sidebar { position: static; width: 100%; min-height: auto; border-right: none; border-bottom: 2px solid var(--border); }
  #sidebar nav { display: flex; flex-wrap: wrap; padding: 8px; }
  .nav-section { display: none; }
  .nav-btn { width: auto; padding: 7px 12px; font-size: 0.75rem; }
  #main { margin-left: 0; }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="logo-area">
    <img id="logo-img" src="" alt="Logo">
    <h2>Luisa Fernanda Garc√©s Garc√≠a</h2>
    <p>Psic√≥loga ¬∑ TP 174366</p>
  </div>
  <nav>
    <div class="nav-section">Principal</div>
    <button class="nav-btn active" onclick="goPage('dashboard')"><span class="icon">üè†</span> Inicio</button>
    <button class="nav-btn" onclick="goPage('pacientes')"><span class="icon">üë§</span> Pacientes</button>

    <div class="nav-section">Cl√≠nico</div>
    <button class="nav-btn" onclick="goPage('anamnesis')"><span class="icon">üìã</span> Anamnesis</button>
    <button class="nav-btn" onclick="goPage('plan')"><span class="icon">üó∫Ô∏è</span> Plan de Tratamiento</button>
    <button class="nav-btn" onclick="goPage('sesiones')"><span class="icon">üìù</span> Notas de Sesi√≥n</button>

    <div class="nav-section">Evaluaci√≥n</div>
    <button class="nav-btn" onclick="goPage('tests')"><span class="icon">üß™</span> Tests</button>
    <button class="nav-btn" onclick="goPage('seguimiento')"><span class="icon">üìä</span> Seguimiento</button>

    <div class="nav-section">Gesti√≥n</div>
    <button class="nav-btn" onclick="goPage('agenda')"><span class="icon">üìÖ</span> Agenda</button>
    <button class="nav-btn" onclick="goPage('finanzas')"><span class="icon">üí∞</span> Finanzas</button>
    <button class="nav-btn" onclick="goPage('documentos')"><span class="icon">üìÑ</span> Documentos</button>
  </nav>
  <div class="version">
    <div style="margin-bottom:8px;font-size:0.65rem;color:var(--border)">Suite Cl√≠nica v1.0 ¬∑ 2025</div>
    <button class="btn" onclick="exportarJSON()" style="width:100%;margin-bottom:6px;font-size:0.72rem;padding:7px 10px">‚¨áÔ∏è Exportar respaldo</button>
    <button class="btn" onclick="document.getElementById('import-input').click()" style="width:100%;font-size:0.72rem;padding:7px 10px">‚¨ÜÔ∏è Importar respaldo</button>
    <input type="file" id="import-input" accept=".json" style="display:none" onchange="importarJSON(event)">
  </div>
</aside>

<!-- MAIN -->
<main id="main">

<!-- ========== DASHBOARD ========== -->
<div class="page active" id="page-dashboard">
  <div class="page-header">
    <h1>Bienvenida, Luisa Fernanda üå∏</h1>
    <p>Resumen general de tu pr√°ctica cl√≠nica</p>
  </div>
  <div class="stat-grid" id="dash-stats"></div>
  <div class="card">
    <div class="sec-title">Pacientes Recientes</div>
    <div id="dash-recent-patients"></div>
  </div>
  <div class="card">
    <div class="sec-title">√öltimas Sesiones</div>
    <div id="dash-recent-sessions"></div>
  </div>
</div>

<!-- ========== PACIENTES ========== -->
<div class="page" id="page-pacientes">
  <div class="page-header">
    <h1>Gesti√≥n de Pacientes</h1>
    <p>Crea y administra los expedientes de tus pacientes</p>
  </div>
  <div class="card">
    <div class="sec-title">Nuevo Paciente</div>
    <div class="row col3">
      <div class="fg"><label class="lbl">Nombre completo *</label><input type="text" id="np-nombre"></div>
      <div class="fg"><label class="lbl">Fecha de nacimiento</label><input type="date" id="np-fnac"></div>
      <div class="fg"><label class="lbl">G√©nero</label><select id="np-genero"><option value="">‚Äî</option><option>Femenino</option><option>Masculino</option><option>No binario</option><option>Prefiero no decir</option></select></div>
    </div>
    <div class="row col3">
      <div class="fg"><label class="lbl">Tel√©fono</label><input type="tel" id="np-tel"></div>
      <div class="fg"><label class="lbl">Email</label><input type="email" id="np-email"></div>
      <div class="fg"><label class="lbl">Ocupaci√≥n</label><input type="text" id="np-ocup"></div>
    </div>
    <div class="btn-row">
      <button class="btn primary" onclick="crearPaciente()">+ Crear Paciente</button>
    </div>
  </div>
  <div class="card">
    <div class="sec-title">Pacientes Registrados</div>
    <div class="patient-grid" id="lista-pacientes"></div>
  </div>
</div>

<!-- ========== ANAMNESIS ========== -->
<div class="page" id="page-anamnesis">
  <div class="page-header">
    <h1>Anamnesis</h1>
    <p>Historia cl√≠nica completa del paciente</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="an-sel-pac" onchange="loadAnamnesis()"></select>
    <button class="btn primary" onclick="guardarAnamnesis()">üíæ Guardar</button>
    <button class="btn" onclick="exportarAnamnesis()">‚¨áÔ∏è Exportar RTF</button>
  </div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('an','datos')">I. Datos Personales</button>
    <button class="tab-btn" onclick="switchTab('an','motivo')">II. Motivo Consulta</button>
    <button class="tab-btn" onclick="switchTab('an','historia')">III. Historia Cl√≠nica</button>
    <button class="tab-btn" onclick="switchTab('an','cogcond')">IV. Evaluaci√≥n</button>
    <button class="tab-btn" onclick="switchTab('an','sustancias')">V. Sustancias</button>
    <button class="tab-btn" onclick="switchTab('an','alimentaria')">VI. Alimentaria</button>
    <button class="tab-btn" onclick="switchTab('an','sueno')">VII. Sue√±o</button>
    <button class="tab-btn" onclick="switchTab('an','trauma')">VIII. Trauma</button>
    <button class="tab-btn" onclick="switchTab('an','social')">IX. Red Social</button>
    <button class="tab-btn" onclick="switchTab('an','metas')">X. Metas</button>
  </div>

  <!-- I. DATOS -->
  <div class="tab-content active" id="an-datos">
    <div class="card">
      <div class="sec-title">I. Datos Personales</div>
      <div style="background:var(--soft);border:1.5px solid var(--bg);border-radius:12px;padding:16px 20px;margin-bottom:18px;display:flex;align-items:center;gap:12px">
        <span style="font-size:1.6rem">üë§</span>
        <div>
          <div style="font-family:'Playfair Display',serif;font-size:1.05rem;color:var(--text)" id="an-pac-nombre-disp">‚Äî</div>
          <div style="font-size:0.75rem;color:var(--strong);margin-top:3px" id="an-pac-meta-disp">‚Äî</div>
          <div style="font-size:0.72rem;color:var(--border);margin-top:2px">Datos tomados del perfil del paciente ¬∑ <a href="#" onclick="goPageDirect('pacientes');return false;" style="color:var(--border)">Editar en Pacientes ‚Üí</a></div>
        </div>
      </div>
      <div class="row col2">
        <div class="fg"><label class="lbl">Fecha de consulta</label><input type="date" id="an-fecha"></div>
        <div class="fg"><label class="lbl">Estado civil</label><select id="an-estado"><option value="">‚Äî</option><option>Soltero/a</option><option>Casado/a</option><option>Uni√≥n libre</option><option>Divorciado/a</option><option>Viudo/a</option></select></div>
      </div>
      <div class="row col3">
        <div class="fg"><label class="lbl">Nivel educativo</label><select id="an-edu"><option value="">‚Äî</option><option>Primaria</option><option>Secundaria</option><option>T√©cnico</option><option>Universitario</option><option>Posgrado</option></select></div>
        <div class="fg"><label class="lbl">Estrato</label><select id="an-estrato"><option value="">‚Äî</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
        <div class="fg"><label class="lbl">Ciudad</label><input type="text" id="an-ciudad"></div>
      </div>
      <div class="row col2"><div class="fg"><label class="lbl">Contacto de emergencia</label><input type="text" id="an-emergN" placeholder="Nombre y relaci√≥n"></div><div class="fg"><label class="lbl">Tel√©fono emergencia</label><input type="tel" id="an-emergT"></div></div>
      <div class="fg"><label class="lbl">Modalidad de atenci√≥n</label>
        <div class="checks">
          <label class="chk"><input type="radio" name="an-modalidad" value="Presencial"> Presencial</label>
          <label class="chk"><input type="radio" name="an-modalidad" value="Virtual"> Virtual</label>
          <label class="chk"><input type="radio" name="an-modalidad" value="Mixta"> Mixta</label>
        </div>
      </div>
    </div>
  </div>

  <!-- II. MOTIVO -->
  <div class="tab-content" id="an-motivo">
    <div class="card">
      <div class="sec-title">II. Motivo de Consulta</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Motivo principal (en palabras del paciente)</label><textarea id="an-motivo"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">¬øPor qu√© consultar ahora?</label><textarea id="an-decision"></textarea></div>
      <div class="row col2"><div class="fg"><label class="lbl">Duraci√≥n del problema</label><input type="text" id="an-duracion" placeholder="Ej: 6 meses"></div><div class="fg"><label class="lbl">Intentos previos de soluci√≥n</label><input type="text" id="an-intentos"></div></div>
      <div class="fg"><label class="lbl">Intensidad percibida (1‚Äì10)</label>
        <div class="range-row">
          <input type="range" id="an-intensidad" min="1" max="10" value="5" oninput="document.getElementById('an-ival').textContent=this.value">
          <div class="rval" id="an-ival">5</div>
        </div>
      </div>
    </div>
  </div>

  <!-- III. HISTORIA -->
  <div class="tab-content" id="an-historia">
    <div class="card">
      <div class="sec-title">III. Historia Cl√≠nica</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Diagn√≥sticos previos</label><textarea id="an-dx"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Tratamientos anteriores</label><textarea id="an-ttoPrev"></textarea></div>
      <div class="row col2"><div class="fg"><label class="lbl">Hospitalizaciones</label><select id="an-hosp"><option>No</option><option>S√≠</option></select></div><div class="fg"><label class="lbl">Detalles hospitalizaciones</label><input type="text" id="an-hospD"></div></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Medicaci√≥n actual</label><textarea id="an-med" placeholder="Nombre, dosis, prescriptor"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Historia del desarrollo</label><textarea id="an-desarrollo"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Antecedentes familiares de salud mental</label><textarea id="an-famMental"></textarea></div>
      <div class="fg"><label class="lbl">Relaci√≥n familiar actual</label><textarea id="an-relFam"></textarea></div>
    </div>
  </div>

  <!-- IV. EVALUACI√ìN -->
  <div class="tab-content" id="an-cogcond">
    <div class="card">
      <div class="sec-title">IV. Evaluaci√≥n Cognitivo-Conductual-Emocional</div>
      <div class="subsec">A. √Årea Cognitiva</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Pensamientos autom√°ticos</label><textarea id="an-pens"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Creencias nucleares</label><textarea id="an-creencias"></textarea></div>
      <div class="subsec">B. √Årea Conductual</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Conductas problema</label><textarea id="an-conductas"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Actividades placenteras</label><textarea id="an-placer"></textarea></div>
      <div class="subsec">C. √Årea Emocional</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Emoci√≥n predominante</label><input type="text" id="an-emociones"></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">S√≠ntomas f√≠sicos</label><textarea id="an-sinFis"></textarea></div>
      <div class="fg"><label class="lbl">Factores de mantenimiento</label><textarea id="an-mant"></textarea></div>
    </div>
  </div>

  <!-- V. SUSTANCIAS -->
  <div class="tab-content" id="an-sustancias">
    <div class="card">
      <div class="sec-title">V. Consumo de Sustancias</div>
      <div class="row col2"><div class="fg"><label class="lbl">Alcohol</label><select id="an-salc"><option>No</option><option>Ocasional</option><option>Frecuente</option><option>Dependencia</option></select></div><div class="fg"><label class="lbl">Detalle alcohol</label><input type="text" id="an-salcD"></div></div>
      <div class="row col2"><div class="fg"><label class="lbl">Tabaco</label><select id="an-stab"><option>No</option><option>Ocasional</option><option>Frecuente</option><option>Dependencia</option></select></div><div class="fg"><label class="lbl">Detalle tabaco</label><input type="text" id="an-stabD"></div></div>
      <div class="row col2"><div class="fg"><label class="lbl">Cannabis</label><select id="an-scan"><option>No</option><option>Ocasional</option><option>Frecuente</option><option>Dependencia</option></select></div><div class="fg"><label class="lbl">Detalle cannabis</label><input type="text" id="an-scanD"></div></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Otras sustancias</label><textarea id="an-sotras"></textarea></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Observaciones generales</label><textarea id="an-sobs"></textarea></div>
    </div>
  </div>

  <!-- VI. ALIMENTARIA -->
  <div class="tab-content" id="an-alimentaria">
    <div class="card">
      <div class="sec-title">VI. Conducta Alimentaria</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Conductas de riesgo alimentario</label><textarea id="an-alCond"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Imagen corporal percibida</label><textarea id="an-alImag"></textarea></div>
      <div class="row col2"><div class="fg"><label class="lbl">Peso / Talla</label><input type="text" id="an-alPeso"></div><div class="fg"><label class="lbl">Relaci√≥n emocional con la comida</label><input type="text" id="an-alEmoc"></div></div>
    </div>
  </div>

  <!-- VII. SUE√ëO -->
  <div class="tab-content" id="an-sueno">
    <div class="card">
      <div class="sec-title">VII. H√°bitos de Sue√±o</div>
      <div class="row col2"><div class="fg"><label class="lbl">Calidad del sue√±o</label><select id="an-suCal"><option>‚Äî</option><option>Buena</option><option>Regular</option><option>Mala</option><option>Muy mala</option></select></div><div class="fg"><label class="lbl">Horas promedio</label><input type="number" id="an-suHoras" min="0" max="24"></div></div>
      <div class="row col2"><div class="fg"><label class="lbl">Hora de acostarse</label><input type="text" id="an-suAcost" placeholder="Ej: 11pm"></div><div class="fg"><label class="lbl">Hora de levantarse</label><input type="text" id="an-suLev" placeholder="Ej: 7am"></div></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Alteraciones del sue√±o</label><textarea id="an-suAlter" placeholder="Insomnio, pesadillas, apnea..."></textarea></div>
      <div class="fg" style="margin-top:14px"><label class="lbl">Observaciones</label><textarea id="an-suObs"></textarea></div>
    </div>
  </div>

  <!-- VIII. TRAUMA -->
  <div class="tab-content" id="an-trauma">
    <div class="card">
      <div class="sec-title">VIII. Historia de Trauma</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Eventos referidos</label><textarea id="an-trEv"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Descripci√≥n del impacto</label><textarea id="an-trImp"></textarea></div>
      <div class="fg"><label class="lbl">Atenci√≥n previa por trauma</label><textarea id="an-trAten"></textarea></div>
    </div>
  </div>

  <!-- IX. SOCIAL -->
  <div class="tab-content" id="an-social">
    <div class="card">
      <div class="sec-title">IX. Red de Apoyo Social</div>
      <div class="row col2"><div class="fg"><label class="lbl">Calidad de la red</label><select id="an-raCal"><option>‚Äî</option><option>S√≥lida</option><option>Moderada</option><option>Fr√°gil</option><option>Ausente</option></select></div><div class="fg"><label class="lbl">¬øAislamiento?</label><select id="an-raAis"><option>No</option><option>Leve</option><option>Moderado</option><option>Severo</option></select></div></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Personas de confianza</label><textarea id="an-raPers"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Calidad de relaciones interpersonales</label><textarea id="an-raRel"></textarea></div>
      <div class="fg"><label class="lbl">Apoyo disponible en crisis</label><textarea id="an-raCrisis"></textarea></div>
    </div>
  </div>

  <!-- X. METAS -->
  <div class="tab-content" id="an-metas">
    <div class="card">
      <div class="sec-title">X. Metas y Observaciones Cl√≠nicas</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Meta corto plazo (1 mes)</label><textarea id="an-mCorto"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Meta mediano plazo (3 meses)</label><textarea id="an-mMedio"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Meta largo plazo (6+ meses)</label><textarea id="an-mLargo"></textarea></div>
      <div class="subsec">Observaciones del Terapeuta</div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Estilo de afrontamiento</label><textarea id="an-oAfront"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Actitud hacia la terapia</label><textarea id="an-oActit"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Fortalezas detectadas</label><textarea id="an-oFortal"></textarea></div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Factores de riesgo</label><textarea id="an-oRiesgo"></textarea></div>
      <div class="fg"><label class="lbl">Notas adicionales</label><textarea id="an-oNotas"></textarea></div>
    </div>
    <div class="btn-row">
      <button class="btn primary" onclick="guardarAnamnesis()">üíæ Guardar Anamnesis</button>
      <button class="btn" onclick="exportarAnamnesis()">‚¨áÔ∏è Exportar RTF</button>
    </div>
  </div>
</div>

<!-- ========== PLAN DE TRATAMIENTO ========== -->
<div class="page" id="page-plan">
  <div class="page-header">
    <h1>Plan de Tratamiento</h1>
    <p>Dise√±a el plan terap√©utico personalizado</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="pl-sel-pac" onchange="loadPlan()"></select>
    <button class="btn primary" onclick="guardarPlan()">üíæ Guardar</button>
    <button class="btn" onclick="exportarPlan()">‚¨áÔ∏è Exportar PDF</button>
  </div>

  <div class="card">
    <div class="sec-title">Informaci√≥n General</div>
    <div class="row col3">
      <div class="fg"><label class="lbl">Fecha de inicio</label><input type="date" id="pl-fecha"></div>
      <div class="fg"><label class="lbl">Modalidad</label><select id="pl-modalidad"><option>Presencial</option><option>Virtual</option><option>Mixta</option></select></div>
      <div class="fg"><label class="lbl">Frecuencia</label><select id="pl-frecuencia"><option>Semanal</option><option>Quincenal</option><option>Mensual</option></select></div>
    </div>
    <div class="fg"><label class="lbl">Diagn√≥stico de trabajo (CIE-11 / DSM-5)</label><textarea id="pl-dx" style="min-height:60px"></textarea></div>
  </div>

  <div class="card">
    <div class="sec-title">Objetivo General del Proceso</div>
    <div class="fg"><textarea id="pl-objetivo" style="min-height:90px" placeholder="Describe el objetivo terap√©utico central en lenguaje claro para el paciente..."></textarea></div>
  </div>

  <div class="card">
    <div class="sec-title">Fases del Proceso</div>
    <table class="fase-table" id="pl-fases-tabla">
      <thead><tr><th>#</th><th>Fase</th><th>Objetivos</th><th>T√©cnicas</th><th>Semanas</th></tr></thead>
      <tbody id="pl-fases-body">
        <tr><td>1</td><td><input type="text" placeholder="Evaluaci√≥n"></td><td><textarea placeholder="Establecer alianza, evaluar..."></textarea></td><td><textarea placeholder="Entrevista, psicoeducaci√≥n..."></textarea></td><td><input type="text" placeholder="1-3"></td></tr>
        <tr><td>2</td><td><input type="text" placeholder="Intervenci√≥n"></td><td><textarea placeholder="Modificar patrones..."></textarea></td><td><textarea placeholder="Reestructuraci√≥n cognitiva..."></textarea></td><td><input type="text" placeholder="4-10"></td></tr>
        <tr><td>3</td><td><input type="text" placeholder="Mantenimiento"></td><td><textarea placeholder="Consolidar avances..."></textarea></td><td><textarea placeholder="Prevenci√≥n de reca√≠das..."></textarea></td><td><input type="text" placeholder="11-14"></td></tr>
      </tbody>
    </table>
    <button class="btn" style="margin-top:10px" onclick="addFaseRow()">+ Agregar Fase</button>
  </div>

  <div class="card">
    <div class="sec-title">Tareas Intersesi√≥n</div>
    <div class="fg" style="margin-bottom:14px"><label class="lbl">Tareas para casa (semanas 1‚Äì4)</label><textarea id="pl-t1"></textarea></div>
    <div class="fg"><label class="lbl">Tareas para casa (semanas 5+)</label><textarea id="pl-t2"></textarea></div>
  </div>

  <div class="card">
    <div class="sec-title">Recursos y Herramientas</div>
    <div class="row col2">
      <div class="fg"><label class="lbl">Materiales / lecturas</label><textarea id="pl-mat"></textarea></div>
      <div class="fg"><label class="lbl">Apps recomendadas</label><textarea id="pl-apps"></textarea></div>
    </div>
    <div class="fg"><label class="lbl">Contacto de emergencia para el paciente</label><input type="text" id="pl-emerg"></div>
  </div>

  <div class="btn-row">
    <button class="btn primary" onclick="guardarPlan()">üíæ Guardar Plan</button>
    <button class="btn" onclick="exportarPlan()">‚¨áÔ∏è Exportar PDF</button>
  </div>
</div>

<!-- ========== NOTAS DE SESI√ìN ========== -->
<div class="page" id="page-sesiones">
  <div class="page-header">
    <h1>Notas de Sesi√≥n</h1>
    <p>Registra cada sesi√≥n y genera el resumen para el paciente</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="ses-sel-pac" onchange="loadSesiones()"></select>
    <button class="btn primary" onclick="nuevaSesion()">+ Nueva Sesi√≥n</button>
  </div>

  <div style="display:grid; grid-template-columns:260px 1fr; gap:20px">
    <div>
      <div class="card" style="padding:16px">
        <div class="sec-title" style="font-size:0.9rem">Sesiones</div>
        <div id="lista-sesiones"></div>
      </div>
    </div>
    <div id="sesion-form" style="display:none">
      <div class="card">
        <div class="sec-title" id="ses-form-title">Nueva Sesi√≥n</div>
        <div class="row col3">
          <div class="fg"><label class="lbl">Fecha</label><input type="date" id="ses-fecha"></div>
          <div class="fg"><label class="lbl">Sesi√≥n N¬∞</label><input type="number" id="ses-num" min="1"></div>
          <div class="fg"><label class="lbl">Duraci√≥n (min)</label><input type="number" id="ses-dur" value="50"></div>
        </div>
        <div class="fg" style="margin-bottom:14px"><label class="lbl">Estado emocional al inicio (1‚Äì10)</label>
          <div class="range-row">
            <input type="range" id="ses-estado" min="1" max="10" value="5" oninput="document.getElementById('ses-eval').textContent=this.value">
            <div class="rval" id="ses-eval">5</div>
          </div>
        </div>
        <div class="fg" style="margin-bottom:14px"><label class="lbl">Temas trabajados en sesi√≥n</label><textarea id="ses-temas" style="min-height:100px"></textarea></div>
        <div class="fg" style="margin-bottom:14px"><label class="lbl">Intervenciones y t√©cnicas utilizadas</label><textarea id="ses-inter"></textarea></div>
        <div class="fg" style="margin-bottom:14px"><label class="lbl">Avances y observaciones cl√≠nicas</label><textarea id="ses-avances"></textarea></div>
        <div class="fg" style="margin-bottom:14px"><label class="lbl">Tarea para casa acordada</label><textarea id="ses-tarea" placeholder="Tarea espec√≠fica acordada con el paciente..."></textarea></div>
        <div class="fg" style="margin-bottom:14px"><label class="lbl">Acuerdos para la pr√≥xima sesi√≥n</label><textarea id="ses-acuerdos"></textarea></div>
        <div class="fg"><label class="lbl">Notas confidenciales (solo tuyas, no van al resumen)</label><textarea id="ses-notas-priv"></textarea></div>
      </div>
      <div class="card">
        <div class="sec-title">üì§ Resumen para el Paciente</div>
        <p style="font-size:0.82rem; color:var(--strong); margin-bottom:14px">Vista previa del documento que recibir√° el paciente. No incluye tus notas confidenciales.</p>
        <button class="btn primary" onclick="generarResumen()" style="margin-bottom:16px">‚ú® Generar Resumen</button>
        <div class="summary-box" id="ses-resumen-box" style="display:none"></div>
        <div class="btn-row" id="ses-export-btns" style="display:none">
          <button class="btn" onclick="exportarResumenPDF()">‚¨áÔ∏è Descargar PDF</button>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn primary" onclick="guardarSesion()">üíæ Guardar Sesi√≥n</button>
      </div>
    </div>
    <div id="sesion-placeholder" style="display:flex; align-items:center; justify-content:center; color:var(--border); font-size:0.9rem; padding:40px">
      Selecciona un paciente y crea o abre una sesi√≥n
    </div>
  </div>
</div>

<!-- ========== TESTS ========== -->
<div class="page" id="page-tests">
  <div class="page-header">
    <h1>Tests de Evaluaci√≥n</h1>
    <p>Aplica y registra los instrumentos de evaluaci√≥n</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="tst-sel-pac"></select>
    <label>Test:</label>
    <select id="tst-sel" onchange="loadTest()">
      <option value="">‚Äî Seleccionar ‚Äî</option>
      <option value="phq9">PHQ-9 (Depresi√≥n)</option>
      <option value="gad7">GAD-7 (Ansiedad)</option>
      <option value="ysq">YSQ-L3 (Esquemas - Young)</option>
      <option value="smi">SMI (Modos - Young)</option>
    </select>
    <button class="btn primary" onclick="guardarTest()">üíæ Guardar Resultado</button>
  </div>
  <div id="test-container"></div>
  <div id="test-resultados" style="display:none">
    <div class="card">
      <div class="sec-title" id="res-titulo">Resultados</div>
      <div id="res-content"></div>
      <div class="btn-row">
        <button class="btn" onclick="exportarTestPDF()">‚¨áÔ∏è Exportar PDF</button>
      </div>
    </div>
    <div class="card">
      <div class="sec-title">Historial de Tests</div>
      <div id="test-historial"></div>
    </div>
  </div>
</div>

<!-- ========== SEGUIMIENTO ========== -->
<div class="page" id="page-seguimiento">
  <div class="page-header">
    <h1>Seguimiento</h1>
    <p>Evoluci√≥n y progreso del paciente a lo largo del tiempo</p>
  </div>
  <div class="patient-bar">
    <label>Paciente:</label>
    <select id="seg-sel-pac" onchange="loadSeguimiento()"></select>
  </div>
  <div class="stat-grid" id="seg-stats"></div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
      <div class="sec-title" style="margin-bottom:0;border-bottom:none;padding-bottom:0">Evoluci√≥n del Estado Emocional por Sesi√≥n</div>
      <button class="btn primary" onclick="exportarEvolucionPDF()">üå∏ Generar Entregable para Paciente</button>
    </div>
    <canvas id="seg-chart" height="100"></canvas>
  </div>
  <div class="card">
    <div class="sec-title">Historial de Sesiones</div>
    <div id="seg-sesiones-lista"></div>
  </div>
  <div class="card">
    <div class="sec-title">Resultados de Tests</div>
    <div id="seg-tests-lista"></div>
  </div>
</div>

<!-- ========== AGENDA ========== -->
<div class="page" id="page-agenda">
  <div class="page-header" style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div>
      <h1>Mi Agenda</h1>
      <p>Citas y eventos del consultorio</p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" style="font-size:.78rem;padding:7px 16px" onclick="document.getElementById('ics-input').click()">üì• Importar desde Google Calendar (.ics)</button>
      <input type="file" id="ics-input" accept=".ics" style="display:none" onchange="importarICS(event)">
      <button class="btn danger" style="font-size:.78rem;padding:7px 16px" onclick="agLimpiarTodo()">üóë Limpiar todos</button>
    </div>
  </div>
  <div class="ag-tab-nav">
    <button class="ag-tab active" onclick="agSwitchTab('hoy',this)">Hoy</button>
    <button class="ag-tab" onclick="agSwitchTab('manana',this)">Ma√±ana</button>
    <button class="ag-tab" onclick="agSwitchTab('semana',this)">Esta semana</button>
  </div>
  <div class="card" style="padding:14px 20px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div id="ag-fecha-titulo" style="font-family:'Playfair Display',serif;font-size:1.1rem"></div>
    <div style="display:flex;gap:8px">
      <button class="arrow" onclick="agCambiarDia(-1)" id="ag-prev">‚Äπ</button>
      <button class="arrow" onclick="agCambiarDia(1)" id="ag-next">‚Ä∫</button>
    </div>
  </div>
  <div id="ag-container"></div>
  <div class="card" style="margin-top:24px">
    <div class="sec-title">‚ûï Agregar evento</div>
    <div class="row col3">
      <div class="fg"><label class="lbl">T√≠tulo</label><input type="text" id="ag-nuevo-titulo" placeholder="Ej: Sesi√≥n con Mar√≠a"></div>
      <div class="fg"><label class="lbl">Fecha y hora inicio</label><input type="datetime-local" id="ag-nuevo-inicio"></div>
      <div class="fg"><label class="lbl">Hora fin</label><input type="datetime-local" id="ag-nuevo-fin"></div>
    </div>
    <div class="row col2">
      <div class="fg"><label class="lbl">Tipo</label>
        <select id="ag-nuevo-tipo">
          <option value="virtual">Virtual</option>
          <option value="presencial">Presencial</option>
          <option value="admin">Administrativo</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Descripci√≥n</label><input type="text" id="ag-nuevo-desc" placeholder="Nota opcional"></div>
    </div>
    <div class="btn-row"><button class="btn primary" onclick="agAgregarEvento()">+ Guardar evento</button></div>
  </div>
</div>

<!-- ========== FINANZAS ========== -->
<div class="page" id="page-finanzas">
  <div class="page-header">
    <h1>Finanzas</h1>
    <p>Control de ingresos, gastos y pagos pendientes</p>
  </div>
  <div class="fin-tab-nav">
    <button class="fin-tab active" onclick="finSwitchTab('resumen',this)">Resumen</button>
    <button class="fin-tab" onclick="finSwitchTab('registrar',this)">Registrar</button>
    <button class="fin-tab" onclick="finSwitchTab('historial',this)">Historial</button>
    <button class="fin-tab" onclick="finSwitchTab('deudores',this)">Pendientes</button>
  </div>

  <!-- RESUMEN -->
  <div class="fin-screen active" id="fin-resumen">
    <div class="mes-nav">
      <button class="arrow" onclick="cambiarMes(-1)">‚Äπ</button>
      <h2 id="mesTitle"></h2>
      <button class="arrow" onclick="cambiarMes(1)">‚Ä∫</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card-fin verde"><div class="stat-label">Ingresos</div><div class="stat-value" id="stat-ingresos">$0</div><div class="stat-sub" id="stat-ingresos-n">0 sesiones</div></div>
      <div class="stat-card-fin rojo"><div class="stat-label">Gastos</div><div class="stat-value" id="stat-gastos">$0</div><div class="stat-sub" id="stat-gastos-n">0 registros</div></div>
      <div class="stat-card-fin rosa"><div class="stat-label">Ganancia neta</div><div class="stat-value" id="stat-neta">$0</div><div class="stat-sub">este mes</div></div>
      <div class="stat-card-fin"><div class="stat-label">Pendientes</div><div class="stat-value" id="stat-pendientes">$0</div><div class="stat-sub" id="stat-pendientes-n">0 pacientes</div></div>
    </div>
    <div id="resumen-lista"></div>
  </div>

  <!-- REGISTRAR -->
  <div class="fin-screen" id="fin-registrar">
    <div class="form-card">
      <div class="form-title">üå∏ Registrar pago de paciente</div>
      <div class="form-grid">
        <div class="field"><label>Nombre del paciente</label><input type="text" id="r_paciente" placeholder="Ej: Mar√≠a Gonz√°lez"></div>
        <div class="field"><label>Fecha</label><input type="date" id="r_fecha"></div>
        <div class="field"><label>Tipo de sesi√≥n</label>
          <select id="r_tipo">
            <option value="80000">Sesi√≥n individual ¬∑ $80.000</option>
            <option value="140000">Pareja / Familia ¬∑ $140.000</option>
            <option value="140000b">Evaluaci√≥n individual ¬∑ $140.000</option>
            <option value="160000">Evaluaci√≥n pareja ¬∑ $160.000</option>
            <option value="custom">Otro monto</option>
          </select>
        </div>
        <div class="field"><label>M√©todo de pago</label>
          <select id="r_metodo">
            <option value="efectivo">Efectivo</option>
            <option value="nu">Nu</option>
            <option value="davibank">Davibank</option>
            <option value="nequi">Nequi</option>
            <option value="breve">Breve</option>
          </select>
        </div>
        <div class="field" id="campo-monto-custom" style="display:none"><label>Monto personalizado</label><input type="number" id="r_monto_custom" placeholder="Ej: 100000"></div>
        <div class="field"><label>Estado</label>
          <select id="r_estado">
            <option value="pagado">Pagado ‚úì</option>
            <option value="pendiente">Pendiente de pago</option>
          </select>
        </div>
      </div>
      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" onclick="registrarPago()">Guardar pago</button>
        <button class="btn" onclick="registrarYRecibo()">Guardar + generar recibo</button>
      </div>
    </div>
    <div class="form-card">
      <div class="form-title">üõí Registrar gasto</div>
      <div class="form-grid">
        <div class="field"><label>Descripci√≥n</label><input type="text" id="g_desc" placeholder="Ej: Papel, marcadores..."></div>
        <div class="field"><label>Fecha</label><input type="date" id="g_fecha"></div>
        <div class="field"><label>Monto</label><input type="number" id="g_monto" placeholder="Ej: 25000"></div>
        <div class="field"><label>Categor√≠a</label>
          <select id="g_cat">
            <option>Materiales y papeler√≠a</option>
            <option>Plataformas o apps</option>
            <option>Publicidad</option>
            <option>Arriendo</option>
            <option>Otro</option>
          </select>
        </div>
      </div>
      <button class="btn primary" style="margin-top:16px" onclick="registrarGasto()">Guardar gasto</button>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div class="fin-screen" id="fin-historial">
    <div class="mes-nav">
      <button class="arrow" onclick="cambiarMes(-1)">‚Äπ</button>
      <h2 id="mesTitle2"></h2>
      <button class="arrow" onclick="cambiarMes(1)">‚Ä∫</button>
    </div>
    <div id="historial-lista"></div>
  </div>

  <!-- DEUDORES -->
  <div class="fin-screen" id="fin-deudores">
    <h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:20px">Pacientes con pago pendiente</h2>
    <div id="deudores-lista"></div>
  </div>
</div>

<!-- MODAL RECIBO -->
<div class="modal-overlay" id="modalOverlay" onclick="cerrarModal(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Recibo de pago</div>
      <button class="modal-close" onclick="cerrarModalBtn()">‚úï</button>
    </div>
    <div class="recibo" id="reciboContent"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn-wa" onclick="enviarReciboWA()">
        <svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
      <button class="btn-secondary-fin" onclick="cerrarModalBtn()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ========== DOCUMENTOS ========== -->
<div class="page" id="page-documentos">
  <div class="page-header">
    <h1>Documentos Cl√≠nicos</h1>
    <p>Genera certificados e informes profesionales en Word (.docx)</p>
  </div>

  <!-- PASO 1: Tipo de documento -->
  <div class="card">
    <div class="sec-title">1Ô∏è‚É£ Selecciona el tipo de documento</div>
    <div class="doc-tipos" id="doc-tipos-grid"></div>
  </div>

  <!-- PASO 2: Paciente -->
  <div class="card" id="doc-paso2" style="display:none">
    <div class="sec-title">2Ô∏è‚É£ Datos del paciente</div>
    <div class="row col2">
      <div class="doc-field-group">
        <label class="lbl">Seleccionar paciente del expediente</label>
        <select id="doc-sel-pac" onchange="docCargarPaciente()">
          <option value="">‚Äî O ingresa los datos manualmente ‚Äî</option>
        </select>
      </div>
      <div class="doc-field-group">
        <label class="lbl">Tratamiento (La se√±ora / El se√±or / etc.)</label>
        <input type="text" id="doc-tratamiento" placeholder="La se√±ora / El se√±or">
      </div>
    </div>
    <div class="row col2">
      <div class="doc-field-group">
        <label class="lbl">Nombre completo del paciente *</label>
        <input type="text" id="doc-pac-nombre" placeholder="Nombre completo">
      </div>
      <div class="doc-field-group">
        <label class="lbl">C√©dula de ciudadan√≠a *</label>
        <input type="text" id="doc-pac-cc" placeholder="N√∫mero de c√©dula">
      </div>
    </div>
    <div class="row col2">
      <div class="doc-field-group">
        <label class="lbl">Ciudad de expedici√≥n CC</label>
        <input type="text" id="doc-pac-ciudad" placeholder="Medell√≠n" value="Medell√≠n">
      </div>
      <div class="doc-field-group">
        <label class="lbl">Fecha de nacimiento</label>
        <input type="date" id="doc-pac-fnac">
      </div>
    </div>
  </div>

  <!-- PASO 3: Contenido espec√≠fico seg√∫n tipo -->
  <div class="card" id="doc-paso3" style="display:none">
    <div class="sec-title" id="doc-paso3-titulo">3Ô∏è‚É£ Contenido del documento</div>
    <div id="doc-campos-especificos"></div>
  </div>

  <!-- PASO 4: Vista previa y descarga -->
  <div class="card" id="doc-paso4" style="display:none">
    <div class="sec-title">4Ô∏è‚É£ Vista previa y descarga</div>
    <div id="doc-preview-box" class="doc-preview"></div>
    <div class="btn-row" style="margin-top:18px">
      <button class="btn primary" onclick="docGenerar()">‚¨áÔ∏è Descargar Word (.docx)</button>
      <button class="btn" onclick="docActualizarPreview()">üîÑ Actualizar vista previa</button>
    </div>
    <p style="font-size:.75rem;color:var(--strong);margin-top:10px">‚ö†Ô∏è El archivo Word se descarga listo para editar y firmar. Puedes ajustar el texto antes de imprimir.</p>
  </div>
</div>

</main>

<!-- TOAST -->
<div id="toast"></div>

<!-- MODAL NEW PATIENT -->
<div class="modal-overlay" id="modal-pac">
  <div class="modal">
    <h3>Nuevo Paciente</h3>
    <div class="fg" style="margin-bottom:12px"><label class="lbl">Nombre completo *</label><input type="text" id="m-nombre"></div>
    <div class="btn-row">
      <button class="btn" onclick="document.getElementById('modal-pac').classList.remove('open')">Cancelar</button>
      <button class="btn primary" onclick="crearPacienteModal()">Crear</button>
    </div>
  </div>
</div>

<script>
// ===================== LOGO =====================
(function(){
  const LOGO_B64 = '/9j/4AAQSkZJRgABAgAAAQABAAD/wAARCAH4AfgDACIAAREBAhEB/9sAQwAIBgYHBgUIBwcHCQkICgwUDQwLCwwZEhMPFB0aHx4dGhwcICQuJyAiLCMcHCg3KSwwMTQ0NB8nOT04MjwuMzQy/9sAQwEJCQkMCwwYDQ0YMiEcITIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIy/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMAAAERAhEAPwD36iiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAUUUCigBKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAFFFAooASiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAUUUCigBKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAFFFAooASiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAUUUCigBKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAFFFAooASiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKZLKsS5Y0APpC6r1YD8azZbqSTgEqvt1/OoDzQaqk3ubIYEcEGlrGVijAqce9aFtciUbW4cfrSTFKm46lmiiimZhRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFBIA56UAFFV/OeT/Uplf77HCn6ev6D3qrdQz3MqWrXBCspaQxqBlRgY5z1J/IGgaV2WDf2wyd5YDqyIWUfUgYqwjpLGHjZWVhkMpyCPrVY28sKfJdsAB/y0RSoH4AfzrKGoPbXYkjQXEMhCyNbq20seAwz8o54PzHOR6UilG+x0FFZsOr+epZbK6wOGHyEqfQqGyD+FWIb+2nDbJfmQfMrAqy/VTyKZPK10J5ZFiQs1ZcsrSuWb8B2Ap08xmfJ+6OgqKk2b06dtWFFFFI1ClVirAjqOaSigDXikEsYYd6fWdaS+XJsbhW/Q1o0zlnHlYUUUUyAopGYKMsQAPWs2XXLZXMduslzIOCIRkA+7HgfnQNJvY06KxhqGoSn5YbeAf8ATRmc/kAB+tTo+psuVlsXP+6y/wBTQU4NbmlRWeb68hP+kWDFR/Hbv5g/IgH8gasW15b3iFoJA2OGHQqfQg8g/WgmzLFFFFAgooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBRRQKKAEooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiigkKMkgD3NABVcj7RI2f9Uhxj+83f8B0+v0ps95FFE7B1LAHAHOT2qrCbdoEDyy5xxtdl/kRz6nuc0FKLsalZs11Ha6hcO+T+5iCooyzEs/A9ScdPaopdT/s9C07maADiQL8wPow6fQ/n61DbPnVRdXRTzZITsUDIiAI4B7k7uT9c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sJ2qFUkc4ySOOMmuoAwKKKSjYbd9BAqgkgDJ6mlooqhBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFACiigUUAJRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAoooFFACUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFACiigUUAJRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAoooFFACUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAlFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFACiigUUAJRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAoooFFACUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAKKKBRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAYoxRRQAUUUUAf/2Q==';
  document.getElementById('logo-img').src = 'data:image/png;base64,' + LOGO_B64;
})();

// ===================== STORAGE ‚Äî DB definido en el <head> con Firebase =====================
// DB ya esta definido arriba junto con Firebase. Solo se inicializan los datos al arrancar.

// ===================== PATIENTS =====================
function getPacientes(){ return DB.get('pacientes') || []; }
function savePacientes(p){ DB.set('pacientes',p); }

function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

function crearPaciente(){
  const nombre = document.getElementById('np-nombre').value.trim();
  if(!nombre){ toast('Ingresa el nombre del paciente'); return; }
  const pacs = getPacientes();
  const nuevo = {
    id: genId(),
    nombre,
    fnac: document.getElementById('np-fnac').value,
    genero: document.getElementById('np-genero').value,
    tel: document.getElementById('np-tel').value,
    email: document.getElementById('np-email').value,
    ocup: document.getElementById('np-ocup').value,
    creado: new Date().toISOString()
  };
  pacs.push(nuevo);
  savePacientes(pacs);
  document.getElementById('np-nombre').value='';
  document.getElementById('np-fnac').value='';
  document.getElementById('np-genero').value='';
  document.getElementById('np-tel').value='';
  document.getElementById('np-email').value='';
  document.getElementById('np-ocup').value='';
  renderPacientes();
  fillSelects();
  toast('Paciente creado ‚úì');
}

function renderPacientes(){
  const pacs = getPacientes();
  const grid = document.getElementById('lista-pacientes');
  if(!pacs.length){ grid.innerHTML='<p style="color:var(--border);font-size:.85rem">A√∫n no tienes pacientes registrados.</p>'; return; }
  grid.innerHTML = pacs.map(p => `
    <div class="patient-card" onclick="selectPaciente('${p.id}')">
      <h3>${p.nombre}</h3>
      <div class="meta">${p.ocup || '‚Äî'} ¬∑ ${calcEdad(p.fnac)}</div>
      <div class="badge">${getSesionesCount(p.id)} sesi√≥n(es)</div>
    </div>
  `).join('');
}

function calcEdad(fnac){
  if(!fnac) return '';
  const diff = Date.now() - new Date(fnac).getTime();
  const age = Math.floor(diff / (1000*60*60*24*365.25));
  return age + ' a√±os';
}

function getSesionesCount(pid){
  const ses = DB.get('sesiones_'+pid) || [];
  return ses.length;
}

function selectPaciente(id){
  ['an-sel-pac','pl-sel-pac','ses-sel-pac','tst-sel-pac','seg-sel-pac'].forEach(sid => {
    const el = document.getElementById(sid);
    if(el) el.value = id;
  });
  toast('Paciente seleccionado');
}

function fillSelects(){
  const pacs = getPacientes();
  const opts = '<option value="">‚Äî Seleccionar paciente ‚Äî</option>' + pacs.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
  ['an-sel-pac','pl-sel-pac','ses-sel-pac','tst-sel-pac','seg-sel-pac'].forEach(sid => {
    const el = document.getElementById(sid);
    if(el){ const v=el.value; el.innerHTML=opts; el.value=v; }
  });
}

// ===================== NAV =====================
function goPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  event.currentTarget.classList.add('active');
  if(name==='dashboard') renderDashboard();
  if(name==='pacientes') renderPacientes();
  if(name==='tests') loadTest();
  if(name==='seguimiento') loadSeguimiento();
  if(name==='agenda') renderAgenda();
  if(name==='finanzas') renderAll();
  if(name==='documentos') renderDocumentos();
}

// ===================== TABS =====================
function switchTab(prefix, name){
  const page = document.getElementById('page-'+prefix) || document.querySelector('.page.active');
  page.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  page.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const el = document.getElementById(prefix+'-'+name);
  if(el) el.classList.add('active');
  event.currentTarget.classList.add('active');
}

// ===================== ANAMNESIS =====================
// nombre, edad, genero, tel, email, ocup come from the patient profile ‚Äî not duplicated here
const AN_FIELDS = ['fecha','estado','edu','estrato','ciudad','emergN','emergT','motivo','decision','duracion','intensidad','intentos','dx','ttoPrev','hosp','hospD','med','desarrollo','famMental','relFam','pens','creencias','conductas','placer','emociones','sinFis','mant','salc','salcD','stab','stabD','scan','scanD','sotras','sobs','alCond','alImag','alPeso','alEmoc','suCal','suHoras','suAcost','suLev','suAlter','suObs','trEv','trImp','trAten','raCal','raAis','raPers','raRel','raCrisis','mCorto','mMedio','mLargo','oAfront','oActit','oFortal','oRiesgo','oNotas'];

function loadAnamnesis(){
  const pid = document.getElementById('an-sel-pac').value;
  if(!pid) return;

  // Pull patient profile data and show in read-only card
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{};
  const edad = calcEdad(pac.fnac);
  document.getElementById('an-pac-nombre-disp').textContent = pac.nombre||'‚Äî';
  const meta = [pac.genero, edad, pac.ocup, pac.tel, pac.email].filter(Boolean).join(' ¬∑ ');
  document.getElementById('an-pac-meta-disp').textContent = meta||'‚Äî';

  // Load saved anamnesis fields (excluding fields now in patient profile)
  const data = DB.get('anamnesis_'+pid) || {};
  AN_FIELDS.forEach(f=>{
    const el = document.getElementById('an-'+f);
    if(el) el.value = data[f]||'';
  });
  // radio
  const modalidad = data['modalidad'];
  if(modalidad){ document.querySelectorAll('input[name="an-modalidad"]').forEach(r=>{ r.checked = r.value===modalidad; }); }
  document.getElementById('an-ival').textContent = data['intensidad']||5;
}

function guardarAnamnesis(){
  const pid = document.getElementById('an-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente primero'); return; }
  const data = {};
  AN_FIELDS.forEach(f=>{ const el=document.getElementById('an-'+f); if(el) data[f]=el.value; });
  const rad = document.querySelector('input[name="an-modalidad"]:checked');
  data['modalidad'] = rad ? rad.value : '';
  DB.set('anamnesis_'+pid, data);
  toast('Anamnesis guardada ‚úì');
}

function exportarAnamnesis(){
  const pid = document.getElementById('an-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const nombrePac = pac.nombre;
  const data = DB.get('anamnesis_'+pid) || {};
  // Merge patient profile data into export
  const d = {...data, nombre: pac.nombre, genero: pac.genero||'', ocup: pac.ocup||'', tel: pac.tel||'', email: pac.email||'', edad: pac.fnac ? calcEdad(pac.fnac) : ''};

  // Convert any character outside ASCII to RTF unicode escape \uN?
  function rtfEncode(str) {
    if(!str) return '';
    let out = '';
    for(let i = 0; i < str.length; i++) {
      const code = str.charCodeAt(i);
      if(code > 127) {
        // RTF unicode: \uN? where N is signed 16-bit, ? is fallback char
        const signed = code > 32767 ? code - 65536 : code;
        out += '\\u' + signed + '?';
      } else if(code === 92) { out += '\\\\'; }
      else if(code === 123) { out += '\\{'; }
      else if(code === 125) { out += '\\}'; }
      else { out += str[i]; }
    }
    return out;
  }

  function sec(t){ return `{\\pard\\sb280\\sa80 {\\b\\fs24\\cf2 ${rtfEncode(t)}}\\par}`; }
  function sub(t){ return `{\\pard\\sb160\\sa40 {\\b\\fs20\\cf3 ${rtfEncode(t)}}\\par}`; }
  function campo(label, val){ if(!val||val==='‚Äî'||val==='') return ''; return `{\\pard\\sb80\\sa40 {\\b\\fs18\\cf1 ${rtfEncode(label)}: }{\\fs18\\cf1 ${rtfEncode(String(val)||'‚Äî')}}\\par}`; }

  const fechaHoy = new Date().toLocaleDateString('es-CO');
  const partes = [
    '{\\rtf1\\ansi\\ansicpg1252\\uc1\\deff0',
    '{\\fonttbl{\\f0\\fswiss Arial;}{\\f1\\froman Georgia;}}',
    '{\\colortbl;\\red100\\green48\\blue0;\\red205\\green142\\blue157;\\red160\\green83\\blue106;}',
    `{\\pard\\sb0\\sa120 {\\f1\\b\\fs32\\cf2 ${rtfEncode('ANAMNESIS PSICOL√ìGICA')}}\\par}`,
    `{\\pard\\sb0\\sa60 {\\f0\\fs20\\cf1 ${rtfEncode('Luisa Fernanda Garc√©s Garc√≠a ¬∑ Psic√≥loga ¬∑ TP 174366')}}\\par}`,
    `{\\pard\\sb0\\sa300 {\\f0\\fs18\\cf3 ${rtfEncode('Fecha: ' + fechaHoy)}}\\par}`,
    sec('I. DATOS PERSONALES'),
    campo('Nombre', d.nombre), campo('Edad', d.edad), campo('G√©nero', d.genero),
    campo('Ocupaci√≥n', d.ocup), campo('Estado civil', d.estado), campo('Tel√©fono', d.tel),
    campo('Email', d.email), campo('Contacto emergencia', (d.emergN||'')+(d.emergT?' | '+d.emergT:'')),
    sec('II. MOTIVO DE CONSULTA'),
    campo('Motivo', d.motivo), campo('¬øPor qu√© ahora?', d.decision),
    campo('Duraci√≥n', d.duracion), campo('Intensidad (1-10)', (d.intensidad||'')+'/10'), campo('Intentos previos', d.intentos),
    sec('III. HISTORIA CL√çNICA'),
    campo('Diagn√≥sticos previos', d.dx), campo('Tratamientos anteriores', d.ttoPrev),
    campo('Hospitalizaciones', d.hosp+(d.hospD?' - '+d.hospD:'')), campo('Medicaci√≥n', d.med),
    campo('Historia del desarrollo', d.desarrollo), campo('Antecedentes familiares', d.famMental),
    sec('IV. EVALUACI√ìN C-C-E'),
    sub('A. Cognitiva'), campo('Pensamientos autom√°ticos', d.pens), campo('Creencias nucleares', d.creencias),
    sub('B. Conductual'), campo('Conductas problema', d.conductas), campo('Actividades placenteras', d.placer),
    sub('C. Emocional'), campo('Emoci√≥n predominante', d.emociones), campo('S√≠ntomas f√≠sicos', d.sinFis),
    sec('X. METAS TERAP√âUTICAS'),
    campo('Corto plazo', d.mCorto), campo('Mediano plazo', d.mMedio), campo('Largo plazo', d.mLargo),
    '{\\pard\\sb300\\sa200\\brdrb\\brdrs\\brdrw10 \\par}',
    `{\\pard\\sb200\\sa80 {\\b\\fs22\\cf2 ${rtfEncode('FIRMAS')}}\\par}`,
    `{\\pard\\sb120\\sa120 {\\f0\\fs20\\cf1 ${rtfEncode('Paciente: _________________________________     Fecha: ___-___-_____')}}\\par}`,
    `{\\pard\\sb60\\sa60 {\\f0\\b\\fs20\\cf1 ${rtfEncode('Terapeuta: Luisa Fernanda Garc√©s Garc√≠a     TP 174366')}}\\par}`,
    '}'
  ];
  const rtf = partes.join('\n');
  // Encode as Latin-1 blob so \uN? escapes render correctly in Word/LibreOffice
  const blob = new Blob([rtf], {type:'application/rtf;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='Anamnesis_'+nombrePac.replace(/\s+/g,'_')+'.rtf';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===================== PLAN =====================
function loadPlan(){
  const pid = document.getElementById('pl-sel-pac').value;
  if(!pid) return;
  const data = DB.get('plan_'+pid) || {};
  ['fecha','modalidad','frecuencia','dx','objetivo','t1','t2','mat','apps','emerg'].forEach(f=>{
    const el = document.getElementById('pl-'+f);
    if(el) el.value = data[f]||'';
  });
  if(!data['fecha']){ document.getElementById('pl-fecha').valueAsDate = new Date(); }
  // fases
  if(data.fases){
    const tbody = document.getElementById('pl-fases-body');
    tbody.innerHTML = '';
    data.fases.forEach((f,i) => {
      tbody.innerHTML += `<tr>
        <td>${i+1}</td>
        <td><input type="text" value="${f[0]||''}"></td>
        <td><textarea>${f[1]||''}</textarea></td>
        <td><textarea>${f[2]||''}</textarea></td>
        <td><input type="text" value="${f[3]||''}"></td>
      </tr>`;
    });
  }
}

function guardarPlan(){
  const pid = document.getElementById('pl-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const data = {};
  ['fecha','modalidad','frecuencia','dx','objetivo','t1','t2','mat','apps','emerg'].forEach(f=>{
    const el = document.getElementById('pl-'+f); if(el) data[f]=el.value;
  });
  const rows = document.querySelectorAll('#pl-fases-body tr');
  data.fases = Array.from(rows).map(r=>{
    const inputs = r.querySelectorAll('input,textarea');
    return [inputs[0]?.value||'', inputs[1]?.value||'', inputs[2]?.value||'', inputs[3]?.value||''];
  });
  DB.set('plan_'+pid, data);
  toast('Plan guardado ‚úì');
}

function addFaseRow(){
  const tbody = document.getElementById('pl-fases-body');
  const n = tbody.rows.length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${n}</td><td><input type="text"></td><td><textarea style="min-height:50px"></textarea></td><td><textarea style="min-height:50px"></textarea></td><td><input type="text"></td>`;
  tbody.appendChild(tr);
}

function exportarPlan(){
  const pid = document.getElementById('pl-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  guardarPlan();
  const data = DB.get('plan_'+pid)||{};
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const logoSrc = document.getElementById('logo-img').src;

  let fasesTabla = '<table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">Fase</th><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">Objetivos</th><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">T√©cnicas</th><th style="background:#fadae1;color:#643000;padding:8px;border:1px solid #cd8e9d;font-size:.78rem">Semanas</th></tr></thead><tbody>';
  (data.fases||[]).forEach(f => {
    fasesTabla += `<tr><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[0]}</td><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[1]}</td><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[2]}</td><td style="padding:8px;border:1px solid #f0d8de;font-size:.84rem">${f[3]}</td></tr>`;
  });
  fasesTabla += '</tbody></table>';

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;color:#643000;background:white;padding:32px;font-size:14px;}
  .header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #cd8e9d;padding-bottom:16px;margin-bottom:24px;}
  .header img{height:60px;}.header h1{font-size:1.1rem;color:#643000;margin-bottom:4px;}.header p{font-size:0.72rem;color:#cd8e9d;letter-spacing:1.2px;text-transform:uppercase;}
  h2{font-size:1.05rem;color:#cd8e9d;margin:20px 0 8px;padding-bottom:5px;border-bottom:1px solid #fadae1;}
  .dato{margin:5px 0;font-size:.9rem;}.dato strong{color:#cd8e9d;}
  .objetivo{background:#fadae1;border-left:4px solid #cd8e9d;padding:12px 16px;border-radius:0 10px 10px 0;margin:10px 0;font-size:.9rem;}
  .firmas{margin-top:36px;border-top:1px solid #cd8e9d;padding-top:18px;}.firma-line{margin:14px 0;font-size:.9rem;}
  @media print{@page{margin:1.8cm}}</style></head><body>
  <div class="header"><img src="${logoSrc}" alt="Logo"><div><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p></div></div>
  <h2>Plan de Tratamiento ‚Äî ${pac.nombre}</h2>
  <div class="dato"><strong>Fecha inicio:</strong> ${data.fecha||'‚Äî'}</div>
  <div class="dato"><strong>Modalidad:</strong> ${data.modalidad||'‚Äî'} ¬∑ <strong>Frecuencia:</strong> ${data.frecuencia||'‚Äî'}</div>
  <h2>Diagn√≥stico de Trabajo</h2><div class="dato">${data.dx||'‚Äî'}</div>
  <h2>Objetivo General</h2><div class="objetivo">${data.objetivo||'‚Äî'}</div>
  <h2>Fases del Proceso</h2>${fasesTabla}
  <h2>Recursos</h2>
  ${data.mat?`<div class="dato"><strong>Materiales:</strong> ${data.mat}</div>`:''}
  ${data.apps?`<div class="dato"><strong>Apps:</strong> ${data.apps}</div>`:''}
  ${data.emerg?`<div class="dato"><strong>Emergencias:</strong> ${data.emerg}</div>`:''}
  <div class="firmas">
  <div class="firma-line">Autorizo este plan y comprendo su car√°cter colaborativo.</div>
  <div class="firma-line">Paciente: _________________________________ &nbsp;&nbsp; Fecha: ___-___-_____</div>
  <div class="firma-line"><strong>Psic√≥loga:</strong> Luisa Fernanda Garc√©s Garc√≠a &nbsp;&nbsp; TP 174366</div>
  </div></body></html>`;
  const win = window.open('','_blank');
  win.document.write(html); win.document.close();
  win.onload = () => win.print();
}

// ===================== SESIONES =====================
let currentSesionId = null;

function loadSesiones(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ document.getElementById('lista-sesiones').innerHTML=''; return; }
  renderListaSesiones(pid);
}

function renderListaSesiones(pid){
  const ses = DB.get('sesiones_'+pid) || [];
  const lista = document.getElementById('lista-sesiones');
  if(!ses.length){ lista.innerHTML='<p style="font-size:.8rem;color:var(--border)">Sin sesiones a√∫n.</p>'; return; }
  lista.innerHTML = ses.slice().reverse().map(s => `
    <div class="session-item" onclick="abrirSesion('${pid}','${s.id}')">
      <h4>Sesi√≥n #${s.num}</h4>
      <p>${s.fecha||'Sin fecha'} ¬∑ ${s.dur||50} min</p>
    </div>
  `).join('');
}

function nuevaSesion(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  currentSesionId = null;
  const ses = DB.get('sesiones_'+pid)||[];
  document.getElementById('ses-num').value = ses.length+1;
  document.getElementById('ses-fecha').valueAsDate = new Date();
  document.getElementById('ses-dur').value = 50;
  document.getElementById('ses-estado').value = 5;
  document.getElementById('ses-eval').textContent = 5;
  ['ses-temas','ses-inter','ses-avances','ses-tarea','ses-acuerdos','ses-notas-priv'].forEach(id=>{ document.getElementById(id).value=''; });
  document.getElementById('ses-resumen-box').style.display='none';
  document.getElementById('ses-export-btns').style.display='none';
  document.getElementById('ses-form-title').textContent='Nueva Sesi√≥n';
  document.getElementById('sesion-form').style.display='block';
  document.getElementById('sesion-placeholder').style.display='none';
}

function abrirSesion(pid, sid){
  const ses = DB.get('sesiones_'+pid)||[];
  const s = ses.find(x=>x.id===sid);
  if(!s) return;
  currentSesionId = sid;
  document.getElementById('ses-num').value = s.num||'';
  document.getElementById('ses-fecha').value = s.fecha||'';
  document.getElementById('ses-dur').value = s.dur||50;
  document.getElementById('ses-estado').value = s.estado||5;
  document.getElementById('ses-eval').textContent = s.estado||5;
  document.getElementById('ses-temas').value = s.temas||'';
  document.getElementById('ses-inter').value = s.inter||'';
  document.getElementById('ses-avances').value = s.avances||'';
  document.getElementById('ses-tarea').value = s.tarea||'';
  document.getElementById('ses-acuerdos').value = s.acuerdos||'';
  document.getElementById('ses-notas-priv').value = s.notasPriv||'';
  document.getElementById('ses-form-title').textContent = 'Sesi√≥n #'+s.num;
  document.getElementById('ses-resumen-box').style.display='none';
  document.getElementById('ses-export-btns').style.display='none';
  document.getElementById('sesion-form').style.display='block';
  document.getElementById('sesion-placeholder').style.display='none';
}

function guardarSesion(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const ses = DB.get('sesiones_'+pid)||[];
  const sesData = {
    id: currentSesionId || genId(),
    num: document.getElementById('ses-num').value,
    fecha: document.getElementById('ses-fecha').value,
    dur: document.getElementById('ses-dur').value,
    estado: document.getElementById('ses-estado').value,
    temas: document.getElementById('ses-temas').value,
    inter: document.getElementById('ses-inter').value,
    avances: document.getElementById('ses-avances').value,
    tarea: document.getElementById('ses-tarea').value,
    acuerdos: document.getElementById('ses-acuerdos').value,
    notasPriv: document.getElementById('ses-notas-priv').value,
    guardada: new Date().toISOString()
  };
  if(currentSesionId){
    const idx = ses.findIndex(x=>x.id===currentSesionId);
    if(idx>=0) ses[idx]=sesData; else ses.push(sesData);
  } else {
    ses.push(sesData);
    currentSesionId = sesData.id;
  }
  DB.set('sesiones_'+pid, ses);
  renderListaSesiones(pid);
  toast('Sesi√≥n guardada ‚úì');
}

function generarResumen(){
  const pid = document.getElementById('ses-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const fecha = document.getElementById('ses-fecha').value;
  const num = document.getElementById('ses-num').value;
  const temas = document.getElementById('ses-temas').value;
  const avances = document.getElementById('ses-avances').value;
  const tarea = document.getElementById('ses-tarea').value;
  const acuerdos = document.getElementById('ses-acuerdos').value;
  const fechaFmt = fecha ? new Date(fecha+'T12:00:00').toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'}) : '‚Äî';

  const texto = `Hola ${pac.nombre.split(' ')[0]} üå∏

Aqu√≠ te comparto el resumen de nuestra sesi√≥n #${num} del ${fechaFmt}.

‚îÄ‚îÄ‚îÄ LO QUE TRABAJAMOS HOY ‚îÄ‚îÄ‚îÄ
${temas||'‚Äî'}

‚îÄ‚îÄ‚îÄ TUS AVANCES ‚îÄ‚îÄ‚îÄ
${avances||'‚Äî'}

‚îÄ‚îÄ‚îÄ TU TAREA PARA CASA üìå ‚îÄ‚îÄ‚îÄ
${tarea||'Sin tarea asignada esta semana.'}

‚îÄ‚îÄ‚îÄ ACUERDOS PARA LA PR√ìXIMA SESI√ìN ‚îÄ‚îÄ‚îÄ
${acuerdos||'‚Äî'}

Con cari√±o,
Luisa Fernanda Garc√©s Garc√≠a
Psic√≥loga ¬∑ TP 174366`;

  const box = document.getElementById('ses-resumen-box');
  box.textContent = texto;
  box.style.display='block';
  document.getElementById('ses-export-btns').style.display='flex';
}

function exportarResumenPDF(){
  const pid = document.getElementById('ses-sel-pac').value;
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const texto = document.getElementById('ses-resumen-box').textContent;
  const logoSrc = document.getElementById('logo-img').src;
  const num = document.getElementById('ses-num').value;
  const fecha = document.getElementById('ses-fecha').value;
  const fechaFmt = fecha ? new Date(fecha+'T12:00:00').toLocaleDateString('es-CO',{year:'numeric',month:'long',day:'numeric'}) : '‚Äî';

  const lines = texto.split('\n').map(l => {
    if(l.startsWith('‚îÄ‚îÄ‚îÄ')) return `<div style="font-weight:700;color:#cd8e9d;margin:18px 0 6px;font-size:.85rem;letter-spacing:1px">${l}</div>`;
    if(!l.trim()) return '<br>';
    return `<div style="font-size:.9rem;line-height:1.7;color:#643000">${l}</div>`;
  }).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;background:white;padding:36px;max-width:680px;margin:0 auto;}
  .header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #cd8e9d;padding-bottom:14px;margin-bottom:24px;}
  .header img{height:56px;}.header h1{font-size:1.05rem;color:#643000;}.header p{font-size:.68rem;color:#cd8e9d;letter-spacing:1.2px;text-transform:uppercase;}
  .titulo{font-family:Georgia,serif;font-size:1.2rem;color:#cd8e9d;margin-bottom:6px;}
  .sub{font-size:.75rem;color:#a0536a;margin-bottom:28px;}
  .pie{margin-top:40px;padding-top:14px;border-top:1px solid #fadae1;font-size:.78rem;color:#a0536a;text-align:center;}
  @media print{@page{margin:2cm}}</style></head><body>
  <div class="header"><img src="${logoSrc}"><div><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p></div></div>
  <div class="titulo">Resumen de Sesi√≥n #${num}</div>
  <div class="sub">${fechaFmt} ¬∑ ${pac.nombre}</div>
  ${lines}
  <div class="pie">Este documento es personal y confidencial. ¬© Luisa Fernanda Garc√©s Garc√≠a, Psic√≥loga.</div>
  </body></html>`;
  const win = window.open('','_blank');
  win.document.write(html); win.document.close();
  win.onload = () => win.print();
}

// ===================== TESTS =====================
const PHQ9_Q = ['Poco inter√©s o placer en hacer cosas','Sentirse deca√≠do/a, deprimido/a o sin esperanza','Problemas para quedarse o mantenerse dormido/a, o dormir demasiado','Sentirse cansado/a o tener poca energ√≠a','Poco apetito o comer en exceso','Sentirse mal consigo mismo/a, sentir que es un fracaso o que ha fallado a s√≠ mismo/a o a su familia','Dificultad para concentrarse en cosas como leer el peri√≥dico o ver la televisi√≥n','Moverse o hablar tan lento que otras personas podr√≠an notarlo, o estar tan inquieto/a que ha estado movi√©ndose mucho m√°s de lo normal','Pensamientos de que estar√≠a mejor muerto/a o de hacerse da√±o de alguna manera'];
const GAD7_Q = ['Sentirse nervioso/a, ansioso/a o con los nervios de punta','No poder dejar de preocuparse o no poder controlar la preocupaci√≥n','Preocuparse demasiado por diferentes cosas','Dificultad para relajarse','Estar tan inquieto/a que es dif√≠cil mantenerse quieto/a','Irritarse o irritarse f√°cilmente','Sentir miedo como si algo terrible pudiera pasar'];
const PHQ9_OPTS = ['Ning√∫n d√≠a (0)','Varios d√≠as (1)','M√°s de la mitad de los d√≠as (2)','Casi todos los d√≠as (3)'];
const GAD7_OPTS = ['Ning√∫n d√≠a (0)','Varios d√≠as (1)','M√°s de la mitad de los d√≠as (2)','Casi todos los d√≠as (3)'];

const YSQ_DOMAINS = {
  'Desconexi√≥n y Rechazo': ['Abandono/Inestabilidad','Desconfianza/Abuso','Deprivaci√≥n Emocional','Defectuosidad/Verg√ºenza','Aislamiento Social'],
  'Autonom√≠a y Desempe√±o Deteriorados': ['Dependencia/Incompetencia','Vulnerabilidad al Da√±o','Enmara√±amiento','Fracaso'],
  'L√≠mites Deteriorados': ['Grandiosidad/Con Derecho','Autocontrol Insuficiente'],
  'Tendencia hacia el Otro': ['Subyugaci√≥n','Autosacrificio','B√∫squeda de Aprobaci√≥n'],
  'Sobrevigilancia e Inhibici√≥n': ['Negatividad/Pesimismo','Inhibici√≥n Emocional','Metas Inalcanzables','Castigo']
};

const SMI_SCHEMAS = ['Ni√±o Vulnerable','Ni√±o Enfadado/Encolerizado','Ni√±o Impulsivo','Ni√±o Feliz','Rendici√≥n Complaciente','Protecci√≥n Desvinculada','Autoengrandecimiento','Atacante/Bullying','Padre Punitivo','Padre Exigente','Adulto Sano'];

function loadTest(){
  const type = document.getElementById('tst-sel').value;
  const container = document.getElementById('test-container');
  document.getElementById('test-resultados').style.display='none';
  if(!type){ container.innerHTML=''; return; }

  if(type==='phq9'){
    container.innerHTML = `<div class="card"><div class="sec-title">PHQ-9 ¬∑ Cuestionario de Salud del Paciente</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">¬øCon qu√© frecuencia le han afectado los siguientes problemas durante las √∫ltimas 2 semanas?</p>
    ${PHQ9_Q.map((q,i)=>`<div class="test-question"><p><strong>${i+1}.</strong> ${q}</p><div class="likert">${PHQ9_OPTS.map((o,v)=>`<label><input type="radio" name="phq${i}" value="${v}"> ${o}</label>`).join('')}</div></div>`).join('')}
    <div class="btn-row"><button class="btn primary" onclick="calcPHQ9()">Calcular Resultado</button></div></div>`;
  } else if(type==='gad7'){
    container.innerHTML = `<div class="card"><div class="sec-title">GAD-7 ¬∑ Escala de Trastorno de Ansiedad Generalizada</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">¬øCon qu√© frecuencia le han afectado los siguientes problemas durante las √∫ltimas 2 semanas?</p>
    ${GAD7_Q.map((q,i)=>`<div class="test-question"><p><strong>${i+1}.</strong> ${q}</p><div class="likert">${GAD7_OPTS.map((o,v)=>`<label><input type="radio" name="gad${i}" value="${v}"> ${o}</label>`).join('')}</div></div>`).join('')}
    <div class="btn-row"><button class="btn primary" onclick="calcGAD7()">Calcular Resultado</button></div></div>`;
  } else if(type==='ysq'){
    let html = `<div class="card"><div class="sec-title">YSQ-L3 ¬∑ Cuestionario de Esquemas de Young</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">Lee cada afirmaci√≥n y punt√∫a del 1 al 6 qu√© tan bien describe tu forma de ser (1 = Completamente falso, 6 = Me describe perfectamente).</p>`;
    let q = 0;
    Object.entries(YSQ_DOMAINS).forEach(([dom, schemas]) => {
      html += `<div class="subsec">${dom}</div>`;
      schemas.forEach(sch => {
        html += `<div class="test-question"><p><strong>${sch}:</strong> <em style="font-size:.82rem;color:var(--strong)">√çtems representativos del esquema</em></p>
        <div class="fg"><label class="lbl">Puntaje promedio del esquema (1-6)</label><input type="number" name="ysq_${q}" id="ysq_${q}" min="1" max="6" step="0.1" placeholder="Ingresa el promedio"></div></div>`;
        q++;
      });
    });
    html += `<div class="btn-row"><button class="btn primary" onclick="calcYSQ()">Ver Resultados</button></div></div>`;
    container.innerHTML = html;
  } else if(type==='smi'){
    container.innerHTML = `<div class="card"><div class="sec-title">SMI ¬∑ Inventario de Modos de Esquemas</div>
    <p style="font-size:.82rem;color:var(--border);margin-bottom:20px">Punt√∫a del 1 al 6 con qu√© frecuencia experimentas cada modo (1 = Nunca, 6 = Siempre).</p>
    ${SMI_SCHEMAS.map((s,i)=>`<div class="test-question"><p><strong>${s}</strong></p><div class="likert">
    ${[1,2,3,4,5,6].map(v=>`<label><input type="radio" name="smi${i}" value="${v}"> ${v}</label>`).join('')}</div></div>`).join('')}
    <div class="btn-row"><button class="btn primary" onclick="calcSMI()">Calcular Resultado</button></div></div>`;
  }
}

function calcPHQ9(){
  let total = 0, missing = false;
  PHQ9_Q.forEach((_,i)=>{
    const r = document.querySelector(`input[name="phq${i}"]:checked`);
    if(!r) missing=true; else total+=parseInt(r.value);
  });
  if(missing){ toast('Responde todas las preguntas'); return; }
  let sev, color;
  if(total<=4){sev='M√≠nima o sin depresi√≥n';color='#4caf50';}
  else if(total<=9){sev='Depresi√≥n leve';color='#8bc34a';}
  else if(total<=14){sev='Depresi√≥n moderada';color='#ff9800';}
  else if(total<=19){sev='Depresi√≥n moderadamente grave';color='#f44336';}
  else{sev='Depresi√≥n grave';color='#b71c1c';}
  showTestResult('PHQ-9 ¬∑ Resultados',`
    <div style="text-align:center;padding:20px 0">
      <div style="font-size:3rem;font-family:Playfair Display,serif;color:${color}">${total}</div>
      <div style="font-size:.8rem;color:var(--strong);text-transform:uppercase;letter-spacing:1px">de 27 puntos</div>
      <div style="margin-top:10px;font-size:1.1rem;font-weight:700;color:${color}">${sev}</div>
    </div>
    <div class="result-bar"><div class="result-bar-fill" style="width:${(total/27*100)}%;background:${color}"></div></div>
    <p style="font-size:.82rem;color:var(--strong);margin-top:12px">Puntaje: 0-4 M√≠nima ¬∑ 5-9 Leve ¬∑ 10-14 Moderada ¬∑ 15-19 Moderadamente grave ¬∑ 20-27 Grave</p>
  `, {score: total, severity: sev, test:'PHQ-9', date: new Date().toISOString()});
}

function calcGAD7(){
  let total = 0, missing = false;
  GAD7_Q.forEach((_,i)=>{
    const r = document.querySelector(`input[name="gad${i}"]:checked`);
    if(!r) missing=true; else total+=parseInt(r.value);
  });
  if(missing){ toast('Responde todas las preguntas'); return; }
  let sev, color;
  if(total<=4){sev='Ansiedad m√≠nima';color='#4caf50';}
  else if(total<=9){sev='Ansiedad leve';color='#8bc34a';}
  else if(total<=14){sev='Ansiedad moderada';color='#ff9800';}
  else{sev='Ansiedad grave';color='#f44336';}
  showTestResult('GAD-7 ¬∑ Resultados',`
    <div style="text-align:center;padding:20px 0">
      <div style="font-size:3rem;font-family:Playfair Display,serif;color:${color}">${total}</div>
      <div style="font-size:.8rem;color:var(--strong);text-transform:uppercase;letter-spacing:1px">de 21 puntos</div>
      <div style="margin-top:10px;font-size:1.1rem;font-weight:700;color:${color}">${sev}</div>
    </div>
    <div class="result-bar"><div class="result-bar-fill" style="width:${(total/21*100)}%;background:${color}"></div></div>
    <p style="font-size:.82rem;color:var(--strong);margin-top:12px">Puntaje: 0-4 M√≠nima ¬∑ 5-9 Leve ¬∑ 10-14 Moderada ¬∑ 15-21 Grave</p>
  `, {score: total, severity: sev, test:'GAD-7', date: new Date().toISOString()});
}

function calcYSQ(){
  const schemas = Object.values(YSQ_DOMAINS).flat();
  const results = schemas.map((s,i)=>{
    const val = parseFloat(document.getElementById('ysq_'+i)?.value)||0;
    return {name:s, val};
  });
  const sorted = [...results].sort((a,b)=>b.val-a.val);
  const html = `<p style="font-size:.82rem;color:var(--strong);margin-bottom:16px">Esquemas ordenados por intensidad (1=m√≠nima, 6=m√°xima):</p>` +
    sorted.map(r=>`<div class="result-schema"><h4>${r.name}</h4>
    <div class="result-bar"><div class="result-bar-fill" style="width:${((r.val-1)/5*100).toFixed(0)}%"></div></div>
    <p style="font-size:.78rem;color:var(--strong)">${r.val.toFixed(1)}/6 ¬∑ ${r.val>=4.5?'Alta activaci√≥n':r.val>=3?'Activaci√≥n moderada':'Baja activaci√≥n'}</p>
    </div>`).join('');
  showTestResult('YSQ ¬∑ Perfil de Esquemas', html, {schemas: results, test:'YSQ', date: new Date().toISOString()});
}

function calcSMI(){
  const results = SMI_SCHEMAS.map((s,i)=>{
    const r = document.querySelector(`input[name="smi${i}"]:checked`);
    return {name:s, val: r?parseInt(r.value):0};
  });
  const missing = results.some(r=>r.val===0);
  if(missing){ toast('Responde todas las preguntas'); return; }
  const sorted = [...results].sort((a,b)=>b.val-a.val);
  const html = `<p style="font-size:.82rem;color:var(--strong);margin-bottom:16px">Modos ordenados por frecuencia (1=nunca, 6=siempre):</p>` +
    sorted.map(r=>`<div class="result-schema"><h4>${r.name}</h4>
    <div class="result-bar"><div class="result-bar-fill" style="width:${((r.val-1)/5*100).toFixed(0)}%"></div></div>
    <p style="font-size:.78rem;color:var(--strong)">${r.val}/6</p></div>`).join('');
  showTestResult('SMI ¬∑ Perfil de Modos', html, {modes: results, test:'SMI', date: new Date().toISOString()});
}

function showTestResult(title, html, dataToSave){
  document.getElementById('res-titulo').textContent = title;
  document.getElementById('res-content').innerHTML = html;
  document.getElementById('test-resultados').style.display='block';
  window._lastTestData = dataToSave;
  renderTestHistorial();
}

function guardarTest(){
  const pid = document.getElementById('tst-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  if(!window._lastTestData){ toast('Calcula el resultado primero'); return; }
  const hist = DB.get('tests_'+pid) || [];
  hist.push(window._lastTestData);
  DB.set('tests_'+pid, hist);
  renderTestHistorial();
  toast('Resultado guardado ‚úì');
}

function renderTestHistorial(){
  const pid = document.getElementById('tst-sel-pac').value;
  if(!pid) return;
  const hist = DB.get('tests_'+pid)||[];
  const el = document.getElementById('test-historial');
  if(!hist.length){ el.innerHTML='<p style="font-size:.8rem;color:var(--border)">Sin tests guardados a√∫n.</p>'; return; }
  el.innerHTML = hist.slice().reverse().map(t=>`
    <div class="session-item">
      <h4>${t.test} ¬∑ ${t.score!==undefined ? 'Puntaje: '+t.score : ''}</h4>
      <p>${new Date(t.date).toLocaleDateString('es-CO')} ¬∑ ${t.severity||''}</p>
    </div>
  `).join('');
}

function exportarTestPDF(){
  const pid = document.getElementById('tst-sel-pac').value;
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const titulo = document.getElementById('res-titulo').textContent;
  const contenido = document.getElementById('res-content').innerHTML;
  const logoSrc = document.getElementById('logo-img').src;
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:Arial,sans-serif;color:#643000;background:white;padding:32px;font-size:14px;}
  .header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #cd8e9d;padding-bottom:14px;margin-bottom:24px;}
  .header img{height:56px;}.header h1{font-size:1.05rem;color:#643000;}.header p{font-size:.68rem;color:#cd8e9d;letter-spacing:1.2px;text-transform:uppercase;}
  h2{font-size:1.1rem;color:#cd8e9d;margin-bottom:16px;}.result-bar{background:#fadae1;border-radius:10px;height:12px;margin:6px 0;overflow:hidden;}
  .result-bar-fill{height:100%;border-radius:10px;background:#cd8e9d;}.result-schema{background:#f5eaec;border-radius:8px;padding:10px 14px;margin:8px 0;}
  .result-schema h4{font-size:.82rem;font-weight:700;margin-bottom:5px;}
  @media print{@page{margin:1.8cm}}</style></head><body>
  <div class="header"><img src="${logoSrc}"><div><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p></div></div>
  <h2>${titulo}</h2><p style="font-size:.78rem;color:#a0536a;margin-bottom:20px">Paciente: ${pac.nombre} ¬∑ ${new Date().toLocaleDateString('es-CO')}</p>
  ${contenido}
  </body></html>`;
  const win = window.open('','_blank');
  win.document.write(html); win.document.close();
  win.onload = () => win.print();
}

// ===================== SEGUIMIENTO =====================
function loadSeguimiento(){
  const pid = document.getElementById('seg-sel-pac').value;
  if(!pid) return;
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'‚Äî'};
  const ses = DB.get('sesiones_'+pid)||[];
  const tests = DB.get('tests_'+pid)||[];

  // stats
  document.getElementById('seg-stats').innerHTML = `
    <div class="stat-card"><div class="num">${ses.length}</div><div class="lbl2">Sesiones</div></div>
    <div class="stat-card"><div class="num">${tests.length}</div><div class="lbl2">Tests</div></div>
    <div class="stat-card"><div class="num">${ses.length?ses[ses.length-1].num:'‚Äî'}</div><div class="lbl2">√öltima sesi√≥n</div></div>
    <div class="stat-card"><div class="num">${ses.length?(ses.reduce((a,s)=>a+parseInt(s.estado||5),0)/ses.length).toFixed(1):'‚Äî'}</div><div class="lbl2">Estado prom.</div></div>
  `;

  // chart
  drawChart(ses);

  // sesiones lista
  document.getElementById('seg-sesiones-lista').innerHTML = ses.length ?
    ses.slice().reverse().map(s=>`<div class="session-item"><h4>Sesi√≥n #${s.num} ¬∑ ${s.fecha||'‚Äî'}</h4><p>Estado: ${s.estado||'‚Äî'}/10 ¬∑ ${s.dur||50} min</p></div>`).join('') :
    '<p style="font-size:.8rem;color:var(--border)">Sin sesiones.</p>';

  // tests lista
  document.getElementById('seg-tests-lista').innerHTML = tests.length ?
    tests.slice().reverse().map(t=>`<div class="session-item"><h4>${t.test} ${t.score!==undefined?'¬∑ '+t.score:''}</h4><p>${new Date(t.date).toLocaleDateString('es-CO')} ¬∑ ${t.severity||''}</p></div>`).join('') :
    '<p style="font-size:.8rem;color:var(--border)">Sin tests.</p>';
}

function drawChart(ses){
  const canvas = document.getElementById('seg-chart');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.parentElement.clientWidth - 48;
  canvas.height = 200;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!ses.length){
    ctx.fillStyle='#cd8e9d'; ctx.font='14px Lato'; ctx.textAlign='center';
    ctx.fillText('Sin datos a√∫n',canvas.width/2,100); return;
  }

  const data = ses.map(s=>parseInt(s.estado||5));
  const labels = ses.map(s=>'#'+s.num);
  const pad = {t:20,r:20,b:40,l:40};
  const W = canvas.width - pad.l - pad.r;
  const H = canvas.height - pad.t - pad.b;
  const max = 10, min = 0;
  const xStep = data.length>1 ? W/(data.length-1) : W/2;

  // grid
  ctx.strokeStyle='#f5eaec'; ctx.lineWidth=1;
  for(let i=0;i<=10;i+=2){
    const y = pad.t + H - (i/max)*H;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+W,y); ctx.stroke();
    ctx.fillStyle='#cd8e9d'; ctx.font='10px Lato'; ctx.textAlign='right';
    ctx.fillText(i, pad.l-6, y+4);
  }

  // line
  ctx.strokeStyle='#cd8e9d'; ctx.lineWidth=2.5; ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = pad.l + (data.length>1?i*xStep:W/2);
    const y = pad.t + H - ((v-min)/(max-min))*H;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();

  // fill
  ctx.fillStyle='rgba(205,142,157,0.12)';
  ctx.beginPath();
  data.forEach((v,i)=>{ const x=pad.l+(data.length>1?i*xStep:W/2); const y=pad.t+H-((v-min)/(max-min))*H; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
  ctx.lineTo(pad.l+(data.length>1?(data.length-1)*xStep:W/2),pad.t+H);
  ctx.lineTo(pad.l,pad.t+H); ctx.closePath(); ctx.fill();

  // dots & labels
  data.forEach((v,i)=>{
    const x = pad.l+(data.length>1?i*xStep:W/2);
    const y = pad.t+H-((v-min)/(max-min))*H;
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#cd8e9d'; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='#643000'; ctx.font='10px Lato'; ctx.textAlign='center';
    ctx.fillText(labels[i], x, pad.t+H+18);
  });
}

// ===================== ENTREGABLE EVOLUCI√ìN =====================
function exportarEvolucionPDF(){
  const pid = document.getElementById('seg-sel-pac').value;
  if(!pid){ toast('Selecciona un paciente'); return; }
  const pacs = getPacientes();
  const pac = pacs.find(p=>p.id===pid)||{nombre:'Paciente'};
  const ses = DB.get('sesiones_'+pid)||[];
  const tests = DB.get('tests_'+pid)||[];

  if(!ses.length){ toast('Este paciente a√∫n no tiene sesiones registradas'); return; }

  // Render a larger offscreen canvas for the export
  const offCanvas = document.createElement('canvas');
  offCanvas.width = 900;
  offCanvas.height = 320;
  const ctx = offCanvas.getContext('2d');

  // White background
  ctx.fillStyle = '#fff8f9';
  ctx.fillRect(0, 0, offCanvas.width, offCanvas.height);

  const data = ses.map(s => parseInt(s.estado||5));
  const labels = ses.map(s => 'Ses. #'+s.num);
  const fechas = ses.map(s => s.fecha ? new Date(s.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'short'}) : '');
  const pad = {t:30, r:30, b:60, l:50};
  const W = offCanvas.width - pad.l - pad.r;
  const H = offCanvas.height - pad.t - pad.b;
  const max = 10, min = 0;
  const xStep = data.length > 1 ? W/(data.length-1) : W/2;

  // Grid lines
  ctx.strokeStyle = '#f0dde3'; ctx.lineWidth = 1;
  for(let i = 0; i <= 10; i += 2){
    const y = pad.t + H - (i/max)*H;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+W, y); ctx.stroke();
    ctx.fillStyle = '#cd8e9d'; ctx.font = 'bold 13px Arial'; ctx.textAlign = 'right';
    ctx.fillText(i, pad.l-8, y+5);
  }

  // Y axis label
  ctx.save(); ctx.translate(14, pad.t + H/2); ctx.rotate(-Math.PI/2);
  ctx.fillStyle = '#a0536a'; ctx.font = '12px Arial'; ctx.textAlign = 'center';
  ctx.fillText('Estado emocional (1‚Äì10)', 0, 0); ctx.restore();

  // Area fill
  ctx.fillStyle = 'rgba(205,142,157,0.15)';
  ctx.beginPath();
  data.forEach((v,i)=>{ const x=pad.l+(data.length>1?i*xStep:W/2); const y=pad.t+H-((v-min)/(max-min))*H; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
  ctx.lineTo(pad.l+(data.length>1?(data.length-1)*xStep:W/2), pad.t+H);
  ctx.lineTo(pad.l, pad.t+H); ctx.closePath(); ctx.fill();

  // Line
  ctx.strokeStyle = '#cd8e9d'; ctx.lineWidth = 3; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
  ctx.beginPath();
  data.forEach((v,i)=>{ const x=pad.l+(data.length>1?i*xStep:W/2); const y=pad.t+H-((v-min)/(max-min))*H; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
  ctx.stroke();

  // Dots, value labels, and session labels
  data.forEach((v,i)=>{
    const x = pad.l + (data.length>1?i*xStep:W/2);
    const y = pad.t + H - ((v-min)/(max-min))*H;
    // dot
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x,y,7,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#cd8e9d'; ctx.lineWidth = 2.5; ctx.stroke();
    // value above dot
    ctx.fillStyle = '#643000'; ctx.font = 'bold 13px Arial'; ctx.textAlign = 'center';
    ctx.fillText(v, x, y-14);
    // session label below
    ctx.fillStyle = '#a0536a'; ctx.font = '11px Arial';
    ctx.fillText(labels[i], x, pad.t+H+20);
    // date below session label
    if(fechas[i]){ ctx.fillStyle = '#cd8e9d'; ctx.font = '10px Arial'; ctx.fillText(fechas[i], x, pad.t+H+36); }
  });

  const chartDataUrl = offCanvas.toDataURL('image/png');

  // Build stats
  const prom = (data.reduce((a,b)=>a+b,0)/data.length).toFixed(1);
  const tendencia = data.length > 1 ? (data[data.length-1] - data[0]) : 0;
  const tendenciaTexto = tendencia > 0 ? `‚Üë Mejora de ${tendencia} punto(s)` : tendencia < 0 ? `‚Üì Descenso de ${Math.abs(tendencia)} punto(s)` : '‚Üí Estable';
  const tendenciaColor = tendencia > 0 ? '#6aaa6a' : tendencia < 0 ? '#e57373' : '#cd8e9d';

  // Build tests table if any
  let testsHTML = '';
  if(tests.length){
    testsHTML = `
    <h2 style="font-size:1rem;color:#cd8e9d;margin:28px 0 10px;padding-bottom:6px;border-bottom:1px solid #fadae1">Resultados de Evaluaciones</h2>
    <table style="width:100%;border-collapse:collapse;font-size:.85rem">
      <thead><tr>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Instrumento</th>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Puntaje</th>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Interpretaci√≥n</th>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Fecha</th>
      </tr></thead>
      <tbody>
      ${tests.map((t,i)=>`<tr style="background:${i%2===0?'#fff':'#fdf0f3'}">
        <td style="padding:8px 12px;border:1px solid #f0d8de;font-weight:700">${t.test}</td>
        <td style="padding:8px 12px;border:1px solid #f0d8de">${t.score !== undefined ? t.score : '‚Äî'}</td>
        <td style="padding:8px 12px;border:1px solid #f0d8de">${t.severity||'‚Äî'}</td>
        <td style="padding:8px 12px;border:1px solid #f0d8de">${new Date(t.date).toLocaleDateString('es-CO')}</td>
      </tr>`).join('')}
      </tbody>
    </table>`;
  }

  // Build session summary table
  const sesTabla = `
    <h2 style="font-size:1rem;color:#cd8e9d;margin:28px 0 10px;padding-bottom:6px;border-bottom:1px solid #fadae1">Resumen de Sesiones</h2>
    <table style="width:100%;border-collapse:collapse;font-size:.85rem">
      <thead><tr>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Sesi√≥n</th>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Fecha</th>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Estado emocional</th>
        <th style="background:#fadae1;color:#643000;padding:8px 12px;text-align:left;border:1px solid #cd8e9d">Tarea asignada</th>
      </tr></thead>
      <tbody>
      ${ses.map((s,i)=>`<tr style="background:${i%2===0?'#fff':'#fdf0f3'}">
        <td style="padding:8px 12px;border:1px solid #f0d8de;font-weight:700">#${s.num}</td>
        <td style="padding:8px 12px;border:1px solid #f0d8de">${s.fecha||'‚Äî'}</td>
        <td style="padding:8px 12px;border:1px solid #f0d8de;text-align:center">${s.estado||'‚Äî'}/10</td>
        <td style="padding:8px 12px;border:1px solid #f0d8de">${s.tarea||'Sin tarea'}</td>
      </tr>`).join('')}
      </tbody>
    </table>`;

  const logoSrc = document.getElementById('logo-img').src;
  const fechaHoy = new Date().toLocaleDateString('es-CO', {year:'numeric', month:'long', day:'numeric'});
  const nombreCorto = pac.nombre.split(' ')[0];

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family: Arial, sans-serif; color:#643000; background:white; padding:36px; max-width:800px; margin:0 auto; }
    .header { display:flex; align-items:center; gap:18px; border-bottom:2px solid #cd8e9d; padding-bottom:16px; margin-bottom:28px; }
    .header img { height:64px; }
    .header h1 { font-family:Georgia,serif; font-size:1.1rem; color:#643000; margin-bottom:3px; }
    .header p { font-size:.7rem; color:#cd8e9d; letter-spacing:1.2px; text-transform:uppercase; }
    .titulo { font-family:Georgia,serif; font-size:1.4rem; color:#cd8e9d; margin-bottom:4px; }
    .subtitulo { font-size:.82rem; color:#a0536a; margin-bottom:24px; }
    .stats-row { display:flex; gap:16px; margin-bottom:28px; flex-wrap:wrap; }
    .stat-box { flex:1; min-width:120px; background:#fadae1; border-radius:14px; padding:16px; text-align:center; }
    .stat-box .n { font-family:Georgia,serif; font-size:2rem; color:#cd8e9d; }
    .stat-box .l { font-size:.7rem; color:#a0536a; text-transform:uppercase; letter-spacing:.8px; margin-top:4px; }
    .chart-box { background:#fff8f9; border:1.5px solid #fadae1; border-radius:14px; padding:20px; margin-bottom:28px; }
    .chart-box h2 { font-size:1rem; color:#cd8e9d; margin-bottom:14px; }
    .chart-box img { width:100%; border-radius:8px; }
    .tendencia { display:inline-block; font-weight:700; font-size:.95rem; margin-top:10px; padding:6px 16px; border-radius:20px; background:#fadae1; color:${tendenciaColor}; }
    .mensaje { background:#fadae1; border-left:4px solid #cd8e9d; border-radius:0 14px 14px 0; padding:16px 20px; margin-bottom:28px; font-size:.9rem; line-height:1.7; }
    .pie { margin-top:40px; padding-top:14px; border-top:1px solid #fadae1; font-size:.72rem; color:#a0536a; text-align:center; font-style:italic; }
    @media print { @page { margin:2cm; size:A4; } }
  </style></head><body>

  <div class="header">
    <img src="${logoSrc}" alt="Logo">
    <div><h1>Luisa Fernanda Garc√©s Garc√≠a</h1><p>Psic√≥loga ¬∑ TP 174366</p></div>
  </div>

  <div class="titulo">Tu Progreso en Terapia üå∏</div>
  <div class="subtitulo">${pac.nombre} ¬∑ Reporte generado el ${fechaHoy}</div>

  <div class="mensaje">
    Hola ${nombreCorto}, este documento es un reflejo de tu camino en el proceso terap√©utico. 
    Cada sesi√≥n que has asistido es un paso que has dado por ti mismo/a. 
    Los n√∫meros no lo dicen todo, pero s√≠ nos ayudan a ver juntas c√≥mo te has sentido a lo largo del tiempo. üíõ
  </div>

  <div class="stats-row">
    <div class="stat-box"><div class="n">${ses.length}</div><div class="l">Sesiones completadas</div></div>
    <div class="stat-box"><div class="n">${prom}</div><div class="l">Estado emocional promedio</div></div>
    <div class="stat-box"><div class="n">${data[data.length-1]}/10</div><div class="l">√öltima sesi√≥n</div></div>
    <div class="stat-box"><div class="n">${tests.length}</div><div class="l">Evaluaciones realizadas</div></div>
  </div>

  <div class="chart-box">
    <h2>üìà Evoluci√≥n de tu Estado Emocional por Sesi√≥n</h2>
    <img src="${chartDataUrl}" alt="Gr√°fica de evoluci√≥n">
    <div><span class="tendencia">${tendenciaTexto}</span></div>
  </div>

  ${testsHTML}
  ${sesTabla}

  <div class="pie">
    Este documento es personal y confidencial. Elaborado por Luisa Fernanda Garc√©s Garc√≠a, Psic√≥loga ¬∑ TP 174366.<br>
    La informaci√≥n aqu√≠ contenida es de uso exclusivo del paciente y la terapeuta.
  </div>
  </body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.onload = () => win.print();
}


// ===================== BACKUP / RESTORE =====================
function exportarJSON(){
  const backup = { version: '1.0', fecha: new Date().toISOString(), datos: {} };
  const appKeys = ['pacientes','agenda_eventos','finanzas_registros'];
  const pacs = getPacientes();
  pacs.forEach(p => {
    appKeys.push('anamnesis_'+p.id);
    appKeys.push('plan_'+p.id);
    appKeys.push('sesiones_'+p.id);
    appKeys.push('tests_'+p.id);
  });
  appKeys.forEach(k => {
    const val = DB.get(k);
    if(val !== null && val !== undefined) backup.datos[k] = JSON.stringify(val);
  });
  const json = JSON.stringify(backup, null, 2);
  const blob = new Blob([json], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const fecha = new Date().toLocaleDateString('es-CO').replace(/\//g,'-');
  a.href = url; a.download = 'SuiteClinica_Respaldo_' + fecha + '.json';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Respaldo exportado ‚úì');
}

function importarJSON(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const backup = JSON.parse(e.target.result);
      if(!backup.datos){ toast('Archivo inv√°lido'); return; }
      const fechaBackup = new Date(backup.fecha).toLocaleDateString('es-CO');
      const ok = window.confirm(
        '¬øImportar respaldo del ' + fechaBackup + '?\n\n' +
        'Esto REEMPLAZAR√Å todos los datos actuales en este dispositivo.\n\n¬øContinuar?'
      );
      if(!ok){ event.target.value=''; return; }
      // Escribir datos del respaldo usando DB (se sincronizan a Firebase)
      Object.entries(backup.datos).forEach(([k,v]) => {
        try { DB.set(k, JSON.parse(v)); } catch(e){ DB.set(k, v); }
      });
      event.target.value = '';
      toast('Respaldo importado ‚úì ‚Äî Recargando...');
      setTimeout(() => location.reload(), 1400);
    } catch(err) {
      toast('Error al leer el archivo');
      event.target.value = '';
    }
  };
  reader.readAsText(file);
}

// ===================== DASHBOARD =====================
function renderDashboard(){
  const pacs = getPacientes();
  let totalSes = 0;
  pacs.forEach(p=>{ totalSes += getSesionesCount(p.id); });

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card"><div class="num">${pacs.length}</div><div class="lbl2">Pacientes</div></div>
    <div class="stat-card"><div class="num">${totalSes}</div><div class="lbl2">Sesiones totales</div></div>
    <div class="stat-card"><div class="num">${new Date().toLocaleDateString('es-CO',{day:'numeric',month:'short'})}</div><div class="lbl2">Hoy</div></div>
  `;

  const recent = pacs.slice(-6).reverse();
  document.getElementById('dash-recent-patients').innerHTML = recent.length ?
    `<div class="patient-grid">${recent.map(p=>`<div class="patient-card" onclick="goPageDirect('pacientes')"><h3>${p.nombre}</h3><div class="meta">${p.ocup||'‚Äî'}</div><div class="badge">${getSesionesCount(p.id)} sesi√≥n(es)</div></div>`).join('')}</div>` :
    '<p style="font-size:.85rem;color:var(--border)">A√∫n no tienes pacientes. <a href="#" onclick="goPageDirect(\'pacientes\')" style="color:var(--border)">Crea el primero ‚Üí</a></p>';

  // √∫ltimas sesiones
  let allSes = [];
  pacs.forEach(p=>{ const s=DB.get('sesiones_'+p.id)||[]; s.forEach(x=>allSes.push({...x,pacNombre:p.nombre})); });
  allSes.sort((a,b)=>new Date(b.guardada)-new Date(a.guardada));
  document.getElementById('dash-recent-sessions').innerHTML = allSes.slice(0,5).length ?
    allSes.slice(0,5).map(s=>`<div class="session-item"><h4>${s.pacNombre} ¬∑ Sesi√≥n #${s.num}</h4><p>${s.fecha||'‚Äî'} ¬∑ Estado: ${s.estado||'‚Äî'}/10</p></div>`).join('') :
    '<p style="font-size:.85rem;color:var(--border)">A√∫n no hay sesiones registradas.</p>';
}

function goPageDirect(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(name==='pacientes') renderPacientes();
}

// ===================== TOAST =====================
function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2500);
}


// ===================== AGENDA =====================
var agEventos = (function(){ try{ return JSON.parse(localStorage.getItem('agenda_eventos')||'[]'); }catch(e){return[];} })();
function agGuardar(){ DB.set('agenda_eventos', agEventos); }

var agTabActual = 'hoy';
var agDiaOffset = 0;
var agMeses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
var agDias = ['domingo','lunes','martes','mi√©rcoles','jueves','viernes','s√°bado'];

function agGetFecha(offset){ var d=new Date(); d.setDate(d.getDate()+(offset||0)); return d; }
function agFormatFecha(d){ return agDias[d.getDay()]+', '+d.getDate()+' de '+agMeses[d.getMonth()]; }
function agFormatHora(str){ var d=new Date(str); return d.toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit',hour12:true}); }
function agMismoDia(d1,d2){ return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()&&d1.getDate()===d2.getDate(); }

function renderAgenda(){
  if(agTabActual==='semana'){ agRenderSemana(); return; }
  var offset = agTabActual==='manana'?1:agDiaOffset;
  var fechaRef = agGetFecha(offset);
  var prefijo = agTabActual==='hoy'?'Hoy ¬∑ ':agTabActual==='manana'?'Ma√±ana ¬∑ ':'';
  document.getElementById('ag-fecha-titulo').textContent = prefijo + agFormatFecha(fechaRef);
  document.getElementById('ag-prev').style.display = agTabActual==='semana'?'none':'';
  document.getElementById('ag-next').style.display = agTabActual==='semana'?'none':'';
  var evs = agEventos.filter(e=>agMismoDia(new Date(e.inicio), fechaRef));
  evs.sort((a,b)=>new Date(a.inicio)-new Date(b.inicio));
  var c = document.getElementById('ag-container');
  if(!evs.length){ c.innerHTML='<div class="ag-empty"><div class="emoji">üå∏</div><p>No hay citas este d√≠a.</p></div>'; return; }
  c.innerHTML = evs.map(e=>agCard(e)).join('');
}

function agRenderSemana(){
  document.getElementById('ag-fecha-titulo').textContent = 'Esta semana';
  var c = document.getElementById('ag-container'); var html='';
  for(var i=0;i<7;i++){
    var dia=agGetFecha(i);
    var evs=agEventos.filter(e=>agMismoDia(new Date(e.inicio),dia));
    evs.sort((a,b)=>new Date(a.inicio)-new Date(b.inicio));
    if(evs.length){ html+='<div class="dia-label">'+agFormatFecha(dia)+'</div>'+evs.map(e=>agCard(e)).join(''); }
  }
  c.innerHTML = html||'<div class="ag-empty"><div class="emoji">üå∏</div><p>No hay citas esta semana.</p></div>';
}

function agCard(e){
  var hora=agFormatHora(e.inicio); var horaFin=agFormatHora(e.fin);
  var safeId='agwa_'+e.id.replace(/[^a-z0-9]/gi,'_');
  var tagMap={virtual:'<span class="ag-tag virtual">Virtual</span>',presencial:'<span class="ag-tag presencial">Presencial</span>',admin:'<span class="ag-tag admin">Administrativo</span>'};
  var waBtn=e.tipo!=='admin'?`<button class="btn" style="font-size:.78rem;padding:6px 14px" onclick="agToggleWA('${safeId}')">üí¨ Recordatorio WhatsApp</button>`:'';
  var waBox=e.tipo!=='admin'?`<div class="wa-box" id="${safeId}"><button class="copy-badge" onclick="agCopiar('${safeId}',this)">Copiar</button><span class="wa-texto">${agGenerarMsg(e)}</span></div>`:'';
  var delBtn=`<button class="btn" style="font-size:.72rem;padding:5px 12px;color:var(--strong);border-color:var(--bg)" onclick="agEliminar('${e.id}')">üóë</button>`;
  return `<div class="cita-card"><div class="cita-hora">${hora} ‚Äì ${horaFin}</div><div class="cita-nombre">${e.titulo}</div>${e.descripcion?`<div class="cita-desc">${e.descripcion}</div>`:''}${tagMap[e.tipo]||''}<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">${waBtn}${delBtn}</div>${waBox}</div>`;
}

function agGenerarMsg(e){
  var hora=agFormatHora(e.inicio);
  var nombreLimpio=e.titulo.replace(/CONSULTORIO (VIRTUAL|PRESENCIAL)\s*[-‚Äì]\s*/i,'').replace(/Sesi√≥n #?\d*/i,'sesi√≥n').trim();
  return `Hola üå∏\n\nTe escribo para recordarte tu ${nombreLimpio} conmigo ma√±ana a las *${hora}*.\n\nSi necesitas cancelar o reprogramar, por favor av√≠same con anticipaci√≥n.\n\n¬°Nos vemos pronto! üåø\n\n*Luisa Fernanda Garc√©s Garc√≠a*\n_Psic√≥loga_`;
}

function agToggleWA(id){ document.getElementById(id).classList.toggle('show'); }
function agCopiar(id,btn){
  var txt=document.getElementById(id).querySelector('.wa-texto').textContent.trim();
  navigator.clipboard.writeText(txt).then(()=>{
    btn.textContent='‚úì Copiado'; btn.classList.add('copied');
    toast('¬°Mensaje copiado! P√©galo en WhatsApp üå∏');
    setTimeout(()=>{btn.textContent='Copiar';btn.classList.remove('copied');},2500);
  });
}
function importarICS(event){
  const file = event.target.files[0];
  if(!file){ return; }
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    const eventos = parsearICS(text);
    if(!eventos.length){ toast('No se encontraron eventos en el archivo'); event.target.value=''; return; }
    const reemplazar = confirm(
      `Se encontraron ${eventos.length} evento(s) en el archivo.\n\n` +
      `¬øQuieres REEMPLAZAR todos los eventos actuales con estos?\n\n` +
      `Presiona Cancelar para AGREGAR los nuevos sin borrar los existentes.`
    );
    if(reemplazar){
      agEventos = eventos;
    } else {
      // Add only events not already present (by title+date)
      const existingKeys = new Set(agEventos.map(e => e.titulo+'|'+e.inicio.slice(0,16)));
      const nuevos = eventos.filter(e => !existingKeys.has(e.titulo+'|'+e.inicio.slice(0,16)));
      agEventos = [...agEventos, ...nuevos];
      toast(`${nuevos.length} evento(s) nuevo(s) agregados ‚úì`);
    }
    agGuardar();
    renderAgenda();
    event.target.value = '';
    if(reemplazar) toast(`${eventos.length} evento(s) importados ‚úì`);
  };
  reader.readAsText(file, 'UTF-8');
}

function parsearICS(text){
  const eventos = [];
  // Unfold lines (ICS wraps long lines with \r\n + space/tab)
  const unfolded = text.replace(/\r\n[ \t]/g, '').replace(/\r/g, '');
  const bloques = unfolded.split('BEGIN:VEVENT');
  bloques.shift(); // remove content before first VEVENT

  bloques.forEach(bloque => {
    const get = (key) => {
      // Match KEY or KEY;params=value: VALUE
      const match = bloque.match(new RegExp('^' + key + '(?:;[^:]*)?:(.+)$', 'm'));
      return match ? match[1].trim() : '';
    };

    const summary = decodeICSText(get('SUMMARY'));
    if(!summary) return;

    // Parse DTSTART ‚Äî handle DATE-only, datetime with/without Z, with TZID
    const dtstart = parsearFechaICS(bloque, 'DTSTART');
    const dtend   = parsearFechaICS(bloque, 'DTEND');
    if(!dtstart) return;

    // Determine type from title keywords
    let tipo = 'presencial';
    const tl = summary.toLowerCase();
    if(tl.includes('virtual') || tl.includes('online') || tl.includes('zoom') || tl.includes('meet')) tipo = 'virtual';
    if(tl.includes('admin') || tl.includes('mensaje') || tl.includes('bloque') || tl.includes('preparaci')) tipo = 'admin';

    const desc = decodeICSText(get('DESCRIPTION'));
    const location = decodeICSText(get('LOCATION'));

    eventos.push({
      id: 'ics_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
      titulo: summary,
      inicio: dtstart,
      fin: dtend || dtstart,
      tipo,
      descripcion: desc || location || ''
    });
  });

  // Sort by date
  eventos.sort((a,b) => new Date(a.inicio) - new Date(b.inicio));
  return eventos;
}

function parsearFechaICS(bloque, key){
  // Match KEY, KEY;TZID=..., KEY;VALUE=DATE, etc.
  const match = bloque.match(new RegExp(key + '(?:;[^:]*)?:([\\d{8}T\\d{6}Z?]+)', 'm'));
  if(!match) return '';
  const raw = match[1].trim();

  try {
    if(raw.length === 8){
      // DATE only: YYYYMMDD
      return raw.slice(0,4)+'-'+raw.slice(4,6)+'-'+raw.slice(6,8)+'T08:00:00';
    }
    // YYYYMMDDTHHMMSS or YYYYMMDDTHHMMSSZ
    const y=raw.slice(0,4), mo=raw.slice(4,6), d=raw.slice(6,8);
    const h=raw.slice(9,11), mi=raw.slice(11,13), s=raw.slice(13,15)||'00';
    return `${y}-${mo}-${d}T${h}:${mi}:${s}`;
  } catch(e){ return ''; }
}

function decodeICSText(str){
  if(!str) return '';
  return str
    .replace(/\\n/g, ' ')
    .replace(/\\,/g, ',')
    .replace(/\\;/g, ';')
    .replace(/\\\\/g, '\\')
    .trim();
}

function agLimpiarTodo(){
  agEventos = [];
  agGuardar();
  renderAgenda();
  toast('Agenda limpiada ‚úì');
}
function agSwitchTab(tab,el){
  document.querySelectorAll('.ag-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderAgenda();
}
function agCambiarDia(dir){ agDiaOffset+=dir; if(agDiaOffset<0)agDiaOffset=0; renderAgenda(); }
function agAgregarEvento(){
  var titulo=document.getElementById('ag-nuevo-titulo').value.trim();
  var inicio=document.getElementById('ag-nuevo-inicio').value;
  var fin=document.getElementById('ag-nuevo-fin').value;
  var tipo=document.getElementById('ag-nuevo-tipo').value;
  var desc=document.getElementById('ag-nuevo-desc').value.trim();
  if(!titulo||!inicio){ toast('Ingresa t√≠tulo y fecha de inicio'); return; }
  agEventos.push({id:'ev'+Date.now(),titulo,inicio,fin:fin||inicio,tipo,descripcion:desc});
  agGuardar();
  document.getElementById('ag-nuevo-titulo').value='';
  document.getElementById('ag-nuevo-inicio').value='';
  document.getElementById('ag-nuevo-fin').value='';
  document.getElementById('ag-nuevo-desc').value='';
  renderAgenda();
  toast('Evento guardado ‚úì');
}
function agEliminar(id){
  if(!confirm('¬øEliminar este evento?')) return;
  agEventos=agEventos.filter(e=>e.id!==id);
  agGuardar(); renderAgenda();
}

// ===================== FINANZAS =====================
var registros = (function(){ try{ return JSON.parse(localStorage.getItem('finanzas_registros')||'[]'); }catch(e){return[];} })();
var mesActual = new Date().getMonth();
var anioActual = new Date().getFullYear();
var reciboActual = null;
var mesesFin = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
var tiposLabel = {'80000':'Sesi√≥n individual','140000':'Sesi√≥n pareja/familia','140000b':'Evaluaci√≥n individual','160000':'Evaluaci√≥n pareja','custom':'Otro'};
var metodoLabel = {'efectivo':'Efectivo','nu':'Nu','davibank':'Davibank','nequi':'Nequi','breve':'Breve'};

function finHoy(){ return new Date().toISOString().split('T')[0]; }
function finGuardar(){ DB.set('finanzas_registros', registros); }
function formatPesos(n){ return '$'+Number(n).toLocaleString('es-CO'); }
function getMonto(){
  var tipo=document.getElementById('r_tipo').value;
  if(tipo==='custom') return parseInt(document.getElementById('r_monto_custom').value)||0;
  if(tipo==='140000b') return 140000;
  return parseInt(tipo);
}

document.addEventListener('DOMContentLoaded',()=>{
  var rTipo=document.getElementById('r_tipo');
  if(rTipo) rTipo.addEventListener('change',function(){
    document.getElementById('campo-monto-custom').style.display=this.value==='custom'?'block':'none';
  });
  var rF=document.getElementById('r_fecha'); if(rF) rF.value=finHoy();
  var gF=document.getElementById('g_fecha'); if(gF) gF.value=finHoy();
});

function finSwitchTab(tab,el){
  document.querySelectorAll('.fin-screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.fin-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('fin-'+tab).classList.add('active');
  el.classList.add('active');
}

function registrarPago(abrirR){
  var paciente=document.getElementById('r_paciente').value.trim();
  var fecha=document.getElementById('r_fecha').value;
  var monto=getMonto();
  var metodo=document.getElementById('r_metodo').value;
  var estado=document.getElementById('r_estado').value;
  var tipoVal=document.getElementById('r_tipo').value;
  if(!paciente||!monto){ toast('Por favor completa el nombre y el monto'); return null; }
  var reg={id:Date.now(),tipo:'ingreso',paciente,fecha,monto,metodo,estado,tipoSesion:tipoVal==='custom'?'Otro':(tiposLabel[tipoVal]||'Sesi√≥n')};
  registros.push(reg); finGuardar(); renderAll();
  document.getElementById('r_paciente').value='';
  document.getElementById('r_fecha').value=finHoy();
  if(!abrirR) toast('‚úÖ Pago registrado');
  return reg;
}
function registrarYRecibo(){ var reg=registrarPago(true); if(reg) abrirRecibo(reg); }
function registrarGasto(){
  var desc=document.getElementById('g_desc').value.trim();
  var fecha=document.getElementById('g_fecha').value;
  var monto=parseInt(document.getElementById('g_monto').value)||0;
  var cat=document.getElementById('g_cat').value;
  if(!desc||!monto){ toast('Completa descripci√≥n y monto'); return; }
  registros.push({id:Date.now(),tipo:'gasto',descripcion:desc,fecha,monto,categoria:cat});
  finGuardar(); renderAll();
  document.getElementById('g_desc').value=''; document.getElementById('g_monto').value='';
  toast('‚úÖ Gasto registrado');
}
function eliminar(id){
  if(!confirm('¬øEliminar este registro?')) return;
  registros=registros.filter(r=>r.id!==id); finGuardar(); renderAll();
}
function getById(id){ return registros.find(r=>r.id===id); }

function getRegistrosMes(m,a){ return registros.filter(r=>{ var d=new Date(r.fecha+'T12:00:00'); return d.getMonth()===m&&d.getFullYear()===a; }); }

function renderAll(){
  renderResumen(); renderHistorial(); renderDeudores();
  var t1=document.getElementById('mesTitle'); var t2=document.getElementById('mesTitle2');
  var titulo=mesesFin[mesActual]+' '+anioActual;
  if(t1) t1.textContent=titulo; if(t2) t2.textContent=titulo;
}
function renderResumen(){
  var regs=getRegistrosMes(mesActual,anioActual);
  var ingresos=regs.filter(r=>r.tipo==='ingreso'&&r.estado==='pagado');
  var gastos=regs.filter(r=>r.tipo==='gasto');
  var totalI=ingresos.reduce((s,r)=>s+r.monto,0);
  var totalG=gastos.reduce((s,r)=>s+r.monto,0);
  var pendientes=registros.filter(r=>r.tipo==='ingreso'&&r.estado==='pendiente');
  var totalP=pendientes.reduce((s,r)=>s+r.monto,0);
  document.getElementById('stat-ingresos').textContent=formatPesos(totalI);
  document.getElementById('stat-ingresos-n').textContent=ingresos.length+' sesiones';
  document.getElementById('stat-gastos').textContent=formatPesos(totalG);
  document.getElementById('stat-gastos-n').textContent=gastos.length+' registros';
  document.getElementById('stat-neta').textContent=formatPesos(totalI-totalG);
  document.getElementById('stat-pendientes').textContent=formatPesos(totalP);
  document.getElementById('stat-pendientes-n').textContent=pendientes.length+' pacientes';
  var lista=document.getElementById('resumen-lista');
  var recientes=regs.slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).slice(0,5);
  lista.innerHTML=recientes.length?'<div style="font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;color:var(--border);margin-bottom:10px;font-weight:500">Actividad reciente</div>'+recientes.map(pagoItemHTML).join(''):'<div style="text-align:center;padding:32px;color:var(--border)">Sin registros este mes</div>';
}
function renderHistorial(){
  var regs=getRegistrosMes(mesActual,anioActual).slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
  var lista=document.getElementById('historial-lista');
  lista.innerHTML=regs.length?regs.map(pagoItemHTML).join(''):'<div style="text-align:center;padding:32px;color:var(--border)">Sin registros este mes</div>';
}
function renderDeudores(){
  var pendientes=registros.filter(r=>r.tipo==='ingreso'&&r.estado==='pendiente');
  var lista=document.getElementById('deudores-lista');
  if(!pendientes.length){ lista.innerHTML='<div style="text-align:center;padding:32px;color:var(--border)">üå∏ ¬°Sin pagos pendientes!</div>'; return; }
  var porPac={};
  pendientes.forEach(r=>{ if(!porPac[r.paciente]) porPac[r.paciente]={total:0,sesiones:0}; porPac[r.paciente].total+=r.monto; porPac[r.paciente].sesiones++; });
  lista.innerHTML=Object.keys(porPac).map(nombre=>{
    var d=porPac[nombre];
    return `<div class="deudor-item"><div><div class="deudor-nombre">${nombre}</div><div style="font-size:.75rem;color:var(--strong)">${d.sesiones} sesi√≥n(es) pendiente(s)</div></div><div class="deudor-monto">${formatPesos(d.total)}</div></div>`;
  }).join('');
}
function pagoItemHTML(r){
  var esI=r.tipo==='ingreso';
  var fecha=new Date(r.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'short'});
  var metBadge=esI?`<span class="metodo-badge">${metodoLabel[r.metodo]||r.metodo}</span>`:'';
  var pendBadge=(esI&&r.estado==='pendiente')?'<span style="background:#fff3e0;color:#f57c00;padding:2px 8px;border-radius:10px;font-size:.68rem;font-weight:600;margin-left:4px">Pendiente</span>':'';
  var acciones=esI?`<button class="icon-btn" onclick="abrirRecibo(getById(${r.id}))" title="Recibo">üßæ</button><button class="icon-btn btn-danger" onclick="eliminar(${r.id})" title="Eliminar">‚úï</button>`:`<button class="icon-btn btn-danger" onclick="eliminar(${r.id})" title="Eliminar">‚úï</button>`;
  return `<div class="pago-item"><div class="pago-dot ${r.tipo}"></div><div class="pago-info"><div class="pago-nombre">${esI?r.paciente:r.descripcion}</div><div class="pago-meta">${fecha} ¬∑ ${esI?r.tipoSesion:r.categoria} ${metBadge}${pendBadge}</div></div><div class="pago-monto ${r.tipo}">${esI?'+':'-'}${formatPesos(r.monto)}</div><div class="pago-actions">${acciones}</div></div>`;
}

function abrirRecibo(reg){
  if(!reg) return; reciboActual=reg;
  var fecha=new Date(reg.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  var numRecibo='REC-'+reg.id.toString().slice(-6);
  document.getElementById('reciboContent').innerHTML=
    '<div class="recibo-logo"><p>Luisa Fernanda Garc√©s Garc√≠a</p><small>Psic√≥loga ¬∑ Consultorio</small></div>'+
    '<hr class="recibo-divider">'+
    `<div class="recibo-fila"><span>N√∫mero</span><span>${numRecibo}</span></div>`+
    `<div class="recibo-fila"><span>Fecha</span><span>${fecha}</span></div>`+
    `<div class="recibo-fila"><span>Paciente</span><span>${reg.paciente}</span></div>`+
    `<div class="recibo-fila"><span>Servicio</span><span>${reg.tipoSesion}</span></div>`+
    `<div class="recibo-fila"><span>M√©todo</span><span>${metodoLabel[reg.metodo]||reg.metodo}</span></div>`+
    `<div class="recibo-total"><span>Total pagado</span><span>${formatPesos(reg.monto)}</span></div>`;
  document.getElementById('modalOverlay').classList.add('open');
}
function cerrarModalBtn(){ document.getElementById('modalOverlay').classList.remove('open'); }
function cerrarModal(e){ if(e.target===document.getElementById('modalOverlay')) cerrarModalBtn(); }
function enviarReciboWA(){
  if(!reciboActual) return;
  var r=reciboActual;
  var fecha=new Date(r.fecha+'T12:00:00').toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  var msg='üå∏ *Recibo de pago*\n\n*Luisa Fernanda Garc√©s Garc√≠a*\n*Psic√≥loga*\n\nN√∫mero: REC-'+r.id.toString().slice(-6)+'\nFecha: '+fecha+'\nPaciente: '+r.paciente+'\nServicio: '+r.tipoSesion+'\nM√©todo: '+(metodoLabel[r.metodo]||r.metodo)+'\n\n*Total: '+formatPesos(r.monto)+'*\n\n_Gracias por tu confianza üå∏_';
  window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
}
function cambiarMes(dir){
  mesActual+=dir;
  if(mesActual>11){mesActual=0;anioActual++;} if(mesActual<0){mesActual=11;anioActual--;}
  renderAll();
}


// ===================== DOCUMENTOS CL√çNICOS =====================
const DOC_TIPOS = [
  { id:'cert_bilingue',    icon:'üåê', nombre:'Certificado Psicol√≥gico', desc:'Biling√ºe espa√±ol/ingl√©s. Con diagn√≥stico y firma profesional.' },
  { id:'cert_espanol',     icon:'üìã', nombre:'Certificado (solo espa√±ol)', desc:'Versi√≥n solo en espa√±ol para uso nacional.' },
  { id:'cert_esa',         icon:'üêæ', nombre:'Certificado ESA', desc:'Animal de soporte emocional. Biling√ºe.' },
  { id:'informe_seguimiento', icon:'üìà', nombre:'Informe de Seguimiento', desc:'Evoluci√≥n terap√©utica del paciente en el per√≠odo.' },
  { id:'informe_diagnostico', icon:'üîç', nombre:'Informe Diagn√≥stico', desc:'Evaluaci√≥n diagn√≥stica completa con resultados.' },
  { id:'informe_legal',    icon:'‚öñÔ∏è', nombre:'Informe Legal / Custodia', desc:'Para procesos judiciales, custodias o peritajes.' },
  { id:'informe_incapacidad', icon:'üè•', nombre:'Incapacidad Laboral', desc:'Certificado de incapacidad por condici√≥n psicol√≥gica.' },
];
var docTipoSeleccionado = null;

function renderDocumentos() {
  const grid = document.getElementById('doc-tipos-grid');
  grid.innerHTML = DOC_TIPOS.map(t => `
    <button class="doc-tipo-btn ${docTipoSeleccionado===t.id?'selected':''}" onclick="docSeleccionarTipo('${t.id}')">
      <div class="dt-icon">${t.icon}</div>
      <div class="dt-nombre">${t.nombre}</div>
      <div class="dt-desc">${t.desc}</div>
    </button>`).join('');
  const sel = document.getElementById('doc-sel-pac');
  const pacs = getPacientes();
  sel.innerHTML = '<option value="">‚Äî O ingresa los datos manualmente ‚Äî</option>' +
    pacs.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
}

function docSeleccionarTipo(id) {
  docTipoSeleccionado = id;
  renderDocumentos();
  ['doc-paso2','doc-paso3','doc-paso4'].forEach(x=>document.getElementById(x).style.display='block');
  const t = DOC_TIPOS.find(x=>x.id===id);
  document.getElementById('doc-paso3-titulo').textContent = `3Ô∏è‚É£ Contenido ¬∑ ${t.icon} ${t.nombre}`;
  renderCamposEspecificos(id);
  docActualizarPreview();
  document.getElementById('doc-paso2').scrollIntoView({behavior:'smooth',block:'start'});
}

function docCargarPaciente() {
  const pid = document.getElementById('doc-sel-pac').value;
  if(!pid) return;
  const pac = getPacientes().find(p=>p.id===pid);
  if(!pac) return;
  document.getElementById('doc-pac-nombre').value = pac.nombre||'';
  document.getElementById('doc-pac-cc').value = '';
  document.getElementById('doc-pac-fnac').value = pac.fnac||'';
  document.getElementById('doc-tratamiento').value = pac.genero==='Femenino'?'La se√±ora':'El se√±or';
  const an = DB.get('anamnesis_'+pid)||{};
  const dxField = document.getElementById('doc-diagnostico');
  if(dxField && an.dx) dxField.value = an.dx;
  const modalField = document.getElementById('doc-modalidad');
  if(modalField){ const plan=DB.get('plan_'+pid)||{}; if(plan.modalidad) modalField.value=plan.modalidad; }
}

const CAMPOS_POR_TIPO = {
  cert_bilingue: [
    {id:'diagnostico',label:'Diagn√≥stico (espa√±ol)',ph:'Ej: Trastorno de Ansiedad Generalizada (TAG)'},
    {id:'diagnostico_en',label:'Diagn√≥stico (ingl√©s)',ph:'Ej: Generalized Anxiety Disorder (GAD)'},
    {id:'manual',label:'Manual diagn√≥stico',ph:'DSM-5',val:'DSM-5'},
    {id:'modalidad',label:'Modalidad de evaluaci√≥n',ph:'virtual / presencial',val:'virtual'},
    {id:'cuerpo',label:'Cuerpo del certificado (espa√±ol)',ph:'Con base en la evaluaci√≥n...',area:true},
    {id:'cuerpo_en',label:'Certificate body (English)',ph:'Based on the clinical assessment...',area:true},
    {id:'observaciones',label:'Observaciones adicionales (opcional)',ph:'',area:true},
  ],
  cert_espanol: [
    {id:'diagnostico',label:'Diagn√≥stico',ph:'Ej: Trastorno Depresivo Mayor (TDM)'},
    {id:'manual',label:'Manual diagn√≥stico',ph:'DSM-5',val:'DSM-5'},
    {id:'modalidad',label:'Modalidad',ph:'virtual / presencial',val:'virtual'},
    {id:'cuerpo',label:'Cuerpo del certificado',ph:'Con base en la evaluaci√≥n cl√≠nica realizada...',area:true},
    {id:'observaciones',label:'Observaciones adicionales (opcional)',ph:'',area:true},
  ],
  cert_esa: [
    {id:'diagnostico',label:'Diagn√≥stico / condici√≥n de salud mental',ph:'Ej: Trastorno de Ansiedad, TEPT...'},
    {id:'nombreAnimal',label:'Nombre del animal',ph:'Ej: Luna'},
    {id:'especieAnimal',label:'Especie / Raza',ph:'Ej: Perro / Golden Retriever'},
    {id:'descAnimal',label:'Descripci√≥n del animal',ph:'Ej: Hembra, color dorado, 3 a√±os'},
  ],
  informe_seguimiento: [
    {id:'diagnostico',label:'Diagn√≥stico',ph:''},
    {id:'periodo',label:'Per√≠odo evaluado',ph:'Ej: Enero ‚Äì Marzo 2025'},
    {id:'modalidad',label:'Modalidad',ph:'virtual / presencial',val:'virtual'},
    {id:'numSesiones',label:'N√∫mero de sesiones en el per√≠odo',ph:'Ej: 8'},
    {id:'motivoConsulta',label:'Motivo de consulta y antecedentes',ph:'',area:true},
    {id:'evolucion',label:'Evoluci√≥n cl√≠nica observada',ph:'',area:true},
    {id:'logros',label:'Logros terap√©uticos',ph:'',area:true},
    {id:'dificultades',label:'Dificultades observadas (opcional)',ph:'',area:true},
    {id:'estadoActual',label:'Estado actual del paciente',ph:'',area:true},
    {id:'estadoEmocional',label:'Estado emocional promedio (1-10)',ph:'Ej: 7'},
    {id:'planContinuidad',label:'Plan de continuidad terap√©utica',ph:'',area:true},
    {id:'conclusiones',label:'Conclusiones',ph:'',area:true},
  ],
  informe_diagnostico: [
    {id:'fechaEval',label:'Fecha(s) de evaluaci√≥n',ph:'Ej: 10, 17 y 24 de febrero de 2025'},
    {id:'modalidad',label:'Modalidad',ph:'virtual / presencial',val:'virtual'},
    {id:'numSesiones',label:'N√∫mero de sesiones de evaluaci√≥n',ph:'Ej: 3'},
    {id:'motivoConsulta',label:'Motivo de consulta',ph:'',area:true},
    {id:'historia',label:'Historia cl√≠nica relevante',ph:'',area:true},
    {id:'instrumentos',label:'Instrumentos y t√©cnicas utilizadas',ph:'Ej: Entrevista cl√≠nica, PHQ-9, GAD-7, YSQ-L3...',area:true},
    {id:'resultados',label:'Resultados de la evaluaci√≥n',ph:'',area:true},
    {id:'diagnostico',label:'Diagn√≥stico principal',ph:'Ej: F41.1 TAG (CIE-11)'},
    {id:'manual',label:'Manual diagn√≥stico',ph:'DSM-5 / CIE-11',val:'DSM-5 / CIE-11'},
    {id:'diagnosticoDif',label:'Diagn√≥stico diferencial (opcional)',ph:''},
    {id:'recomendaciones',label:'Recomendaciones',ph:'',area:true},
    {id:'conclusiones',label:'Conclusiones',ph:'',area:true},
  ],
  informe_legal: [
    {id:'tipoProcess',label:'Tipo de proceso',ph:'Ej: Custodia, Proceso Penal, Evaluaci√≥n Pericial'},
    {id:'solicitante',label:'Solicitado por',ph:'Nombre de la persona o entidad'},
    {id:'entidad',label:'Autoridad / Entidad',ph:'Ej: Juzgado de Familia, Fiscal√≠a...'},
    {id:'proposito',label:'Prop√≥sito del informe',ph:'',area:true},
    {id:'radicado',label:'N√∫mero de radicado / expediente (opcional)',ph:''},
    {id:'relacionProceso',label:'Relaci√≥n del paciente con el proceso',ph:'Ej: Demandante, hijo en disputa de custodia...'},
    {id:'metodologia',label:'Metodolog√≠a de evaluaci√≥n',ph:'',area:true},
    {id:'instrumentos',label:'Instrumentos aplicados',ph:''},
    {id:'hallazgos',label:'Hallazgos cl√≠nicos relevantes',ph:'',area:true},
    {id:'analisis',label:'An√°lisis psicol√≥gico',ph:'',area:true},
    {id:'conclusiones',label:'Conclusiones y concepto profesional',ph:'',area:true},
    {id:'recomendaciones',label:'Recomendaciones',ph:'',area:true},
  ],
  informe_incapacidad: [
    {id:'empleador',label:'Empleador / Empresa',ph:'Nombre del empleador'},
    {id:'cargo',label:'Cargo del paciente',ph:''},
    {id:'diagnostico',label:'Diagn√≥stico',ph:''},
    {id:'codigoDx',label:'C√≥digo CIE-11 / DSM-5',ph:'Ej: F33.1'},
    {id:'justificacion',label:'Justificaci√≥n de la incapacidad',ph:'',area:true},
    {id:'periodo',label:'Per√≠odo de incapacidad recomendado',ph:'Ej: 15 d√≠as'},
    {id:'fechaInicio',label:'Fecha de inicio',ph:'',type:'date'},
    {id:'fechaFin',label:'Fecha de fin estimada',ph:'',type:'date'},
    {id:'recomendaciones',label:'Recomendaciones',ph:'',area:true},
  ],
};

function renderCamposEspecificos(tipo) {
  const campos = CAMPOS_POR_TIPO[tipo]||[];
  document.getElementById('doc-campos-especificos').innerHTML = campos.map(c=>`
    <div class="doc-field-group">
      <label class="lbl">${c.label}</label>
      ${c.area
        ? `<textarea id="doc-${c.id}" placeholder="${c.ph||''}">${c.val||''}</textarea>`
        : `<input type="${c.type||'text'}" id="doc-${c.id}" placeholder="${c.ph||''}" value="${c.val||''}">`
      }
    </div>`).join('');
}

function docGetDatos() {
  const campos = CAMPOS_POR_TIPO[docTipoSeleccionado]||[];
  const datos={};
  campos.forEach(c=>{ const el=document.getElementById('doc-'+c.id); if(el) datos[c.id]=el.value.trim(); });
  return datos;
}

function docGetPaciente() {
  return {
    nombre: document.getElementById('doc-pac-nombre').value.trim()||'___________',
    cc: document.getElementById('doc-pac-cc').value.trim(),
    ciudadExp: document.getElementById('doc-pac-ciudad').value.trim()||'Medell√≠n',
    fnac: document.getElementById('doc-pac-fnac').value,
    tratamiento: document.getElementById('doc-tratamiento').value.trim(),
  };
}

function docActualizarPreview() {
  if(!docTipoSeleccionado) return;
  const pac=docGetPaciente(), datos=docGetDatos();
  const tipo=DOC_TIPOS.find(t=>t.id===docTipoSeleccionado);
  const fecha=new Date().toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  const PSI={nombre:'Luisa Fernanda Garc√©s Garc√≠a',tp:'174366',cc:'1036602429',tel:'3246381453',email:'luisafgarces@gmail.com'};
  let contenido='';
  switch(docTipoSeleccionado){
    case 'cert_bilingue': case 'cert_espanol':
      contenido=`${datos.cuerpo||'[Cuerpo del certificado]'}\n\n${datos.observaciones||''}`;
      break;
    case 'cert_esa':
      contenido=`Condici√≥n: ${datos.diagnostico||'___'}\nAnimal: ${datos.nombreAnimal||'___'} ¬∑ ${datos.especieAnimal||'___'}`;
      break;
    case 'informe_seguimiento':
      contenido=`Per√≠odo: ${datos.periodo||'___'} ¬∑ Sesiones: ${datos.numSesiones||'___'}\n\nEvoluci√≥n: ${(datos.evolucion||'[Por completar]').slice(0,200)}...\n\nConclusiones: ${(datos.conclusiones||'[Por completar]').slice(0,150)}...`;
      break;
    case 'informe_diagnostico':
      contenido=`Diagn√≥stico: ${datos.diagnostico||'___'} (${datos.manual||'DSM-5'})\n\nResultados: ${(datos.resultados||'[Por completar]').slice(0,200)}...\n\nConclusiones: ${(datos.conclusiones||'[Por completar]').slice(0,150)}...`;
      break;
    case 'informe_legal':
      contenido=`Proceso: ${datos.tipoProcess||'___'} ¬∑ Radicado: ${datos.radicado||'___'}\n\nHallazgos: ${(datos.hallazgos||'[Por completar]').slice(0,200)}...\n\nConcepto: ${(datos.conclusiones||'[Por completar]').slice(0,150)}...`;
      break;
    case 'informe_incapacidad':
      contenido=`Empleador: ${datos.empleador||'___'} ¬∑ Diagn√≥stico: ${datos.diagnostico||'___'}\nPer√≠odo: ${datos.periodo||'___'} ¬∑ Del ${datos.fechaInicio||'___'} al ${datos.fechaFin||'___'}\n\n${(datos.justificacion||'[Por completar]').slice(0,200)}...`;
      break;
  }
  document.getElementById('doc-preview-box').innerHTML=`
    <h3>${tipo?.icon} ${tipo?.nombre}</h3>
    <p style="text-align:center;font-size:.75rem;color:var(--border);margin-bottom:14px">Vista previa ¬∑ El Word descargado incluye logo, encabezado y formato completo</p>
    <hr style="border:none;border-top:1px solid var(--bg);margin:10px 0">
    <p style="margin:6px 0;font-size:.82rem"><strong>Paciente:</strong> ${pac.nombre} ¬∑ C.C. ${pac.cc||'___'}</p>
    <div style="margin:12px 0">${contenido.replace(/\n/g,'<br>')}</div>
    <div class="firma-preview">
      <strong>${PSI.nombre}</strong><br>
      Psic√≥loga Titulada ¬∑ T.P. No. ${PSI.tp}<br>
      C.C. ${PSI.cc} ¬∑ ${PSI.tel} ¬∑ ${PSI.email}
    </div>`;
}

function docGenerar() {
  if(!docTipoSeleccionado){ toast('Selecciona un tipo de documento'); return; }
  const pac=docGetPaciente();
  if(pac.nombre==='___________'){ toast('Ingresa el nombre del paciente'); return; }
  const datos=docGetDatos();
  const tipo=DOC_TIPOS.find(t=>t.id===docTipoSeleccionado);
  const rtf=docGenerarRTF(tipo, pac, datos);
  const blob=new Blob([rtf],{type:'application/rtf'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const nombre=(tipo.nombre+'_'+pac.nombre.split(' ')[0]).replace(/\s+/g,'_');
  a.href=url; a.download=nombre+'_'+new Date().toLocaleDateString('es-CO').replace(/\//g,'-')+'.rtf';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Documento generado ‚úì ‚Äî √Åbrelo en Word para editar y firmar');
}

function docGenerarRTF(tipo, pac, datos) {
  const fecha=new Date().toLocaleDateString('es-CO',{day:'numeric',month:'long',year:'numeric'});
  const PSI={nombre:'Luisa Fernanda Garc√©s Garc√≠a',tp:'174366',cc:'1036602429',tel:'3246381453',email:'luisafgarces@gmail.com',dir:'Circular 73A # 39-79, Medell√≠n, Colombia'};
  function re(s){ if(!s) return ''; let o=''; for(let i=0;i<s.length;i++){ const c=s.charCodeAt(i); if(c>127){const n=c>32767?c-65536:c;o+='\\u'+n+'?';} else if(c===92)o+='\\\\'; else if(c===123)o+='\\{'; else if(c===125)o+='\\}'; else if(c===10||c===13)o+='\\line '; else o+=s[i];} return o; }
  function title(t){ return `{\\pard\\sb200\\sa120\\qc{\\f1\\b\\fs30\\cf1 ${re(t)}}\\par}\n`; }
  function subtitle(t){ return `{\\pard\\sb40\\sa160\\qc{\\f0\\fs18\\i\\cf2 ${re(t)}}\\par}\n`; }
  function sec(t){ return `{\\pard\\sb240\\sa60\\brdrb\\brdrs\\brdrw8\\brdrcf2{\\f0\\b\\fs20\\cf1 ${re(t.toUpperCase())}}\\par}\n`; }
  function camp(l,v){ if(!v) return ''; return `{\\pard\\sb60\\sa40{\\f0\\b\\fs19\\cf1 ${re(l+': ')}}{\\f0\\fs19\\cf3 ${re(v)}}\\par}\n`; }
  function par(t,opts={}){ if(!t) return ''; return `{\\pard\\sb80\\sa120\\qj{\\f0\\fs19\\cf3${opts.italic?'\\i':''} ${re(t)}}\\par}\n`; }
  function hr(){ return `{\\pard\\sb80\\sa80\\brdrb\\brdrs\\brdrw6\\brdrcf2\\par}\n`; }
  function enSection(label){ return `{\\pard\\sb80\\sa60{\\f0\\b\\fs18\\cf2 ${re(label)}}\\par}\n`; }

  let body='';
  switch(tipo.id){
    case 'cert_bilingue': case 'cert_espanol': {
      const bil=tipo.id==='cert_bilingue';
      body+=title(bil?'CERTIFICADO PSICOL√ìGICO / PSYCHOLOGICAL CERTIFICATE':'CERTIFICADO PSICOL√ìGICO');
      body+=hr();
      body+=par(`La suscrita, ${PSI.nombre}, Psic√≥loga Titulada con Tarjeta Profesional No. ${PSI.tp}, en el ejercicio de mis funciones profesionales, certifica lo siguiente:`);
      body+=par(`${pac.tratamiento||'El/La paciente'} ${pac.nombre}, identificado(a) con c√©dula de ciudadan√≠a n√∫mero ${pac.cc||'___________'} de ${pac.ciudadExp||'Medell√≠n'}, ha sido sometido(a) a una valoraci√≥n psicol√≥gica integral llevada a cabo mediante modalidad ${datos.modalidad||'virtual'}.`);
      body+=par(datos.cuerpo||(datos.diagnostico?`Con base en la evaluaci√≥n cl√≠nica realizada, se concluye que el/la paciente cumple con los criterios diagn√≥sticos de ${datos.diagnostico} (de acuerdo con el ${datos.manual||'DSM-5'}).`:'[Completar cuerpo del certificado]'));
      if(datos.observaciones) body+=par(datos.observaciones);
      body+=par(`Este certificado se emite a solicitud de la interesada/o para los fines que estime pertinentes, en Medell√≠n, a los ${fecha}.`);
      if(bil){
        body+=`{\\pard\\sb320\\sa40\\par}\n`;
        body+=hr();
        body+=enSection('ENGLISH VERSION');
        body+=par(`The undersigned, ${PSI.nombre}, Licensed Psychologist with Professional License No. ${PSI.tp}, hereby certifies the following:`);
        body+=par(`${pac.tratamiento_en||'The patient'} ${pac.nombre}, identified with citizenship ID number ${pac.cc||'___________'} from ${pac.ciudadExp||'Medell√≠n'}, has undergone a comprehensive psychological evaluation conducted via ${datos.modalidad==='presencial'?'in-person':'virtual'} modality.`);
        body+=par(datos.cuerpo_en||(datos.diagnostico_en||datos.diagnostico?`Based on the clinical assessment, the patient meets diagnostic criteria for ${datos.diagnostico_en||datos.diagnostico} (as per the ${datos.manual||'DSM-5'}).`:'[Add certificate body in English]'));
        body+=par(`This certificate is issued at the request of the interested party for the purposes deemed pertinent, in Medell√≠n, on ${new Date().toLocaleDateString('en-US',{day:'numeric',month:'long',year:'numeric'})}.`);
      }
      break;
    }
    case 'cert_esa': {
      body+=title('CERTIFICADO DE IDONEIDAD PARA ANIMAL DE SOPORTE EMOCIONAL (ESA)');
      body+=subtitle('Emotional Support Animal Certificate');
      body+=hr();
      body+=par(`Yo, ${PSI.nombre}, Psic√≥loga Titulada con Tarjeta Profesional No. ${PSI.tp}, certifico que he evaluado psicol√≥gicamente a:`);
      body+=camp('Paciente',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc); body+=camp('Diagn√≥stico / Condici√≥n',datos.diagnostico);
      body+=par(`Con base en la evaluaci√≥n cl√≠nica, certifico que ${pac.nombre.split(' ')[0]} presenta una condici√≥n de salud mental que justifica m√©dica y psicol√≥gicamente la tenencia de un Animal de Soporte Emocional (ESA).`);
      body+=sec('Informaci√≥n del Animal');
      body+=camp('Nombre',datos.nombreAnimal); body+=camp('Especie / Raza',datos.especieAnimal); body+=camp('Descripci√≥n',datos.descAnimal);
      body+=par(`Este certificado se emite en Medell√≠n, a los ${fecha}.`);
      body+=`{\\pard\\sb280\\sa0\\par}\n`; body+=hr(); body+=enSection('ENGLISH VERSION');
      body+=par(`I, ${PSI.nombre}, Licensed Psychologist (Professional License No. ${PSI.tp}), hereby certify that ${pac.nombre} presents a mental health condition (${datos.diagnostico||'___'}) that medically and psychologically justifies the need for an Emotional Support Animal (ESA).`);
      body+=par(`Animal: ${datos.nombreAnimal||'___'} ¬∑ ${datos.especieAnimal||'___'}${datos.descAnimal?' ¬∑ '+datos.descAnimal:''}. Issued in Medell√≠n, on ${new Date().toLocaleDateString('en-US',{day:'numeric',month:'long',year:'numeric'})}.`);
      break;
    }
    case 'informe_seguimiento': {
      body+=title('INFORME DE SEGUIMIENTO TERAP√âUTICO'); body+=hr();
      body+=sec('I. Datos de Identificaci√≥n');
      body+=camp('Paciente',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc);
      body+=camp('Diagn√≥stico',datos.diagnostico); body+=camp('Per√≠odo evaluado',datos.periodo);
      body+=camp('Modalidad',datos.modalidad); body+=camp('N√∫mero de sesiones',datos.numSesiones);
      body+=sec('II. Motivo de Consulta y Antecedentes'); body+=par(datos.motivoConsulta);
      body+=sec('III. Evoluci√≥n Cl√≠nica'); body+=par(datos.evolucion);
      if(datos.logros) body+=camp('Logros terap√©uticos',datos.logros);
      if(datos.dificultades) body+=camp('Dificultades observadas',datos.dificultades);
      body+=sec('IV. Estado Actual'); body+=par(datos.estadoActual);
      if(datos.estadoEmocional) body+=camp('Estado emocional promedio (1-10)',datos.estadoEmocional);
      body+=sec('V. Plan de Continuidad'); body+=par(datos.planContinuidad);
      body+=sec('VI. Conclusiones'); body+=par(datos.conclusiones);
      break;
    }
    case 'informe_diagnostico': {
      body+=title('INFORME PSICOL√ìGICO DE EVALUACI√ìN DIAGN√ìSTICA'); body+=hr();
      body+=sec('I. Datos de Identificaci√≥n');
      body+=camp('Paciente',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc);
      body+=camp('Fecha(s) de evaluaci√≥n',datos.fechaEval); body+=camp('Modalidad',datos.modalidad); body+=camp('Sesiones',datos.numSesiones);
      body+=sec('II. Motivo de Consulta'); body+=par(datos.motivoConsulta);
      body+=sec('III. Historia Cl√≠nica'); body+=par(datos.historia);
      body+=sec('IV. Instrumentos Utilizados'); body+=par(datos.instrumentos);
      body+=sec('V. Resultados'); body+=par(datos.resultados);
      body+=sec('VI. Diagn√≥stico');
      body+=camp('Diagn√≥stico principal',datos.diagnostico); body+=camp('Manual',datos.manual);
      if(datos.diagnosticoDif) body+=camp('Diagn√≥stico diferencial',datos.diagnosticoDif);
      body+=sec('VII. Recomendaciones'); body+=par(datos.recomendaciones);
      body+=sec('VIII. Conclusiones'); body+=par(datos.conclusiones);
      break;
    }
    case 'informe_legal': {
      body+=title('INFORME PSICOL√ìGICO PARA PROCESO LEGAL');
      body+=subtitle(datos.tipoProcess||'Evaluaci√≥n Pericial'); body+=hr();
      body+=`{\\pard\\sb80\\sa120{\\f0\\b\\fs18\\cf2 ${re('‚ö† DOCUMENTO CONFIDENCIAL ‚Äî USO EXCLUSIVO PARA FINES JUDICIALES')}}\\par}\n`;
      body+=sec('I. Datos del Solicitante');
      body+=camp('Solicitado por',datos.solicitante); body+=camp('Entidad',datos.entidad);
      body+=camp('Prop√≥sito',datos.proposito); body+=camp('Radicado',datos.radicado);
      body+=sec('II. Datos del Evaluado/a');
      body+=camp('Nombre',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc); body+=camp('Relaci√≥n con el proceso',datos.relacionProceso);
      body+=sec('III. Metodolog√≠a'); body+=par(datos.metodologia); body+=camp('Instrumentos',datos.instrumentos);
      body+=sec('IV. Hallazgos Cl√≠nicos'); body+=par(datos.hallazgos);
      body+=sec('V. An√°lisis Psicol√≥gico'); body+=par(datos.analisis);
      body+=sec('VI. Conclusiones y Concepto'); body+=par(datos.conclusiones);
      body+=sec('VII. Recomendaciones'); body+=par(datos.recomendaciones);
      body+=par('La profesional suscrita declara que el presente informe ha sido elaborado de manera objetiva, con base en la evidencia cl√≠nica recopilada.',{italic:true});
      break;
    }
    case 'informe_incapacidad': {
      body+=title('CERTIFICADO PSICOL√ìGICO DE INCAPACIDAD LABORAL'); body+=hr();
      body+=sec('I. Datos del Paciente');
      body+=camp('Nombre completo',pac.nombre); body+=camp('Identificaci√≥n','C.C. '+pac.cc);
      body+=camp('Empleador / Empresa',datos.empleador); body+=camp('Cargo',datos.cargo);
      body+=sec('II. Diagn√≥stico');
      body+=camp('Diagn√≥stico',datos.diagnostico); body+=camp('C√≥digo CIE-11 / DSM-5',datos.codigoDx);
      body+=sec('III. Justificaci√≥n de Incapacidad'); body+=par(datos.justificacion);
      body+=camp('Per√≠odo recomendado',datos.periodo); body+=camp('Fecha inicio',datos.fechaInicio); body+=camp('Fecha fin estimada',datos.fechaFin);
      body+=sec('IV. Recomendaciones'); body+=par(datos.recomendaciones);
      break;
    }
  }
  // Firma
  body+=`{\\pard\\sb400\\sa0\\par}\n`; body+=hr();
  body+=par(`En constancia se firma en Medell√≠n, a los ${fecha}.`,{italic:true});
  body+=`{\\pard\\sb360\\sa0{\\f0\\fs19\\cf3 ${re('_'.repeat(45))}}\\par}\n`;
  body+=`{\\pard\\sb40\\sa0{\\f0\\b\\fs22\\cf1 ${re(PSI.nombre)}}\\par}\n`;
  body+=`{\\pard\\sb20\\sa0{\\f0\\fs19\\cf2 ${re('Psic√≥loga Titulada ¬∑ T.P. No. '+PSI.tp)}}\\par}\n`;
  body+=`{\\pard\\sb20\\sa0{\\f0\\fs18\\cf3 ${re('C.C. '+PSI.cc+' ¬∑ '+PSI.tel+' ¬∑ '+PSI.email)}}\\par}\n`;
  body+=`{\\pard\\sb10\\sa0{\\f0\\fs18\\cf3 ${re(PSI.dir)}}\\par}\n`;

  return `{\\rtf1\\ansi\\ansicpg1252\\uc1\\deff0\n{\\fonttbl{\\f0\\fswiss Arial;}{\\f1\\froman Georgia;}}\n{\\colortbl;\\red100\\green48\\blue0;\\red205\\green142\\blue157;\\red80\\green80\\blue80;}\n\\widowctrl\\hyphauto\\paperw11906\\paperh16838\\margl1440\\margr1440\\margt1440\\margb1440\n${body}}`;
}

document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('an-fecha').valueAsDate = new Date();
  document.getElementById('pl-fecha').valueAsDate = new Date();
  document.getElementById('ses-fecha').valueAsDate = new Date();
  fillSelects();
  renderDashboard();

  // Sincronizar con Firebase y refrescar UI
  DB.loadAll().then(function(ok){
    if(!ok) return;
    // Recargar variables globales con datos de la nube
    var ag = DB.get('agenda_eventos');
    if(ag){ agEventos.length=0; ag.forEach(function(e){ agEventos.push(e); }); }
    var fin = DB.get('finanzas_registros');
    if(fin){ registros.length=0; fin.forEach(function(r){ registros.push(r); }); }
    // Re-renderizar con datos frescos de la nube
    renderDashboard();
    fillSelects();
    if(typeof renderAgenda === 'function') renderAgenda();
    if(typeof renderAll === 'function') renderAll();
  });
});
</script>
</body>
</html>
